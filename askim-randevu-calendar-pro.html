<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aşkım Erkek Kuaförü — Randevu (Takvimli Pro)</title>
<meta name="theme-color" content="#0e0e10">
<style>
:root{
  --bg:#0e0e10;--elev:#131317;--card:#17171c;--line:#26252b;
  --text:#f3f3f5;--muted:#9a9aa3;--accent:#f5c451;--ok:#2ecc71;--bad:#ff5c5c;--warn:#ffbf47;
  --chip:#0f1014;--chipline:#2b2b31;
}
*{box-sizing:border-box} ::selection{background:rgba(245,196,81,.25)}
body{margin:0;background:radial-gradient(80% 80% at 50% -20%,rgba(245,196,81,.06),transparent 60%),var(--bg);color:var(--text);font:500 15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;letter-spacing:.1px}
a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
.header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(14,14,16,.95),rgba(14,14,16,.7));backdrop-filter:saturate(1.2) blur(10px);border-bottom:1px solid var(--line)}
.container{max-width:1100px;margin:0 auto;padding:14px 16px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:40px;height:40px;border-radius:10px;background:
  conic-gradient(from 210deg at 50% 50%, #000 0 25%, var(--accent) 25% 26%, #000 26% 50%, var(--accent) 50% 51%, #000 51% 75%, var(--accent) 75% 76%, #000 76% 100%);
  box-shadow:0 0 0 1px #303038,0 10px 30px rgba(0,0,0,.35)}
.title{font-weight:800;letter-spacing:.4px}
.subtitle{font-size:12px;color:var(--muted);margin-top:-2px}
.header-actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.btn{border:1px solid var(--line);background:linear-gradient(180deg,#141419,#0f0f13);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
.btn:active{transform:translateY(1px)}
.btn-accent{background:linear-gradient(180deg,#2a2315,#1a150a);border-color:#3a2b12}
.btn-ghost{background:#0f1014}
.main{max-width:1100px;margin:0 auto;padding:18px 16px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media (min-width:900px){.grid{grid-template-columns:1.15fr .85fr}}
.card{background:linear-gradient(180deg,var(--elev),var(--card));border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.h2{margin:0 0 10px;font-size:18px}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
input,select,button,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:#0f0f13;color:var(--text)}
input:focus,select:focus,textarea:focus{outline:2px solid rgba(245,196,81,.35)}
.row{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:600px){.row{grid-template-columns:1fr 1fr}}
.helper{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0 0 0}
.chip{background:var(--chip);border:1px solid var(--chipline);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);cursor:pointer}
.chip:hover{border-color:#3a3a42;color:#cfcfd6}
#slots{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;max-height:320px;overflow:auto;padding-right:2px}
.slot{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#101015;cursor:pointer;text-align:center;font-weight:700}
.slot[disabled]{opacity:.45;cursor:not-allowed;text-decoration:line-through}
.slot.active{outline:2px solid var(--accent)}
.line{height:1px;background:linear-gradient(90deg,transparent,#2a2a30,transparent);margin:10px 0}
.item{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#0e0e12;color:#c8c8cf}
.item .who{margin-left:auto;color:#c8c8cf}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111217;border:1px solid #2c2c34;border-radius:12px;padding:10px 14px;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none}
.toast.ok{color:var(--ok)} .toast.err{color:var(--bad)} .toast.warn{color:var(--warn)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;place-items:center;padding:16px;z-index:30}
.modal .panel{width:100%;max-width:940px}
.kudos{font-size:12px;color:var(--muted);margin-top:6px;text-align:center}
.footer{opacity:.8;font-size:12px;margin-top:10px;text-align:center;color:var(--muted)}
.section-title{display:flex;align-items:center;gap:8px;margin:14px 0 6px 0;font-weight:800}
.badge{background:#0f1014;border:1px solid #2a2a30;border-radius:8px;padding:4px 8px;font-size:11px;color:#b9b9c1}
.cta{position:sticky;bottom:-1px;z-index:15;background:linear-gradient(180deg,transparent,rgba(14,14,16,.2)),linear-gradient(180deg,var(--elev),var(--card));padding-top:6px;margin-top:10px}
.hidden{display:none}
/* Weekly calendar */
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:6px 0 10px}
.day{background:#0f1014;border:1px solid var(--line);border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer}
.day.active{outline:2px solid var(--accent)}
.calbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:6px 0}
.calbar .grp{display:flex;gap:8px}
</style>
</head>
<body>
  <div class="header">
    <div class="container brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">AŞKIM ERKEK KUAFÖRÜ</div>
        <div class="subtitle">Randevunu 1 dakikada al</div>
      </div>
      <div class="header-actions">
        <button class="btn" id="adminBtn">⚙️ Ayarlar</button>
        <a class="btn btn-ghost" id="mapLink" href="#" target="_blank">📍 Yol tarifi</a>
      </div>
    </div>
  </div>

  <main class="main">
    <div class="grid">
      <section class="card">
        <div class="section-title">📅 Randevu Al <span class="badge" id="openInfo"></span></div>

        <!-- Weekly calendar controls -->
        <div class="calbar">
          <div class="grp">
            <button class="btn" id="prevWeek">← Önceki</button>
            <button class="btn" id="todayBtn">Bugün</button>
            <button class="btn" id="nextWeek">Sonraki →</button>
          </div>
          <div class="badge" id="weekRange"></div>
        </div>
        <div id="calendar" class="calendar"></div>

        <div class="row">
          <div>
            <label>Ad Soyad</label>
            <input id="name" placeholder="Örn: Ahmet Tekeli">
          </div>
          <div>
            <label>Telefon</label>
            <input id="phone" placeholder="05xx xxx xx xx">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Hizmet</label>
            <select id="service"></select>
            <div class="helper" id="serviceChips"></div>
          </div>
          <div>
            <label>Personel (isteğe bağlı)</label>
            <select id="staff"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Tarih</label>
            <input id="date" type="date">
          </div>
          <div>
            <label>Saat Seç</label>
            <div id="slots"></div>
            <div class="helper">
              <span class="chip" data-part="morning">Sabah</span>
              <span class="chip" data-part="noon">Öğlen</span>
              <span class="chip" data-part="evening">Akşam</span>
              <span class="chip" data-part="all">Tümü</span>
            </div>
          </div>
        </div>

        <div class="cta">
          <div class="row">
            <button class="btn btn-accent" id="confirmBtn">✅ Randevuyu Onayla</button>
            <button class="btn" id="waBtn">💬 WhatsApp</button>
          </div>
          <div class="kudos">Onay sonrası randevular “Randevular” paneline düşer.</div>
        </div>
      </section>

      <aside class="card" id="ownerPanel">
        <div class="section-title">🗓️ Bugün <span class="badge" id="todayBadge"></span></div>
        <div id="todayInfo" class="kudos" style="text-align:left"></div>
        <div class="line"></div>
        <div class="section-title">📋 Randevular</div>
        <div class="row" style="margin-bottom:6px">
          <button class="btn" id="exportBtn">⤴️ Dışa Aktar</button>
          <input type="file" id="importFile" class="hidden" accept="application/json">
          <button class="btn" id="importBtn">⤵️ İçe Aktar</button>
          <button class="btn" id="clearBtn">🗑️ Temizle</button>
          <button class="btn" id="syncBtn">🔄 Senkronize</button>
        </div>
        <div id="list"></div>
        <div class="footer">Veriler cihazında saklanır (LocalStorage). “Senkronize” için Ayarlara webhook linki gir.</div>
      </aside>
    </div>
  </main>

  <!-- Admin Modal -->
  <div id="adminModal" class="modal">
    <div class="card panel">
      <div class="section-title">⚙️ Ayarlar <span class="badge">PIN: <span id="pinShow">2525</span></span> <button class="btn" id="closeAdmin" style="margin-left:auto;width:auto;padding:8px 12px">Kapat</button></div>
      <div class="row">
        <div><label>İşyeri Adı</label><input id="shopName"></div>
        <div><label>WhatsApp Numara (905xx…)</label><input id="waNumber" placeholder="905xxxxxxxxx"></div>
      </div>
      <div class="row">
        <div><label>Slot Süresi (dakika)</label><input id="slotMins" type="number" min="5" step="5"></div>
        <div><label>Eşzamanlı Koltuk Sayısı</label><input id="chairs" type="number" min="1" step="1"></div>
      </div>
      <div class="row">
        <div><label>Harita Linki (Google Maps)</label><input id="mapUrl" placeholder="https://maps.app.goo.gl/..."></div>
        <div><label>Webhook (Google Apps Script URL)</label><input id="syncUrl" placeholder="https://script.google.com/.../exec"></div>
      </div>
      <div class="section-title">🧰 Hizmetler</div>
      <div class="kudos">Her hizmet için süre (dk) ve fiyatı düzenleyebilirsin.</div>
      <div id="servicesEditor"></div>
      <div class="row"><button class="btn" id="addService">+ Hizmet Ekle</button></div>
      <div class="section-title">👤 Personel</div>
      <div id="staffEditor"></div>
      <div class="row"><button class="btn" id="addStaff">+ Personel Ekle</button></div>
      <div class="section-title">⏰ Mesai Saatleri</div>
      <div class="kudos">Her gün için açılış / kapanış saatini değiştir. Tatil gününü boş bırak.</div>
      <div id="hoursEditor"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn btn-accent" id="saveAdmin">💾 Kaydet</button>
        <button class="btn" id="resetAdmin">↺ Varsayılanlar</button>
        <button class="btn" id="changePin">PIN Değiştir</button>
      </div>
      <div class="kudos">Değişiklikler anında geçerli olur.</div>
    </div>
  </div>

  <div class="toast" id="toast">Kaydedildi</div>

<script>
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));

// ===== Defaults & Storage =====
const DEFAULTS = {
  pin:'2525', shopName:'Aşkım Erkek Kuaförü', waNumber:'', slotMins:30, chairs:1,
  mapUrl:'https://maps.app.goo.gl/', syncUrl:'',
  services:[{name:'Saç',minutes:30,price:400},{name:'Sakal',minutes:20,price:250},{name:'Saç + Sakal',minutes:45,price:600},{name:'Cilt Bakımı',minutes:40,price:500}], 
  staff:['Genel'],
  hours:{Mon:{open:'10:00',close:'19:00'},Tue:{open:'10:00',close:'19:00'},Wed:{open:'10:00',close:'19:00'},Thu:{open:'10:00',close:'19:00'},Fri:{open:'10:00',close:'19:00'},Sat:{open:'10:00',close:'19:00'},Sun:{}},
  bookings:[]
};
const KEY='askim_randevu_calendar_v1';
function load(){ try{ return Object.assign(structuredClone(DEFAULTS), JSON.parse(localStorage.getItem(KEY))||{});}catch(e){return structuredClone(DEFAULTS);} }
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function toast(msg,cls='ok'){ const t=$("#toast"); t.textContent=msg; t.className='toast '+cls; t.style.display='block'; setTimeout(()=>t.style.display='none',1600); }

let state = load();

// ===== Helpers =====
const fmt=n=>n.toString().padStart(2,'0'); 
const toISO=d=>new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split('T')[0];
const toHM=d=>fmt(d.getHours())+':'+fmt(d.getMinutes());
function addMins(d,m){ const x=new Date(d); x.setMinutes(x.getMinutes()+m); return x;}
function parseHM(hm){ const [h,m]=hm.split(':').map(Number); return {h,m}; }
function weekdayKey(dateStr){ const d=new Date(dateStr+'T12:00'); return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]; }
function serviceByName(n){ return state.services.find(s=>s.name===n); }
function isOverlap(aStart,aDur,bStart,bDur){ const toMin=t=>{const [H,M]=t.split(':').map(Number);return H*60+M}; const a0=toMin(aStart),a1=a0+aDur,b0=toMin(bStart),b1=b0+bDur; return Math.max(a0,b0)<Math.min(a1,b1); }
function isTaken(date,time,minutes,staff=''){ const same=state.bookings.filter(b=>b.date===date && (!staff||b.staff===staff||b.staff==='')); let overlapping=0; same.forEach(b=>{ if(isOverlap(b.time,b.minutes,time,minutes)) overlapping++; }); return overlapping>=state.chairs; }

// ===== Brand/UI =====
function refreshBrand(){ document.title=state.shopName+' — Randevu (Takvimli Pro)'; $(".title").textContent=state.shopName.toUpperCase(); $("#mapLink").href=state.mapUrl||'#'; $("#pinShow").textContent=state.pin; }
function fillSelects(){ const sSel=$("#service"); sSel.innerHTML=''; state.services.forEach(s=>{ const o=document.createElement('option'); o.value=s.name; o.textContent=`${s.name} • ${s.minutes} dk • ${s.price}₺`; sSel.appendChild(o); });
  const stSel=$("#staff"); stSel.innerHTML=''; const any=document.createElement('option'); any.value=''; any.textContent='Farketmez'; stSel.appendChild(any);
  state.staff.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; stSel.appendChild(o); });
  const chips=$("#serviceChips"); chips.innerHTML=''; state.services.slice(0,4).forEach(s=>{ const c=document.createElement('span'); c.className='chip'; c.textContent=s.name; c.onclick=()=>{ sSel.value=s.name; generateSlots(); }; chips.appendChild(c); });
}
function setDefaultDate(){ $("#date").value = toISO(new Date()); }

// ===== Weekly Calendar =====
let weekStart = new Date(); // Monday of current week
weekStart.setDate(weekStart.getDate() - ((weekStart.getDay()+6)%7)); // Monday
function renderWeek(){
  const cal=$("#calendar"); cal.innerHTML='';
  const start = new Date(weekStart); const end = new Date(weekStart); end.setDate(end.getDate()+6);
  $("#weekRange").textContent = toISO(start)+' — '+toISO(end);
  for(let i=0;i<7;i++){
    const d=new Date(weekStart); d.setDate(d.getDate()+i);
    const iso = toISO(d);
    const names=['Pzt','Sal','Çar','Per','Cum','Cmt','Paz'];
    const btn=document.createElement('button'); btn.className='day'; btn.dataset.date=iso;
    btn.innerHTML = names[i]+'<br><span style="opacity:.8">'+d.getDate()+' '+d.toLocaleString('tr-TR',{month:'short'})+'</span>';
    if($("#date").value===iso) btn.classList.add('active');
    btn.onclick=()=>{ $$(".day").forEach(b=>b.classList.remove('active')); btn.classList.add('active'); $("#date").value=iso; generateSlots(); };
    cal.appendChild(btn);
  }
}
$("#prevWeek").onclick=()=>{ weekStart.setDate(weekStart.getDate()-7); renderWeek(); };
$("#nextWeek").onclick=()=>{ weekStart.setDate(weekStart.getDate()+7); renderWeek(); };
$("#todayBtn").onclick=()=>{ weekStart = new Date(); weekStart.setDate(weekStart.getDate() - ((weekStart.getDay()+6)%7)); $("#date").value = toISO(new Date()); renderWeek(); generateSlots(); };

// ===== Slots / Today =====
function openCloseBadge(dateStr){ const w=weekdayKey(dateStr); const h=state.hours[w]||{}; $("#openInfo").textContent=(h.open&&h.close)?`Açık: ${h.open}–${h.close}`:'Bugün kapalı'; }
function generateSlots(){ const cont=$("#slots"); cont.innerHTML=''; const dateStr=$("#date").value; if(!dateStr) return; openCloseBadge(dateStr); const w=weekdayKey(dateStr); const hours=state.hours[w]||{};
  if(!hours.open||!hours.close){ cont.innerHTML='<span class="kudos">Bu gün kapalı.</span>'; return; } const {h:oh,m:om}=parseHM(hours.open); const {h:ch,m:cm}=parseHM(hours.close);
  let cur=new Date(dateStr+'T'+fmt(oh)+':'+fmt(om)+':00'); const end=new Date(dateStr+'T'+fmt(ch)+':'+fmt(cm)+':00'); const selected=serviceByName($("#service").value)||{minutes:state.slotMins};
  while(cur<end){ const t=toHM(cur); const b=document.createElement('button'); b.type='button'; b.className='slot'; b.textContent=t; b.dataset.time=t;
    if(isTaken(dateStr,t,selected.minutes,$("#staff").value)){ b.disabled=true; b.title='Dolu'; }
    b.onclick=()=>{ $$(".slot.active").forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
    cont.appendChild(b); cur=addMins(cur,state.slotMins);
  }
  // highlight selected day in calendar
  $$(".day").forEach(btn=>{ btn.classList.toggle('active', btn.dataset.date===dateStr); });
}
function refreshToday(){ const today=new Date(); const days=['Pazar','Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi'];
  const iso=toISO(today); const w=weekdayKey(iso); const h=state.hours[w]||{};
  $("#todayBadge").textContent=days[today.getDay()]; $("#todayInfo").innerHTML=h.open?`Açık: <b>${h.open}–${h.close}</b>`:'<b>Bugün kapalı</b>'; }

// ===== Admin Builders =====
function buildServicesEditor(){ const root=$("#servicesEditor"); root.innerHTML=''; state.services.forEach((s,idx)=>{ const row=document.createElement('div'); row.className='row'; row.style.margin='6px 0'; row.innerHTML=`
  <input value="${s.name}" data-k="name" placeholder="Ad: Saç">
  <input type="number" value="${s.minutes}" data-k="minutes" placeholder="Süre (dk)">
  <input type="number" value="${s.price}" data-k="price" placeholder="Fiyat (₺)">
  <button class="btn" data-a="del">Sil</button>`;
  row.querySelectorAll('input').forEach(inp=>{ inp.oninput=()=>{ const k=inp.dataset.k; state.services[idx][k]=k==='name'?inp.value:Number(inp.value); save(); fillSelects(); generateSlots(); }; });
  row.querySelector('[data-a="del"]').onclick=()=>{ state.services.splice(idx,1); save(); buildServicesEditor(); fillSelects(); generateSlots(); };
  root.appendChild(row);
});}
function buildStaffEditor(){ const root=$("#staffEditor"); root.innerHTML=''; state.staff.forEach((p,idx)=>{ const row=document.createElement('div'); row.className='row'; row.style.margin='6px 0'; row.innerHTML=`
  <input value="${p}" placeholder="İsim"><button class="btn" data-a="del">Sil</button>`;
  row.querySelector('input').oninput=e=>{ state.staff[idx]=e.target.value; save(); fillSelects(); };
  row.querySelector('[data-a="del"]').onclick=()=>{ state.staff.splice(idx,1); save(); buildStaffEditor(); fillSelects(); };
  root.appendChild(row);
});}
function buildHoursEditor(){ const keys=['Mon','Tue','Wed','Thu','Fri','Sat','Sun']; const names={Mon:'Pazartesi',Tue:'Salı',Wed:'Çarşamba',Thu:'Perşembe',Fri:'Cuma',Sat:'Cumartesi',Sun:'Pazar'}; const root=$("#hoursEditor"); root.innerHTML='';
  keys.forEach(k=>{ const row=document.createElement('div'); row.className='row'; row.style.margin='6px 0'; const open=state.hours[k]?.open||''; const close=state.hours[k]?.close||'';
    row.innerHTML=`<div><label>${names[k]}</label><input type="time" value="${open}" data-k="${k}" data-f="open"></div><div><label>&nbsp;</label><input type="time" value="${close}" data-k="${k}" data-f="close"></div>`;
    row.querySelectorAll('input').forEach(inp=>{ inp.oninput=()=>{ const day=inp.dataset.k,f=inp.dataset.f,val=inp.value; if(!state.hours[day]) state.hours[day]={}; state.hours[day][f]=val; if((state.hours[day].open||'')===''||(state.hours[day].close||'')===''){ state.hours[day]={}; } save(); generateSlots(); refreshToday(); }; });
    root.appendChild(row);
  });
}

// ===== Events =====
$("#adminBtn").onclick=()=>{ const pin=prompt('Ayarlar PIN:'); if(pin===state.pin){ $("#adminModal").style.display='grid'; buildServicesEditor(); buildStaffEditor(); buildHoursEditor();
  $("#shopName").value=state.shopName; $("#waNumber").value=state.waNumber; $("#slotMins").value=state.slotMins; $("#chairs").value=state.chairs; $("#mapUrl").value=state.mapUrl; $("#syncUrl").value=state.syncUrl; } else if(pin!==null){ toast('Hatalı PIN','err'); } };
$("#closeAdmin").onclick=()=>$("#adminModal").style.display='none';
$("#saveAdmin").onclick=()=>{ state.shopName=$("#shopName").value||state.shopName; state.waNumber=$("#waNumber").value.trim(); state.slotMins=Math.max(5, Number($("#slotMins").value)||state.slotMins); state.chairs=Math.max(1, Number($("#chairs").value)||state.chairs); state.mapUrl=$("#mapUrl").value.trim(); state.syncUrl=$("#syncUrl").value.trim();
  save(); refreshBrand(); fillSelects(); generateSlots(); refreshToday(); toast('Ayarlar kaydedildi','ok'); };
$("#resetAdmin").onclick=()=>{ if(confirm('Varsayılan ayarlara dönülsün mü? (Randevular silinmez)')){ const keep=state.bookings; state=structuredClone(DEFAULTS); state.bookings=keep; save(); refreshBrand(); fillSelects(); setDefaultDate(); renderWeek(); generateSlots(); renderList(); refreshToday(); buildServicesEditor(); buildStaffEditor(); buildHoursEditor(); toast('Varsayılanlara dönüldü','warn'); } };
$("#changePin").onclick=()=>{ const np=prompt('Yeni PIN (min 4):'); if(np && np.length>=4){ state.pin=np; save(); $("#pinShow").textContent=np; toast('PIN güncellendi'); } };
$("#addService").onclick=()=>{ state.services.push({name:'Yeni Hizmet',minutes:30,price:0}); save(); buildServicesEditor(); fillSelects(); generateSlots(); };
$("#addStaff").onclick=()=>{ state.staff.push('Yeni Personel'); save(); buildStaffEditor(); fillSelects(); };

// Booking actions
$("#service").onchange=generateSlots; $("#date").onchange=generateSlots;
$$('[data-part]').forEach(c=>c.onclick=()=>{ filterPart(c.dataset.part); });
function filterPart(part){ const getMin=t=>{const [H,M]=t.split(':').map(Number);return H*60+M}; const elems=$$(".slot"); elems.forEach(e=>e.style.display=''); if(part==='all') return;
  const ranges={morning:[0,12*60],noon:[12*60,17*60],evening:[17*60,24*60]}; const [a,b]=ranges[part]; elems.forEach(e=>{ const m=getMin(e.dataset.time); if(m<a||m>=b) e.style.display='none'; }); }
$("#confirmBtn").onclick=()=>{ const name=$("#name").value.trim(); const phone=$("#phone").value.trim(); const service=$("#service").value; const staff=$("#staff").value; const date=$("#date").value; const slotBtn=$(".slot.active");
  if(!name||!phone||!service||!date||!slotBtn){ toast('Lütfen tüm alanları doldur ve saat seç','err'); return; }
  const minutes=serviceByName(service)?.minutes||state.slotMins; const time=slotBtn.dataset.time; if(isTaken(date,time,minutes,staff)){ toast('Bu saat dolu, başka saat seç','err'); return; }
  const booking={name,phone,service,staff,date,time,minutes, shop:state.shopName, createdAt:new Date().toISOString()};
  state.bookings.push(booking); save(); renderList(); generateSlots(); toast('Randevu alındı ✅','ok');
  // remote sync if configured
  if(state.syncUrl){ try{ fetch(state.syncUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(booking),mode:'no-cors'}); }catch(e){} }
};
$("#waBtn").onclick=()=>{ const name=$("#name").value.trim(); const service=$("#service").value; const date=$("#date").value; const slotBtn=$(".slot.active"); const time=slotBtn?slotBtn.dataset.time:'';
  const text=encodeURIComponent(`Merhaba ${name||''}, ${date||''} ${time||''} tarihli "${service||''}" randevu talebiniz alındı. Onay için dönüş yapacağız.`); window.open(`https://wa.me/${state.waNumber||''}?text=${text}`,'_blank'); };

// Export/Import/Clear/Sync
$("#exportBtn").onclick=()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='askim-kuafor-randevu-calendar.json'; a.click(); };
$("#importBtn").onclick=()=>$("#importFile").click();
$("#importFile").addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{ const data=JSON.parse(rd.result); state=Object.assign(structuredClone(DEFAULTS),data); save(); refreshBrand(); fillSelects(); setDefaultDate(); renderWeek(); generateSlots(); renderList(); refreshToday(); toast('İçe aktarıldı'); }catch(_){ toast('Dosya okunamadı','err'); } }; rd.readAsText(f); });
$("#clearBtn").onclick=()=>{ if(confirm('Tüm randevular silinsin mi?')){ state.bookings=[]; save(); renderList(); generateSlots(); toast('Randevular temizlendi','warn'); } };
$("#syncBtn").onclick=()=>{ if(!state.syncUrl){ toast('Ayarlar → Webhook linki ekleyin','warn'); return; } const all=state.bookings; all.forEach(b=>{ try{ fetch(state.syncUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b),mode:'no-cors'});}catch(e){} }); toast('Senkronizasyon gönderildi','ok'); };

// Owner/Client mode via URL params
const params = new URLSearchParams(location.search);
const readonly = params.get('readonly')==='1' || params.get('mode')==='client';
if(readonly){ $("#adminBtn").style.display='none'; $("#ownerPanel").style.display='none'; }

// Init
refreshBrand(); fillSelects(); setDefaultDate(); renderWeek(); generateSlots(); renderList(); refreshToday();
</script>
</body>
</html>
