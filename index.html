<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ahmet Tekeli â€¢ Randevu (Firebase â€¢ Tek Dosya)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f6f7fa;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--card:#fff;--gold:#d4af37;--brand:#101827}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;width:100%;overflow-x:hidden}
.wrap{max-width:1000px;margin:0 auto;padding:0 14px}

/* Header */
header{position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:20}
.header-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.brand{display:flex;align-items:center;gap:10px}
.brand .title{font-family:Georgia,serif;font-weight:700;color:var(--brand);font-size:24px;line-height:1}
.brand .sub{font-size:12px;color:var(--muted)}
.actions{display:flex;align-items:center;gap:8px}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer}
.badge .dot{min-width:18px;height:18px;padding:0 6px;border-radius:999px;background:#ef4444;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700}

/* Buttons & form */
.btn{border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn-primary{background:var(--gold);border-color:var(--gold);color:#111}
.small{font-size:12px;color:var(--muted)}
label{display:block;font-weight:600;margin:0 0 6px 0}
input,select{width:100%;max-width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px}

/* Main cards */
main{padding:16px 0}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;overflow-x:hidden}
h2{margin:0 0 12px 0}
.grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}

/* Slotbar â€” mobil parmak dostu */
.slotbar{
  display:flex; gap:14px; overflow-x:auto; overflow-y:hidden; padding:10px 4px;
  scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; max-width:100%;
}
.slot{
  flex:0 0 auto; scroll-snap-align:center; min-width:120px; text-align:center;
  padding:16px 20px; border:2px solid var(--line); border-radius:999px; background:#fff;
  white-space:nowrap; font-size:18px; line-height:1.25;
}
.slot.sel{background:#111827;color:#fff;border-color:#111827;box-shadow:0 6px 18px rgba(0,0,0,.22);transform:translateY(-1px)}
.slot.dis{opacity:.45;pointer-events:none;text-decoration:line-through}
@media (pointer:coarse){.slot{min-width:136px;font-size:19px;padding:18px 22px}}
.slots-wrap .btn{width:44px;height:44px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;font-size:20px;padding:0}

/* KPI (admin) */
.kpi{display:none;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:16px}
.kpi .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}

/* Sheets (modal alt-Ã§ekme) */
.sheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:flex-end;z-index:30}
.sheet.show{display:flex}
.sheet .panel{width:100%;max-height:92vh;background:#fff;border-radius:16px 16px 0 0;box-shadow:0 -12px 30px rgba(0,0,0,.25);padding:14px 14px 18px;overflow:auto;animation:rise .18s ease-out}
@keyframes rise{from{transform:translateY(12px);opacity:.95}to{transform:none;opacity:1}}
.sheet h3{margin:4px 0 10px 0}

/* Toast */
#toast{position:fixed;left:50%;top:-80px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:50;transition:top .45s}
#toast.show{top:12px}

/* Bell (admin) */
#bellBtn{display:none}
#bellBtn.blink{animation:pulse 1s ease-in-out infinite}
@keyframes pulse{0%{filter:none}50%{filter:drop-shadow(0 0 8px #f43) saturate(1.3)}100%{filter:none}}

/* Table */
.table-scroll{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}
thead th{background:#f3f4f6;font-weight:700}

/* Responsive */
@media(max-width:760px){.grid-2{grid-template-columns:minmax(0,1fr)}}
ul{margin:0;padding-left:16px}
</style>
</head>
<body>
<div id="toast"></div>

<header>
  <div class="wrap header-row">
    <div class="brand">
      <div>
        <div class="title">AHMET TEKELÄ°</div>
        <div class="sub">Erkek KuafÃ¶rÃ¼</div>
      </div>
    </div>
    <div class="actions">
      <!-- YalnÄ±z admin -->
      <button id="bellBtn" class="badge" title="Bildirimler">ğŸ”” <span id="bellCount" class="small">0</span></button>

      <!-- GiriÅŸ kÄ±sayollarÄ± -->
      <button id="adminOpen" class="badge">ğŸ‘¨â€ğŸ’¼ Admin</button>
      <button id="custOpen"  class="badge">ğŸ‘¤ MÃ¼ÅŸteri</button>
      <button id="custLogout" class="badge" style="display:none">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>

      <!-- MÃ¼ÅŸteri panel: rozetli -->
      <button id="myApptsOpen" class="badge" style="display:none">ğŸ“… RandevularÄ±m <span id="myBadge" class="dot" style="display:none">0</span></button>

      <!-- Admin yÃ¶netim -->
      <button id="manageOpen" class="badge" style="display:none">âš™ï¸ YÃ¶netim</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card" id="randevu">
    <h2>Randevu OluÅŸtur</h2>
    <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px">
      <div><label>Ad Soyad</label><input id="f_name" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z"></div>
      <div><label>Telefon</label><input id="f_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
      <div><label>Berber</label><select id="f_staff"><option disabled selected>â€” SeÃ§iniz â€”</option></select></div>
      <div><label>Hizmet</label><select id="f_service"><option disabled selected>â€” SeÃ§iniz â€”</option></select></div>
      <div><label>Tarih</label><input type="date" id="f_date"></div>
      <div style="min-width:0">
        <label>Uygun Saatler</label>
        <div class="slots-wrap">
          <button class="btn" type="button" id="slotPrev">â€¹</button>
          <div id="slotbar" class="slotbar"></div>
          <button class="btn" type="button" id="slotNext">â€º</button>
        </div>
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button class="btn btn-primary" id="f_book">RANDEVU AL</button>
      <span id="f_status" class="small"></span>
    </div>

    <!-- Admin KPI -->
    <div id="kpi" class="kpi">
      <div class="box"><div class="small">BugÃ¼n</div><b id="kpiToday">0</b></div>
      <div class="box"><div class="small">Onay/Bekl/Ä°ptal</div><b id="kpiOBI">0/0/0</b></div>
      <div class="box"><div class="small">HaftalÄ±k</div><b id="kpiWeek">0</b></div>
    </div>
  </section>
</main>

<!-- Admin bildirim sheet -->
<div id="sheetBell" class="sheet" aria-hidden="true">
  <div class="panel">
    <h3>Onay KuyruÄŸu</h3>
    <div id="queueList" class="small">Kuyruk boÅŸ.</div>
  </div>
</div>

<!-- Admin giriÅŸi -->
<div id="sheetAdmin" class="sheet" aria-hidden="true">
  <div class="panel">
    <h3>YÃ¶netici GiriÅŸi</h3>
    <div class="grid-2">
      <div><label>Admin Telefon</label><input id="adminPhone" value="+905356749243"></div>
      <div><label>Åifre</label><input id="adminPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
    </div>
    <div class="actions" style="margin-top:8px">
      <button class="btn btn-primary" id="adminLoginBtn">GiriÅŸ Yap</button>
      <button class="btn" id="adminLogoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
      <span id="adminStatus" class="small"></span>
    </div>
  </div>
</div>

<!-- MÃ¼ÅŸteri giriÅŸi -->
<div id="sheetCust" class="sheet" aria-hidden="true">
  <div class="panel">
    <h3>MÃ¼ÅŸteri GiriÅŸi / KayÄ±t</h3>
    <div class="grid-2">
      <div><label>Ad Soyad</label><input id="c_name" placeholder="Ad Soyad"></div>
      <div><label>Telefon</label><input id="c_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
    </div>
    <div class="grid-2">
      <div><label>PIN (4 hane)</label><input id="c_pin" maxlength="4" inputmode="numeric"></div>
      <div><label style="visibility:hidden">â€”</label><button class="btn btn-primary" id="c_login">GiriÅŸ / KayÄ±t</button></div>
    </div>
    <div class="actions" style="margin-top:6px">
      <button class="btn" id="c_forgot">Åifremi Unuttum</button>
    </div>
    <p class="small" id="c_status"></p>
  </div>
</div>

<!-- MÃ¼ÅŸteri â€¢ RandevularÄ±m -->
<div id="sheetMyAppts" class="sheet" aria-hidden="true">
  <div class="panel">
    <h3>RandevularÄ±m</h3>
    <div class="actions" style="flex-wrap:wrap;gap:8px;margin-bottom:6px">
      <select id="my_filter" style="max-width:200px">
        <option value="upcoming">YaklaÅŸan</option>
        <option value="all">TÃ¼mÃ¼</option>
        <option value="past">GeÃ§miÅŸ</option>
      </select>
      <button class="btn" id="my_refresh">Yenile</button>
    </div>
    <div class="table-scroll">
      <table>
        <thead><tr><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="my_tbody"></tbody>
      </table>
    </div>
    <p class="small" style="margin-top:8px">Not: DeÄŸiÅŸiklikten sonra randevu tekrar onaya dÃ¼ÅŸer.</p>
  </div>
</div>

<!-- Randevu DeÄŸiÅŸtir (MÃ¼ÅŸteri) -->
<div id="sheetResched" class="sheet" aria-hidden="true">
  <div class="panel">
    <h3>Randevuyu DeÄŸiÅŸtir</h3>
    <div class="grid-2">
      <div><label>Tarih</label><input type="date" id="rs_date"></div>
      <div>
        <label>Uygun Saatler</label>
        <div class="slots-wrap">
          <button class="btn" id="rs_prev" type="button">â€¹</button>
          <div id="rs_slots" class="slotbar"></div>
          <button class="btn" id="rs_next" type="button">â€º</button>
        </div>
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button class="btn btn-primary" id="rs_save">Kaydet</button>
      <button class="btn" id="rs_cancel">VazgeÃ§</button>
      <span id="rs_status" class="small"></span>
    </div>
  </div>
</div>

<!-- YÃ¶netim (USTALAR / HÄ°ZMETLER / Ã‡ALIÅMA SAATLERÄ° / MÃœÅTERÄ°LER / PIN TALEPLERÄ° / RAPORLAR) -->
<div id="sheetManage" class="sheet" aria-hidden="true">
  <div class="panel">
    <h3>YÃ¶netim</h3>

    <!-- USTALAR -->
    <section class="card" style="padding:12px">
      <h4>USTALAR</h4>
      <div class="actions">
        <input id="newStaffName" placeholder="Yeni usta adÄ±">
        <button class="btn" id="addStaff">Ekle</button>
      </div>
      <ul id="staffList" class="small" style="margin-top:8px"></ul>
    </section>

    <!-- HÄ°ZMETLER -->
    <section class="card" style="padding:12px;margin-top:10px">
      <h4>HÄ°ZMETLER</h4>
      <div class="actions" style="flex-wrap:wrap">
        <input id="newSvcName" placeholder="Hizmet adÄ±">
        <input id="newSvcDur" type="number" placeholder="SÃ¼re (dk)" style="max-width:120px">
        <input id="newSvcPrice" type="number" placeholder="Fiyat (TL)" style="max-width:120px">
        <button class="btn" id="addSvc">Ekle</button>
      </div>
      <ul id="svcList" class="small" style="margin-top:8px"></ul>
    </section>

    <!-- Ã‡ALIÅMA SAATLERÄ° -->
    <section class="card" style="padding:12px;margin-top:10px">
      <h4>Usta Ã‡alÄ±ÅŸma Saatleri</h4>
      <div class="grid-2">
        <div><label>Usta</label><select id="wh_staff"></select></div>
        <div><label>Slot (dk)</label><input id="wh_slot" type="number" value="15"></div>
      </div>
      <div id="wh_days" class="actions" style="flex-wrap:wrap;margin-top:8px"></div>
      <div class="actions" style="margin-top:8px">
        <button class="btn btn-primary" id="saveWorkHours">Kaydet</button>
        <span id="wh_status" class="small"></span>
      </div>
    </section>

    <!-- MÃœÅTERÄ°LER -->
    <section class="card" style="padding:12px;margin-top:10px">
      <h4>MÃœÅTERÄ°LER</h4>
      <div class="actions" style="margin-bottom:6px">
        <input id="custSearch" placeholder="Ä°sim/Telefon ara" style="max-width:320px">
        <button class="btn" id="custRefresh">Yenile</button>
      </div>
      <div class="table-scroll">
        <table>
          <thead><tr><th>Ad</th><th>Telefon</th><th>KayÄ±t</th><th>Son GiriÅŸ</th><th>Ä°ÅŸlem</th></tr></thead>
          <tbody id="custTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- PIN TALEPLERÄ° -->
    <section class="card" style="padding:12px;margin-top:10px">
      <h4>PIN TALEPLERÄ°</h4>
      <div class="table-scroll">
        <table>
          <thead><tr><th>Telefon</th><th>Yeni PIN</th><th>Talep</th><th>Ä°ÅŸlem</th></tr></thead>
          <tbody id="pinTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- RAPORLAR -->
    <section class="card" style="padding:12px;margin-top:10px">
      <h4>RAPORLAR</h4>
      <div class="grid-2">
        <div class="card" style="padding:10px">
          <div class="small">BugÃ¼n Toplam Randevu</div><b id="rp_today">0</b>
        </div>
        <div class="card" style="padding:10px">
          <div class="small">BugÃ¼n OnaylÄ± Tutar (TL)</div><b id="rp_rev_today">0</b>
        </div>
        <div class="card" style="padding:10px">
          <div class="small">HaftalÄ±k Randevu</div><b id="rp_week">0</b>
        </div>
        <div class="card" style="padding:10px">
          <div class="small">AylÄ±k Randevu</div><b id="rp_month">0</b>
        </div>
      </div>
    </section>

    <!-- RANDEVULAR (YÃ–NET) -->
    <section class="card" style="padding:12px;margin-top:10px">
      <h4>RANDEVULAR</h4>
      <div class="actions" style="flex-wrap:wrap;gap:8px;margin-bottom:6px">
        <input type="date" id="ap_fdate" style="max-width:180px">
        <select id="ap_fstaff" style="max-width:220px"><option value="">TÃ¼m Ustalar</option></select>
        <select id="ap_fstatus" style="max-width:180px">
          <option value="">TÃ¼m Durumlar</option>
          <option value="pending">Onay Bekliyor</option>
          <option value="approved">OnaylandÄ±</option>
          <option value="cancelled">Ä°ptal</option>
          <option value="rejected">Reddedildi</option>
        </select>
        <button class="btn" id="ap_refresh">Yenile</button>
      </div>
      <div class="table-scroll">
        <table>
          <thead><tr><th>Tarih</th><th>Saat</th><th>MÃ¼ÅŸteri</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
          <tbody id="ap_tbody"></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const store={get(k,d){try{const v=localStorage.getItem(k);return v===null?d:JSON.parse(v)}catch(e){return d}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}},del(k){try{localStorage.removeItem(k)}catch(e){}};
function toast(m,ms=2400){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);}
const toMin=t=>{const[h,m]=t.split(':').map(Number);return h*60+m}, toHHMM=m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60,'0').padStart(2,'0')}`;

/* SeÃ§ilen slotu ortaya kaydÄ±rma ve oklar */
function centerSelected(barEl){
  try{
    const sel = barEl.querySelector('.slot.sel'); if(!sel) return;
    const wrapRect = barEl.getBoundingClientRect(), btnRect = sel.getBoundingClientRect();
    const delta = (btnRect.left + btnRect.width/2) - (wrapRect.left + wrapRect.width/2);
    barEl.scrollBy({left: delta, behavior:'smooth'});
  }catch(e){}
}
function wireSlotClicks(barEl){
  barEl.querySelectorAll('.slot').forEach(b=>{
    b.onclick=()=>{ if(b.classList.contains('dis')) return; barEl.querySelectorAll('.slot').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); centerSelected(barEl); };
  });
}
function wireArrows(prevBtn, barEl, nextBtn){
  prevBtn?.addEventListener('click',()=>barEl.scrollBy({left:-240,behavior:'smooth'}));
  nextBtn?.addEventListener('click',()=>barEl.scrollBy({left: 240,behavior:'smooth'}));
}
function autoPickFirst(barEl){
  const first=barEl.querySelector('.slot:not(.dis)');
  if(first && !barEl.querySelector('.slot.sel')){ first.classList.add('sel'); setTimeout(()=>centerSelected(barEl),0); }
}

/* ===== Firebase ===== */
firebase.initializeApp({
  apiKey:"AIzaSyBtSQ9_5R42BU5ga0cOt1QETkC5nOf2tW4",
  authDomain:"randevu-81305.firebaseapp.com",
  projectId:"randevu-81305",
  storageBucket:"randevu-81305.firebasestorage.app",
  messagingSenderId:"686048709577",
  appId:"1:686048709577:web:b2db4eeae83203ca2e3618",
  measurementId:"G-3ZX91ND545"
});
const db=firebase.firestore();

/* ===== Global State ===== */
const ADMIN_PHONE_E164='+905356749243';
const ADMIN_PASSWORD='ahmet07';
let adminOn=false, currentUser=null;
let unsubAppts=null, unsubStaff=null, unsubSvcs=null, unsubUsers=null, unsubPins=null;
let lastStaffCache=[], lastSvcCache=[], lastUserCache=[], lastApptCache=[], lastPinCache=[];
let _rs_ctx=null; // reschedule context

/* === MÃ¼ÅŸteri bildirim takip: Ã¶nceki statÃ¼ler === */
let myPrevStatusById = {};   // {apptId: 'pending'|'approved'|'rejected'|'cancelled'}
let myUnreadCount = 0;

/* ===== Sheets ===== */
const sheet={show:id=>{ $(id).classList.add('show'); document.body.style.overflow='hidden'; }, hide:id=>{ $(id).classList.remove('show'); document.body.style.overflow=''; }};
['#sheetBell','#sheetAdmin','#sheetCust','#sheetMyAppts','#sheetResched','#sheetManage'].forEach(id=>{
  const el=$(id); el?.addEventListener('click',e=>{ if(e.target===el){ sheet.hide(id); } });
});
$('#adminOpen')?.addEventListener('click', ()=> sheet.show('#sheetAdmin'));
$('#custOpen') ?.addEventListener('click', ()=> sheet.show('#sheetCust'));
$('#myApptsOpen')?.addEventListener('click', ()=>{
  sheet.show('#sheetMyAppts');
  // mÃ¼ÅŸteri paneli aÃ§Ä±lÄ±nca rozet sÄ±fÄ±rla
  myUnreadCount = 0; myPrevStatusById = myPrevStatusById || {};
  const b = $('#myBadge'); if(b){ b.style.display='none'; b.textContent='0'; }
});
$('#manageOpen')?.addEventListener('click', ()=> sheet.show('#sheetManage'));
$('#bellBtn')   .addEventListener('click', ()=> sheet.show('#sheetBell'));

/* ===== Admin gÃ¶rÃ¼nÃ¼rlÃ¼k ===== */
function setAdmin(on){
  adminOn=!!on;
  $('#bellBtn').style.display   = adminOn ? 'inline-flex' : 'none';
  $('#manageOpen').style.display= adminOn ? 'inline-flex' : 'none';
  $('#kpi').style.display       = adminOn ? 'grid'       : 'none';
  if(!adminOn){ sheet.hide('#sheetBell'); sheet.hide('#sheetManage'); }
}
(function restoreAdmin(){
  const ok = store.get('adminSession')==='on' && store.get('adminPhone')===ADMIN_PHONE_E164;
  setAdmin(ok);
})();

/* ===== Customer gÃ¶rÃ¼nÃ¼rlÃ¼k + kalÄ±cÄ± oturum ===== */
function setCustomerLogged(on){
  $('#myApptsOpen').style.display = on ? 'inline-flex' : 'none';
  $('#custLogout').style.display   = on ? 'inline-flex' : 'none';
  if(!on){ sheet.hide('#sheetMyAppts'); sheet.hide('#sheetResched'); }
}
function saveCustomerSession(u){ store.set('custSession', { id:u.id, name:u.name, phone:u.phone }); }
function restoreCustomer(){
  const sess=store.get('custSession',null);
  if(!sess){ setCustomerLogged(false); return; }
  currentUser={id:sess.id,name:sess.name,phone:sess.phone};
  setCustomerLogged(true);
  try{ myPrevStatusById={}; const mine=(lastApptCache||[]).filter(a=>a.phone===currentUser.phone); mine.forEach(a=>{ myPrevStatusById[a.id]=a.status; }); }catch(e){}
}

/* ===== Realtime ===== */
function startRealtime(){
  if(unsubAppts) unsubAppts(); if(unsubStaff) unsubStaff(); if(unsubSvcs) unsubSvcs(); if(unsubUsers) unsubUsers(); if(unsubPins) unsubPins();

  unsubStaff = db.collection('staff').onSnapshot(ss=>{
    const list=ss.docs.map(d=>({id:d.id,...d.data()}));
    lastStaffCache=list;
    renderStaffList(list); fillStaffSelect(list); fillAdminStaffFilter(list);
    renderWorkHoursEditor(list); computeSlots();
    renderAdminAppts(lastApptCache);
    if(_rs_ctx) computeReschedSlots();
  });

  unsubSvcs = db.collection('services').onSnapshot(ss=>{
    const list=ss.docs.map(d=>({id:d.id,...d.data()}));
    lastSvcCache=list;
    renderServiceList(list); fillServiceSelect(list); computeSlots();
    renderAdminAppts(lastApptCache);
  });

  unsubUsers = db.collection('users').onSnapshot(ss=>{
    const list=ss.docs.map(d=>({id:d.id,...d.data()}));
    lastUserCache=list; renderCustomers(list);
  });

  unsubPins = db.collection('pin_reqs').orderBy('createdAt','desc').onSnapshot(ss=>{
    const list=ss.docs.map(d=>({id:d.id,...d.data()}));
    lastPinCache=list; renderPinReqs(list);
  });

  unsubAppts = db.collection('appts').onSnapshot(ss=>{
    const list=ss.docs.map(d=>({id:d.id,...d.data()}));
    lastApptCache=list;
    updateBell(list); renderQueue(list); updateKpis(list); computeSlots(list);
    renderAdminAppts(list); renderMyAppts(list); renderReports(list);
    if(_rs_ctx) computeReschedSlots(list);

    // mÃ¼ÅŸteri canlÄ± bildirimleri
    try{
      if(currentUser){
        const mine = list.filter(a=>a.phone===currentUser.phone);
        mine.forEach(a=>{
          const prev = myPrevStatusById[a.id];
          if(prev && prev==='pending' && (a.status==='approved' || a.status==='rejected')){
            if(a.status==='approved') toast(`âœ… Randevunuz onaylandÄ± â€¢ ${a.date} ${a.time}`);
            else toast(`â›” Randevunuz reddedildi â€¢ ${a.date} ${a.time}`);
            myUnreadCount = (myUnreadCount||0)+1;
            const b = $('#myBadge'); if(b){ b.style.display='inline-flex'; b.textContent=String(myUnreadCount); }
          }
          myPrevStatusById[a.id] = a.status;
        });
      }
    }catch(e){}
  });
}

/* ===== Init ===== */
(function init(){
  $('#f_date').value=new Date().toISOString().slice(0,10);
  $('#ap_fdate').value=new Date().toISOString().slice(0,10);
  fillStaffSelect([]); fillServiceSelect([]);
  try{const wrap=document.querySelector('#randevu > div'); if(wrap){[].forEach.call(wrap.children, el=>el.style.minWidth='0');}}catch(e){}
  restoreCustomer();   // mÃ¼ÅŸteri oturumunu geri yÃ¼kle
  startRealtime();     // canlÄ± dinleyiciler
})();
$('#custLogout')?.addEventListener('click', ()=>{
  currentUser=null; store.del('custSession'); setCustomerLogged(false); toast('MÃ¼ÅŸteri oturumu kapatÄ±ldÄ±');
});

/* ===== Doldurucular ===== */
function fillStaffSelect(list){
  $('#f_staff').innerHTML='<option disabled selected>â€” SeÃ§iniz â€”</option>'+list.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#wh_staff').innerHTML=list.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
function fillAdminStaffFilter(list){
  $('#ap_fstaff').innerHTML='<option value="">TÃ¼m Ustalar</option>'+list.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
function fillServiceSelect(list){
  $('#f_service').innerHTML='<option disabled selected>â€” SeÃ§iniz â€”</option>'+list.map(s=>`<option value="${s.id}">${s.name} â€” ${s.dur} dk</option>`).join('');
}

/* ===== Slot hesaplama ===== */
function conflicts(appts,date,staffId){
  return (appts||[]).filter(a=>a.date===date&&a.staffId===staffId&&a.status!=='cancelled'&&a.status!=='rejected')
    .map(a=>({start:toMin(a.time),end:toMin(a.time)+a.duration}));
}
function overlaps(aS,aE,bS,bE){return aS<bE&&aE>bS}
function getHoursFor(staff,dateISO){
  const dow=new Date(dateISO+'T00:00:00').getDay();
  if(staff?.hoursByDay && staff.hoursByDay[dow]) return staff.hoursByDay[dow];
  return staff?.hours || {open:'09:00',close:'21:00',slot:15};
}
async function computeSlots(apptList){
  const staffId=$('#f_staff').value, svcId=$('#f_service').value, date=$('#f_date').value;
  const bar=$('#slotbar'); bar.innerHTML='';
  if(!staffId||!svcId||!date) return;
  try{
    const sDoc=await db.collection('staff').doc(staffId).get(); const staff=sDoc.data()||{};
    const vDoc=await db.collection('services').doc(svcId).get(); const svc=vDoc.data()||{dur:30};
    const dur=svc.dur||30;
    const {open,close,slot}=getHoursFor(staff,date);
    const openM=toMin(open), closeM=toMin(close), step=slot||15;
    const taken=conflicts(apptList||[],date,staffId);
    const works=!((staff?.offDates||[]).includes(date)) && (!staff?.days || staff.days.includes(new Date(date+'T00:00:00').getDay()));
    for(let t=openM;t+dur<=closeM;t+=step){
      const disabled=!works || taken.some(x=>overlaps(t,t+dur,x.start,x.end));
      const b=document.createElement('button'); b.type='button'; b.className='slot'+(disabled?' dis':''); b.textContent=toHHMM(t); b.dataset.time=toHHMM(t);
      b.onclick=()=>{ if(disabled) return; $$('#slotbar .slot').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); centerSelected(bar); };
      bar.appendChild(b);
    }
    wireArrows($('#slotPrev'),bar,$('#slotNext'));
    autoPickFirst(bar);
  }catch(e){ console.error('computeSlots',e); }
}
$('#slotPrev')?.addEventListener('click',()=>$('#slotbar')?.scrollBy({left:-220,behavior:'smooth'}));
$('#slotNext')?.addEventListener('click',()=>$('#slotbar')?.scrollBy({left:220,behavior:'smooth'}));
$('#f_staff').addEventListener('change',()=>computeSlots(lastApptCache));
$('#f_service').addEventListener('change',()=>computeSlots(lastApptCache));
$('#f_date').addEventListener('change',()=>computeSlots(lastApptCache));

/* ===== Randevu oluÅŸtur ===== */
$('#f_book').addEventListener('click', async ()=>{
  const name=$('#f_name').value.trim();
  const phoneRaw=$('#f_phone').value.trim();
  const staffId=$('#f_staff').value, svcId=$('#f_service').value, date=$('#f_date').value;
  const timeBtn=$('#slotbar .slot.sel'); const time=timeBtn?.dataset.time;
  if(!name||!phoneRaw||!staffId||!svcId||!date||!time){ $('#f_status').textContent='LÃ¼tfen tÃ¼m alanlarÄ± doldurun.'; toast('Eksik bilgi'); return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);
  try{
    const same=await db.collection('appts').where('phone','==',phone).where('date','==',date).get();
    const activeCnt=same.docs.map(d=>d.data()).filter(a=>a.status==='pending'||a.status==='approved').length;
    if(activeCnt>=2){ toast('AynÄ± gÃ¼n en fazla 2 aktif randevu'); return; }
    let uid=null; const uq=await db.collection('users').where('phone','==',phone).limit(1).get();
    if(uq.empty){ const uref=await db.collection('users').add({name,phone,verified:true,pin:'0000',createdAt:Date.now(),lastLogin:Date.now()}); uid=uref.id; }
    else{ uid=uq.docs[0].id; await db.collection('users').doc(uid).set({lastLogin:Date.now()},{merge:true}); }
    const svc=(await db.collection('services').doc(svcId).get()).data();
    const st =(await db.collection('staff').doc(staffId).get()).data();
    await db.collection('appts').add({
      userId:uid,name,phone,serviceId:svcId,serviceName:svc?.name||'Hizmet',duration:svc?.dur||30,price:svc?.price||0,
      staffId,staffName:st?.name||'Usta',date,time,status:'pending',createdAt:Date.now()
    });
    $('#f_status').textContent='Randevu oluÅŸturuldu (Onay bekliyor).'; toast('Randevu alÄ±ndÄ± â€¢ Onay bekliyor');
  }catch(err){ console.error(err); $('#f_status').textContent='Hata: Firestore izin/baÄŸlantÄ±.'; toast('Hata: Firestore Rules / aÄŸ'); }
});

/* ===== Admin bildirim & kuyruk ===== */
function updateBell(list){
  const cnt=(list||[]).filter(a=>a.status==='pending').length;
  $('#bellCount').textContent=String(cnt);
  if(adminOn && cnt>0) $('#bellBtn').classList.add('blink'); else $('#bellBtn').classList.remove('blink');
}
function renderQueue(list){
  const box=$('#queueList');
  const rows=(list||[]).filter(a=>a.status==='pending').sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  if(rows.length===0){ box.textContent='Kuyruk boÅŸ.'; return; }
  box.innerHTML=rows.map(a=>`
   <div style="display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0">
     <div style="flex:1 1 auto;min-width:0"><b>${a.date} ${a.time}</b> â€¢ ${a.name} â€¢ ${a.serviceName} / ${a.staffName}</div>
     <button class="btn" onclick="approve('${a.id}')">Onayla</button>
     <button class="btn" onclick="reject('${a.id}')">Reddet</button>
     <button class="btn" onclick="delAppt('${a.id}')">Sil</button>
   </div>`).join('');
}
window.approve=async(id)=>{ try{await db.collection('appts').doc(id).set({status:'approved'},{merge:true}); toast('OnaylandÄ±');}catch(e){toast('Hata: OnaylanamadÄ±');} };
window.reject =async(id)=>{ try{await db.collection('appts').doc(id).set({status:'rejected'},{merge:true}); toast('Reddedildi');}catch(e){toast('Hata: Reddedilemedi');} };
window.cancelAppt =async(id)=>{ try{await db.collection('appts').doc(id).set({status:'cancelled'},{merge:true}); toast('Ä°ptal edildi');}catch(e){toast('Hata: Ä°ptal edilemedi');} };
window.delAppt=async(id)=>{ if(!confirm('Silinsin mi?')) return; try{await db.collection('appts').doc(id).delete(); toast('Silindi');}catch(e){toast('Hata: Silinemedi');} };

/* ===== KPI & RAPORLAR ===== */
function updateKpis(list){
  if(!adminOn) return;
  const today=new Date().toISOString().slice(0,10);
  const d=list.filter(a=>a.date===today);
  $('#kpiToday').textContent=String(d.length);
  $('#kpiOBI').textContent=[d.filter(a=>a.status==='approved').length,d.filter(a=>a.status==='pending').length,d.filter(a=>a.status==='cancelled').length].join('/');
  const now=new Date(); const ws=new Date(now); ws.setDate(now.getDate()-now.getDay()); const we=new Date(ws); we.setDate(ws.getDate()+6);
  const inWeek=list.filter(a=>a.status!=='rejected' && a.date>=ws.toISOString().slice(0,10) && a.date<=we.toISOString().slice(0,10));
  $('#kpiWeek').textContent=String(inWeek.length);
}
function renderReports(list){
  const today=new Date().toISOString().slice(0,10);
  const now=new Date(), monthStart=new Date(now.getFullYear(),now.getMonth(),1).toISOString().slice(0,10);
  const weekStart=new Date(now); weekStart.setDate(now.getDate()-now.getDay());
  const toISO=d=>d.toISOString().slice(0,10);
  const weekEnd=new Date(weekStart); weekEnd.setDate(weekStart.getDate()+6);

  const todayRows=list.filter(a=>a.date===today);
  const todayApproved=todayRows.filter(a=>a.status==='approved');
  const revToday=todayApproved.reduce((s,a)=>s+(a.price||0),0);

  const weekRows=list.filter(a=>a.date>=toISO(weekStart)&&a.date<=toISO(weekEnd));
  const monthRows=list.filter(a=>a.date>=monthStart);

  $('#rp_today').textContent=String(todayRows.length);
  $('#rp_rev_today').textContent=String(revToday);
  $('#rp_week').textContent=String(weekRows.length);
  $('#rp_month').textContent=String(monthRows.length);
}

/* ===== YÃ¶netim: Ustalar/Hizmetler/Ã‡alÄ±ÅŸma Saatleri ===== */
function renderStaffList(list){
  $('#staffList').innerHTML=(list||[]).sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr')).map(s=>`
    <li style="display:flex;align-items:center;gap:8px;margin:6px 0">
      <span style="flex:1">${s.name}</span>
      <button class="btn" onclick="delStaff('${s.id}')">Sil</button>
    </li>`).join('') || 'â€”';
  $('#wh_staff').innerHTML=(list||[]).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  renderWorkHoursEditor(list);
}
window.delStaff=async(id)=>{ try{await db.collection('staff').doc(id).delete(); toast('Usta silindi');}catch(e){toast('Hata: Usta silinemedi');} };
$('#addStaff').addEventListener('click', async ()=>{
  const name=$('#newStaffName').value.trim(); if(!name){toast('Usta adÄ± gerekli');return;}
  try{
    await db.collection('staff').add({name,days:[1,2,3,4,5,6],hours:{open:'09:00',close:'21:00',slot:15},hoursByDay:{},offDates:[]});
    $('#newStaffName').value=''; toast('Usta eklendi');
  }catch(e){ toast('Hata: Usta eklenemedi'); }
});

function renderServiceList(list){
  $('#svcList').innerHTML=(list||[]).sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr')).map(s=>`
    <li style="display:flex;align-items:center;gap:8px;margin:6px 0">
      <span style="flex:1">${s.name} â€” ${s.dur} dk / ${s.price||0} TL</span>
      <button class="btn" onclick="delSvc('${s.id}')">Sil</button>
    </li>`).join('') || 'â€”';
}
window.delSvc=async(id)=>{ try{await db.collection('services').doc(id).delete(); toast('Hizmet silindi');}catch(e){toast('Hata: Hizmet silinemedi');} };
$('#addSvc').addEventListener('click', async ()=>{
  const name=$('#newSvcName').value.trim(), dur=parseInt($('#newSvcDur').value||'30',10), price=parseInt($('#newSvcPrice').value||'0',10);
  if(!name){toast('Hizmet adÄ± gerekli');return;}
  try{
    await db.collection('services').add({name,dur,price});
    $('#newSvcName').value=''; $('#newSvcDur').value=''; $('#newSvcPrice').value='';
    toast('Hizmet eklendi');
  }catch(e){ toast('Hata: Hizmet eklenemedi'); }
});

/* Ã‡alÄ±ÅŸma saatleri */
const DAY_LABELS=['Paz','Pzt','Sal','Ã‡ar','Per','Cum','Cmt'];
function renderWorkHoursEditor(staffList){
  const wrap=$('#wh_days'); wrap.innerHTML='';
  const sid=$('#wh_staff').value || (staffList[0]?.id||''); $('#wh_staff').value=sid;
  const staff=staffList.find(s=>s.id===sid); if(!staff) return;
  const byDay=staff.hoursByDay||{}; const slot=staff.hours?.slot||15; $('#wh_slot').value=slot;
  DAY_LABELS.forEach((lab,i)=>{
    const d=byDay[i]||staff.hours||{open:'09:00',close:'21:00',slot:15};
    const chk=(staff.days||[1,2,3,4,5,6]).includes(i)?'checked':'';
    const item=document.createElement('div');
    item.style.cssText='display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:6px 8px;flex:0 0 auto';
    item.innerHTML=`
      <label class="badge" style="background:#f8fafc;border-color:#e5e7eb">${lab} <input type="checkbox" data-dow="${i}" ${chk} style="margin-left:6px;width:auto"></label>
      <input type="time" value="${d.open}" data-typ="open" data-dow="${i}" style="max-width:110px">
      <span>â€“</span>
      <input type="time" value="${d.close}" data-typ="close" data-dow="${i}" style="max-width:110px">`;
    wrap.appendChild(item);
  });
}
$('#wh_staff').addEventListener('change', async ()=>{
  try{ const list=(await db.collection('staff').get()).docs.map(d=>({id:d.id,...d.data()})); renderWorkHoursEditor(list); }
  catch(e){ console.error('wh_staff change',e); }
});
$('#saveWorkHours').addEventListener('click', async ()=>{
  const sid=$('#wh_staff').value; if(!sid){toast('Usta seÃ§iniz');return;}
  const days=[...document.querySelectorAll('#wh_days input[type="checkbox"]')].filter(x=>x.checked).map(x=>parseInt(x.dataset.dow,10));
  const hoursByDay={};
  [...document.querySelectorAll('#wh_days input[type="time"]')].forEach(inp=>{
    const i=parseInt(inp.dataset.dow,10); hoursByDay[i]=hoursByDay[i]||{open:'09:00',close:'21:00'};
    hoursByDay[i][inp.dataset.typ]=inp.value||'09:00';
  });
  try{
    await db.collection('staff').doc(sid).set({
      days,hoursByDay,
      hours:{open:hoursByDay[1]?.open||'09:00',close:hoursByDay[1]?.close||'21:00',slot:parseInt($('#wh_slot').value||'15',10)}
    },{merge:true});
    $('#wh_status').textContent='Kaydedildi.'; toast('Ã‡alÄ±ÅŸma saatleri kaydedildi');
  }catch(e){ toast('Hata: Ã‡alÄ±ÅŸma saatleri kaydedilemedi'); }
});

/* ===== MÃ¼ÅŸteriler ===== */
function renderCustomers(list){
  const term = ($('#custSearch')?.value||'').trim().toLowerCase();
  const tb=$('#custTbody'); if(!tb) return;
  const rows=(list||[])
    .filter(u=>{
      if(!term) return true;
      const name=(u.name||'').toLowerCase(), phone=(u.phone||'').toLowerCase();
      return name.includes(term) || phone.includes(term);
    })
    .sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr'));
  tb.innerHTML = rows.map(u=>`
    <tr>
      <td>${u.name||''}</td>
      <td>${u.phone||''}</td>
      <td>${u.createdAt?new Date(u.createdAt).toLocaleString():'-'}</td>
      <td>${u.lastLogin?new Date(u.lastLogin).toLocaleString():'-'}</td>
      <td><button class="btn" onclick="delUser('${u.id}')">Sil</button></td>
    </tr>`).join('') || `<tr><td colspan="5" class="small">MÃ¼ÅŸteri yok</td></tr>`;
}
window.delUser=async(id)=>{ if(!confirm('Bu mÃ¼ÅŸteriyi silmek istiyor musunuz?')) return;
  try{ await db.collection('users').doc(id).delete(); toast('MÃ¼ÅŸteri silindi'); }catch(e){ toast('Hata: MÃ¼ÅŸteri silinemedi'); }
};
$('#custSearch')?.addEventListener('input', ()=>renderCustomers(lastUserCache));
$('#custRefresh')?.addEventListener('click', ()=>renderCustomers(lastUserCache));

/* ===== PIN TALEPLERÄ° ===== */
function renderPinReqs(list){
  const tb=$('#pinTbody'); if(!tb) return;
  tb.innerHTML = (list||[]).map(r=>`
    <tr>
      <td>${r.phone}</td>
      <td>${r.newPin}</td>
      <td>${r.createdAt?new Date(r.createdAt).toLocaleString():'-'}</td>
      <td>
        <button class="btn" onclick="pinApprove('${r.id}','${r.phone}','${r.newPin}')">Onayla</button>
        <button class="btn" onclick="pinDelete('${r.id}')">Sil</button>
      </td>
    </tr>`).join('') || `<tr><td colspan="4" class="small">Talep yok</td></tr>`;
}
window.pinApprove=async(id,phone,newPin)=>{
  try{
    const q=await db.collection('users').where('phone','==',phone).limit(1).get();
    if(!q.empty){ await db.collection('users').doc(q.docs[0].id).set({pin:newPin},{merge:true}); }
    await db.collection('pin_reqs').doc(id).delete();
    toast('PIN gÃ¼ncellendi');
  }catch(e){ toast('Hata: PIN gÃ¼ncellenemedi'); }
};
window.pinDelete=async(id)=>{ try{await db.collection('pin_reqs').doc(id).delete(); toast('Talep silindi');}catch(e){toast('Hata: Talep silinemedi');} };

/* ===== Randevular (Admin) ===== */
function renderAdminAppts(list){
  const tb=$('#ap_tbody'); if(!tb) return;
  const fdate = $('#ap_fdate').value || '';
  const fstaff= $('#ap_fstaff').value || '';
  const fstat = $('#ap_fstatus').value || '';
  let rows = (list||[]);
  if(fdate) rows = rows.filter(a=>a.date===fdate);
  if(fstaff) rows = rows.filter(a=>a.staffId===fstaff);
  if(fstat) rows = rows.filter(a=>a.status===fstat);
  rows = rows.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  tb.innerHTML = rows.map(a=>{
    const actBtns = a.status==='pending'
      ? `<button class="btn" onclick="approve('${a.id}')">Onayla</button>
         <button class="btn" onclick="reject('${a.id}')">Reddet</button>`
      : a.status==='approved'
        ? `<button class="btn" onclick="cancelAppt('${a.id}')">Ä°ptal</button>`
        : '';
    return `<tr>
      <td>${a.date}</td><td>${a.time}</td>
      <td>${a.name} (${a.phone||''})</td>
      <td>${a.serviceName||''}</td>
      <td>${a.staffName||''}</td>
      <td>${a.status}</td>
      <td class="actions" style="gap:6px">${actBtns} <button class="btn" onclick="delAppt('${a.id}')">Sil</button></td>
    </tr>`;
  }).join('') || `<tr><td colspan="7" class="small">Randevu bulunamadÄ±</td></tr>`;
}
$('#ap_refresh')?.addEventListener('click', ()=>renderAdminAppts(lastApptCache));
$('#ap_fdate')  ?.addEventListener('change', ()=>renderAdminAppts(lastApptCache));
$('#ap_fstaff') ?.addEventListener('change', ()=>renderAdminAppts(lastApptCache));
$('#ap_fstatus')?.addEventListener('change', ()=>renderAdminAppts(lastApptCache));

/* ===== MÃ¼ÅŸteri â€¢ RandevularÄ±m ===== */
function renderMyAppts(list){
  const tb = $('#my_tbody'); if(!tb) return;
  if(!currentUser){ tb.innerHTML = `<tr><td colspan="6" class="small">LÃ¼tfen mÃ¼ÅŸteri giriÅŸi yapÄ±n.</td></tr>`; return; }
  const todayISO = new Date().toISOString().slice(0,10);
  const filt = ($('#my_filter')?.value || 'upcoming');
  let rows = (list||[]).filter(a => a.phone === currentUser.phone);
  if(filt === 'upcoming'){ rows = rows.filter(a => a.date >= todayISO); }
  else if(filt === 'past'){ rows = rows.filter(a => a.date < todayISO); }
  rows = rows.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  tb.innerHTML = rows.map(a=>{
    const canCancel = (a.status==='pending' || a.status==='approved');
    const btns =
      `<button class="btn" onclick="openResched('${a.id}')">DeÄŸiÅŸtir</button>`+
      (canCancel?` <button class="btn" onclick="myCancel('${a.id}')">Ä°ptal</button>`:'');
    return `<tr>
      <td>${a.date}</td><td>${a.time}</td>
      <td>${a.serviceName||''}</td><td>${a.staffName||''}</td>
      <td>${a.status}</td><td>${btns}</td>
    </tr>`;
  }).join('') || `<tr><td colspan="6" class="small">Randevu bulunamadÄ±</td></tr>`;
}
window.myCancel = async (id)=>{
  if(!currentUser) return;
  if(!confirm('Randevunuzu iptal etmek istiyor musunuz?')) return;
  try{ await db.collection('appts').doc(id).set({status:'cancelled'},{merge:true}); toast('Randevu iptal edildi'); }
  catch(e){ toast('Hata: Ä°ptal edilemedi'); }
};
$('#my_filter') ?.addEventListener('change', ()=>renderMyAppts(lastApptCache));
$('#my_refresh')?.addEventListener('click',  ()=>renderMyAppts(lastApptCache));

/* ===== MÃ¼ÅŸteri â€¢ Randevu DeÄŸiÅŸtir (sheet) ===== */
async function openResched(id){
  if(!currentUser) return;
  const doc=await db.collection('appts').doc(id).get();
  if(!doc.exists){ toast('Randevu bulunamadÄ±'); return; }
  const a=doc.data();
  if(a.phone!==currentUser.phone){ toast('Bu iÅŸlem size ait deÄŸil'); return; }
  _rs_ctx={id, staffId:a.staffId, duration:a.duration, date:a.date}; // hizmet/usta sabit
  $('#rs_date').value=a.date;
  $('#rs_status').textContent='';
  computeReschedSlots(lastApptCache);
  sheet.show('#sheetResched');
}
function computeReschedSlots(appts){
  const box=$('#rs_slots'); if(!box||!_rs_ctx) return;
  const date=$('#rs_date').value; if(!date){ box.innerHTML=''; return; }
  _rs_ctx.date=date;
  const staff=(lastStaffCache||[]).find(s=>s.id===_rs_ctx.staffId)||{};
  const {open,close,slot}=getHoursFor(staff,date);
  const openM=toMin(open), closeM=toMin(close), step=slot||15;
  const taken=conflicts(appts||[],date,_rs_ctx.staffId);
  box.innerHTML='';
  const works = !((staff.offDates||[]).includes(date)) && (!staff.days || staff.days.includes(new Date(date+'T00:00:00').getDay()));
  for(let t=openM; t+_rs_ctx.duration<=closeM; t+=step){
    const conflict=taken.some(x=>overlaps(t,t+_rs_ctx.duration,x.start,x.end));
    const dis = !works || conflict;
    const b=document.createElement('button');
    b.type='button'; b.className='slot'+(dis?' dis':''); b.textContent=toHHMM(t); b.dataset.time=toHHMM(t);
    b.onclick=()=>{ if(dis) return; $$('#rs_slots .slot').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); centerSelected(box); };
    box.appendChild(b);
  }
  wireArrows($('#rs_prev'),box,$('#rs_next'));
  autoPickFirst(box);
}
$('#rs_date').addEventListener('change', ()=>computeReschedSlots(lastApptCache));
$('#rs_cancel').addEventListener('click', ()=>{ _rs_ctx=null; sheet.hide('#sheetResched'); });
$('#rs_save').addEventListener('click', async ()=>{
  if(!_rs_ctx){ sheet.hide('#sheetResched'); return; }
  const btn=$('#rs_slots .slot.sel'); const time=btn?.dataset.time;
  if(!time){ $('#rs_status').textContent='LÃ¼tfen bir saat seÃ§in.'; return; }
  try{
    await db.collection('appts').doc(_rs_ctx.id).set({date:_rs_ctx.date,time, status:'pending'},{merge:true});
    toast('Randevu gÃ¼ncellendi (onay bekliyor)');
    _rs_ctx=null; sheet.hide('#sheetResched');
  }catch(e){ console.error(e); $('#rs_status').textContent='Hata: Kaydedilemedi'; }
});

/* ===== Admin & Customer giriÅŸ ===== */
$('#adminLoginBtn').addEventListener('click', ()=>{
  const p=$('#adminPhone').value.trim(), s=$('#adminPass').value.trim();
  if(p===ADMIN_PHONE_E164 && s===ADMIN_PASSWORD){
    setAdmin(true); store.set('adminSession','on'); store.set('adminPhone',p);
    $('#adminStatus').textContent='GiriÅŸ baÅŸarÄ±lÄ±'; sheet.hide('#sheetAdmin'); toast('Admin olarak giriÅŸ yapÄ±ldÄ±');
  }else{ $('#adminStatus').textContent='Bilgiler hatalÄ±'; }
});
$('#adminLogoutBtn').addEventListener('click', ()=>{
  setAdmin(false); store.del('adminSession'); store.del('adminPhone');
  $('#adminStatus').textContent='Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±'; toast('Admin oturumu kapatÄ±ldÄ±');
});
$('#c_login').addEventListener('click', async ()=>{
  const name=$('#c_name').value.trim(), phoneRaw=$('#c_phone').value.trim(), pin=$('#c_pin').value.trim();
  if(!name||!phoneRaw||pin.length!==4){ $('#c_status').textContent='Ad/Telefon ve 4 haneli PIN gerekli.'; return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);
  try{
    let uid=null, udata=null;
    const q=await db.collection('users').where('phone','==',phone).limit(1).get();
    if(q.empty){ const uref=await db.collection('users').add({name,phone,verified:true,pin,createdAt:Date.now(),lastLogin:Date.now()}); uid=uref.id; udata={name,phone}; }
    else{ const u=q.docs[0].data(); uid=q.docs[0].id; if((u.pin||'')!==pin){ $('#c_status').textContent='PIN hatalÄ±.'; return; } await db.collection('users').doc(uid).set({lastLogin:Date.now()},{merge:true}); udata=u; }
    currentUser={id:uid,name:udata.name,phone:udata.phone}; saveCustomerSession(currentUser); setCustomerLogged(true);
    myPrevStatusById={}; const mine=(lastApptCache||[]).filter(a=>a.phone===currentUser.phone); mine.forEach(a=>{ myPrevStatusById[a.id]=a.status; });
    $('#c_status').textContent='GiriÅŸ baÅŸarÄ±lÄ±.'; toast('MÃ¼ÅŸteri giriÅŸi yapÄ±ldÄ±'); setTimeout(()=>sheet.hide('#sheetCust'),350);
  }catch(err){ console.error('MÃ¼ÅŸteri login hata',err); $('#c_status').textContent='Sunucu hatasÄ±: Firestore izinlerini kontrol edin.'; toast('Hata: Firestore Rules?'); }
});

/* MÃ¼ÅŸteri: Åifremi Unuttum -> pin_reqs'e talep */
$('#c_forgot').addEventListener('click', async ()=>{
  const phoneRaw=prompt('Telefon numaranÄ±zÄ± yazÄ±n (05xxxxxxxxx):'); if(!phoneRaw) return;
  const newPin=prompt('Yeni PIN (4 hane):'); if(!/^\d{4}$/.test(newPin||'')){ alert('4 hane olmalÄ±'); return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);
  try{ await db.collection('pin_reqs').add({phone,newPin,createdAt:Date.now()}); toast('PIN talebiniz alÄ±ndÄ± (admin onayÄ± gerekir)'); }
  catch(e){ toast('Hata: Talep kaydedilemedi'); }
});

/* ===== BaÅŸlat ===== */
startRealtime();
</script>
</body>
</html>
