<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ahmet Tekeli • Randevu Sistemi (Güncel+PIN+Modal+Takvim)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#eef0f3;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--card:#fff;--gold:#d4af37;--dark:#0b1324;--dark2:#121a2e;--ok:#16a34a;--bad:#ef4444}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
a{color:inherit}
.wrap{max-width:min(1100px,100%);margin:0 auto;padding:0 14px}
.bg{position:fixed;inset:0;z-index:-1;background:
  radial-gradient(900px 400px at 15% -10%,rgba(212,175,55,.08),transparent 55%),
  radial-gradient(700px 360px at 85% 0,rgba(0,0,0,.05),transparent 60%),
  linear-gradient(180deg,#f3f5f8 0,var(--bg) 45%,#e7ebf1 100%)}
header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:20}
.hero{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 0}
.brand{font-weight:800;letter-spacing:.5px;cursor:pointer}
.brand b{font-size:20px;display:block}
.brand small{color:var(--muted)}
.actions{display:flex;gap:8px;align-items:center}
.btn{padding:9px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
.btn-primary{background:var(--gold);border-color:var(--gold);color:#111;font-weight:700}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}
#bellBtn{position:relative;display:none}
#bellBtn .dot{position:absolute;right:-4px;top:-4px;min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:#ef4444;color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800}
#bellBtn.flash{animation:bl 1s infinite}
@keyframes bl{0%{transform:translateY(0)}50%{transform:translateY(-1px)}100%{transform:translateY(0)}}

.layout{display:grid;grid-template-columns:260px 1fr;gap:14px;margin:16px 0}
#sidebar{background:linear-gradient(180deg,var(--dark),var(--dark2));color:#dbe1f1;border-radius:16px;padding:10px;display:none}
#sidebar .menu{display:flex;flex-direction:column;gap:6px}
#sidebar .menu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;text-decoration:none;color:#e5e7eb}
#sidebar .menu a:hover,#sidebar .menu a.active{background:rgba(255,255,255,.08)}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
h2{margin:8px 0 12px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
label{display:block;font-weight:700;margin:.5rem 0 .25rem}
input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
.slots-wrap{display:flex;align-items:center;gap:8px}
.slots{display:flex;gap:10px;overflow-x:auto;padding:6px 2px}
.slots::-webkit-scrollbar{height:6px}.slots::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
.slot{padding:10px 16px;border:1px solid var(--line);border-radius:999px;background:#fff;flex:0 0 auto}
.slot.dis{opacity:.45;pointer-events:none;text-decoration:line-through}
.slot.sel{background:#111827;color:#fff;border-color:#111827;box-shadow:0 4px 14px rgba(0,0,0,.18)}
.small{font-size:12px;color:var(--muted)}
.table-scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}
thead th{background:#f3f4f6;font-weight:700}
.kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
.kpi .box{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
footer{padding:28px 0;color:var(--muted);text-align:center}

/* Modal (giriş & bildirim & edit) */
.sheet-mask{position:fixed;inset:0;background:rgba(0,0,0,.25);backdrop-filter:blur(2px);display:none;z-index:100}
.sheet{position:fixed;left:50%;top:-40%;transform:translate(-50%,-50%);width:min(560px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.2);opacity:0;transition:all .35s;z-index:101}
.sheet.show{top:50%;opacity:1}
.sheet h3{margin:.25rem 0 8px}
.sheet .row{display:flex;gap:8px;flex-wrap:wrap}
.sheet input,.sheet select{flex:1 1 220px}
.sheet .list{max-height:55vh;overflow:auto;border:1px solid var(--line);border-radius:12px}
.appt-card{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px;border-bottom:1px dashed #edf1f7}
.appt-card .act{display:flex;gap:6px}
.ok{background:var(--ok);border-color:var(--ok);color:#fff}
.no{background:var(--bad);border-color:var(--bad);color:#fff}
.admin-pane{display:none}
.day-row{display:flex;gap:8px;overflow-x:auto;padding:6px;border:1px solid var(--line);border-radius:10px}
.day-chip{display:flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;white-space:nowrap}

/* Mobile */
@media (max-width:900px){.layout{grid-template-columns:1fr}#sidebar{display:none}}
</style>
</head>
<body>
<div class="bg"></div>

<header>
  <div class="wrap hero">
    <div class="brand" id="brandClickable"><b>AHMET TEKELİ</b><small>Erkek Kuaförü</small></div>
    <div class="actions">
      <button id="menuToggle" class="btn" title="Menüyü Aç/Kapat">☰</button>
      <button id="bellBtn" class="badge" title="Bildirimler (Admin)"><span>🔔</span><span id="bellCount" class="dot">0</span></button>
      <button class="badge" id="adminOpen">👨🏻‍💼 Admin Girişi</button>
      <button class="badge" id="custOpen">👤 Müşteri Girişi</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="layout">
    <!-- Admin Sidebar -->
    <aside id="sidebar">
      <div class="menu">
        <a href="#" data-pane="#home" id="menuHome">⬅️ Ana Ekran</a>
        <a href="#" data-pane="#pane_queue">🏠 Onay Kuyruğu</a>
        <a href="#" data-pane="#pane_calendar">🗓️ Günlük Takvim</a>
        <a href="#" data-pane="#pane_staff">💈 Ustalar</a>
        <a href="#" data-pane="#pane_services">🧰 Hizmetler</a>
        <a href="#" data-pane="#pane_customers">👥 Müşteriler</a>
        <a href="#" data-pane="#pane_pin">🔑 PIN Talepleri</a>
        <a href="#" data-pane="#pane_reports">📊 Raporlar</a>
      </div>
    </aside>

    <!-- Ana form (herkese açık) -->
    <section class="card" id="randevu">
      <h2 style="display:flex;align-items:center;gap:8px">RANDEVU OLUŞTUR</h2>
      <div class="grid">
        <div>
          <label>Ad Soyad</label><input id="f_name" placeholder="Adınız ve Soyadınız">
          <label>Telefon</label><input id="f_phone" placeholder="05xxxxxxxxx" inputmode="tel">
          <label>Berber Seçimi</label><select id="f_staff"></select>
        </div>
        <div>
          <label>İşlem Seçimi</label><select id="f_service"></select>
          <label>Tarih</label><input id="f_date" type="date">
          <label>Uygun Saatler</label>
          <div class="slots-wrap">
            <button class="btn" type="button" id="slotPrev">‹</button>
            <div id="slots" class="slots" aria-label="Uygun saatler"></div>
            <button class="btn" type="button" id="slotNext">›</button>
          </div>
          <p class="small">Genel saatler: <span id="hoursLabel"></span> • Slot: <span id="slotSizeLabel"></span> dk</p>
        </div>
      </div>
      <div class="actions" style="margin-top:12px">
        <button class="btn btn-primary" id="createAppt">RANDEVU AL</button>
        <span id="formStatus" class="small"></span>
      </div>
    </section>

    <!-- Müşteri randevularım -->
    <section id="myAppts" class="card" style="display:none">
      <h3>Randevularım</h3>
      <div class="table-scroll">
        <table>
          <thead><tr><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>İşlem</th></tr></thead>
          <tbody id="myApptTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Admin Panelleri -->
    <section id="pane_queue" class="card admin-pane">
      <h3>Onay Kuyruğu</h3>
      <div class="table-scroll"><table>
        <thead><tr><th>Ad</th><th>Tel</th><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Süre</th><th>İşlem</th></tr></thead>
        <tbody id="queueTbody"></tbody>
      </table></div>
    </section>

    <section id="pane_calendar" class="card admin-pane">
      <h3>Günlük Takvim</h3>
      <div class="actions">
        <input type="date" id="calDate">
        <select id="calStaff"></select>
        <button class="btn" id="viewCal" type="button">Görüntüle</button>
      </div>
      <div class="table-scroll"><table>
        <thead><tr><th>Saat</th><th>Müşteri</th><th>Hizmet</th><th>Durum</th><th>İşlem</th></tr></thead>
        <tbody id="calTbody"></tbody>
      </table></div>
    </section>

    <section id="pane_staff" class="card admin-pane">
      <h3>Ustalar</h3>
      <div class="actions" style="margin:8px 0">
        <input id="newStaffName" placeholder="Usta adı" style="max-width:220px">
        <input id="newStaffOpen" type="time" value="09:00" style="max-width:120px">
        <span>–</span>
        <input id="newStaffClose" type="time" value="21:00" style="max-width:120px">
        <button class="btn" id="addStaff">Ekle</button>
      </div>
      <div id="staffList" class="table-scroll"><table>
        <thead><tr><th>Ad</th><th>Günler</th><th>Saat</th><th>Kapalı Günler</th><th>İşlem</th></tr></thead>
        <tbody id="staffTbody"></tbody>
      </table></div>
    </section>

    <section id="pane_services" class="card admin-pane">
      <h3>Hizmetler</h3>
      <div class="actions" style="margin:8px 0">
        <button class="btn btn-primary" id="openSvcNew">Yeni Hizmet</button>
      </div>
      <div id="svcList"></div>
    </section>

    <section id="pane_customers" class="card admin-pane">
      <h3>Müşteriler</h3>
      <div class="table-scroll"><table>
        <thead><tr><th>Ad</th><th>Telefon</th><th>Kayıt</th><th>Son Giriş</th><th>Doğrulandı</th><th>İşlem</th></tr></thead>
        <tbody id="usersTbody"></tbody>
      </table></div>
    </section>

    <section id="pane_pin" class="card admin-pane">
      <h3>PIN Talepleri</h3>
      <div class="table-scroll"><table>
        <thead><tr><th>Telefon</th><th>İstenen Yeni PIN</th><th>Tarih</th><th>İşlem</th></tr></thead>
        <tbody id="pinTbody"></tbody>
      </table></div>
    </section>

    <section id="pane_reports" class="card admin-pane">
      <h3>Raporlar</h3>
      <div class="kpi">
        <div class="box"><div class="small">Bugünkü Randevu</div><div id="kpiToday" style="font-size:22px;font-weight:800">0</div></div>
        <div class="box"><div class="small">Haftalık Toplam</div><div id="kpiWeek" style="font-size:22px;font-weight:800">0</div></div>
        <div class="box"><div class="small">Onaylı / Bekleyen / İptal</div><div id="kpiStatus" style="font-size:22px;font-weight:800">0/0/0</div></div>
        <div class="box"><div class="small">Toplam Tutar</div><div id="kpiAmount" style="font-size:22px;font-weight:800">0 ₺</div></div>
      </div>
    </section>

  </div>
</main>

<footer><div class="wrap">© Ahmet Tekeli Erkek Kuaförü • Randevu Sistemi</div></footer>

<!-- SHEETLER -->
<div id="mask" class="sheet-mask"></div>

<!-- Admin Giriş -->
<div id="adminSheet" class="sheet">
  <h3>Yönetici Girişi</h3>
  <div class="row">
    <input id="adminPhone" value="+905356749243" placeholder="+90…">
    <input id="adminPass" type="password" placeholder="Admin şifre">
    <label class="badge"><input type="checkbox" id="autoApprove" style="width:auto"> Admin eklerse otomatik onay</label>
  </div>
  <div class="actions" style="margin-top:10px">
    <button class="btn btn-primary" id="adminLogin">Giriş Yap</button>
    <button class="btn" id="adminLogout">Çıkış</button>
    <button class="btn" id="adminClose">Kapat</button>
    <span id="adminStatus" class="small"></span>
  </div>
</div>

<!-- Müşteri Giriş/Kayıt -->
<div id="custSheet" class="sheet">
  <h3>Müşteri Girişi / Kayıt</h3>
  <div class="row">
    <input id="c_name" placeholder="Ad Soyad">
    <input id="c_phone" placeholder="05xxxxxxxxx" inputmode="tel">
    <input id="c_pin" placeholder="PIN (4 hane)" inputmode="numeric" maxlength="4">
  </div>
  <div class="actions" style="margin-top:10px">
    <button class="btn btn-primary" id="custLogin">Giriş</button>
    <button class="btn" id="custRegister">Kayıt Ol</button>
    <button class="btn" id="custClose">Kapat</button>
    <span id="custStatus" class="small"></span>
  </div>
</div>

<!-- Bildirim Sheet -->
<div id="notifSheet" class="sheet">
  <h3>Yeni Randevu Talepleri</h3>
  <div class="actions" style="margin:6px 0 10px">
    <button class="btn ok"  id="btnApproveAll">Tümünü Onayla</button>
    <button class="btn no"  id="btnRejectAll">Bekleyenleri Reddet</button>
  </div>
  <div id="notifList" class="list"></div>
  <div class="actions" style="margin-top:8px"><button class="btn" id="notifClose">Kapat</button></div>
</div>

<!-- Hizmet Modal (Yeni/Düzenle) -->
<div id="svcSheet" class="sheet">
  <h3 id="svcTitle">Hizmet</h3>
  <div class="row">
    <input id="svcName" placeholder="Hizmet adı">
    <input id="svcDur" type="number" placeholder="Süre (dk)">
    <input id="svcPrice" type="number" placeholder="Fiyat (TL)">
  </div>
  <div class="actions" style="margin-top:10px">
    <button class="btn btn-primary" id="svcSave">Kaydet</button>
    <button class="btn" id="svcCancel">Kapat</button>
    <span id="svcStatus" class="small"></span>
  </div>
</div>

<!-- Usta Modal (Yeni/Düzenle) -->
<div id="staffSheet" class="sheet">
  <h3 id="staffTitle">Usta</h3>
  <div class="row">
    <input id="stName" placeholder="Usta adı">
    <input id="stOpen" type="time" value="09:00">
    <input id="stClose" type="time" value="21:00">
  </div>
  <div class="day-row" id="stDays"></div>
  <div class="actions" style="margin-top:10px">
    <button class="btn btn-primary" id="stSave">Kaydet</button>
    <button class="btn" id="stCancel">Kapat</button>
    <span id="stStatus" class="small"></span>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* ====== Firebase ====== */
const firebaseConfig={apiKey:"AIzaSyBtSQ9_5R42BU5ga0cOt1QETkC5nOf2tW4",authDomain:"randevu-81305.firebaseapp.com",projectId:"randevu-81305",storageBucket:"randevu-81305.firebasestorage.app",messagingSenderId:"686048709577",appId:"1:686048709577:web:b2db4eeae83203ca2e3618",measurementId:"G-3ZX91ND545"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

/* ====== Yardımcılar ====== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const store={get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch(_){return d}},set(k,v){localStorage.setItem(k,JSON.stringify(v))},del(k){localStorage.removeItem(k)}};
const toMin=t=>{const[h,m]=t.split(':').map(Number);return h*60+m},toHHMM=m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
const todayISO=()=>new Date().toISOString().slice(0,10);
const uuid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const maskPhone=p=>p?`0${p.slice(3,6)} ${p.slice(6,9)} ${p.slice(9,11)} ${p.slice(11,13)}`:'';
const trSort=(a,b,k)=>String(a[k]||'').localeCompare(String(b[k]||''),'tr');

/* ====== Global ====== */
let currentUser=null, adminAuthed=false;
let unsubUsers=null, unsubAppts=null, unsubStaff=null, unsubServices=null, unsubPins=null;
let services=[], staff=[], settings={open:"09:00",close:"21:00",slot:30};
let _prevApptStatusById={};
const ADMIN_PHONE_E164='+905356749243';

/* ====== Başlat ====== */
document.addEventListener('DOMContentLoaded',()=>{
  $('#f_date').value=todayISO(); $('#calDate').value=todayISO();
  $('#hoursLabel').textContent=`${settings.open} - ${settings.close}`; $('#slotSizeLabel').textContent=settings.slot;

  // Kalıcı oturumlar
  const uid=store.get('currentUserId',null);
  if(uid) fetchUser(uid).then(u=>{ if(u){ currentUser=u; fillFormFromUser(); renderMyAppts(); }});
  if(store.get('adminSession')==='on'){ setAdminUI(true); } else { setAdminUI(false); }
  goHome(); // sayfa yenilenince ana ekranda kal

  startRealtime();

  // UI events
  $('#adminOpen').onclick=openAdminSheet; $('#adminClose').onclick=closeSheets;
  $('#adminLogout').onclick=()=>{ setAdminState(false); }; $('#adminLogin').onclick=adminLogin;
  $('#custOpen').onclick=openCustSheet; $('#custClose').onclick=closeSheets;
  $('#custRegister').onclick=customerRegister; $('#custLogin').onclick=customerLogin;

  $('#createAppt').onclick=createAppointment;
  $('#slotPrev').onclick=()=>$('#slots').scrollBy({left:-220,behavior:'smooth'});
  $('#slotNext').onclick=()=>$('#slots').scrollBy({left:220,behavior:'smooth'});
  $('#viewCal').onclick=renderCal; $('#notifClose').onclick=closeSheets; $('#bellBtn').onclick=openNotifSheet;

  $$('#sidebar .menu a').forEach(a=>{ a.onclick=(e)=>{e.preventDefault(); openAdminPane(a.dataset.pane);} });

  $('#menuToggle').onclick=()=>{ const side=$('#sidebar'); side.style.display=(side.style.display==='none'||!side.style.display)?'block':'none'; };
  $('#brandClickable').onclick=(e)=>{e.preventDefault(); goHome();};

  // Hizmet modal tetikleri
  $('#openSvcNew').onclick=()=>openSvcModal(); $('#svcCancel').onclick=closeSheets; $('#svcSave').onclick=saveSvcModal;

  // Usta modal tetikleri
  $('#stCancel').onclick=closeSheets; $('#stSave').onclick=saveStaffModal;
});

/* ====== Sheets ====== */
function openAdminSheet(){ $('#mask').style.display='block'; $('#adminSheet').classList.add('show'); }
function openCustSheet(){ $('#mask').style.display='block'; $('#custSheet').classList.add('show'); }
function openNotifSheet(){ if(!adminAuthed) return; $('#mask').style.display='block'; $('#notifSheet').classList.add('show'); }
function openSvcModal(svc=null){
  $('#mask').style.display='block'; $('#svcSheet').classList.add('show');
  $('#svcTitle').textContent=svc?'Hizmeti Düzenle':'Yeni Hizmet';
  $('#svcName').value=svc?.name||''; $('#svcDur').value=svc?.dur||30; $('#svcPrice').value=svc?.price||0;
  $('#svcSheet').dataset.editId = svc?.id||'';
}
function openStaffModal(st=null){
  $('#mask').style.display='block'; $('#staffSheet').classList.add('show');
  $('#staffTitle').textContent=st?'Ustayı Düzenle':'Yeni Usta';
  $('#stName').value=st?.name||''; $('#stOpen').value=st?.hours?.open||'09:00'; $('#stClose').value=st?.hours?.close||'21:00';
  const daysLbl=['Paz','Pzt','Sal','Çar','Per','Cum','Cmt']; const cur=new Set(st?.days?.length?st.days:[1,2,3,4,5,6]);
  $('#stDays').innerHTML = daysLbl.map((lab,i)=>`<label class="day-chip"><input type="checkbox" data-dow="${i}" ${cur.has(i)?'checked':''} style="width:auto">${lab}</label>`).join('');
  $('#staffSheet').dataset.editId = st?.id||'';
}
function closeSheets(){ $('#mask').style.display='none'; $$('.sheet').forEach(x=>x.classList.remove('show')); }

/* ====== Admin Oturum ====== */
async function adminLogin(){
  const p=($('#adminPhone').value||'').trim(), pass=($('#adminPass').value||'').trim();
  if(p===ADMIN_PHONE_E164 && pass){ setAdminState(true); $('#adminStatus').textContent='Giriş başarılı.'; closeSheets(); }
  else $('#adminStatus').textContent='Bilgiler hatalı.';
}
function setAdminState(on){ setAdminUI(on); if(on){store.set('adminSession','on')} else {store.del('adminSession')} goHome(); }
function setAdminUI(on){
  adminAuthed=!!on;
  if(on){ $('#sidebar').style.display='block'; $('.admin-pane')?.style.setProperty('display','none'); $('#bellBtn').style.display='inline-flex';}
  else { $('#sidebar').style.display='none'; $$('.admin-pane').forEach(s=>s.style.display='none'); $('#bellBtn').style.display='none'; }
}
function goHome(){ $$('.admin-pane').forEach(s=>s.style.display='none'); $$('#sidebar .menu a').forEach(x=>x.classList.remove('active')); if(window.innerWidth<900){ $('#sidebar').style.display='none'; } document.querySelector('#randevu')?.scrollIntoView({behavior:'smooth'}); }
function openAdminPane(sel){ if(sel==='#home'){ goHome(); return; } $$('#sidebar .menu a').forEach(x=>x.classList.remove('active')); $$('#sidebar .menu a').find(x=>x.dataset.pane===sel)?.classList.add('active'); $$('.admin-pane').forEach(s=>s.style.display='none'); $(sel).style.display='block'; }

/* ====== Müşteri Oturum ====== */
async function fetchUser(id){ const d=await db.collection('users').doc(id).get(); return d.exists?d.data():null; }
function toE164(raw){ if(!raw) return null; let s=String(raw).trim().replace(/[()\-\s]/g,''); if(s.startsWith('+')) return s.replace(/\D/g,'').length>=10?('+'+s.replace(/\D/g,'')):null; const only=s.replace(/\D/g,''); if(only.length===11&&only.startsWith('05')) return '+90'+only.slice(1); if(only.length===10&&only.startsWith('5')) return '+90'+only; return null; }
function fillFormFromUser(){ if(!currentUser) return; $('#f_name').value=currentUser.name||''; $('#f_phone').value=currentUser.phone?('0'+currentUser.phone.slice(3)):''; }
async function customerRegister(){
  const name=$('#c_name').value.trim(), phone=toE164($('#c_phone').value), pin=$('#c_pin').value.trim();
  if(!name||!phone||!/^\d{4}$/.test(pin)) return $('#custStatus').textContent='Ad/telefon/PIN gerekli';
  const ss=await db.collection('users').where('phone','==',phone).get(); if(!ss.empty){ $('#custStatus').textContent='Bu telefon kayıtlı, giriş yapın.'; return; }
  const u={id:uuid(),name,phone,verified:true,pin,createdAt:Date.now()}; await db.collection('users').doc(u.id).set(u);
  currentUser=u; store.set('currentUserId',u.id); fillFormFromUser(); renderMyAppts(); $('#custStatus').textContent='Kayıt tamamlandı.'; closeSheets();
}
async function customerLogin(){
  const phone=toE164($('#c_phone').value), pin=$('#c_pin').value.trim();
  const ss=await db.collection('users').where('phone','==',phone).get();
  if(ss.empty){ $('#custStatus').textContent='Kayıt yok. Önce kayıt olun.'; return; }
  const u=ss.docs[0].data();
  if(String(u.pin)===pin){ currentUser=u; store.set('currentUserId',u.id); fillFormFromUser(); renderMyAppts(); $('#custStatus').textContent='Giriş başarılı.'; closeSheets(); }
  else $('#custStatus').textContent='PIN hatalı.';
}

/* ====== Realtime ====== */
function startRealtime(){
  unsubStaff && unsubStaff(); unsubStaff=db.collection('staff').onSnapshot(ss=>{ staff=ss.docs.map(d=>d.data()); renderStaffUI(); renderSelects(); renderSlots(); renderCal(); });
  unsubServices && unsubServices(); unsubServices=db.collection('services').onSnapshot(ss=>{ services=ss.docs.map(d=>d.data()); renderSvcUI(); renderSelects(); });
  unsubUsers && unsubUsers(); unsubUsers=db.collection('users').onSnapshot(_=>{ renderUsers(); });
  unsubAppts && unsubAppts(); unsubAppts=db.collection('appts').onSnapshot(ss=>{
    const all=ss.docs.map(d=>d.data());
    if(adminAuthed){ const pend=all.filter(a=>a.status==='pending'); const prev=Object.values(_prevApptStatusById).filter(x=>x==='pending').length; if(pend.length>prev){ showToast('🔔 Yeni randevu talebi'); } }
    _prevApptStatusById={}; all.forEach(a=>_prevApptStatusById[a.id]=a.status);
    renderQueue(all); renderCal(all); renderSlots(all); renderReports(all); updateBell(all); fillNotifList(all); renderMyAppts();
  });
  unsubPins && unsubPins(); unsubPins=db.collection('resetReqs').onSnapshot(ss=>{ renderPinReqs(ss.docs.map(d=>d.data())); updateBell(); });
}

/* ====== Seçimler/Slotlar ====== */
function renderSelects(){
  $('#f_staff').innerHTML = staff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#calStaff').innerHTML = `<option value="">Tümü</option>`+staff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#f_service').innerHTML = services.length? services.map(s=>`<option value="${s.id}">${s.name} — ${s.dur} dk / ${s.price||0} ₺</option>`).join('') : `<option disabled>— Önce hizmet ekleyin (Admin) —</option>`;
  $('#f_staff').options.length && ($('#f_staff').selectedIndex=0); $('#f_service').options.length && ($('#f_service').selectedIndex=0);
  renderSlots();
}
function staffById(id){ return staff.find(x=>x.id===id)||{} }
function staffWorksThatDay(staffObj,dateISO){ const dow=new Date(dateISO+'T00:00:00').getDay(); const days=Array.isArray(staffObj?.days)&&staffObj.days.length?staffObj.days:[1,2,3,4,5,6]; return days.includes(dow); }
function isOffDate(staffObj,dateISO){ return (staffObj.offDates||[]).includes(dateISO) }
function getHoursFor(staffObj,dateISO){ const dow=new Date(dateISO+'T00:00:00').getDay(); const byDay=staffObj.hoursByDay; if(byDay&&byDay[dow]) return {open:byDay[dow].open,close:byDay[dow].close}; if(staffObj.hours) return staffObj.hours; return settings; }
function conflicts(date,staffId,appts){ return (appts||[]).filter(a=>a.date===date&&a.staffId===staffId&&a.status!=='cancelled'&&a.status!=='rejected').map(a=>({start:toMin(a.time),end:toMin(a.time)+(a.duration||30)})); }
function overlaps(aS,aE,bS,bE){ return aS<bE && aE>bS }
function renderSlots(appts=[]){
  $('#hoursLabel').textContent=`${settings.open} - ${settings.close}`; $('#slotSizeLabel').textContent=settings.slot;
  const svc=services.find(x=>x.id===$('#f_service').value), st=staffById($('#f_staff').value), date=$('#f_date').value; const box=$('#slots'); box.innerHTML='';
  if(!svc||!st.id||!date) return;
  const {open,close}=getHoursFor(st,date); const openM=toMin(open), closeM=toMin(close), step=settings.slot, dur=svc.dur;
  const works=staffWorksThatDay(st,date), closed=isOffDate(st,date);
  if(!works){ box.innerHTML='<div class="small">Bu usta seçilen günde çalışmıyor.</div>'; return; }
  if(closed){ box.innerHTML='<div class="small">Seçilen gün bu usta için kapalı.</div>'; return; }
  for(let t=openM;t+dur<=closeM;t+=step){
    const dis=conflicts(date,st.id,appts).some(x=>overlaps(t,t+dur,x.start,x.end));
    const b=document.createElement('button'); b.type='button'; b.className='slot'+(dis?' dis':''); b.textContent=toHHMM(t); b.dataset.time=toHHMM(t);
    b.onclick=()=>{ if(dis) return; $$('.slot').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); b.scrollIntoView({inline:'center',behavior:'smooth'}); };
    box.appendChild(b);
  }
  box.querySelector('.slot:not(.dis)')?.classList.add('sel');
}

/* ====== Randevu Oluştur + Google Takvim ====== */
function gcalUrl(appt){
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Istanbul';
  const startLocal = new Date(appt.date+'T'+appt.time+':00');
  const endLocal   = new Date(startLocal.getTime()+ (appt.duration||30)*60000);
  const pad=n=>String(n).padStart(2,'0');
  const fmt=d=>`${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;
  const gStart=fmt(startLocal), gEnd=fmt(endLocal);
  const title = `${appt.serviceName} - ${appt.staffName||'Berber'}`;
  const desc  = `Müşteri: ${appt.name} (${maskPhone(appt.phone)})\nTarih: ${appt.date} ${appt.time}\nSüre: ${appt.duration} dk`;
  const loc   = 'Ahmet Tekeli Erkek Kuaförü';
  return 'https://calendar.google.com/calendar/render?action=TEMPLATE'
    + '&text=' + encodeURIComponent(title)
    + '&dates=' + encodeURIComponent(`${gStart}/${gEnd}`)
    + '&details=' + encodeURIComponent(desc)
    + '&location=' + encodeURIComponent(loc)
    + '&ctz=' + encodeURIComponent(tz);
}
async function createAppointment(){
  const name=$('#f_name').value.trim(), phone=toE164($('#f_phone').value), svc=services.find(x=>x.id===$('#f_service').value);
  const st=staffById($('#f_staff').value); const date=$('#f_date').value; const tBtn=document.querySelector('.slot.sel'); const time=tBtn?.dataset.time;
  if(!name||!phone||!svc||!st.id||!date||!time){ $('#formStatus').textContent='Eksik bilgi'; return; }
  const isAdmin=adminAuthed && $('#autoApprove').checked;
  if(!isAdmin){
    const same=await db.collection('appts').where('phone','==',phone).where('date','==',date).get();
    const active=same.docs.map(d=>d.data()).filter(a=>a.status==='pending'||a.status==='approved').length;
    if(active>=2){ $('#formStatus').textContent='Aynı gün en fazla 2 aktif randevu alabilirsiniz.'; return; }
  }
  const us=await db.collection('users').where('phone','==',phone).get();
  let u=us.empty?{id:uuid(),name,phone,verified:true,pin:'0000',createdAt:Date.now()}:us.docs[0].data();
  if(us.empty) await db.collection('users').doc(u.id).set(u);
  const appt={id:uuid(),userId:u.id,name,phone,serviceId:svc.id,serviceName:svc.name,staffId:st.id,staffName:st.name,date,time,duration:svc.dur,status:isAdmin?'approved':'pending',createdAt:Date.now()};
  await db.collection('appts').doc(appt.id).set(appt);
  const link=gcalUrl(appt);
  $('#formStatus').innerHTML=(isAdmin?'Onaylandı ve eklendi. ':'Randevu oluşturuldu (Onay Bekliyor). ') + `<a href="${link}" target="_blank" rel="noopener">Google Takvim’e ekle</a>`;
}

/* ====== Müşteri Randevularım ====== */
async function renderMyAppts(){
  const box=$('#myAppts'); if(!currentUser){ box.style.display='none'; return; }
  const tb=$('#myApptTbody'); box.style.display='block'; tb.innerHTML='';
  const ss=await db.collection('appts').where('userId','==',currentUser.id).get();
  const rows=ss.docs.map(d=>d.data()).sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time,'tr'));
  rows.forEach(a=>{
    const link=gcalUrl(a);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.date}</td><td>${a.time}</td><td>${a.serviceName}</td><td>${a.staffName||''}</td><td>${a.status}</td>
    <td>
      <button class="btn" onclick="resched('${a.id}')">Saat Değiştir</button>
      <button class="btn" onclick="cancelMine('${a.id}')">İptal</button>
      <a class="btn btn-primary" href="${link}" target="_blank" rel="noopener">Takvime Ekle</a>
    </td>`;
    tb.appendChild(tr);
  });
}
window.resched=async(id)=>{
  const d=await db.collection('appts').doc(id).get(); if(!d.exists) return; const a=d.data();
  const svc=services.find(s=>s.id===a.serviceId); const st=staffById(a.staffId);
  const {open,close}=getHoursFor(st,a.date); const openM=toMin(open), closeM=toMin(close), step=settings.slot;
  const q=await db.collection('appts').where('date','==',a.date).where('staffId','==',a.staffId).get();
  const taken=conflicts(a.date,a.staffId,q.docs.map(x=>x.data())).filter(x=>!(x.start===toMin(a.time)&&x.end===toMin(a.time)+a.duration));
  let opts=[]; for(let t=openM; t+svc.dur<=closeM; t+=step){ if(!taken.some(x=>overlaps(t,t+svc.dur,x.start,x.end))) opts.push(toHHMM(t)); }
  const pick=prompt(`Yeni saat (${opts.slice(0,20).join(', ')})`, opts[0]||a.time); if(!pick) return;
  await db.collection('appts').doc(id).set({time:pick,status:'pending'},{merge:true}); renderMyAppts();
};
window.cancelMine=async(id)=>{ await db.collection('appts').doc(id).set({status:'cancelled'},{merge:true}); renderMyAppts(); };

/* ====== Admin İşlemleri ====== */
async function approve(id){ await db.collection('appts').doc(id).set({status:'approved'},{merge:true}); }
async function reject(id){ await db.collection('appts').doc(id).set({status:'rejected'},{merge:true}); }
async function removeAppt(id){ await db.collection('appts').doc(id).delete(); }

/* ====== Admin Panelleri ====== */
function renderQueue(all=[]){
  const tb=$('#queueTbody'); if(!tb) return; tb.innerHTML='';
  (all||[]).filter(a=>a.status==='pending').sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time,'tr')).forEach(a=>{
    const tr=document.createElement('tr');
    const link=gcalUrl(a);
    tr.innerHTML=`<td>${a.name}</td><td>${maskPhone(a.phone)}</td><td>${a.date}</td><td>${a.time}</td><td>${a.serviceName}</td><td>${a.staffName||''}</td><td>${a.duration} dk</td>
      <td><button class="btn ok" onclick="approve('${a.id}')">Onayla</button>
          <button class="btn no" onclick="reject('${a.id}')">Reddet</button>
          <button class="btn" onclick="removeAppt('${a.id}')">Sil</button>
          <a class="btn btn-primary" href="${link}" target="_blank" rel="noopener">Takvim</a>
      </td>`;
    tb.appendChild(tr);
  });
}
function renderCal(all=[]){
  const tb=$('#calTbody'); if(!tb) return; tb.innerHTML='';
  const date=$('#calDate').value||todayISO(); const staffId=$('#calStaff').value;
  (all||[]).filter(a=>a.date===date&&(!staffId||a.staffId===staffId)&&a.status!=='rejected').sort((a,b)=>a.time.localeCompare(b.time)).forEach(a=>{
    const link=gcalUrl(a);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.time} (${a.duration}')</td><td>${a.name}</td><td>${a.serviceName} / ${a.staffName||''}</td><td>${a.status}</td>
    <td>${a.status!=='cancelled'?`<button class="btn" onclick="db.collection('appts').doc('${a.id}').set({status:'cancelled'},{merge:true})">İptal</button>`:''}
        <button class="btn" onclick="removeAppt('${a.id}')">Sil</button>
        <a class="btn btn-primary" href="${link}" target="_blank" rel="noopener">Takvim</a>
    </td>`;
    tb.appendChild(tr);
  });
}
function renderUsers(){
  const tb=$('#usersTbody'); if(!tb) return;
  db.collection('users').get().then(ss=>{
    const list=ss.docs.map(d=>d.data()).sort((a,b)=>trSort(a,b,'name'));
    tb.innerHTML=list.map(u=>`<tr><td>${u.name||''}</td><td>${maskPhone(u.phone)||''}</td><td>${u.createdAt?new Date(u.createdAt).toLocaleString('tr-TR'):'-'}</td><td>${u.lastLogin?new Date(u.lastLogin).toLocaleString('tr-TR'):'-'}</td><td>${u.verified?'✅':'—'}</td><td><button class="btn" onclick="db.collection('users').doc('${u.id}').delete()">Sil</button></td></tr>`).join('');
  });
}
function renderReports(all=[]){
  const today=todayISO();
  const todayC=all.filter(a=>a.date===today).length;
  const weekC=all.filter(a=> (Date.now()-new Date(a.date).getTime())<=7*86400000 ).length;
  const ok=all.filter(a=>a.status==='approved').length, pend=all.filter(a=>a.status==='pending').length, can=all.filter(a=>a.status==='cancelled').length;
  let total=0; all.forEach(a=>{ const s=services.find(x=>x.id===a.serviceId); total+= (s?.price||0); });
  $('#kpiToday').textContent=todayC; $('#kpiWeek').textContent=weekC; $('#kpiStatus').textContent=`${ok}/${pend}/${can}`; $('#kpiAmount').textContent=`${total} ₺`;
}
function renderSvcUI(){
  const box=$('#svcList'); if(!box) return;
  db.collection('services').get().then(ss=>{
    services=ss.docs.map(d=>d.data()).sort((a,b)=>trSort(a,b,'name'));
    box.innerHTML = services.length? services.map(s=>`
      <div class="actions" style="justify-content:space-between;border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0">
        <span><b>${s.name}</b> — ${s.dur} dk / ${s.price||0} ₺</span>
        <span>
          <button class="btn" onclick='openSvcModal(${JSON.stringify(s)})'>Düzenle</button>
          <button class="btn" onclick="db.collection('services').doc('${s.id}').delete()">Sil</button>
        </span>
      </div>`).join('') : '<div class="small">Henüz hizmet yok</div>';
  });
}
function saveSvcModal(){
  const id=$('#svcSheet').dataset.editId||''; const name=$('#svcName').value.trim(); const dur=parseInt($('#svcDur').value||'30',10); const price=parseInt($('#svcPrice').value||'0',10);
  if(!name) return $('#svcStatus').textContent='Ad gerekli';
  const docId=id||uuid(); db.collection('services').doc(docId).set({id:docId,name,dur,price},{merge:true}).then(()=>{ $('#svcStatus').textContent='Kaydedildi'; setTimeout(closeSheets,300); });
}

function renderStaffUI(){
  const tb=$('#staffTbody'); if(!tb) return;
  db.collection('staff').get().then(ss=>{
    staff=ss.docs.map(d=>d.data()).sort((a,b)=>trSort(a,b,'name'));
    tb.innerHTML=staff.map(s=>{
      const days=(s.days?.length?s.days:[1,2,3,4,5,6]).map(i=>['Paz','Pzt','Sal','Çar','Per','Cum','Cmt'][i]).join(', ');
      const hours=s.hours? `${s.hours.open}–${s.hours.close}`:'-';
      const off=(s.offDates||[]).slice(0,6).join(', ');
      return `<tr><td>${s.name}</td><td>${days}</td><td>${hours}</td><td class="small">${off}</td>
      <td>
        <button class="btn" onclick='openStaffModal(${JSON.stringify(s)})'>Düzenle</button>
        <button class="btn" onclick="db.collection('staff').doc('${s.id}').delete()">Sil</button>
      </td></tr>`;
    }).join('');
  });
}
function saveStaffModal(){
  const id=$('#staffSheet').dataset.editId||''; const name=$('#stName').value.trim(); const open=$('#stOpen').value||'09:00'; const close=$('#stClose').value||'21:00';
  const days=[...document.querySelectorAll('#stDays input[type=checkbox][data-dow]')].filter(x=>x.checked).map(x=>parseInt(x.dataset.dow,10));
  if(!name) return $('#stStatus').textContent='Usta adı gerekli';
  if(days.length===0) return $('#stStatus').textContent='En az bir gün seçin';
  const docId=id||uuid(); db.collection('staff').doc(docId).set({id:docId,name,days,hours:{open,close},offDates:[]},{merge:true}).then(()=>{ $('#stStatus').textContent='Kaydedildi'; setTimeout(closeSheets,300); });
}
$('#addStaff').onclick=()=>openStaffModal();

/* ====== PIN Talepleri (GERÇEK) ====== */
function renderPinReqs(list=[]){
  const tb=$('#pinTbody'); if(!tb) return; tb.innerHTML='';
  list.sort((a,b)=> (a.createdAt||0)-(b.createdAt||0));
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${maskPhone(r.phone||'')}</td><td><b>${r.newPin||''}</b></td><td>${r.createdAt?new Date(r.createdAt).toLocaleString('tr-TR'):'-'}</td>
      <td>
        <button class="btn ok" onclick="applyPin('${r.id}')">PIN Uygula</button>
        <button class="btn" onclick="deletePinReq('${r.id}')">Sil</button>
      </td>`;
    tb.appendChild(tr);
  });
}
// PIN uygulama: ilgili kullanıcıyı bulur, PIN günceller, talebi siler
async function applyPin(reqId){
  const req=await db.collection('resetReqs').doc(reqId).get(); if(!req.exists) return;
  const r=req.data(); const us=await db.collection('users').where('phone','==',r.phone).get();
  if(us.empty){ alert('Kullanıcı bulunamadı'); return; }
  await db.collection('users').doc(us.docs[0].id).set({pin:r.newPin},{merge:true});
  await db.collection('resetReqs').doc(reqId).delete();
  showToast('PIN güncellendi');
}
async function deletePinReq(reqId){ await db.collection('resetReqs').doc(reqId).delete(); }

/* ====== Bildirimler (Çan) ====== */
function updateBell(all){
  // bekleyen randevular + pin talepleri
  Promise.all([
    all?Promise.resolve(all):db.collection('appts').get().then(s=>s.docs.map(d=>d.data())),
    db.collection('resetReqs').get().then(s=>s.docs.length)
  ]).then(([appts,pinCount])=>{
    const count = appts.filter(a=>a.status==='pending').length + pinCount;
    $('#bellCount').textContent=count; const btn=$('#bellBtn');
    if(adminAuthed && count>0){ btn.classList.add('flash'); } else { btn.classList.remove('flash'); }
  });
}
function fillNotifList(all=[]){
  const list=$('#notifList'); if(!list) return;
  const rows=all.filter(a=>a.status==='pending').sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time,'tr'));
  list.innerHTML = rows.length? rows.map(a=>`<div class="appt-card">
    <div><b>${a.date} ${a.time}</b> — ${a.serviceName} / ${a.staffName||''}<br><span class="small">${a.name} • ${maskPhone(a.phone)}</span></div>
    <div class="act">
      <button class="btn ok" onclick="approve('${a.id}')">Onayla</button>
      <button class="btn no" onclick="reject('${a.id}')">Reddet</button>
      <button class="btn" onclick="removeAppt('${a.id}')">Sil</button>
    </div>
  </div>`).join('') : '<div class="small" style="padding:12px">Bekleyen talep yok.</div>';
}
$('#btnApproveAll')?.addEventListener('click', async ()=>{
  const ss=await db.collection('appts').where('status','==','pending').get();
  await Promise.all(ss.docs.map(d=>db.collection('appts').doc(d.id).set({status:'approved'},{merge:true})));
  showToast('Tüm bekleyenler onaylandı');
});
$('#btnRejectAll')?.addEventListener('click', async ()=>{
  const ss=await db.collection('appts').where('status','==','pending').get();
  await Promise.all(ss.docs.map(d=>db.collection('appts').doc(d.id).set({status:'rejected'},{merge:true})));
  showToast('Tüm bekleyenler reddedildi');
});

/* ====== Toast ====== */
function showToast(msg){
  let t=document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast'; document.body.appendChild(t);
    Object.assign(t.style,{position:'fixed',left:'50%',top:'-80px',transform:'translateX(-50%)',background:'#111827',color:'#fff',padding:'10px 14px',borderRadius:'999px',boxShadow:'0 10px 24px rgba(0,0,0,.18)',zIndex:9999,transition:'top .45s ease'});}
  t.textContent=msg; t.style.top='12px'; setTimeout(()=>t.style.top='-80px',2600);
}

/* ====== Bildirim izni (opsiyonel) ====== */
if("Notification" in window){ Notification.requestPermission?.(); }
</script>
</body>
</html>
