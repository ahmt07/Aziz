<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AHMET TEKELİ ERKEK KUAFÖRÜ</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f6f7fb;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--card:#fff;--gold:#d4af37}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1000px;margin:0 auto;padding:0 14px}

/* Header — sadece butonlar */
header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:20}
.header-row{display:flex;align-items:center;justify-content:flex-end;padding:10px 0}
.actions{display:flex;gap:8px;align-items:center}
.badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
.badge .dot{min-width:18px;height:18px;border-radius:999px;background:#ef4444;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700}
#bellBtn{display:none}
#bellBtn.blink{animation:pulse 1s ease-in-out infinite}
@keyframes pulse{0%{filter:none}50%{filter:drop-shadow(0 0 8px #f43) saturate(1.2)}100%{filter:none}}

/* Cards & form */
main{padding:16px 0}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
.grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media(max-width:760px){.grid-2{grid-template-columns:minmax(0,1fr)}}
h2{margin:0 0 12px}
h4{margin:0 0 8px}
label{display:block;font-weight:600;margin:0 0 6px}
input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px}
.btn{border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn-primary{background:var(--gold);border-color:var(--gold);color:#111}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* Slot grid */
.slotgrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
@media(max-width:540px){.slotgrid{grid-template-columns:repeat(3,minmax(0,1fr))}}
.slot{border:1px solid #e5e7eb;background:#f3f4f6;color:#0f172a;border-radius:22px;padding:14px 0;font-weight:700;text-align:center}
.slot.busy{background:#cfd4dc;color:#6b7280;pointer-events:none}
.slot.sel{background:#111827;color:#fff;border-color:#111827}

/* Table */
.table-scroll{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}
thead th{background:#f3f4f6;font-weight:700}

/* KPI (admin) */
.kpi{display:none;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:16px}
.kpi .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}

/* Sheets */
.sheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:flex-end;z-index:30}
.sheet.show{display:flex}
.sheet .panel{width:100%;max-height:92vh;background:#fff;border-radius:16px 16px 0 0;box-shadow:0 -12px 30px rgba(0,0,0,.25);padding:14px 14px 18px;overflow:auto}
.sheet h3{margin:4px 0 10px}

/* Toast */
#toast{position:fixed;left:50%;top:-80px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:50;transition:top .45s}

/* Hero — ortada tek logo */
.hero{margin:16px auto;display:flex;justify-content:center;align-items:center;flex-direction:column}
.hero img{width:120px;height:120px;object-fit:contain}
.hero h1{margin:12px 0 0;text-align:center;font-size:22px}
</style>
</head>
<body>
<div id="toast"></div>

<header>
  <div class="wrap header-row">
    <div class="actions">
      <button id="bellBtn" class="badge" title="Bildirimler">🔔 <span id="bellCount" class="dot">0</span></button>
      <button id="adminOpen" class="badge">👨‍💼 Admin</button>
      <button id="custOpen"  class="badge">👤 Müşteri</button>
      <button id="manageOpen" class="badge" style="display:none">⚙️ Yönetim</button>
      <button id="myApptsOpen" class="badge" style="display:none">📅 Randevularım <span id="myBadge" class="dot" style="display:none">0</span></button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Logo yalnız ortada -->
  <section class="hero">
    <img id="main.png" alt="logo">
    <h1>AHMET TEKELİ ERKEK KUAFÖRÜ</h1>
  </section>

  <section class="card" id="randevu">
    <h2>Randevu Oluştur</h2>
    <div class="grid-2">
      <div><label>Ad Soyad</label><input id="f_name" placeholder="Adınız Soyadınız"></div>
      <div><label>Telefon</label><input id="f_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
      <div><label>Berber</label><select id="f_staff"><option disabled selected>— Seçiniz —</option></select></div>
      <div><label>Hizmet</label><select id="f_service"><option disabled selected>— Seçiniz —</option></select></div>
      <div><label>Tarih</label><input type="date" id="f_date"></div>
      <div><label>Saat Seçimi</label><div id="slotgrid" class="slotgrid"></div></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn btn-primary" id="f_book">RANDEVU AL</button>
      <span id="f_status" class="small"></span>
    </div>
    <div id="kpi" class="kpi">
      <div class="box"><div class="small">Bugün</div><b id="kpiToday">0</b></div>
      <div class="box"><div class="small">Onay/Bekl/İptal</div><b id="kpiOBI">0/0/0</b></div>
      <div class="box"><div class="small">Haftalık</div><b id="kpiWeek">0</b></div>
    </div>
  </section>
</main>

<!-- Onay Kuyruğu -->
<div id="sheetBell" class="sheet"><div class="panel">
  <h3>Onay Kuyruğu</h3>
  <div id="queueList" class="small">Kuyruk boş.</div>
</div></div>

<!-- Admin -->
<div id="sheetAdmin" class="sheet"><div class="panel">
  <h3>Yönetici Girişi</h3>
  <div class="grid-2">
    <div><label>Admin Telefon</label><input id="adminPhone" value="+905356749243"></div>
    <div><label>Şifre</label><input id="adminPass" type="password" placeholder="••••••"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <button class="btn btn-primary" id="adminLoginBtn">Giriş Yap</button>
    <button class="btn" id="adminLogoutBtn">Çıkış</button>
    <span id="adminStatus" class="small"></span>
  </div>

  <hr style="margin:12px 0;border:none;border-top:1px solid var(--line)">
  <h4>Yönetici Şifre Değiştir</h4>
  <div class="grid-2">
    <div><label>Mevcut Şifre</label><input id="adm_old" type="password"></div>
    <div><label>Yeni Şifre (min 6)</label><input id="adm_new" type="password"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <button class="btn" id="adm_change">Şifreyi Güncelle</button>
    <span id="adm_status" class="small"></span>
  </div>
</div></div>

<!-- Müşteri -->
<div id="sheetCust" class="sheet"><div class="panel">
  <h3>Müşteri Girişi / Kayıt</h3>
  <div class="grid-2">
    <div><label>Ad Soyad</label><input id="c_name" placeholder="Ad Soyad (kayıt için)"></div>
    <div><label>Telefon</label><input id="c_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
  </div>
  <div class="grid-2">
    <div><label>Şifre</label><input id="c_pass" type="password" placeholder="Şifre"></div>
    <div class="row" style="align-items:flex-end">
      <button class="btn btn-primary" id="c_register">Kayıt Ol</button>
      <button class="btn" id="c_login">Giriş Yap</button>
    </div>
  </div>
  <p class="small" id="c_status"></p>
</div></div>

<!-- Müşteri: Randevularım -->
<div id="sheetMyAppts" class="sheet"><div class="panel">
  <h3>Randevularım</h3>
  <div class="row" style="gap:8px;margin-bottom:6px">
    <select id="my_filter" style="max-width:220px">
      <option value="upcoming">Yaklaşan</option>
      <option value="all">Tümü</option>
      <option value="past">Geçmiş</option>
    </select>
    <button class="btn" id="my_refresh">Yenile</button>
  </div>
  <div class="table-scroll">
    <table>
      <thead><tr><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>İşlem</th></tr></thead>
      <tbody id="my_tbody"></tbody>
    </table>
  </div>
</div></div>

<!-- Yönetim -->
<div id="sheetManage" class="sheet"><div class="panel">
  <h3>Yönetim</h3>

  <div class="grid-2">
    <section class="card" style="padding:12px">
      <h4>Ustalar</h4>
      <div class="row">
        <input id="newStaffName" placeholder="Yeni usta adı" style="max-width:260px">
        <button class="btn" id="addStaff">Ekle</button>
      </div>
      <ul id="staffList" class="small"></ul>
    </section>

    <section class="card" style="padding:12px">
      <h4>Hizmetler</h4>
      <div class="row" style="flex-wrap:wrap">
        <input id="newSvcName" placeholder="Hizmet adı">
        <input id="newSvcDur" type="number" placeholder="Süre (dk)" style="max-width:120px">
        <input id="newSvcPrice" type="number" placeholder="Fiyat (TL)" style="max-width:120px">
        <button class="btn" id="addSvc">Ekle</button>
      </div>
      <ul id="svcList" class="small"></ul>
    </section>
  </div>

  <section class="card" style="padding:12px;margin-top:10px">
    <h4>Usta Çalışma Saatleri</h4>
    <div class="grid-2">
      <div><label>Usta</label><select id="wh_staff"></select></div>
      <div><label>Varsayılan Slot (dk) — 30</label><input id="wh_slot" type="number" value="30" disabled></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div style="flex:1">
        <b>Haftalık Saatler (tek aralık)</b>
        <div class="grid-2" style="margin-top:6px">
          <div><label>Açılış</label><input type="time" id="wh_open" value="09:00"></div>
          <div><label>Kapanış</label><input type="time" id="wh_close" value="21:00"></div>
        </div>
      </div>
      <div style="flex:1">
        <b>İzin / Tatil Günleri</b>
        <div class="row" style="margin-top:6px">
          <input type="date" id="offDate" style="max-width:180px">
          <button class="btn" id="addOff">Ekle</button>
        </div>
        <div id="offList" class="row" style="margin-top:6px;gap:6px;flex-wrap:wrap"></div>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn btn-primary" id="saveWorkHours">Kaydet</button>
      <span id="wh_status" class="small"></span>
    </div>
  </section>

  <section class="card" style="padding:12px;margin-top:10px">
    <h4>Randevular</h4>
    <div class="row" style="gap:8px;margin-bottom:6px;flex-wrap:wrap">
      <input type="date" id="ap_fdate" style="max-width:180px">
      <select id="ap_fstaff" style="max-width:220px"><option value="">Tüm Ustalar</option></select>
      <select id="ap_fstatus" style="max-width:180px">
        <option value="">Tüm Durumlar</option>
        <option value="pending">Beklemede</option>
        <option value="approved">Onaylandı</option>
        <option value="cancelled">İptal</option>
        <option value="rejected">Reddedildi</option>
      </select>
      <button class="btn" id="ap_refresh">Yenile</button>
    </div>
    <div class="table-scroll">
      <table>
        <thead><tr><th></th><th>Tarih</th><th>Saat</th><th>Müşteri</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>İşlem</th></tr></thead>
        <tbody id="ap_tbody"></tbody>
      </table>
    </div>
  </section>

</div></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>

<script>
/* ===== Firebase init ===== */
firebase.initializeApp({
  apiKey:"AIzaSyBtSQ9_5R42BU5ga0cOt1QETkC5nOf2tW4",
  authDomain:"randevu-81305.firebaseapp.com",
  projectId:"randevu-81305",
  storageBucket:"randevu-81305.firebasestorage.app",
  messagingSenderId:"686048709577",
  appId:"1:686048709577:web:b2db4eeae83203ca2e3618",
  measurementId:"G-3ZX91ND545"
});
const db=firebase.firestore();
const storage=firebase.storage();

/* ===== Yardımcılar ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const store={get(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}},del(k){try{localStorage.removeItem(k)}catch(e){}}};
function toast(m,ms=2200){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);}
const toMin=t=>{const[h,m]=t.split(':').map(Number);return h*60+m}, toHHMM=m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
function overlaps(aS,aE,bS,bE){return aS<bE && aE>bS}
function maskPhone(p){ if(!p) return ''; if(p.startsWith('+90')&&p.length===13){const n=p.slice(3); return `0${n.slice(0,3)} ${n.slice(3,6)} ${n.slice(6,8)} ${n.slice(8,10)}`} return p }

/* ===== Ses & Titreşim kilidi (ilk etkileşimde açılır) ===== */
let audioUnlocked=false;
function unlockAudio(){ try{
  if(audioUnlocked) return;
  const C=window.AudioContext||window.webkitAudioContext; if(!C) { audioUnlocked=true; return; }
  const ctx=new C();
  // küçük bir sessiz buffer ile “resume” tetikle
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.connect(g); g.connect(ctx.destination);
  g.gain.value=0.00001; o.start(); setTimeout(()=>{o.stop(); ctx.close(); audioUnlocked=true;},50);
}catch(e){ audioUnlocked=true; } }
['click','touchstart','pointerdown','keydown'].forEach(ev=>window.addEventListener(ev,unlockAudio,{once:true,passive:true}));

function playAlertTone(){
  if(!audioUnlocked) return; // ilk dokunuştan önce tarayıcı engeller
  try{
    const C=window.AudioContext||window.webkitAudioContext; if(!C) return;
    const ctx=new C(); const o=ctx.createOscillator(); const g=ctx.createGain();
    o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.25, ctx.currentTime+0.01);
    o.start();
    setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.25);
      setTimeout(()=>{ o.stop(); ctx.close(); },260);
    },240);
  }catch(e){}
}
function vibrate(ms=200){ if(navigator.vibrate) try{ navigator.vibrate(ms);}catch(e){} }

/* ===== Global ===== */
const DEFAULT_ADMIN_PHONE = '+905356749243';
let DEFAULT_ADMIN_PASS = 'ahmet07';
let adminOn=false, currentUser=store.get('custSession',null);
let lastStaff=[], lastSvcs=[], lastAppts=[];
let unsubStaff=null, unsubSvcs=null, unsubAppts=null;

/* --- Bildirim algılama yardımcıları --- */
let prevPendingIds = new Set();          // admin için “yeni bekleyen” tespiti
let myPrevStatus = {};                   // müşteri için randevu durum değişikliği tespiti

/* ===== Logo (Storage → logos/main.png) ===== */
(async function loadLogo(){
  try{
    const url = await storage.ref('logos/main.png').getDownloadURL();
    $('#centerLogo').src=url;
  }catch(e){
    $('#centerLogo').style.display='none'; // logo yoksa sadece başlık görünsün
  }
})();

/* ===== Sheets ===== */
const sheet={show:id=>{ $(id).classList.add('show'); document.body.style.overflow='hidden'; }, hide:id=>{ $(id).classList.remove('show'); document.body.style.overflow=''; }};
['#sheetBell','#sheetAdmin','#sheetCust','#sheetMyAppts','#sheetManage'].forEach(id=>$(id).addEventListener('click',e=>{ if(e.target===e.currentTarget) sheet.hide(id); }));
$('#adminOpen').onclick=()=>sheet.show('#sheetAdmin');
$('#custOpen').onclick =()=>sheet.show('#sheetCust');
$('#bellBtn').onclick  =()=>sheet.show('#sheetBell');
$('#manageOpen').onclick=()=>sheet.show('#sheetManage');
$('#myApptsOpen').onclick=()=>{ sheet.show('#sheetMyAppts'); };

/* ===== Görünürlük ===== */
function setAdmin(on){adminOn=!!on; $('#bellBtn').style.display=on?'inline-flex':'none'; $('#kpi').style.display=on?'grid':'none'; $('#manageOpen').style.display=on?'inline-flex':'none';}
function setCust(on){ $('#myApptsOpen').style.display=on?'inline-flex':'none';}

/* ===== Seed (admin/usta/hizmet) ===== */
async function seedIfNeeded(){
  try{
    const aDoc=await db.collection('admins').doc(DEFAULT_ADMIN_PHONE).get();
    if(!aDoc.exists){ await db.collection('admins').doc(DEFAULT_ADMIN_PHONE).set({pass:DEFAULT_ADMIN_PASS,createdAt:Date.now()}); }
  }catch(e){ console.warn('Admin seed hatası:', e); }

  try{
    const s=await db.collection('staff').limit(1).get();
    if(s.empty){ await db.collection('staff').add({name:'Ahmet Usta',days:[1,2,3,4,5,6],open:'09:00',close:'21:00',offDates:[]}); }
  }catch(e){ console.warn('Staff seed hatası:', e); }

  try{
    const v=await db.collection('services').limit(1).get();
    if(v.empty){ await db.collection('services').add({name:'Saç + Sakal',dur:30,price:0}); }
  }catch(e){ console.warn('Service seed hatası:', e); }
}

/* ===== Realtime ===== */
function startRealtime(){
  if(unsubStaff)unsubStaff(); if(unsubSvcs)unsubSvcs(); if(unsubAppts)unsubAppts();

  unsubStaff=db.collection('staff').onSnapshot(ss=>{
    lastStaff=ss.docs.map(d=>({id:d.id,...d.data()}));
    fillStaff(); fillAdminStaff(); renderStaffList(); renderOffList(); computeSlots();
  });
  unsubSvcs=db.collection('services').onSnapshot(ss=>{
    lastSvcs=ss.docs.map(d=>({id:d.id,...d.data()}));
    fillServices(); computeSlots();
  });
  unsubAppts=db.collection('appts').onSnapshot(ss=>{
    lastAppts=ss.docs.map(d=>({id:d.id,...d.data()}));

    // --- ADMIN: “yeni bekleyen” randevu algıla (edge-trigger) ---
    const currPending = new Set(lastAppts.filter(a=>a.status==='pending').map(a=>a.id));
    const newOnes = [...currPending].filter(id=>!prevPendingIds.has(id));
    if(adminOn && newOnes.length>0){
      $('#bellBtn').classList.add('blink');
      $('#bellCount').textContent=String(currPending.size);
      playAlertTone(); vibrate(220);
    } else {
      $('#bellCount').textContent=String(currPending.size);
      if(currPending.size===0) $('#bellBtn').classList.remove('blink');
    }
    prevPendingIds = currPending;

    // --- MÜŞTERİ: kendi randevu durum değişiklik uyarısı ---
    if(currentUser){
      const mine=lastAppts.filter(a=>a.phone===currentUser.phone);
      mine.forEach(a=>{
        const prev=myPrevStatus[a.id];
        if(prev==='pending' && (a.status==='approved'||a.status==='rejected'||a.status==='cancelled')){
          const msg = a.status==='approved' ? '✅ Randevunuz onaylandı' :
                      a.status==='rejected' ? '⛔ Randevunuz reddedildi' :
                                              'ℹ️ Randevunuz iptal edildi';
          toast(msg); playAlertTone(); vibrate(180);
          // “Randevularım” rozeti istersen buraya eklenebilir
          const b=document.getElementById('myBadge'); if(b){ b.style.display='inline-flex'; b.textContent='1'; }
        }
        myPrevStatus[a.id]=a.status;
      });
    }

    computeSlots(lastAppts); renderQueue(lastAppts); renderAdminAppts(lastAppts); renderMy(lastAppts);
  });
}

/* ===== Select doldur ===== */
function fillStaff(){
  const sel=$('#f_staff'); const cur=sel.value;
  sel.innerHTML='<option disabled selected>— Seçiniz —</option>'+lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  if(lastStaff.some(s=>s.id===cur)) sel.value=cur;
  $('#wh_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
function fillAdminStaff(){ $('#ap_fstaff').innerHTML='<option value="">Tüm Ustalar</option>'+lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); }
function fillServices(){
  const sel=$('#f_service'); const cur=sel.value;
  sel.innerHTML='<option disabled selected>— Seçiniz —</option>'+lastSvcs.map(s=>`<option value="${s.id}">${s.name} — ${s.dur} dk</option>`).join('');
  if(lastSvcs.some(s=>s.id===cur)) sel.value=cur;
}

/* ===== Slot / çakışma ===== */
function conflicts(appts,date,staffId){
  return (appts||[]).filter(a=>a.date===date&&a.staffId===staffId&&a.status!=='cancelled'&&a.status!=='rejected')
    .map(a=>({start:toMin(a.time), end:toMin(a.time)+(a.duration||30)}));
}
function staffWorks(staff,dateISO){
  const dow=new Date(dateISO+'T00:00:00').getDay();
  const dayOk = !staff?.days || staff.days.includes(dow);
  const off   = (staff?.offDates||[]).includes(dateISO);
  return dayOk && !off;
}
const STEP=30;
function renderGrid(containerId, staff, svcDur, date){
  const box=document.getElementById(containerId); box.innerHTML='';
  if(!staff||!svcDur||!date) return;
  const taken=conflicts(lastAppts,date,staff.id);
  const openM=toMin(staff.open||'09:00'), closeM=toMin(staff.close||'21:00');
  for(let t=openM; t+svcDur<=closeM; t+=STEP){
    const time=toHHMM(t);
    const busy = !staffWorks(staff,date) || taken.some(x=>overlaps(t,t+svcDur,x.start,x.end));
    const b=document.createElement('button');
    b.type='button'; b.className='slot'+(busy?' busy':''); b.textContent=time; b.dataset.time=time;
    b.onclick=()=>{ if(busy) return; [...box.querySelectorAll('.slot')].forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); };
    box.appendChild(b);
  }
}
function getSelected(containerId){ return document.querySelector(`#${containerId} .slot.sel`)?.dataset.time||null; }
async function computeSlots(){ const sId=$('#f_staff').value, vId=$('#f_service').value, d=$('#f_date').value; if(!sId||!vId||!d){$('#slotgrid').innerHTML='';return;} const s=lastStaff.find(x=>x.id===sId), v=lastSvcs.find(x=>x.id===vId); if(!s||!v)return; renderGrid('slotgrid',s,v.dur||30,d); }

/* ===== Randevu oluşturma ===== */
$('#f_date').value=new Date().toISOString().slice(0,10);
$('#f_staff').onchange=computeSlots; $('#f_service').onchange=computeSlots; $('#f_date').onchange=computeSlots;

$('#f_book').onclick=async ()=>{
  const name=$('#f_name').value.trim(), phoneRaw=$('#f_phone').value.trim();
  const staffId=$('#f_staff').value, svcId=$('#f_service').value, date=$('#f_date').value;
  const time=getSelected('slotgrid');
  if(!name||!phoneRaw||!staffId||!svcId||!date||!time){ $('#f_status').textContent='Lütfen tüm alanları doldurun.'; toast('Eksik bilgi'); return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);

  try{
    const svc=(await db.collection('services').doc(svcId).get()).data()||{};
    const st =(await db.collection('staff').doc(staffId).get()).data()||{};
    const same=await db.collection('appts').where('phone','==',phone).where('date','==',date).get();
    const activeCnt=same.docs.map(d=>d.data()).filter(a=>['pending','approved'].includes(a.status)).length;
    if(activeCnt>=2){ $('#f_status').textContent='Aynı gün en fazla 2 aktif randevu'; toast('Aynı gün en fazla 2 aktif randevu'); return; }

    const ref = await db.collection('appts').add({
      name,phone,serviceId:svcId,serviceName:svc.name||'Hizmet',duration:svc.dur||30,price:svc.price||0,
      staffId,staffName:st.name||'Usta',date,time,status:'pending',createdAt:Date.now()
    });

    // müşteri oturumunu kur + takip için başlangıç statüsü
    currentUser={name,phone}; store.set('custSession',currentUser); setCust(true);
    myPrevStatus[ref.id]='pending';

    $('#f_status').textContent='Randevu alındı (beklemede).'; toast('Randevu oluşturuldu');
    playAlertTone(); vibrate(100);
  }catch(e){ console.error(e); $('#f_status').textContent=(e?.code==='permission-denied'?'Firestore yazma izni yok':'Sunucu hatası'); }
};

/* ===== Kuyruk & Bildirim ===== */
function renderQueue(list){
  const box=$('#queueList'); const rows=(list||[]).filter(a=>a.status==='pending').sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  const cnt=rows.length; $('#bellCount').textContent=String(cnt);
  if(adminOn && cnt>0){ $('#bellBtn').classList.add('blink'); } else $('#bellBtn').classList.remove('blink');
  box.innerHTML=cnt?rows.map(a=>`
    <div style="display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0">
      <div style="flex:1 1 auto;min-width:0"><b>${a.date} ${a.time}</b> • ${a.name} • ${a.serviceName} / ${a.staffName}</div>
      <button class="btn" onclick="approve('${a.id}')">Onayla</button>
      <button class="btn" onclick="reject('${a.id}')">Reddet</button>
      <button class="btn" onclick="delAppt('${a.id}')">Sil</button>
    </div>`).join('') : 'Kuyruk boş.';
}
window.approve=async(id)=>{ try{await db.collection('appts').doc(id).set({status:'approved'},{merge:true}); toast('Onaylandı');}catch(e){toast('Hata');} }
window.reject =async(id)=>{ try{await db.collection('appts').doc(id).set({status:'rejected'},{merge:true}); toast('Reddedildi');}catch(e){toast('Hata');} }
window.delAppt=async(id)=>{ if(!confirm('Silinsin mi?'))return;try{await db.collection('appts').doc(id).delete();toast('Silindi');}catch(e){toast('Hata');} }

/* ===== Admin tablo ===== */
function renderAdminAppts(list){
  const tb=$('#ap_tbody'); if(!tb) return;
  const fdate=$('#ap_fdate').value||'', fstaff=$('#ap_fstaff').value||'', fstat=$('#ap_fstatus').value||'';
  let rows=[...(list||[])];
  if(fdate) rows=rows.filter(a=>a.date===fdate);
  if(fstaff) rows=rows.filter(a=>a.staffId===fstaff);
  if(fstat) rows=rows.filter(a=>a.status===fstat);
  rows.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  tb.innerHTML=rows.map(a=>{
    const act=a.status==='pending'
      ? `<button class="btn" onclick="approve('${a.id}')">Onayla</button> <button class="btn" onclick="reject('${a.id}')">Reddet</button>`
      : a.status==='approved' ? `<button class="btn" onclick="setCancelled('${a.id}')">İptal</button>` : '';
    return `<tr>
      <td></td>
      <td>${a.date}</td><td>${a.time}</td>
      <td>${a.name} (${maskPhone(a.phone)})</td>
      <td>${a.serviceName||''}</td>
      <td>${a.staffName||''}</td>
      <td>${a.status}</td>
      <td class="row" style="gap:6px">${act} <button class="btn" onclick="delAppt('${a.id}')">Sil</button></td>
    </tr>`;
  }).join('') || `<tr><td colspan="8" class="small">Randevu yok</td></tr>`;
}
function setCancelled(id){ return db.collection('appts').doc(id).set({status:'cancelled'},{merge:true}).then(()=>toast('İptal edildi')).catch(()=>toast('Hata')); }

/* ===== Yönetim: ustalar/hizmetler, saatler, izin günleri ===== */
function renderStaffList(){
  $('#staffList').innerHTML=(lastStaff||[]).map(s=>`<li class="small" style="margin:4px 0;display:flex;justify-content:space-between"><span>${s.name}</span><button class="btn" onclick="delStaff('${s.id}')">Sil</button></li>`).join('')||'—';
}
window.delStaff=async(id)=>{ try{await db.collection('staff').doc(id).delete(); toast('Usta silindi');}catch(e){toast('Hata');} };
$('#addStaff').onclick=async ()=>{ const name=$('#newStaffName').value.trim(); if(!name){toast('Usta adı gerekli');return;} await db.collection('staff').add({name,days:[1,2,3,4,5,6],open:'09:00',close:'21:00',offDates:[]}); $('#newStaffName').value=''; toast('Usta eklendi'); };

$('#addSvc').onclick=async ()=>{ const name=$('#newSvcName').value.trim(), dur=parseInt($('#newSvcDur').value||'30',10), price=parseInt($('#newSvcPrice').value||'0',10); if(!name){toast('Hizmet adı gerekli');return;} await db.collection('services').add({name,dur,price}); $('#newSvcName').value=''; $('#newSvcDur').value=''; $('#newSvcPrice').value=''; toast('Hizmet eklendi'); };

function renderOffList(){
  const sid=$('#wh_staff').value || lastStaff[0]?.id; if(!sid) { $('#offList').innerHTML=''; return; }
  const staff=lastStaff.find(s=>s.id===sid); const wrap=$('#offList'); wrap.innerHTML='';
  (staff?.offDates||[]).sort().forEach(d=>{
    const chip=document.createElement('span'); chip.className='small'; chip.style.border='1px solid #e5e7eb'; chip.style.borderRadius='12px'; chip.style.padding='6px 10px'; chip.textContent=d+' ';
    const b=document.createElement('button'); b.className='btn'; b.textContent='Sil';
    b.onclick=async()=>{ const list=(staff.offDates||[]).filter(x=>x!==d); await db.collection('staff').doc(staff.id).set({offDates:list},{merge:true}); toast('İzin silindi'); };
    chip.appendChild(b); wrap.appendChild(chip);
  });
}
$('#wh_staff').addEventListener('change',()=>{ renderOffList(); });
$('#addOff').onclick=async ()=>{
  const sid=$('#wh_staff').value || lastStaff[0]?.id; const d=$('#offDate').value; if(!d||!sid) return;
  const staff=lastStaff.find(s=>s.id===sid); const set=new Set(staff?.offDates||[]); set.add(d);
  await db.collection('staff').doc(sid).set({offDates:[...set]},{merge:true}); toast('İzin eklendi'); renderOffList();
};
$('#saveWorkHours').onclick=async ()=>{
  const sid=$('#wh_staff').value || lastStaff[0]?.id; if(!sid){toast('Usta seçiniz');return;}
  const open=$('#wh_open').value||'09:00', close=$('#wh_close').value||'21:00';
  await db.collection('staff').doc(sid).set({open,close},{merge:true});
  $('#wh_status').textContent='Kaydedildi'; toast('Saatler kaydedildi');
};

/* ===== Admin giriş / şifre değiştir (kalıcı oturum) ===== */
$('#adminLoginBtn').onclick=async()=>{
  const phone=($('#adminPhone').value||'').trim();
  const pass =($('#adminPass').value||'').trim();
  if(!phone||!pass){ $('#adminStatus').textContent='Telefon ve şifre gerekli.'; return; }

  try{
    if(phone===DEFAULT_ADMIN_PHONE && pass===DEFAULT_ADMIN_PASS){
      await db.collection('admins').doc(DEFAULT_ADMIN_PHONE).set({pass:DEFAULT_ADMIN_PASS},{merge:true});
      setAdmin(true); store.set('adminSession','on'); store.set('adminPhone',phone);
      $('#adminStatus').textContent='Giriş başarılı'; sheet.hide('#sheetAdmin'); toast('Yönetici girişi (varsayılan)');
      return;
    }
    const snap=await db.collection('admins').doc(phone).get();
    if(!snap.exists){ $('#adminStatus').textContent='Yönetici hesabı bulunamadı.'; return; }
    const adm=snap.data();
    if((adm.pass||'')!==pass){ $('#adminStatus').textContent='Telefon ya da şifre yanlış.'; return; }
    setAdmin(true); store.set('adminSession','on'); store.set('adminPhone',phone);
    $('#adminStatus').textContent='Giriş başarılı'; sheet.hide('#sheetAdmin'); toast('Yönetici girişi');
  }catch(e){ console.error(e); $('#adminStatus').textContent=(e?.code==='permission-denied'?'Firestore okuma izni yok':'Sunucu hatası'); }
};
$('#adminLogoutBtn').onclick=()=>{ setAdmin(false); store.del('adminSession'); store.del('adminPhone'); $('#adminStatus').textContent='Çıkış yapıldı'; toast('Çıkış'); };
$('#adm_change').onclick=async()=>{
  if(!adminOn){ $('#adm_status').textContent='Önce yönetici girişi yapın.'; return; }
  const old=($('#adm_old').value||'').trim(), nw=($('#adm_new').value||'').trim();
  if(nw.length<6){ $('#adm_status').textContent='Yeni şifre en az 6 karakter.'; return; }
  const phone=store.get('adminPhone',DEFAULT_ADMIN_PHONE);
  if(phone===DEFAULT_ADMIN_PHONE && old===DEFAULT_ADMIN_PASS){ DEFAULT_ADMIN_PASS=nw; }
  try{ await db.collection('admins').doc(phone).set({pass:nw},{merge:true}); $('#adm_status').textContent='Şifre güncellendi.'; toast('Şifre değiştirildi'); }catch(e){ $('#adm_status').textContent='Sunucu hatası'; }
};

/* ===== Müşteri — Kayıt & Giriş (kalıcı oturum) ===== */
$('#c_register').onclick=async ()=>{
  const name=$('#c_name').value.trim(), phoneRaw=$('#c_phone').value.trim(), pass=$('#c_pass').value.trim();
  if(!name||!phoneRaw||!pass){ $('#c_status').textContent='Kayıt için ad, telefon, şifre gerekli.'; return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);
  try{
    const exists=await db.collection('users').where('phone','==',phone).limit(1).get();
    if(!exists.empty){ $('#c_status').textContent='Bu telefon zaten kayıtlı. Giriş yapın.'; return; }
    const ref=await db.collection('users').add({name,phone,pass,createdAt:Date.now(),lastLogin:Date.now()});
    currentUser={id:ref.id,name,phone}; store.set('custSession',currentUser); setCust(true);
    $('#c_status').textContent='Kayıt başarılı. Giriş yapıldı.'; toast('Kayıt tamam'); sheet.hide('#sheetCust');
    $('#f_name').value=name; $('#f_phone').value=phone.replace('+90','0');
  }catch(e){ console.error(e); $('#c_status').textContent=(e?.code==='permission-denied'?'Firestore yazma izni yok':'Sunucu hatası'); }
};
$('#c_login').onclick=async ()=>{
  const phoneRaw=$('#c_phone').value.trim(), pass=$('#c_pass').value.trim();
  if(!phoneRaw||!pass){ $('#c_status').textContent='Telefon ve şifre gerekli.'; return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);
  try{
    const q=await db.collection('users').where('phone','==',phone).limit(1).get();
    if(q.empty){ $('#c_status').textContent='Kayıt yok. Lütfen Kayıt Ol\'a basın.'; return; }
    const u=q.docs[0].data(); if((u.pass||'')!==pass){ $('#c_status').textContent='Şifre hatalı.'; return; }
    await db.collection('users').doc(q.docs[0].id).set({lastLogin:Date.now()},{merge:true});
    currentUser={id:q.docs[0].id,name:u.name||'',phone}; store.set('custSession',currentUser); setCust(true);
    $('#c_status').textContent='Giriş başarılı.'; toast('Müşteri girişi'); sheet.hide('#sheetCust');
    $('#f_name').value=currentUser.name||''; $('#f_phone').value=phone.replace('+90','0');
  }catch(e){ console.error(e); $('#c_status').textContent=(e?.code==='permission-denied'?'Firestore okuma izni yok':'Sunucu hatası'); }
};

/* ===== Müşteri: Randevularım ===== */
function renderMy(list){
  const tb=$('#my_tbody'); if(!tb) return;
  if(!currentUser){ tb.innerHTML='<tr><td colspan="6" class="small">Lütfen müşteri girişi yapın.</td></tr>'; return; }
  const today=new Date().toISOString().slice(0,10);
  let rows=(list||[]).filter(a=>a.phone===currentUser.phone);
  const f=$('#my_filter').value||'upcoming';
  if(f==='upcoming') rows=rows.filter(a=>a.date>=today);
  else if(f==='past') rows=rows.filter(a=>a.date<today);
  rows.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  tb.innerHTML=rows.map(a=>{
    const canCancel=(a.status==='pending'||a.status==='approved');
    return `<tr>
      <td>${a.date}</td><td>${a.time}</td><td>${a.serviceName||''}</td><td>${a.staffName||''}</td>
      <td>${a.status}</td>
      <td class="row" style="gap:6px">
        ${canCancel?`<button class="btn" onclick="setCancelled('${a.id}')">İptal</button>`:''}
      </td>
    </tr>`;
  }).join('') || '<tr><td colspan="6" class="small">Randevu yok</td></tr>';
}
$('#my_refresh').onclick=()=>renderMy(lastAppts);
$('#my_filter').onchange=()=>renderMy(lastAppts);

/* ===== Boot (kalıcı oturumlar) ===== */
(async function boot(){
  try{ await seedIfNeeded(); }catch(e){}
  // Admin oturumu kalıcı
  if(store.get('adminSession')==='on'){
    setAdmin(true);
  } else {
    setAdmin(false);
  }
  // Müşteri oturumu kalıcı
  if(currentUser){
    setCust(true);
    $('#f_name').value=currentUser.name||'';
    $('#f_phone').value=(currentUser.phone||'').replace('+90','0');
  } else {
    setCust(false);
  }
  $('#f_date').value=new Date().toISOString().slice(0,10);
  const apd=document.getElementById('ap_fdate'); if(apd) apd.value=new Date().toISOString().slice(0,10);
  startRealtime();
})();
</script>
</body>
</html>
