<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ahmet Tekeli â€¢ Randevu (Ã‡ift AralÄ±k + Toplu Ä°ÅŸlemler)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f6f7fb;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--card:#fff;--brand:#101827;--gold:#d4af37}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1000px;margin:0 auto;padding:0 14px}

/* Header */
header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:20}
.header-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.brand .title{font-family:Georgia,serif;font-weight:700;color:var(--brand);font-size:24px;line-height:1}
.brand .sub{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:8px;align-items:center}
.badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
.badge .dot{min-width:18px;height:18px;border-radius:999px;background:#ef4444;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700}
#bellBtn{display:none}
#bellBtn.blink{animation:pulse 1s ease-in-out infinite}
@keyframes pulse{0%{filter:none}50%{filter:drop-shadow(0 0 8px #f43) saturate(1.2)}100%{filter:none}}

/* Cards & form */
main{padding:16px 0}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
.grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media(max-width:760px){.grid-2{grid-template-columns:minmax(0,1fr)}}
h2{margin:0 0 12px}
label{display:block;font-weight:600;margin:0 0 6px}
input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px}
.btn{border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn-primary{background:var(--gold);border-color:var(--gold);color:#111}
.small{font-size:12px;color:var(--muted)}

/* Saat Ä±zgarasÄ± (yarÄ±m saat + geniÅŸ dokunma) */
.slotgrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px}
@media(max-width:540px){.slotgrid{grid-template-columns:repeat(3,minmax(0,1fr))}}
@media(max-width:400px){.slotgrid{grid-template-columns:repeat(2,minmax(0,1fr))}}
.slot-item{border:1px solid #e5e7eb;background:#f3f4f6;color:#0f172a;border-radius:22px;padding:16px 0;font-weight:700;text-align:center;font-size:16px}
.slot-item.busy{background:#cfd4dc;color:#6b7280;pointer-events:none}
.slot-item.sel{background:#111827;color:#fff;border-color:#111827}

/* KPI (admin) */
.kpi{display:none;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:16px}
.kpi .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}

/* Sheets (modal) */
.sheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:flex-end;z-index:30}
.sheet.show{display:flex}
.sheet .panel{width:100%;max-height:92vh;background:#fff;border-radius:16px 16px 0 0;box-shadow:0 -12px 30px rgba(0,0,0,.25);padding:14px 14px 18px;overflow:auto}
.sheet h3{margin:4px 0 10px}

/* Toast */
#toast{position:fixed;left:50%;top:-80px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:50;transition:top .45s}
#toast.show{top:12px}

/* Table */
.table-scroll{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}
thead th{background:#f3f4f6;font-weight:700}
ul{margin:8px 0 0 18px}
</style>
</head>
<body>
<div id="toast"></div>

<header>
  <div class="wrap header-row">
    <div class="brand">
      <div>
        <div class="title">AHMET TEKELÄ°</div>
        <div class="sub">Erkek KuafÃ¶rÃ¼</div>
      </div>
    </div>
    <div class="actions">
      <button id="bellBtn" class="badge">ğŸ”” <span id="bellCount" class="dot">0</span></button>
      <button id="adminOpen" class="badge">ğŸ‘¨â€ğŸ’¼ Admin</button>
      <button id="custOpen"  class="badge">ğŸ‘¤ MÃ¼ÅŸteri</button>
      <button id="manageOpen" class="badge" style="display:none">âš™ï¸ YÃ¶netim</button>
      <button id="myApptsOpen" class="badge" style="display:none">ğŸ“… RandevularÄ±m <span id="myBadge" class="dot" style="display:none">0</span></button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card" id="randevu">
    <h2>Randevu OluÅŸtur</h2>
    <div class="grid-2">
      <div><label>Ad Soyad</label><input id="f_name" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z"></div>
      <div><label>Telefon</label><input id="f_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
      <div><label>Berber</label><select id="f_staff"><option disabled selected>â€” SeÃ§iniz â€”</option></select></div>
      <div><label>Hizmet</label><select id="f_service"><option disabled selected>â€” SeÃ§iniz â€”</option></select></div>
      <div><label>Tarih</label><input type="date" id="f_date"></div>
      <div>
        <label>Saat SeÃ§imi</label>
        <div id="slotgrid" class="slotgrid"></div>
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button class="btn btn-primary" id="f_book">RANDEVU AL</button>
      <span id="f_status" class="small"></span>
    </div>

    <div id="kpi" class="kpi">
      <div class="box"><div class="small">BugÃ¼n</div><b id="kpiToday">0</b></div>
      <div class="box"><div class="small">Onay/Bekl/Ä°ptal</div><b id="kpiOBI">0/0/0</b></div>
      <div class="box"><div class="small">HaftalÄ±k</div><b id="kpiWeek">0</b></div>
    </div>
  </section>
</main>

<!-- Bildirim/Onay kuyruÄŸu -->
<div id="sheetBell" class="sheet"><div class="panel">
  <h3>Onay KuyruÄŸu</h3>
  <div id="queueList" class="small">Kuyruk boÅŸ.</div>
</div></div>

<!-- Admin giriÅŸi -->
<div id="sheetAdmin" class="sheet"><div class="panel">
  <h3>YÃ¶netici GiriÅŸi</h3>
  <div class="grid-2">
    <div><label>Admin Telefon</label><input id="adminPhone" value="+905356749243"></div>
    <div><label>Åifre</label><input id="adminPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
  </div>
  <div class="actions" style="margin-top:8px">
    <button class="btn btn-primary" id="adminLoginBtn">GiriÅŸ Yap</button>
    <button class="btn" id="adminLogoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
    <span id="adminStatus" class="small"></span>
  </div>
</div></div>

<!-- MÃ¼ÅŸteri giriÅŸi -->
<div id="sheetCust" class="sheet"><div class="panel">
  <h3>MÃ¼ÅŸteri GiriÅŸi / KayÄ±t</h3>
  <div class="grid-2">
    <div><label>Ad Soyad</label><input id="c_name" placeholder="Ad Soyad"></div>
    <div><label>Telefon</label><input id="c_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
  </div>
  <div class="grid-2">
    <div><label>Åifre</label><input id="c_pwd" type="password" placeholder="En az 4 karakter"></div>
    <div><label style="visibility:hidden">-</label><button class="btn btn-primary" id="c_login">GiriÅŸ / KayÄ±t</button></div>
  </div>
  <p class="small">Åifreni unuttuysan lÃ¼tfen salondan admin ile iletiÅŸime geÃ§.</p>
  <p class="small" id="c_status"></p>
</div></div>

<!-- MÃ¼ÅŸteri randevularÄ±m -->
<div id="sheetMyAppts" class="sheet"><div class="panel">
  <h3>RandevularÄ±m</h3>
  <div class="actions" style="gap:8px;flex-wrap:wrap;margin-bottom:6px">
    <select id="my_filter" style="max-width:200px">
      <option value="upcoming">YaklaÅŸan</option>
      <option value="all">TÃ¼mÃ¼</option>
      <option value="past">GeÃ§miÅŸ</option>
    </select>
    <button class="btn" id="my_refresh">Yenile</button>
  </div>
  <div class="table-scroll">
    <table>
      <thead><tr><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
      <tbody id="my_tbody"></tbody>
    </table>
  </div>
  <p class="small">â€œDeÄŸiÅŸtirâ€ sonrasÄ± randevu tekrar onaya dÃ¼ÅŸer.</p>
</div></div>

<!-- DeÄŸiÅŸtir sheet -->
<div id="sheetResched" class="sheet"><div class="panel">
  <h3>Randevuyu DeÄŸiÅŸtir</h3>
  <div class="grid-2">
    <div><label>Tarih</label><input type="date" id="rs_date"></div>
    <div><label>Saat SeÃ§imi</label><div id="rs_grid" class="slotgrid"></div></div>
  </div>
  <div class="actions" style="margin-top:10px">
    <button class="btn btn-primary" id="rs_save">Kaydet</button>
    <button class="btn" id="rs_cancel">VazgeÃ§</button>
    <span id="rs_status" class="small"></span>
  </div>
</div></div>

<!-- YÃ¶netim (yalnÄ±z admin) -->
<div id="sheetManage" class="sheet"><div class="panel">
  <h3>YÃ¶netim</h3>

  <div class="grid-2">
    <section class="card" style="padding:12px">
      <h4>Ustalar</h4>
      <div class="actions" style="gap:8px">
        <input id="newStaffName" placeholder="Yeni usta adÄ±">
        <button class="btn" id="addStaff">Ekle</button>
      </div>
      <ul id="staffList" class="small"></ul>
    </section>

    <section class="card" style="padding:12px">
      <h4>Hizmetler</h4>
      <div class="actions" style="gap:8px;flex-wrap:wrap">
        <input id="newSvcName" placeholder="Hizmet adÄ±">
        <input id="newSvcDur" type="number" placeholder="SÃ¼re (dk)" style="max-width:120px">
        <input id="newSvcPrice" type="number" placeholder="Fiyat (TL)" style="max-width:120px">
        <button class="btn" id="addSvc">Ekle</button>
      </div>
      <ul id="svcList" class="small"></ul>
    </section>
  </div>

  <!-- Usta Ã§alÄ±ÅŸma saatleri (Ã§ift aralÄ±k) -->
  <section class="card" style="padding:12px;margin-top:10px">
    <h4>Usta Ã‡alÄ±ÅŸma Saatleri (Ã–ÄŸle ArasÄ± Destekli)</h4>
    <div><label>Usta</label><select id="wh_staff"></select></div>
    <div id="wh_days" class="actions" style="flex-wrap:wrap;margin-top:8px"></div>
    <div class="actions" style="margin-top:8px">
      <button class="btn btn-primary" id="saveWorkHours">Kaydet</button>
      <span id="wh_status" class="small"></span>
    </div>

    <div class="actions" style="gap:8px;margin-top:12px">
      <input type="date" id="offDate">
      <button class="btn" id="addOff">Tatil/Ä°zin Ekle</button>
    </div>
    <div id="offList" class="actions" style="flex-wrap:wrap;margin-top:8px"></div>
  </section>

  <!-- Yeni randevu -->
  <section class="card" style="padding:12px;margin-top:10px">
    <h4>Yeni Randevu (Admin)</h4>
    <div class="grid-2">
      <div><label>Ad Soyad</label><input id="a_name" placeholder="MÃ¼ÅŸteri adÄ±"></div>
      <div><label>Telefon</label><input id="a_phone" placeholder="+90â€¦ / 05â€¦"></div>
      <div><label>Hizmet</label><select id="a_service"></select></div>
      <div><label>Usta</label><select id="a_staff"></select></div>
      <div><label>Tarih</label><input type="date" id="a_date"></div>
      <div><label>Saat SeÃ§imi</label><div id="a_grid" class="slotgrid"></div></div>
    </div>
    <div class="actions" style="margin-top:8px">
      <button class="btn btn-primary" id="a_create">Randevu OluÅŸtur (OnaylÄ±)</button>
      <span id="a_status" class="small"></span>
    </div>
  </section>

  <!-- MÃ¼ÅŸteriler (Toplu iÅŸlemler) -->
  <section class="card" style="padding:12px;margin-top:10px">
    <h4>MÃ¼ÅŸteriler (Toplu Ä°ÅŸlem)</h4>
    <div class="actions" style="gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <input id="custSearch" placeholder="Ä°sim/Telefon ara" style="max-width:320px">
      <label class="small"><input type="checkbox" id="custAll" style="width:auto"> TÃ¼mÃ¼nÃ¼ SeÃ§</label>
      <button class="btn" id="custDeleteSel">SeÃ§ilileri Sil</button>
      <button class="btn" id="custRefresh">Yenile</button>
    </div>
    <div class="table-scroll">
      <table>
        <thead><tr><th></th><th>Ad</th><th>Telefon</th><th>KayÄ±t</th><th>Son GiriÅŸ</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="custTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- Randevular (Toplu iÅŸlemler) -->
  <section class="card" style="padding:12px;margin-top:10px">
    <h4>Randevular (Toplu Ä°ÅŸlem)</h4>
    <div class="actions" style="gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <input type="date" id="ap_fdate" style="max-width:180px">
      <select id="ap_fstaff" style="max-width:220px"><option value="">TÃ¼m Ustalar</option></select>
      <select id="ap_fstatus" style="max-width:200px">
        <option value="">TÃ¼m Durumlar</option>
        <option value="pending">Beklemede</option>
        <option value="approved">OnaylandÄ±</option>
        <option value="cancelled">Ä°ptal</option>
        <option value="rejected">Reddedildi</option>
      </select>
      <label class="small"><input type="checkbox" id="ap_all" style="width:auto"> TÃ¼mÃ¼nÃ¼ SeÃ§</label>
      <button class="btn" id="ap_bulkApprove">SeÃ§ilileri Onayla</button>
      <button class="btn" id="ap_bulkReject">SeÃ§ilileri Reddet</button>
      <button class="btn" id="ap_bulkCancel">SeÃ§ilileri Ä°ptal</button>
      <button class="btn" id="ap_bulkDelete">SeÃ§ilileri Sil</button>
      <button class="btn" id="ap_refresh">Yenile</button>
    </div>
    <div class="table-scroll">
      <table>
        <thead><tr><th></th><th>Tarih</th><th>Saat</th><th>MÃ¼ÅŸteri</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="ap_tbody"></tbody>
      </table>
    </div>
  </section>
</div></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const store={get(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}},del(k){try{localStorage.removeItem(k)}catch(e){}};
function toast(m,ms=2200){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);}
const toMin=t=>{const[h,m]=t.split(':').map(Number);return h*60+m}, toHHMM=m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
function overlaps(aS,aE,bS,bE){return aS<bE && aE>bS}
function maskTR(p){if(!p) return ''; if(p.startsWith('+90')&&p.length===13){const n=p.slice(3);return `0${n.slice(0,3)} ${n.slice(3,6)} ${n.slice(6,8)} ${n.slice(8,10)}`} return p}
function toE164(raw){if(!raw) return null; let s=String(raw).trim().replace(/[()\-.\s]/g,''); if(s.startsWith('+')) return s; if(s.startsWith('05')) return '+90'+s.slice(1); if(s.startsWith('5')&&s.length===10) return '+90'+s; return null}

/* ===== Firebase ===== */
firebase.initializeApp({
  apiKey:"AIzaSyBtSQ9_5R42BU5ga0cOt1QETkC5nOf2tW4",
  authDomain:"randevu-81305.firebaseapp.com",
  projectId:"randevu-81305",
  storageBucket:"randevu-81305.firebasestorage.app",
  messagingSenderId:"686048709577",
  appId:"1:686048709577:web:b2db4eeae83203ca2e3618",
  measurementId:"G-3ZX91ND545"
});
const db=firebase.firestore();

/* ===== Globals ===== */
const ADMIN_PHONE_E164='+905356749243';
const ADMIN_PASSWORD='ahmet07';
let adminOn=false, currentUser=store.get('custSession',null);
let lastStaff=[], lastSvcs=[], lastAppts=[];
let unsubStaff=null, unsubSvcs=null, unsubAppts=null;
let _rs=null, myPrevStatus={}, myUnread=0;

/* ===== Sheets ===== */
const sheet={show:id=>{ $(id).classList.add('show'); document.body.style.overflow='hidden'; }, hide:id=>{ $(id).classList.remove('show'); document.body.style.overflow=''; }};
['#sheetBell','#sheetAdmin','#sheetCust','#sheetMyAppts','#sheetResched','#sheetManage'].forEach(id=>$(id).addEventListener('click',e=>{ if(e.target===e.currentTarget) sheet.hide(id); }));
$('#adminOpen').onclick=()=>sheet.show('#sheetAdmin');
$('#custOpen').onclick =()=>sheet.show('#sheetCust');
$('#bellBtn').onclick  =()=>sheet.show('#sheetBell');
$('#manageOpen').onclick=()=>sheet.show('#sheetManage');
$('#myApptsOpen').onclick=()=>{ sheet.show('#sheetMyAppts'); myUnread=0; $('#myBadge').style.display='none'; };

/* ===== Visibility ===== */
function setAdmin(on){adminOn=!!on; $('#bellBtn').style.display=on?'inline-flex':'none'; $('#kpi').style.display=on?'grid':'none'; $('#manageOpen').style.display=on?'inline-flex':'none';}
function setCust(on){ $('#myApptsOpen').style.display=on?'inline-flex':'none';}
setAdmin(store.get('adminSession')==='on' && store.get('adminPhone')===ADMIN_PHONE_E164);
setCust(!!currentUser);

/* ===== Realtime ===== */
function startRealtime(){
  if(unsubStaff)unsubStaff(); if(unsubSvcs)unsubSvcs(); if(unsubAppts)unsubAppts();

  unsubStaff=db.collection('staff').onSnapshot(ss=>{
    lastStaff=ss.docs.map(d=>({id:d.id,...d.data()}));
    fillStaff(); renderStaffList(); renderWorkHoursEditor(); renderOffList(); computeSlots(); fillAdminCreate();
    if(_rs) computeResched();
  });
  unsubSvcs=db.collection('services').onSnapshot(ss=>{
    lastSvcs=ss.docs.map(d=>({id:d.id,...d.data()}));
    fillServices(); renderServiceList(); computeSlots(); fillAdminCreate();
  });
  unsubAppts=db.collection('appts').onSnapshot(ss=>{
    lastAppts=ss.docs.map(d=>({id:d.id,...d.data()}));
    computeSlots(lastAppts); renderQueue(lastAppts); updateKpi(lastAppts); renderMy(lastAppts); renderAdminAppts(lastAppts);
    if(_rs) computeResched();

    // MÃ¼ÅŸteri toast + rozet (TR)
    if(currentUser){
      const mine=lastAppts.filter(a=>a.phone===currentUser.phone);
      mine.forEach(a=>{
        const prev=myPrevStatus[a.id];
        if(prev && prev==='pending'){
          if(a.status==='approved') { toast(`âœ… Randevunuz onaylandÄ± â€¢ ${a.date} ${a.time}`); myUnread++; }
          else if(a.status==='rejected'){ toast(`â›” Randevunuz reddedildi â€¢ ${a.date} ${a.time}`); myUnread++; }
          else if(a.status==='cancelled'){ toast(`â„¹ï¸ Randevunuz iptal edildi â€¢ ${a.date} ${a.time}`); myUnread++; }
        }
        myPrevStatus[a.id]=a.status;
      });
      if(myUnread>0){ const b=$('#myBadge'); b.style.display='inline-flex'; b.textContent=String(myUnread); }
    }
  });
}
startRealtime();

/* ===== Fillers ===== */
function fillStaff(){
  const sel=$('#f_staff'); const cur=sel.value;
  sel.innerHTML='<option disabled selected>â€” SeÃ§iniz â€”</option>'+lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  if(lastStaff.some(s=>s.id===cur)) sel.value=cur;
  $('#wh_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#ap_fstaff').innerHTML='<option value="">TÃ¼m Ustalar</option>'+lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
function fillServices(){
  const sel=$('#f_service'); const cur=sel.value;
  sel.innerHTML='<option disabled selected>â€” SeÃ§iniz â€”</option>'+lastSvcs.map(s=>`<option value="${s.id}">${s.name} â€” ${s.dur} dk</option>`).join('');
  if(lastSvcs.some(s=>s.id===cur)) sel.value=cur;
}
function fillAdminCreate(){
  $('#a_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#a_service').innerHTML=lastSvcs.map(s=>`<option value="${s.id}">${s.name} â€” ${s.dur} dk</option>`).join('');
}

/* ===== Hours & conflicts (Ã§ift aralÄ±k) ===== */
function conflicts(appts,date,staffId){
  return (appts||[]).filter(a=>a.date===date&&a.staffId===staffId&&a.status!=='cancelled'&&a.status!=='rejected')
    .map(a=>({start:toMin(a.time), end:toMin(a.time)+(a.duration||30)}));
}
function spansFor(staff,dateISO){
  const dow=new Date(dateISO+'T00:00:00').getDay();
  const d=(staff?.hoursByDay||{})[dow] || staff?.hours || {};
  const s=[];
  if(d.open1 && d.close1){ s.push({start:d.open1,end:d.close1}); }
  if(d.open2 && d.close2){ s.push({start:d.open2,end:d.close2}); }
  if(s.length===0 && d.open && d.close){ s.push({start:d.open,end:d.close}); }
  return s;
}

/* ===== Grid render (30 dk) ===== */
function renderGrid(containerId, staff, svcDur, date){
  const box=document.getElementById(containerId); box.innerHTML='';
  if(!staff||!svcDur||!date) return;
  const spans=spansFor(staff,date);
  const taken=conflicts(lastAppts,date,staff.id);
  const works = !((staff.offDates||[]).includes?.(date)) && (!staff.days || staff.days.includes(new Date(date+'T00:00:00').getDay()));
  const step=30; // :00 / :30
  spans.forEach(sp=>{
    const openM=toMin(sp.start), closeM=toMin(sp.end);
    for(let t=openM; t+svcDur<=closeM; t+=step){
      const time=toHHMM(t);
      const busy=!works || taken.some(x=>overlaps(t,t+svcDur,x.start,x.end));
      const b=document.createElement('button');
      b.type='button'; b.className='slot-item'+(busy?' busy':''); b.textContent=time; b.dataset.time=time;
      b.onclick=()=>{ if(busy) return; [...box.querySelectorAll('.slot-item')].forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); };
      box.appendChild(b);
    }
  });
}
function getSelected(containerId){ return document.querySelector(`#${containerId} .slot-item.sel`)?.dataset.time||null; }

/* ===== Compute Slots ===== */
function computeSlots(){
  const staffId=$('#f_staff').value, svcId=$('#f_service').value, date=$('#f_date').value;
  if(!staffId||!svcId||!date) { $('#slotgrid').innerHTML=''; return; }
  const staff=lastStaff.find(s=>s.id===staffId); if(!staff) return;
  const svc  =lastSvcs .find(s=>s.id===svcId);   if(!svc)   return;
  renderGrid('slotgrid',staff,svc.dur||30,date);
}
function computeResched(){ if(!_rs) return; const staff=lastStaff.find(s=>s.id===_rs.staffId); if(!staff) return; renderGrid('rs_grid',staff,_rs.duration,_rs.date); }

/* ===== Listeners ===== */
$('#f_staff').onchange=computeSlots; $('#f_service').onchange=computeSlots; $('#f_date').onchange=computeSlots;
$('#f_date').value=new Date().toISOString().slice(0,10);

/* ===== Booking (mÃ¼ÅŸteri) ===== */
$('#f_book').onclick=async ()=>{
  const name=$('#f_name').value.trim(), phoneRaw=$('#f_phone').value.trim();
  const staffId=$('#f_staff').value, svcId=$('#f_service').value, date=$('#f_date').value;
  const time=getSelected('slotgrid');
  if(!name||!phoneRaw||!staffId||!svcId||!date||!time){ $('#f_status').textContent='LÃ¼tfen tÃ¼m alanlarÄ± doldurun.'; toast('Eksik bilgi'); return; }
  const phone=toE164(phoneRaw); if(!phone){ toast('Telefon formatÄ± geÃ§ersiz'); return; }

  // aynÄ± gÃ¼n max 2 aktif (admin dÄ±ÅŸÄ±)
  const same=await db.collection('appts').where('phone','==',phone).where('date','==',date).get();
  const activeCnt=same.docs.map(d=>d.data()).filter(a=>a.status==='pending'||a.status==='approved').length;
  if(activeCnt>=2){ toast('AynÄ± gÃ¼n en fazla 2 aktif randevu'); return; }

  try{
    // user bul/oluÅŸtur + kalÄ±cÄ± giriÅŸ
    let uid=null; const uq=await db.collection('users').where('phone','==',phone).limit(1).get();
    if(uq.empty){ const uref=await db.collection('users').add({name,phone,password:'set-on-first',createdAt:Date.now(),lastLogin:Date.now()}); uid=uref.id; }
    else{ uid=uq.docs[0].id; await db.collection('users').doc(uid).set({name,lastLogin:Date.now()},{merge:true}); }
    currentUser={id:uid,name,phone}; store.set('custSession',currentUser); setCust(true);

    const svc=(await db.collection('services').doc(svcId).get()).data();
    const st =(await db.collection('staff').doc(staffId).get()).data();

    await db.collection('appts').add({
      userId:uid,name,phone,serviceId:svcId,serviceName:svc?.name||'Hizmet',duration:svc?.dur||30,price:svc?.price||0,
      staffId,staffName:st?.name||'Usta',date,time,status:'pending',createdAt:Date.now()
    });
    $('#f_status').textContent='Randevu alÄ±ndÄ± (beklemede).'; toast('Randevu oluÅŸturuldu (beklemede)');
    myPrevStatus = myPrevStatus || {};
  }catch(e){ console.error(e); toast('Hata: Firestore izinleri?'); }
};

/* ===== Admin: bildirim & kuyruk ===== */
function updateBell(list){
  const pendCnt=(list||[]).filter(a=>a.status==='pending').length;
  $('#bellCount').textContent=String(pendCnt);
  if(adminOn && pendCnt>0) $('#bellBtn').classList.add('blink'); else $('#bellBtn').classList.remove('blink');
}
function renderQueue(list){
  const box=$('#queueList');
  const rows=(list||[]).filter(a=>a.status==='pending').sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  if(rows.length===0){ box.textContent='Kuyruk boÅŸ.'; return; }
  box.innerHTML=rows.map(a=>`
   <div style="display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0">
     <div style="flex:1 1 auto;min-width:0"><b>${a.date} ${a.time}</b> â€¢ ${a.name} â€¢ ${a.serviceName} / ${a.staffName}</div>
     <button class="btn" onclick="approve('${a.id}')">Onayla</button>
     <button class="btn" onclick="reject('${a.id}')">Reddet</button>
     <button class="btn" onclick="delAppt('${a.id}')">Sil</button>
   </div>`).join('');
}
window.approve=async(id)=>{try{await db.collection('appts').doc(id).set({status:'approved'},{merge:true});toast('Randevu onaylandÄ±');}catch(e){toast('Hata');}}
window.reject =async(id)=>{try{await db.collection('appts').doc(id).set({status:'rejected'},{merge:true});toast('Randevu reddedildi');}catch(e){toast('Hata');}}
window.delAppt=async(id)=>{if(!confirm('Silinsin mi?'))return;try{await db.collection('appts').doc(id).delete();toast('Silindi');}catch(e){toast('Hata');}}

/* ===== KPI ===== */
function updateKpi(list){
  if(!adminOn) return;
  const today=new Date().toISOString().slice(0,10);
  const d=list.filter(a=>a.date===today);
  $('#kpiToday').textContent=String(d.length);
  $('#kpiOBI').textContent=[d.filter(a=>a.status==='approved').length,d.filter(a=>a.status==='pending').length,d.filter(a=>a.status==='cancelled').length].join('/');
  const now=new Date(); const ws=new Date(now); ws.setDate(now.getDate()-now.getDay()); const we=new Date(ws); we.setDate(ws.getDate()+6);
  const inWeek=list.filter(a=>a.status!=='rejected' && a.date>=ws.toISOString().slice(0,10) && a.date<=we.toISOString().slice(0,10));
  $('#kpiWeek').textContent=String(inWeek.length);
}

/* ===== YÃ¶netim: Ustalar/Hizmetler/Ã‡alÄ±ÅŸma Saatleri ===== */
function renderStaffList(){
  $('#staffList').innerHTML=(lastStaff||[]).sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr')).map(s=>`
    <li style="display:flex;align-items:center;gap:8px;margin:6px 0">
      <span style="flex:1">${s.name}</span>
      <button class="btn" onclick="delStaff('${s.id}')">Sil</button>
    </li>`).join('') || 'â€”';
  $('#wh_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  renderWorkHoursEditor();
}
window.delStaff=async(id)=>{ try{await db.collection('staff').doc(id).delete(); toast('Usta silindi');}catch(e){toast('Hata: Usta silinemedi');} };
$('#addStaff').onclick=async()=>{
  const name=$('#newStaffName').value.trim(); if(!name){toast('Usta adÄ± gerekli');return;}
  try{
    await db.collection('staff').add({name,days:[1,2,3,4,5,6],hours:{open1:'09:00',close1:'19:00'},offDates:[],hoursByDay:{}}); // Ã¶rnek
    $('#newStaffName').value=''; toast('Usta eklendi');
  }catch(e){ toast('Hata: Usta eklenemedi'); }
};

function renderServiceList(){
  $('#svcList').innerHTML=(lastSvcs||[]).sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr')).map(s=>`
    <li style="display:flex;align-items:center;gap:8px;margin:6px 0">
      <span style="flex:1">${s.name} â€” ${s.dur} dk / ${s.price||0} TL</span>
      <button class="btn" onclick="delSvc('${s.id}')">Sil</button>
    </li>`).join('') || 'â€”';
}
window.delSvc=async(id)=>{ try{await db.collection('services').doc(id).delete(); toast('Hizmet silindi');}catch(e){toast('Hata: Hizmet silinemedi');} };
$('#addSvc').onclick=async()=>{
  const name=$('#newSvcName').value.trim(), dur=parseInt($('#newSvcDur').value||'30',10), price=parseInt($('#newSvcPrice').value||'0',10);
  if(!name){toast('Hizmet adÄ± gerekli');return;}
  try{
    await db.collection('services').add({name,dur,price});
    $('#newSvcName').value=''; $('#newSvcDur').value=''; $('#newSvcPrice').value='';
    toast('Hizmet eklendi');
  }catch(e){ toast('Hata: Hizmet eklenemedi'); }
};

const DAY_LABELS=['Paz','Pzt','Sal','Ã‡ar','Per','Cum','Cmt'];
function renderWorkHoursEditor(){
  const wrap=$('#wh_days'); wrap.innerHTML='';
  const sid=$('#wh_staff').value || (lastStaff[0]?.id||''); $('#wh_staff').value=sid;
  const staff=lastStaff.find(s=>s.id===sid); if(!staff) return;

  // GÃ¼n kartlarÄ±: Ã‡alÄ±ÅŸÄ±yor? AÃ§1â€“Kapa1 / AÃ§2â€“Kapa2
  for(let i=0;i<7;i++){
    const byDay=(staff.hoursByDay||{})[i]||{};
    const working = (staff.days||[1,2,3,4,5,6]).includes(i);
    const open1=byDay.open1||byDay.open||staff.hours?.open1||staff.hours?.open||'09:00';
    const close1=byDay.close1||byDay.close||staff.hours?.close1||staff.hours?.close||'19:00';
    const open2=byDay.open2||staff.hours?.open2||'';
    const close2=byDay.close2||staff.hours?.close2||'';

    const card=document.createElement('div');
    card.style.cssText='display:flex;flex-wrap:wrap;gap:8px;border:1px solid var(--line);border-radius:12px;padding:8px';
    card.innerHTML=`
      <label class="small" style="min-width:60px"><input type="checkbox" data-dow="${i}" ${working?'checked':''} style="width:auto;margin-right:6px">${DAY_LABELS[i]}</label>
      <input type="time" data-dow="${i}" data-k="open1" value="${open1}" style="max-width:120px">
      <span>â€“</span>
      <input type="time" data-dow="${i}" data-k="close1" value="${close1}" style="max-width:120px">
      <span style="width:12px"></span>
      <input type="time" data-dow="${i}" data-k="open2" value="${open2}" style="max-width:120px" placeholder="Ã–rn 13:00">
      <span>â€“</span>
      <input type="time" data-dow="${i}" data-k="close2" value="${close2}" style="max-width:120px" placeholder="Ã–rn 15:00">
    `;
    wrap.appendChild(card);
  }
}
$('#wh_staff').addEventListener('change', renderWorkHoursEditor);

$('#saveWorkHours').onclick=async()=>{
  const sid=$('#wh_staff').value; if(!sid){toast('Usta seÃ§iniz');return;}
  const days=[...document.querySelectorAll('#wh_days input[type="checkbox"]')].filter(x=>x.checked).map(x=>parseInt(x.dataset.dow,10));
  const hoursByDay={};
  [...document.querySelectorAll('#wh_days input[type="time"]')].forEach(inp=>{
    const i=parseInt(inp.dataset.dow,10), k=inp.dataset.k; hoursByDay[i]=hoursByDay[i]||{}; hoursByDay[i][k]=inp.value||'';
  });
  try{
    await db.collection('staff').doc(sid).set({days,hoursByDay},{merge:true});
    $('#wh_status').textContent='Kaydedildi.'; toast('Ã‡alÄ±ÅŸma saatleri kaydedildi');
  }catch(e){ toast('Hata: Ã‡alÄ±ÅŸma saatleri kaydedilemedi'); }
};

function renderOffList(){
  const sid=$('#wh_staff').value; const staff=lastStaff.find(s=>s.id===sid); if(!staff) return;
  const wrap=$('#offList'); wrap.innerHTML='';
  (staff.offDates||[]).sort().forEach(d=>{
    const chip=document.createElement('span');
    chip.className='badge'; chip.textContent=d+' ';
    const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Sil';
    btn.onclick=async()=>{ const list=(staff.offDates||[]).filter(x=>x!==d); await db.collection('staff').doc(sid).set({offDates:list},{merge:true}); toast('Ä°zin silindi'); };
    chip.appendChild(btn); wrap.appendChild(chip);
  });
}
$('#addOff').onclick=async()=>{ const sid=$('#wh_staff').value, d=$('#offDate').value; if(!sid||!d) return; const staff=lastStaff.find(s=>s.id===sid)||{}; const set=new Set(staff.offDates||[]); set.add(d); await db.collection('staff').doc(sid).set({offDates:[...set]},{merge:true}); toast('Ä°zin eklendi'); renderOffList(); };

/* ===== Admin: yeni randevu (onaylÄ±) ===== */
function fillAdminCreate(){ $('#a_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); $('#a_service').innerHTML=lastSvcs.map(s=>`<option value="${s.id}">${s.name} â€” ${s.dur} dk</option>`).join(''); }
function renderAdminGrid(){ const sid=$('#a_staff').value, svcId=$('#a_service').value, date=$('#a_date').value; const staff=lastStaff.find(s=>s.id===sid), svc=lastSvcs.find(s=>s.id===svcId); if(staff&&svc&&date) renderGrid('a_grid',staff,svc.dur||30,date); else $('#a_grid').innerHTML=''; }
$('#a_staff').onchange=renderAdminGrid; $('#a_service').onchange=renderAdminGrid; $('#a_date').onchange=renderAdminGrid;

$('#a_create').onclick=async()=>{
  const name=$('#a_name').value.trim(), phoneRaw=$('#a_phone').value.trim(); const phone=toE164(phoneRaw);
  const svcId=$('#a_service').value, staffId=$('#a_staff').value, date=$('#a_date').value, time=getSelected('a_grid');
  if(!name||!phone||!svcId||!staffId||!date||!time){ $('#a_status').textContent='Eksik bilgi'; toast('Eksik bilgi'); return; }
  try{
    let uid=null; const q=await db.collection('users').where('phone','==',phone).limit(1).get();
    if(q.empty){ const uref=await db.collection('users').add({name,phone,password:'set-by-admin',createdAt:Date.now()}); uid=uref.id; } else { uid=q.docs[0].id; }
    const svc=(await db.collection('services').doc(svcId).get()).data();
    const st =(await db.collection('staff').doc(staffId).get()).data();
    await db.collection('appts').add({userId:uid,name,phone,serviceId:svcId,serviceName:svc?.name||'Hizmet',duration:svc?.dur||30,price:svc?.price||0,staffId,staffName:st?.name||'Usta',date,time,status:'approved',createdAt:Date.now()});
    $('#a_status').textContent='OnaylÄ± randevu oluÅŸturuldu'; toast('OnaylÄ± randevu oluÅŸturuldu'); renderAdminGrid();
  }catch(e){ console.error(e); $('#a_status').textContent='Hata'; toast('Hata: Firestore'); }
};

/* ===== MÃ¼ÅŸteriler (liste + toplu) ===== */
function renderCustomers(list){
  const term = ($('#custSearch')?.value||'').trim().toLowerCase();
  const tb=$('#custTbody'); if(!tb) return;
  const rows=(list||[])
    .filter(u=>{ if(!term) return true; const name=(u.name||'').toLowerCase(), phone=(u.phone||'').toLowerCase(); return name.includes(term)||phone.includes(term); })
    .sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr'));
  tb.innerHTML = rows.map(u=>`
    <tr>
      <td><input type="checkbox" class="chk-cust" data-id="${u.id}"></td>
      <td>${u.name||''}</td>
      <td>${maskTR(u.phone)||''}</td>
      <td>${u.createdAt?new Date(u.createdAt).toLocaleString():'-'}</td>
      <td>${u.lastLogin?new Date(u.lastLogin).toLocaleString():'-'}</td>
      <td><button class="btn" onclick="delUser('${u.id}')">Sil</button></td>
    </tr>`).join('') || `<tr><td colspan="6" class="small">MÃ¼ÅŸteri yok</td></tr>`;
}
function refreshCustomers(){ db.collection('users').get().then(ss=>renderCustomers(ss.docs.map(d=>({id:d.id,...d.data()})))); }
$('#custRefresh').onclick=refreshCustomers;
$('#custSearch').addEventListener('input', refreshCustomers);
$('#custAll').addEventListener('change',e=>$$('#custTbody .chk-cust').forEach(c=>c.checked=e.target.checked));
$('#custDeleteSel').onclick=async()=>{ const ids=[...document.querySelectorAll('#custTbody .chk-cust:checked')].map(x=>x.dataset.id); if(ids.length===0) return toast('SeÃ§im yok'); if(!confirm(`${ids.length} mÃ¼ÅŸteri silinsin mi?`)) return; for(const id of ids){ await db.collection('users').doc(id).delete(); } toast('SeÃ§ililer silindi'); refreshCustomers(); };
window.delUser=async(id)=>{ if(!confirm('Bu mÃ¼ÅŸteriyi silmek istiyor musunuz?')) return; try{ await db.collection('users').doc(id).delete(); toast('MÃ¼ÅŸteri silindi'); refreshCustomers(); }catch(e){ toast('Hata: MÃ¼ÅŸteri silinemedi'); } };

/* ===== Randevular (liste + toplu) ===== */
function renderAdminAppts(list){
  const tb=$('#ap_tbody'); if(!tb) return;
  const fdate=$('#ap_fdate').value||''; const fstaff=$('#ap_fstaff').value||''; const fstat=$('#ap_fstatus').value||'';
  let rows=(list||[]);
  if(fdate) rows=rows.filter(a=>a.date===fdate);
  if(fstaff)rows=rows.filter(a=>a.staffId===fstaff);
  if(fstat) rows=rows.filter(a=>a.status===fstat);
  rows=rows.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  tb.innerHTML=rows.map(a=>`
    <tr>
      <td><input type="checkbox" class="chk-appt" data-id="${a.id}"></td>
      <td>${a.date}</td><td>${a.time}</td>
      <td>${a.name} (${maskTR(a.phone)})</td>
      <td>${a.serviceName||''}</td>
      <td>${a.staffName||''}</td>
      <td>${a.status}</td>
      <td class="actions" style="gap:6px">
        ${a.status==='pending'?`<button class="btn" onclick="approve('${a.id}')">Onayla</button>
                                 <button class="btn" onclick="reject('${a.id}')">Reddet</button>`:''}
        ${a.status==='approved'?`<button class="btn" onclick="cancelApptSingle('${a.id}')">Ä°ptal</button>`:''}
        <button class="btn" onclick="delAppt('${a.id}')">Sil</button>
      </td>
    </tr>`).join('') || `<tr><td colspan="8" class="small">Randevu yok</td></tr>`;
}
$('#ap_refresh').onclick=()=>renderAdminAppts(lastAppts);
$('#ap_fdate').onchange=()=>renderAdminAppts(lastAppts);
$('#ap_fstaff').onchange=()=>renderAdminAppts(lastAppts);
$('#ap_fstatus').onchange=()=>renderAdminAppts(lastAppts);
window.cancelApptSingle=async(id)=>{try{await db.collection('appts').doc(id).set({status:'cancelled'},{merge:true});toast('Ä°ptal edildi');}catch(e){toast('Hata');}}
$('#ap_all').addEventListener('change',e=>$$('#ap_tbody .chk-appt').forEach(c=>c.checked=e.target.checked));
async function bulk(ids,patch){for(const id of ids){await db.collection('appts').doc(id).set(patch,{merge:true});}}
$('#ap_bulkApprove').onclick=async()=>{const ids=[...document.querySelectorAll('#ap_tbody .chk-appt:checked')].map(x=>x.dataset.id); if(!ids.length) return toast('SeÃ§im yok'); await bulk(ids,{status:'approved'}); toast('OnaylandÄ±');}
$('#ap_bulkReject').onclick =async()=>{const ids=[...document.querySelectorAll('#ap_tbody .chk-appt:checked')].map(x=>x.dataset.id); if(!ids.length) return toast('SeÃ§im yok'); await bulk(ids,{status:'rejected'}); toast('Reddedildi');}
$('#ap_bulkCancel').onclick =async()=>{const ids=[...document.querySelectorAll('#ap_tbody .chk-appt:checked')].map(x=>x.dataset.id); if(!ids.length) return toast('SeÃ§im yok'); await bulk(ids,{status:'cancelled'}); toast('Ä°ptal edildi');}
$('#ap_bulkDelete').onclick =async()=>{const ids=[...document.querySelectorAll('#ap_tbody .chk-appt:checked')].map(x=>x.dataset.id); if(!ids.length) return toast('SeÃ§im yok'); if(!confirm(`${ids.length} randevu silinsin mi?`)) return; for(const id of ids){ await db.collection('appts').doc(id).delete(); } toast('Silindi');}

/* ===== MÃ¼ÅŸteri â€¢ RandevularÄ±m ===== */
function renderMy(list){
  const tb=$('#my_tbody'); if(!tb) return;
  if(!currentUser){ tb.innerHTML = `<tr><td colspan="6" class="small">LÃ¼tfen mÃ¼ÅŸteri giriÅŸi yapÄ±n.</td></tr>`; return; }
  const todayISO = new Date().toISOString().slice(0,10);
  const filt = ($('#my_filter')?.value || 'upcoming');
  let rows = (list||[]).filter(a => a.phone === currentUser.phone);
  if(filt === 'upcoming'){ rows = rows.filter(a => a.date >= todayISO); }
  else if(filt === 'past'){ rows = rows.filter(a => a.date < todayISO); }
  rows = rows.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  tb.innerHTML = rows.map(a=>{
    const canCancel = (a.status==='pending' || a.status==='approved');
    const btns =
      `<button class="btn" onclick="openResched('${a.id}')">DeÄŸiÅŸtir</button>`+
      (canCancel?` <button class="btn" onclick="myCancel('${a.id}')">Ä°ptal</button>`:'');
    return `<tr>
      <td>${a.date}</td><td>${a.time}</td>
      <td>${a.serviceName||''}</td><td>${a.staffName||''}</td>
      <td>${a.status}</td><td>${btns}</td>
    </tr>`;
  }).join('') || `<tr><td colspan="6" class="small">Randevu bulunamadÄ±</td></tr>`;
}
window.myCancel = async (id)=>{
  if(!currentUser) return;
  if(!confirm('Randevunuzu iptal etmek istiyor musunuz?')) return;
  try{ await db.collection('appts').doc(id).set({status:'cancelled'},{merge:true}); toast('Randevu iptal edildi'); }
  catch(e){ toast('Hata: Ä°ptal edilemedi'); }
};
$('#my_filter').addEventListener('change', ()=>renderMy(lastAppts));
$('#my_refresh').addEventListener('click',  ()=>renderMy(lastAppts));

/* ===== MÃ¼ÅŸteri â€¢ Randevu DeÄŸiÅŸtir ===== */
async function openResched(id){
  if(!currentUser) return;
  const doc=await db.collection('appts').doc(id).get(); if(!doc.exists) return toast('Randevu bulunamadÄ±');
  const a=doc.data(); if(a.phone!==currentUser.phone) return toast('Bu iÅŸlem size ait deÄŸil');
  _rs={id, staffId:a.staffId, duration:a.duration, date:a.date};
  $('#rs_date').value=a.date; $('#rs_status').textContent='';
  computeResched(); sheet.show('#sheetResched');
}
$('#rs_date').addEventListener('change', ()=>{ if(_rs){ _rs.date=$('#rs_date').value; computeResched(); } });
$('#rs_cancel').onclick=()=>{ _rs=null; sheet.hide('#sheetResched'); };
$('#rs_save').onclick=async()=>{
  if(!_rs) return; const time=getSelected('rs_grid'); if(!time){ $('#rs_status').textContent='Saat seÃ§in'; return; }
  try{ await db.collection('appts').doc(_rs.id).set({date:_rs.date,time,status:'pending'},{merge:true}); toast('Randevu gÃ¼ncellendi (beklemede)'); _rs=null; sheet.hide('#sheetResched'); }
  catch(e){ $('#rs_status').textContent='Hata'; }
};

/* ===== Admin & Customer Login (kalÄ±cÄ±) ===== */
$('#adminLoginBtn').onclick=()=>{
  const p=$('#adminPhone').value.trim(), s=$('#adminPass').value.trim();
  if(p===ADMIN_PHONE_E164 && s===ADMIN_PASSWORD){
    setAdmin(true); store.set('adminSession','on'); store.set('adminPhone',p); $('#adminStatus').textContent='GiriÅŸ baÅŸarÄ±lÄ±'; sheet.hide('#sheetAdmin'); toast('Admin olarak giriÅŸ yapÄ±ldÄ±');
  }else{ $('#adminStatus').textContent='Bilgiler hatalÄ±'; }
};
$('#adminLogoutBtn').onclick=()=>{
  setAdmin(false); store.del('adminSession'); store.del('adminPhone'); $('#adminStatus').textContent='Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±'; toast('Admin oturumu kapatÄ±ldÄ±');
};

$('#c_login').onclick=async()=>{
  const name=$('#c_name').value.trim(), phone=toE164($('#c_phone').value.trim()), pwd=$('#c_pwd').value.trim();
  if(!name||!phone||pwd.length<4){ $('#c_status').textContent='Ad/Telefon ve en az 4 karakter ÅŸifre gerekli.'; return; }
  try{
    const q=await db.collection('users').where('phone','==',phone).limit(1).get();
    let uid=null, uname=name;
    if(q.empty){ const uref=await db.collection('users').add({name,phone,password:pwd,createdAt:Date.now(),lastLogin:Date.now()}); uid=uref.id; }
    else{ const u=q.docs[0].data(); uid=q.docs[0].id; uname=u.name||name; if((u.password||'')!==pwd){ $('#c_status').textContent='Åifre hatalÄ±.'; return; } await db.collection('users').doc(uid).set({lastLogin:Date.now()},{merge:true}); }
    currentUser={id:uid,name:uname,phone}; store.set('custSession',currentUser); setCust(true);
    // mevcut randevu statÃ¼lerini cachele
    myPrevStatus={}; (lastAppts||[]).filter(a=>a.phone===currentUser.phone).forEach(a=>myPrevStatus[a.id]=a.status);
    $('#c_status').textContent='GiriÅŸ baÅŸarÄ±lÄ±.'; toast('MÃ¼ÅŸteri giriÅŸi yapÄ±ldÄ±'); setTimeout(()=>sheet.hide('#sheetCust'),300);
  }catch(err){ console.error('Login',err); $('#c_status').textContent='Sunucu hatasÄ±: Firestore kurallarÄ±nÄ± kontrol edin.'; }
};

/* ===== Ä°lk deÄŸerler ===== */
$('#f_date').value=new Date().toISOString().slice(0,10);
</script>
</body>
</html>
