<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ahmet Tekeli ‚Ä¢ Randevu (Firebase ‚Ä¢ Tek Ekran)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f5f6f9; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb;
  --card:#fff; --gold:#d4af37; --brand:#101827;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1000px;margin:0 auto;padding:0 14px}
header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:20}
.header-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.brand{display:flex;align-items:center;gap:10px}
.brand .title{font-family:Georgia,serif;font-weight:700;color:var(--brand);font-size:24px;line-height:1}
.brand .sub{font-size:12px;color:var(--muted)}
.actions{display:flex;align-items:center;gap:8px}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer}
.btn{border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn-primary{background:var(--gold);border-color:var(--gold);color:#111}
.small{font-size:12px;color:var(--muted)}

main{padding:16px 0}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
h2{margin:0 0 12px 0}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{display:block;font-weight:600;margin:0 0 6px 0}
input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px}
.slotbar{display:flex;gap:10px;overflow:auto;padding:6px 2px;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}
.slot{flex:0 0 auto;scroll-snap-align:start;min-width:74px;text-align:center;padding:8px 14px;border:1px solid var(--line);border-radius:999px;background:#fff}
.slot.dis{opacity:.45;pointer-events:none;text-decoration:line-through}
.slot.sel{background:#111827;color:#fff;border-color:#111827;box-shadow:0 4px 14px rgba(0,0,0,.18)}

.kpi{display:none;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:16px}
.kpi .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}

.sheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:flex-end;z-index:30}
.sheet.show{display:flex}
.sheet .panel{width:100%;max-height:92vh;background:#fff;border-radius:16px 16px 0 0;box-shadow:0 -12px 30px rgba(0,0,0,.25);padding:14px 14px 18px;overflow:auto}
.sheet h3{margin:4px 0 10px 0}

#toast{position:fixed;left:50%;top:-80px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:50;transition:top .45s}
#toast.show{top:12px}

/* Bildirim √ßanƒ± yanƒ±p s√∂nme */
#bellBtn{display:none}
#bellBtn.blink{animation:pulse 1s ease-in-out infinite}
@keyframes pulse{0%{filter:none}50%{filter:drop-shadow(0 0 8px #f43) saturate(1.3)}100%{filter:none}}

@media(max-width:760px){
  .grid-2{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="toast"></div>

<header>
  <div class="wrap header-row">
    <div class="brand">
      <div>
        <div class="title">AHMET TEKELƒ∞</div>
        <div class="sub">Erkek Kuaf√∂r√º</div>
      </div>
    </div>
    <div class="actions">
      <button id="bellBtn" class="badge" title="Bildirimler">üîî <span id="bellCount" class="small">0</span></button>
      <button id="adminOpen" class="badge">üë®‚Äçüíº Admin</button>
      <button id="custOpen"  class="badge">üë§ M√º≈üteri</button>
      <button id="manageOpen" class="badge" style="display:none">‚öôÔ∏è Y√∂netim</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h2>Randevu Olu≈ütur</h2>
    <div class="grid-2">
      <div>
        <label>Ad Soyad</label>
        <input id="f_name" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z">
      </div>
      <div>
        <label>Telefon</label>
        <input id="f_phone" placeholder="05xxxxxxxxx" inputmode="tel">
      </div>
    </div>
    <div class="grid-2">
      <div>
        <label>Berber</label>
        <select id="f_staff"><option disabled selected>‚Äî Se√ßiniz ‚Äî</option></select>
      </div>
      <div>
        <label>Hizmet</label>
        <select id="f_service"><option disabled selected>‚Äî Se√ßiniz ‚Äî</option></select>
      </div>
    </div>
    <div class="grid-2">
      <div>
        <label>Tarih</label>
        <input type="date" id="f_date">
      </div>
      <div>
        <label>Uygun Saatler</label>
        <div id="slotbar" class="slotbar"></div>
      </div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button class="btn btn-primary" id="f_book">RANDEVU AL</button>
      <span id="f_status" class="small"></span>
    </div>

    <!-- Admin KPI (sadece admin g√∂r√ºn√ºr) -->
    <div id="kpi" class="kpi">
      <div class="box"><div class="small">Bug√ºn</div><b id="kpiToday">0</b></div>
      <div class="box"><div class="small">Onay/Bekl/ƒ∞ptal</div><b id="kpiOBI">0/0/0</b></div>
      <div class="box"><div class="small">Haftalƒ±k</div><b id="kpiWeek">0</b></div>
    </div>
  </section>
</main>

<!-- Bildirim paneli (k√º√ß√ºk onay/red) -->
<div id="sheetBell" class="sheet" aria-hidden="true">
  <div class="panel">
    <h3>Onay Kuyruƒüu</h3>
    <div id="queueList" class="small">Kuyruk bo≈ü.</div>
  </div>
</div>

<!-- Admin giri≈üi -->
<div id="sheetAdmin" class="sheet" aria-hidden="true">
  <div class="panel">
    <h3>Y√∂netici Giri≈üi</h3>
    <div class="grid-2">
      <div><label>Admin Telefon</label><input id="adminPhone" value="+905356749243"></div>
      <div><label>≈ûifre</label><input id="adminPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    </div>
    <div class="actions" style="margin-top:8px">
      <button class="btn btn-primary" id="adminLoginBtn">Giri≈ü Yap</button>
      <button class="btn" id="adminLogoutBtn">√áƒ±kƒ±≈ü</button>
      <span id="adminStatus" class="small"></span>
    </div>
  </div>
</div>

<!-- M√º≈üteri giri≈üi -->
<div id="sheetCust" class="sheet" aria-hidden="true">
  <div class="panel">
    <h3>M√º≈üteri Giri≈üi / Kayƒ±t</h3>
    <div class="grid-2">
      <div><label>Ad Soyad</label><input id="c_name" placeholder="Ad Soyad"></div>
      <div><label>Telefon</label><input id="c_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
    </div>
    <div class="grid-2">
      <div><label>PIN (4 hane)</label><input id="c_pin" maxlength="4" inputmode="numeric"></div>
      <div><label style="visibility:hidden">‚Äî</label><button class="btn btn-primary" id="c_login">Giri≈ü / Kayƒ±t</button></div>
    </div>
    <p class="small" id="c_status"></p>
  </div>
</div>

<!-- Y√∂netim (tek sheet: Usta/Hizmet/√áalƒ±≈üma saatleri) -->
<div id="sheetManage" class="sheet" aria-hidden="true">
  <div class="panel">
    <h3>Y√∂netim</h3>
    <div class="grid-2">
      <section class="card" style="padding:12px">
        <h4>Ustalar</h4>
        <div class="actions">
          <input id="newStaffName" placeholder="Yeni usta adƒ±">
          <button class="btn" id="addStaff">Ekle</button>
        </div>
        <ul id="staffList" class="small" style="margin-top:8px"></ul>
      </section>

      <section class="card" style="padding:12px">
        <h4>Hizmetler</h4>
        <div class="actions">
          <input id="newSvcName" placeholder="Hizmet adƒ±">
          <input id="newSvcDur" type="number" placeholder="S√ºre (dk)" style="max-width:120px">
          <input id="newSvcPrice" type="number" placeholder="Fiyat (TL)" style="max-width:120px">
          <button class="btn" id="addSvc">Ekle</button>
        </div>
        <ul id="svcList" class="small" style="margin-top:8px"></ul>
      </section>
    </div>

    <section class="card" style="padding:12px;margin-top:10px">
      <h4>Usta √áalƒ±≈üma Saatleri</h4>
      <div class="grid-2">
        <div><label>Usta</label><select id="wh_staff"></select></div>
        <div><label>Slot (dk)</label><input id="wh_slot" type="number" value="15"></div>
      </div>
      <div id="wh_days" class="actions" style="flex-wrap:wrap;margin-top:8px"></div>
      <div class="actions" style="margin-top:8px">
        <button class="btn btn-primary" id="saveWorkHours">Kaydet</button>
        <span id="wh_status" class="small"></span>
      </div>
    </section>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const store={get(k,d){try{const v=localStorage.getItem(k);return v===null?d:JSON.parse(v)}catch(e){return d}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}},del(k){try{localStorage.removeItem(k)}catch(e){}}};
function toast(m,ms=2400){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);}
const toMin=t=>{const[h,m]=t.split(':').map(Number);return h*60+m}, toHHMM=m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;

/* ===== Firebase ===== */
firebase.initializeApp({
  apiKey:"AIzaSyBtSQ9_5R42BU5ga0cOt1QETkC5nOf2tW4",
  authDomain:"randevu-81305.firebaseapp.com",
  projectId:"randevu-81305",
  storageBucket:"randevu-81305.firebasestorage.app",
  messagingSenderId:"686048709577",
  appId:"1:686048709577:web:b2db4eeae83203ca2e3618",
  measurementId:"G-3ZX91ND545"
});
const db=firebase.firestore();

/* ===== State ===== */
const ADMIN_PHONE_E164='+905356749243';
const ADMIN_PASSWORD='ahmet07';
let adminOn=false, currentUser=null;
let unsubAppts=null, unsubStaff=null, unsubSvcs=null, unsubUsers=null;

/* ===== Sheets ===== */
const sheet = {
  show(id){ $(id).classList.add('show'); document.body.style.overflow='hidden'; },
  hide(id){ $(id).classList.remove('show'); document.body.style.overflow=''; }
}
['#sheetBell','#sheetAdmin','#sheetCust','#sheetManage'].forEach(id=>{
  $(id).addEventListener('click',e=>{ if(e.target.id===id.slice(1)) sheet.hide(id); });
});

/* ===== Admin UI visibility ===== */
function setAdmin(on){
  adminOn=!!on;
  $('#bellBtn').style.display=adminOn?'inline-flex':'none';
  $('#manageOpen').style.display=adminOn?'inline-flex':'none';
  $('#kpi').style.display=adminOn?'grid':'none';
  if(!adminOn){ sheet.hide('#sheetBell'); sheet.hide('#sheetManage'); }
}
function restoreAdmin(){
  const ok = store.get('adminSession')==='on' && store.get('adminPhone')===ADMIN_PHONE_E164;
  setAdmin(ok);
}

/* ===== Realtime ===== */
function startRealtime(){
  if(unsubAppts) unsubAppts(); if(unsubStaff) unsubStaff(); if(unsubSvcs) unsubSvcs(); if(unsubUsers) unsubUsers();

  unsubStaff = db.collection('staff').onSnapshot(ss=>{
    const list=ss.docs.map(d=>({id:d.id,...d.data()}));
    renderStaffList(list); fillStaffSelect(list); renderWorkHoursEditor(list); computeSlots(); 
  });
  unsubSvcs = db.collection('services').onSnapshot(ss=>{
    const list=ss.docs.map(d=>({id:d.id,...d.data()}));
    renderServiceList(list); fillServiceSelect(list); computeSlots();
  });
  unsubUsers = db.collection('users').onSnapshot(ss=>{
    const list=ss.docs.map(d=>({id:d.id,...d.data()})); renderCustomers(list);
  });
  unsubAppts = db.collection('appts').onSnapshot(ss=>{
    const list=ss.docs.map(d=>({id:d.id,...d.data()}));
    updateBell(list); renderQueue(list); updateKpis(list); computeSlots(list);
  });
}

/* ===== Init ===== */
(async function init(){
  restoreAdmin();
  $('#f_date').value=new Date().toISOString().slice(0,10);
  fillStaffSelect([]); fillServiceSelect([]);
  startRealtime();
})();

/* ===== Form select fillers ===== */
function fillStaffSelect(list){ $('#f_staff').innerHTML='<option disabled selected>‚Äî Se√ßiniz ‚Äî</option>'+list.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); $('#wh_staff').innerHTML=list.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); }
function fillServiceSelect(list){ $('#f_service').innerHTML='<option disabled selected>‚Äî Se√ßiniz ‚Äî</option>'+list.map(s=>`<option value="${s.id}">${s.name} ‚Äî ${s.dur} dk</option>`).join(''); }

/* ===== Slot hesaplama ===== */
function conflicts(appts,date,staffId){
  return (appts||[]).filter(a=>a.date===date&&a.staffId===staffId&&a.status!=='cancelled'&&a.status!=='rejected')
    .map(a=>({start:toMin(a.time),end:toMin(a.time)+a.duration}));
}
function overlaps(aS,aE,bS,bE){return aS<bE&&aE>bS}
function getHoursFor(staff,dateISO){
  const dow=new Date(dateISO+'T00:00:00').getDay();
  if(staff?.hoursByDay && staff.hoursByDay[dow]) return staff.hoursByDay[dow];
  return staff?.hours || {open:'09:00',close:'21:00',slot:15};
}
async function computeSlots(apptList){
  const staffId=$('#f_staff').value, svcId=$('#f_service').value, date=$('#f_date').value;
  const bar=$('#slotbar'); bar.innerHTML='';
  if(!staffId||!svcId||!date) return;
  const sDoc=await db.collection('staff').doc(staffId).get(); const staff=sDoc.data()||{};
  const vDoc=await db.collection('services').doc(svcId).get(); const svc=vDoc.data()||{dur:30};
  const dur=svc.dur||30;
  const {open,close,slot}=getHoursFor(staff,date);
  const openM=toMin(open), closeM=toMin(close), step=slot||15;
  const taken=conflicts(apptList||[],date,staffId);
  const works = !((staff?.offDates||[]).includes(date)) && (!staff?.days || staff.days.includes(new Date(date+'T00:00:00').getDay()));
  for(let t=openM;t+dur<=closeM;t+=step){
    const disabled = !works || taken.some(x=>overlaps(t,t+dur,x.start,x.end));
    const b=document.createElement('button'); b.type='button'; b.className='slot'+(disabled?' dis':''); b.textContent=toHHMM(t); b.dataset.time=toHHMM(t);
    b.onclick=()=>{ if(disabled) return; $$('#slotbar .slot').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); };
    bar.appendChild(b);
  }
}
$('#f_staff').addEventListener('change',()=>computeSlots());
$('#f_service').addEventListener('change',()=>computeSlots());
$('#f_date').addEventListener('change',()=>computeSlots());

/* ===== Randevu olu≈ütur ===== */
$('#f_book').addEventListener('click', async ()=>{
  const name=$('#f_name').value.trim();
  const phoneRaw=$('#f_phone').value.trim();
  const staffId=$('#f_staff').value, svcId=$('#f_service').value, date=$('#f_date').value;
  const timeBtn=$('#slotbar .slot.sel'); const time=timeBtn?.dataset.time;
  if(!name||!phoneRaw||!staffId||!svcId||!date||!time){ $('#f_status').textContent='L√ºtfen t√ºm alanlarƒ± doldurun.'; toast('Eksik bilgi'); return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);

  // G√ºnl√ºk max 2 aktif
  const same=await db.collection('appts').where('phone','==',phone).where('date','==',date).get();
  const activeCnt=same.docs.map(d=>d.data()).filter(a=>a.status==='pending'||a.status==='approved').length;
  if(activeCnt>=2){ toast('Aynƒ± g√ºn en fazla 2 aktif randevu'); return; }

  // user upsert
  let uid=null; const uq=await db.collection('users').where('phone','==',phone).limit(1).get();
  if(uq.empty){ const u=await db.collection('users').add({name,phone,verified:true,pin:'0000',createdAt:Date.now()}); uid=u.id; } else { uid=uq.docs[0].id; }

  const svc=(await db.collection('services').doc(svcId).get()).data(); const staff=(await db.collection('staff').doc(staffId).get()).data();

  await db.collection('appts').add({
    id:firebase.firestore.FieldValue.serverTimestamp().toMillis?.()||String(Date.now()),
    userId:uid,name,phone,
    serviceId:svcId,serviceName:svc?.name||'Hizmet',duration:svc?.dur||30,price:svc?.price||0,
    staffId,staffName:staff?.name||'Usta',
    date,time,status:'pending',createdAt:Date.now()
  });
  $('#f_status').textContent='Randevu olu≈üturuldu (Onay bekliyor).';
  toast('Randevu alƒ±ndƒ± ‚Ä¢ Onay bekliyor');
});

/* ===== √áan & Kuyruk ===== */
function updateBell(list){
  const cnt=(list||[]).filter(a=>a.status==='pending').length;
  $('#bellCount').textContent=String(cnt);
  // admin g√∂r√ºn√ºr + bekleyen varsa yanƒ±p s√∂n
  if(adminOn && cnt>0) { $('#bellBtn').classList.add('blink'); }
  else { $('#bellBtn').classList.remove('blink'); }
}
$('#bellBtn').addEventListener('click', ()=> sheet.show('#sheetBell'));

function renderQueue(list){
  const box=$('#queueList');
  const rows=(list||[]).filter(a=>a.status==='pending').sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  if(rows.length===0){ box.textContent='Kuyruk bo≈ü.'; return; }
  box.innerHTML=rows.map(a=>`
   <div style="display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0">
     <div><b>${a.date} ${a.time}</b> ‚Ä¢ ${a.name} ‚Ä¢ ${a.serviceName} / ${a.staffName}</div>
     <button class="btn" onclick="approve('${a.id}')">Onayla</button>
     <button class="btn" onclick="reject('${a.id}')">Reddet</button>
     <button class="btn" onclick="delAppt('${a.id}')">Sil</button>
   </div>`).join('');
}
window.approve=async(id)=>{ await db.collection('appts').doc(id).set({status:'approved'},{merge:true}); toast('Onaylandƒ±'); };
window.reject =async(id)=>{ await db.collection('appts').doc(id).set({status:'rejected'},{merge:true}); toast('Reddedildi'); };
window.delAppt=async(id)=>{ if(!confirm('Silinsin mi?')) return; await db.collection('appts').doc(id).delete(); toast('Silindi'); };

/* ===== KPI ===== */
function updateKpis(list){
  if(!adminOn){ return; }
  const today=new Date().toISOString().slice(0,10);
  const d=list.filter(a=>a.date===today);
  $('#kpiToday').textContent=String(d.length);
  $('#kpiOBI').textContent=[d.filter(a=>a.status==='approved').length,d.filter(a=>a.status==='pending').length,d.filter(a=>a.status==='cancelled').length].join('/');
  const now=new Date(); const ws=new Date(now); ws.setDate(now.getDate()-now.getDay()); const we=new Date(ws); we.setDate(ws.getDate()+6);
  const inWeek=list.filter(a=>a.status!=='rejected' && a.date>=ws.toISOString().slice(0,10) && a.date<=we.toISOString().slice(0,10));
  $('#kpiWeek').textContent=String(inWeek.length);
}

/* ===== Y√∂netim: Usta/Hizmet/√áalƒ±≈üma saatleri ===== */
function renderStaffList(list){
  $('#staffList').innerHTML=(list||[]).sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr')).map(s=>`
    <li style="display:flex;align-items:center;gap:8px;margin:6px 0">
      <span style="flex:1">${s.name}</span>
      <button class="btn" onclick="delStaff('${s.id}')">Sil</button>
    </li>`).join('') || '‚Äî';
  $('#wh_staff').innerHTML=(list||[]).map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  renderWorkHoursEditor(list);
}
window.delStaff=async(id)=>{ await db.collection('staff').doc(id).delete(); toast('Usta silindi'); };

$('#addStaff').addEventListener('click', async ()=>{
  const name=$('#newStaffName').value.trim(); if(!name){toast('Usta adƒ± gerekli');return;}
  await db.collection('staff').add({name,days:[1,2,3,4,5,6],hours:{open:'09:00',close:'21:00',slot:15},offDates:[]});
  $('#newStaffName').value=''; toast('Usta eklendi');
});

function renderServiceList(list){
  $('#svcList').innerHTML=(list||[]).sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr')).map(s=>`
    <li style="display:flex;align-items:center;gap:8px;margin:6px 0">
      <span style="flex:1">${s.name} ‚Äî ${s.dur} dk / ${s.price||0} TL</span>
      <button class="btn" onclick="delSvc('${s.id}')">Sil</button>
    </li>`).join('') || '‚Äî';
}
window.delSvc=async(id)=>{ await db.collection('services').doc(id).delete(); toast('Hizmet silindi'); };

$('#addSvc').addEventListener('click', async ()=>{
  const name=$('#newSvcName').value.trim(), dur=parseInt($('#newSvcDur').value||'30',10), price=parseInt($('#newSvcPrice').value||'0',10);
  if(!name){toast('Hizmet adƒ± gerekli');return;}
  await db.collection('services').add({name,dur,price});
  $('#newSvcName').value=''; $('#newSvcDur').value=''; $('#newSvcPrice').value=''; toast('Hizmet eklendi');
});

const DAY_LABELS=['Paz','Pzt','Sal','√áar','Per','Cum','Cmt'];
function renderWorkHoursEditor(staffList){
  const wrap=$('#wh_days'); wrap.innerHTML='';
  const sid=$('#wh_staff').value || (staffList[0]?.id||''); $('#wh_staff').value=sid;
  const staff=staffList.find(s=>s.id===sid); if(!staff) return;
  const byDay=staff.hoursByDay||{}; const slot=staff.hours?.slot||15; $('#wh_slot').value=slot;
  DAY_LABELS.forEach((lab,i)=>{
    const d=byDay[i]||staff.hours||{open:'09:00',close:'21:00',slot:15};
    const chk=(staff.days||[1,2,3,4,5,6]).includes(i)?'checked':'';
    const item=document.createElement('div');
    item.style.cssText='display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;padding:6px 8px;flex:0 0 auto';
    item.innerHTML=`
      <label class="badge" style="background:#f8fafc;border-color:#e5e7eb">${lab} <input type="checkbox" data-dow="${i}" ${chk} style="margin-left:6px;width:auto"></label>
      <input type="time" value="${d.open}" data-typ="open" data-dow="${i}" style="max-width:110px">
      <span>‚Äì</span>
      <input type="time" value="${d.close}" data-typ="close" data-dow="${i}" style="max-width:110px">`;
    wrap.appendChild(item);
  });
}
$('#wh_staff').addEventListener('change', async ()=>{
  const list=(await db.collection('staff').get()).docs.map(d=>({id:d.id,...d.data()}));
  renderWorkHoursEditor(list);
});
$('#saveWorkHours').addEventListener('click', async ()=>{
  const sid=$('#wh_staff').value; if(!sid){toast('Usta se√ßiniz');return;}
  const days=[...document.querySelectorAll('#wh_days input[type="checkbox"]')].filter(x=>x.checked).map(x=>parseInt(x.dataset.dow,10));
  const hoursByDay={};
  [...document.querySelectorAll('#wh_days input[type="time"]')].forEach(inp=>{
    const i=parseInt(inp.dataset.dow,10); hoursByDay[i]=hoursByDay[i]||{open:'09:00',close:'21:00'};
    hoursByDay[i][inp.dataset.typ]=inp.value||'09:00';
  });
  await db.collection('staff').doc(sid).set({days,hoursByDay,hours:{open:hoursByDay[1]?.open||'09:00',close:hoursByDay[1]?.close||'21:00',slot:parseInt($('#wh_slot').value||'15',10)}},{merge:true});
  $('#wh_status').textContent='Kaydedildi.'; toast('√áalƒ±≈üma saatleri kaydedildi');
});

/* ===== Customers render (liste) ===== */
function renderCustomers(list){
  // Bu √∂rnekte yalnƒ±z y√∂netimde liste g√∂steriyoruz; ekstra bir alanda gerekirse ekleriz.
}

/* ===== Admin & Customer ===== */
$('#adminOpen').addEventListener('click',()=>sheet.show('#sheetAdmin'));
$('#custOpen').addEventListener('click',()=>sheet.show('#sheetCust'));
$('#manageOpen').addEventListener('click',()=>sheet.show('#sheetManage'));

$('#adminLoginBtn').addEventListener('click',()=>{
  const p=$('#adminPhone').value.trim(), pass=$('#adminPass').value.trim();
  if(p===ADMIN_PHONE_E164 && pass===ADMIN_PASSWORD){
    setAdmin(true); store.set('adminSession','on'); store.set('adminPhone',p);
    $('#adminStatus').textContent='Giri≈ü ba≈üarƒ±lƒ±'; sheet.hide('#sheetAdmin'); toast('Admin olarak giri≈ü yapƒ±ldƒ±');
  }else $('#adminStatus').textContent='Bilgiler hatalƒ±';
});
$('#adminLogoutBtn').addEventListener('click',()=>{ setAdmin(false); store.del('adminSession'); store.del('adminPhone'); $('#adminStatus').textContent='√áƒ±kƒ±≈ü yapƒ±ldƒ±'; toast('Admin oturumu kapatƒ±ldƒ±'); });

$('#c_login').addEventListener('click', async ()=>{
  const name=$('#c_name').value.trim(), phoneRaw=$('#c_phone').value.trim(), pin=$('#c_pin').value.trim();
  if(!name||!phoneRaw||pin.length!==4){ $('#c_status').textContent='Ad/Telefon ve 4 haneli PIN gerekli.'; return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);
  const q=await db.collection('users').where('phone','==',phone).limit(1).get();
  if(q.empty){ await db.collection('users').add({name,phone,verified:true,pin,createdAt:Date.now()}); }
  currentUser={name,phone};
  $('#c_status').textContent='Giri≈ü ba≈üarƒ±lƒ±.'; toast('M√º≈üteri giri≈üi yapƒ±ldƒ±'); setTimeout(()=>sheet.hide('#sheetCust'),400);
});
</script>
</body>
</html>
