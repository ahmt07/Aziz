<!doctype html><html lang="tr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ahmet Tekeli Erkek Kuaförü — Randevu</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,700&display=swap" rel="stylesheet">
<style>
:root{--bg:#eef0f3;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--card:#fff;--gold:#d4af37}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:min(1000px,100%);margin:0 auto;padding:0 12px}
.bg{position:fixed;inset:0;z-index:-1;background:
  radial-gradient(900px 400px at 15% -10%,rgba(212,175,55,.08),transparent 55%),
  radial-gradient(700px 360px at 85% 0,rgba(0,0,0,.05),transparent 60%),
  linear-gradient(180deg,#f3f5f8 0,var(--bg) 45%,#e7ebf1 100%)}
header{position:sticky;top:0;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:10}
.hero{display:flex;flex-direction:column;align-items:center;gap:10px;padding:56px 0 14px}
.brand{font-family:"Playfair Display",serif;font-style:italic;font-weight:700;color:#111827;font-size:30px;text-align:center}
header .wrap{position:relative}
#topRight{position:absolute;top:10px;right:12px;display:flex;gap:8px}
.iconBtn{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.9);cursor:pointer}
#notifyBell{display:inline-flex;align-items:center;gap:6px}
#notifyBell .badge{min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:#ef4444;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
#profileBadge{display:none;align-items:center;gap:8px;margin-top:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.9)}
.login{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;width:100%;max-width:860px}
.auth-tabs{display:flex;gap:8px;margin-bottom:8px}.auth-tab{border:1px solid var(--line);background:#f8fafc;padding:8px 10px;border-radius:10px;cursor:pointer}.auth-tab.active{background:#111827;color:#fff;border-color:#111827}
.login .row{display:flex;gap:8px;flex-wrap:wrap}
.login input,.login select{flex:1 1 220px;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff}
.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}.btn-primary{background:var(--gold);border-color:var(--gold);color:#111}
.tabs{display:flex;gap:18px;padding:10px 4px;border-radius:12px;background:#f7f8fb;border:1px solid var(--line);max-width:860px;width:100%}
.tab{background:transparent;border:none;padding:8px 6px;border-bottom:2px solid transparent;cursor:pointer}.tab.active{border-bottom-color:#111827;font-weight:700}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0}
label{display:block;font-weight:700;margin:.4rem 0 .2rem}
input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff}
.slots-wrap{display:flex;align-items:center;gap:8px}.slots{display:flex;gap:12px;flex-wrap:nowrap;overflow-x:auto;padding:6px 2px}
.slot{padding:10px 16px;border:1px solid var(--line);border-radius:999px;background:#fff;flex:0 0 auto}
.slot.dis{opacity:.45;pointer-events:none;text-decoration:line-through}.slot.sel{background:#111827;color:#fff;border-color:#111827;box-shadow:0 4px 14px rgba(0,0,0,.18)}
.small{font-size:12px;color:var(--muted)}.actions{display:flex;gap:12px;flex-wrap:wrap}
.table-scroll{overflow-x:auto}table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}thead th{background:#f3f4f6;font-weight:700}
footer{padding:24px 0;color:var(--muted);text-align:center}
#toast{position:fixed;left:50%;top:-80px;transform:translateX(-50%);background:#111827;color:#fff;padding:12px 16px;border-radius:999px;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:9999;transition:top .45s ease}
#toast.show{top:12px}
.reportGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin:8px 0}
.reportCard{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}.reportCard .k{font-size:12px;color:#6b7280}.reportCard .v{font-size:22px;font-weight:800;margin-top:2px}.reportCard .sub{font-size:12px;color:#6b7280;margin-top:2px}
.badge-soft{display:inline-flex;align-items:center;gap:6px;font-size:12px;background:#f3f4f6;border:1px solid var(--line);border-radius:999px;padding:4px 8px}.badge-soft.red{background:#fee2e2;border-color:#fecaca}
</style>
</head><body>
<div class="bg"></div><div id="toast"></div>

<header><div class="wrap">
  <div id="topRight">
    <button id="notifyBell" class="iconBtn" title="Bildirimler" type="button">🔔 <span id="notifyCount" class="badge">0</span></button>
    <button id="shareBtn" class="iconBtn" title="Bağlantıyı paylaş">🔗 Paylaş</button>
  </div>
  <div class="hero">
    <img src="logo.png" alt="Logo" style="width:110px;height:110px;object-fit:contain;filter:drop-shadow(0 6px 12px rgba(0,0,0,.2));border-radius:50%;background:#fff;padding:10px;border:2px solid #d4af37">
    <div class="brand">AHMET TEKELİ<br><span style="font-size:.72em;letter-spacing:.04em">ERKEK KUAFÖRÜ</span></div>
    <div id="profileBadge">👤 <b id="profName"></b> <button id="switchBtn" class="btn">Hesabı değiştir</button></div>

    <!-- Giriş/Kayıt -->
    <div class="login">
      <div class="auth-tabs">
        <button class="auth-tab active" data-auth="login">Müşteri Girişi</button>
        <button class="auth-tab" data-auth="register">Kayıt Ol</button>
        <button class="auth-tab" data-auth="admin">Admin Girişi</button>
      </div>

      <div id="auth-login">
        <div class="row">
          <select id="l_cc" style="max-width:140px"><option value="+90" selected>🇹🇷 +90</option><option value="other">🌍 Diğer (+…)</option></select>
          <input id="l_phone" placeholder="Telefon" inputmode="tel">
          <input id="l_pin" placeholder="PIN (4 hane)" inputmode="numeric" maxlength="4">
          <label style="display:flex;align-items:center;gap:8px;margin:.2rem 0 0"><input type="checkbox" id="l_remember" checked style="width:auto"> <span class="small">Beni hatırla</span></label>
          <button class="btn btn-primary" id="loginBtn" type="button">Giriş</button>
          <button class="btn" id="forgotPinBtn" type="button">Şifremi Unuttum?</button>
        </div><p class="small" id="loginInfo" style="margin-top:6px"></p>
      </div>

      <div id="auth-register" style="display:none">
        <div class="row">
          <input id="r_name" placeholder="Ad Soyad">
          <select id="r_cc" style="max-width:140px"><option value="+90" selected>🇹🇷 +90</option><option value="other">🌍 Diğer (+…)</option></select>
          <input id="r_phone" placeholder="Telefon" inputmode="tel">
          <input id="r_pin" placeholder="PIN (4 hane)" inputmode="numeric" maxlength="4">
          <button class="btn btn-primary" id="registerBtn" type="button">Kayıt Ol</button>
        </div>
      </div>

      <div id="auth-admin" style="display:none">
        <div class="row">
          <input id="adminPass" placeholder="Admin şifresi" style="max-width:260px">
          <button class="btn btn-primary" id="adminLoginBtn" type="button">Giriş</button>
          <button class="btn" id="adminLogoutBtn" type="button">Çıkış</button>
          <span id="adminStatus" class="small"></span>
        </div>
      </div>
    </div>

    <!-- Sekmeler -->
    <div class="tabs">
      <button class="tab active" data-target="#randevu">Randevu Al</button>
      <button class="tab" data-target="#randevularim">Randevularım</button>
      <button class="tab" data-target="#admin">Yönetici Paneli</button>
    </div>
  </div>
</div></header>

<main class="wrap">
  <!-- Randevu alma -->
  <section id="randevu" class="card">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px">
      <div>
        <label>Hizmet</label><select id="svc"></select>
        <label>Berber</label><select id="staff"></select>
        <label>Tarih</label><input type="date" id="date">
        <p class="small">Kayıt olmadan <b>uygun saatleri görebilirsiniz</b>. Almak için giriş gerekir.</p>
        <div id="staffInfo" class="small"></div>
      </div>
      <div>
        <label>Uygun Saatler</label>
        <div class="slots-wrap"><button class="btn" type="button" id="slotPrev">‹</button><div id="slots" class="slots"></div><button class="btn" type="button" id="slotNext">›</button></div>
        <div class="actions" style="margin-top:10px"><button class="btn btn-primary" id="makeAppt" type="button">Randevu Oluştur</button></div>
        <div id="makeStatus" class="small"></div>
        <p class="small">Genel: <span id="hoursLabel"></span> • Slot: <span id="slotSizeLabel"></span> dk</p>
      </div>
    </div>
  </section>

  <!-- Randevularım -->
  <section id="randevularim" class="card" style="display:none">
    <h3>Randevularım</h3>
    <div class="table-scroll"><table>
      <thead><tr><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>İşlem</th></tr></thead>
      <tbody id="myApptTbody"></tbody></table></div>
  </section>

  <!-- Admin -->
  <section id="admin" class="card" style="display:none">
    <h3>Yönetici Paneli</h3>
    <div id="adminArea">
      <h4>Onay Kuyruğu</h4>
      <div class="table-scroll"><table>
        <thead><tr><th></th><th>Müşteri</th><th>Tel</th><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Süre</th><th>İşlem</th></tr></thead>
        <tbody id="queueTbody"></tbody></table></div>

      <h4 style="margin-top:16px">Günlük Takvim</h4>
      <div class="actions" style="margin:8px 0">
        <input type="date" id="calDate"><select id="calStaff"></select>
        <button class="btn" id="viewCal" type="button">Görüntüle</button>
        <button class="btn" id="refreshAdmin" type="button">Yenile</button>
      </div>
      <div class="table-scroll"><table>
        <thead><tr><th></th><th>Saat</th><th>Müşteri</th><th>Hizmet</th><th>Durum</th><th>İşlem</th></tr></thead>
        <tbody id="calTbody"></tbody></table></div>

      <h4 style="margin-top:16px">Yeni Randevu (Dışarıdan)</h4>
      <div class="card">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
          <div><label>Ad Soyad</label><input id="a_name" placeholder="Müşteri adı"></div>
          <div><label>Telefon</label><div class="row"><select id="a_cc" style="max-width:140px"><option value="+90" selected>🇹🇷 +90</option><option value="other">🌍 Diğer (+…)</option></select><input id="a_phone" placeholder="Telefon" inputmode="tel"></div></div>
          <div><label>Hizmet</label><select id="a_svc"></select></div>
          <div><label>Berber</label><select id="a_staff"></select></div>
          <div><label>Tarih</label><input type="date" id="a_date"></div>
          <div style="align-self:end">
            <label class="small" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="a_override" style="width:auto"> Limit yok say</label>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:8px">
          <div><label>Süre (dk)</label><input id="a_dur" type="number" min="5" step="5" placeholder="Dakika"></div>
          <div style="align-self:end"><label class="small" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="a_lockSvcDur" checked style="width:auto"> Hizmet süresini kullan</label></div>
        </div>
        <div style="margin-top:10px"><label>Uygun Saatler</label>
          <div class="slots-wrap"><button class="btn" type="button" id="a_prev">‹</button><div id="a_slots" class="slots"></div><button class="btn" type="button" id="a_next">›</button></div>
        </div>
        <div class="actions" style="margin-top:10px"><button class="btn btn-primary" id="a_create" type="button">Randevu Oluştur (Admin)</button><span id="a_status" class="small"></span></div>
      </div>

      <h4 style="margin-top:16px">Müşteri Listesi</h4>
      <div class="table-scroll"><table>
        <thead><tr><th>Ad</th><th>Telefon</th><th>Kayıt</th><th>Son Giriş</th><th>Doğrulandı</th><th>İşlem</th></tr></thead>
        <tbody id="usersTbody"></tbody></table></div>

      <details class="card" style="margin-top:16px">
        <summary><b>📅 Usta Takvimi</b></summary>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:12px">
          <div>
            <label>Usta Seç</label><select id="schedStaff"></select>
            <div id="schedMeta" class="small" style="margin-top:6px"></div>
            <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">
            <label>Çalışma Günleri</label><div id="dayChecks" class="actions" style="flex-wrap:wrap"></div>
            <label style="margin-top:12px">Tek Aralık Çalışma Saatleri</label>
            <div class="actions"><input type="time" id="schedOpen" value="09:00" style="max-width:140px"><span style="align-self:center">–</span><input type="time" id="schedClose" value="21:00" style="max-width:140px"><button class="btn" id="saveSched" type="button">Kaydet</button></div>
            <p class="small">Gün/saatler yalnızca seçili usta için geçerlidir.</p>
          </div>
          <div>
            <label>Kapalı Günler (İzin/Tatil)</label>
            <div class="actions"><input type="date" id="offDate"><button class="btn" id="addOff" type="button">Ekle</button></div>
            <div id="offList" class="actions" style="flex-wrap:wrap;margin-top:8px"></div>
            <p class="small">Bu tarihlerde bu usta için randevu verilemez.</p>
          </div>
        </div>
      </details>

      <details class="card" style="margin-top:16px">
        <summary><b>⚙️ Ayarlar (Genel)</b></summary>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:12px">
          <div>
            <label>Genel Açılış</label><input id="openTime" value="09:00" type="time">
            <label>Genel Kapanış</label><input id="closeTime" value="21:00" type="time">
            <label>Slot Süresi (dk)</label><input id="slotSize" value="15" type="number" min="5" step="5">
            <button class="btn" id="saveSettings" type="button">Kaydet</button>
            <p id="settingsStatus" class="small"></p>
          </div>
          <div>
            <label>Hizmetler</label><div id="svcList"></div>
            <div class="actions"><input id="newSvcName" placeholder="Hizmet adı"><input id="newSvcDur" type="number" placeholder="Süre (dk)" style="max-width:140px"><input id="newSvcPrice" type="number" placeholder="Fiyat (TL)" style="max-width:140px"><button class="btn" id="addSvc" type="button">Ekle</button></div>
          </div>
        </div>
      </details>

      <details class="card" style="margin-top:16px">
        <summary><b>🗑️ Randevuları Yönet (Toplu Sil)</b></summary>
        <div class="actions" style="margin:8px 0"><input type="date" id="allDate"><select id="allStaff"></select><button class="btn" id="loadAll" type="button">Listele</button><button class="btn" id="bulkDelete" type="button">Seçilileri Sil</button><label class="small" style="margin-left:auto"><input type="checkbox" id="chkAll" style="width:auto"> Tümünü Seç</label></div>
        <div class="table-scroll"><table><thead><tr><th></th><th>Tarih</th><th>Saat</th><th>Müşteri</th><th>Tel</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>İşlem</th></tr></thead><tbody id="allApptTbody"></tbody></table></div>
      </details>

      <section class="card" id="adminReports" style="margin-top:12px">
        <h4>Özet Raporlar</h4>
        <div id="reportToday" class="reportGrid" aria-label="Bugün"></div>
        <div id="reportWeek" class="reportGrid" aria-label="Son 7 Gün"></div>
      </section>

      <h4 style="margin-top:16px">PIN Sıfırlama Talepleri</h4>
      <div class="table-scroll"><table><thead><tr><th>Telefon</th><th>Yeni PIN</th><th>Talep</th><th>İşlem</th></tr></thead><tbody id="resetTbody"></tbody></table></div>
    </div>
  </section>
</main>

<footer><div class="wrap">© Ahmet Tekeli Erkek Kuaförü • Randevu Sistemi</div></footer>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* ==== ADMIN & POLİTİKA ==== */
const ADMIN_PHONE_E164 = '+905356749243'; // sadece bu hesap admin
const ADMIN_PASSWORD   = 'ahmet07';
const CUSTOMER_MODIFY = false;            // müşteri randevu yönetemesin
const MAX_APPTS_PER_DAY = 2;              // müşteri günlük limit
const ADMIN_AUTO_APPROVE = true;          // admin eklediğinde otomatik approved

/* ==== Basit depolama ==== */
(function(){const mem={};window.store={get(k,d){try{const v=localStorage.getItem(k);if(v!==null)return JSON.parse(v);return mem.hasOwnProperty(k)?mem[k]:d}catch(e){return mem.hasOwnProperty(k)?mem[k]:d}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){mem[k]=v}},del(k){try{localStorage.removeItem(k)}catch(e){delete mem[k]}}};})();
const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s));
const toMin=t=>{const[h,m]=t.split(':').map(Number);return h*60+m},toHHMM=m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
const todayISO=()=>new Date().toISOString().slice(0,10);const uuid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
function showToast(msg,ms=2200){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);}
function maskPhone(p){ if(!p) return ''; if(p.startsWith('+90') && p.length===13){const n=p.slice(3); return `0${n.slice(0,3)} ${n.slice(3,6)} ${n.slice(6,8)} ${n.slice(8,10)}`} return p }
function trNormalize(s){return (s||'').trim().normalize('NFC').replace(/\s+/g,' ')}
function trCmp(a,b){return (a||'').toString().localeCompare((b||'').toString(),'tr',{sensitivity:'base'})}

/* ==== Telefon (E.164) ==== */
function toE164(raw, ccHint='+90'){ if(!raw) return null; let s=String(raw).trim().replace(/[()\-\s]/g,''); if(s.startsWith('+')){const d=s.slice(1).replace(/\D/g,''); return (d.length>=8&&d.length<=15)?`+${d}`:null;} const only=s.replace(/\D/g,''); if(ccHint==='+90'){ if(only.length===11&&only.startsWith('05')) return '+90'+only.slice(1); if(only.length===10&&only.startsWith('5')) return '+90'+only; return null;} return null;}
function isTR(p){return typeof p==='string'&&p.startsWith('+90')&&p.length===13}

/* ==== Firebase ==== */
const firebaseConfig={apiKey:"AIzaSyBtSQ9_5R42BU5ga0cOt1QETkC5nOf2tW4",authDomain:"randevu-81305.firebaseapp.com",projectId:"randevu-81305",storageBucket:"randevu-81305.firebasestorage.app",messagingSenderId:"686048709577",appId:"1:686048709577:web:b2db4eeae83203ca2e3618",measurementId:"G-3ZX91ND545"};
firebase.initializeApp(firebaseConfig);const db=firebase.firestore();

/* ==== Cloud CRUD ==== */
const cloud={async users_list(){const ss=await db.collection('users').get();return ss.docs.map(d=>({id:d.id,...d.data()}))},
  async users_upsert(u){const id=u.id||uuid();await db.collection('users').doc(id).set({...u,id});return id},
  async users_update(id,patch){await db.collection('users').doc(id).set(patch,{merge:true})},
  async users_delete(id){await db.collection('users').doc(id).delete()},
  async appts_list(){const ss=await db.collection('appts').get();return ss.docs.map(d=>({id:d.id,...d.data()}))},
  async appts_add(a){const id=a.id||uuid(); // admin auto-approve
    if(ADMIN_AUTO_APPROVE && adminAuthed) a={...a,status:'approved'};
    await db.collection('appts').doc(id).set({...a,id});return id},
  async appts_update(id,patch){await db.collection('appts').doc(id).set(patch,{merge:true})},
  async appts_delete(id){await db.collection('appts').doc(id).delete()},
  async staff_list(){const ss=await db.collection('staff').get();return ss.docs.map(d=>({id:d.id,...d.data()}))},
  async staff_upsert(s){const id=s.id||uuid();await db.collection('staff').doc(id).set({...s,id});return id},
  async staff_update(id,patch){await db.collection('staff').doc(id).set(patch,{merge:true})},
  async staff_delete(id){await db.collection('staff').doc(id).delete()}
};

/* ==== Yerel seed ==== */
(function seed(){ if(!store.get('settings')) store.set('settings',{open:"09:00",close:"21:00",slot:30});
  if(!store.get('services')) store.set('services',[]);
  if(!store.get('users')) store.set('users',[]); if(!store.get('appts')) store.set('appts',[]);
  if(!store.get('resetReqs')) store.set('resetReqs',[]);})();
function refreshSettingsUI(){ const s=store.get('settings'); $('#hoursLabel').textContent=`${s.open} - ${s.close}`; $('#slotSizeLabel').textContent=s.slot; $('#openTime').value=s.open; $('#closeTime').value=s.close; $('#slotSize').value=s.slot; }
function activeCountFor(dateISO, phone){const a=store.get('appts',[])||[];return a.filter(x=>x.date===dateISO&&x.phone===phone&&(x.status==='pending'||x.status==='approved')).length}
function canCreateAppt(dateISO, phone){ if(phone===ADMIN_PHONE_E164) return true; return activeCountFor(dateISO,phone) < MAX_APPTS_PER_DAY; }

/* ==== Realtime ==== */
let adminAuthed=false,currentUser=null,_prevApptStatusById={};let unsubU=null,unsubA=null,unsubS=null;
function startRealtime(){
  if(unsubU)unsubU();unsubU=db.collection('users').onSnapshot(ss=>{store.set('users',ss.docs.map(d=>({id:d.id,...d.data()})));renderUsers();const id=store.get('currentUserId',null);if(id){const u=(store.get('users',[])||[]).find(x=>x.id===id);if(u) $('#profName').textContent=`${u.name} (${maskPhone(u.phone)})`; }});
  if(unsubA)unsubA();unsubA=db.collection('appts').onSnapshot(ss=>{store.set('appts',ss.docs.map(d=>({id:d.id,...d.data()})));
    try{const appts=store.get('appts',[])||[]; if(currentUser){ appts.filter(a=>a.userId===currentUser.id).forEach(a=>{const b=_prevApptStatusById[a.id]; if(b&&b==='pending'&&a.status==='approved'){showToast('✅ Randevun onaylandı');} _prevApptStatusById[a.id]=a.status;});}}
    catch(e){} updateBell(); renderQueue(); renderCal(); renderAllAppts(); loadMyAppts(); renderSlots(); renderReports();});
  if(unsubS)unsubS();unsubS=db.collection('staff').onSnapshot(ss=>{store.set('staffCloud',ss.docs.map(d=>({id:d.id,...d.data()})));renderStaffUI(); renderScheduleEditor(); renderSlots(); renderAdminNewSlots(); renderCal(); });
}

/* ==== UI kontroller ==== */
const DAY_LABELS=['Paz','Pzt','Sal','Çar','Per','Cum','Cmt'];
function staffAll(){return store.get('staffCloud',[])||[]}
function staffWorksThatDay(staff,dateISO){const dow=new Date(dateISO+'T00:00:00').getDay();return (staff.days||[1,2,3,4,5,6]).includes(dow);}
function isOffDate(staff,dateISO){return (staff.offDates||[]).includes(dateISO)}
const overlaps=(aS,aE,bS,bE)=>aS<bE&&aE>bS;
function conflicts(date,staffId){return (store.get('appts',[])||[]).filter(a=>a.date===date&&a.staffId===staffId&&a.status!=='cancelled'&&a.status!=='rejected').map(a=>({start:toMin(a.time),end:toMin(a.time)+a.duration}))}
function getHoursFor(staff,dateISO){const s=store.get('settings');const dow=new Date(dateISO+'T00:00:00').getDay();const byDay=staff?.hoursByDay;if(byDay&&byDay[dow]?.open&&byDay[dow]?.close){return {open:byDay[dow].open,close:byDay[dow].close}} if(staff?.hours?.open&&staff?.hours?.close){return {open:staff.hours.open,close:staff.hours.close}} return {open:s.open,close:s.close}}
function renderSvcUI(){const list=(store.get('services',[])||[]).slice().sort((a,b)=>trCmp(a.name,b.name));
  if(list.length===0){$('#svc').innerHTML='<option disabled selected>— Önce hizmet ekleyin (Ayarlar) —</option>';$('#a_svc').innerHTML='<option disabled selected>— Hizmet yok —</option>';$('#svcList').innerHTML='<div class="small">Henüz hizmet yok.</div>';return;}
  $('#svc').innerHTML=list.map(s=>`<option value="${s.id}">${s.name} — ${s.dur} dk / ${s.price} TL</option>`).join('');
  $('#a_svc').innerHTML=list.map(s=>`<option value="${s.id}">${s.name} — ${s.dur} dk</option>`).join('');
  $('#svcList').innerHTML=list.map(s=>`<div class="actions" style="align-items:center"><input class="inlineFld" value="${s.name}" data-sv-name="${s.id}" style="max-width:200px"><input class="inlineFld" type="number" value="${s.dur}" data-sv-dur="${s.id}" style="max-width:100px"><input class="inlineFld" type="number" value="${s.price||0}" data-sv-price="${s.id}" style="max-width:120px"><button class="btn btn-primary" onclick="saveService('${s.id}')">Kaydet</button><button class="btn" onclick="delSvc('${s.id}')">Sil</button></div>`).join('');
}
function renderStaffUI(){const staff=staffAll().slice().sort((a,b)=>trCmp(a.name,b.name));
  if(staff.length===0){$('#staff').innerHTML='<option disabled selected>— Önce usta ekleyin —</option>';$('#calStaff').innerHTML='<option value="">Tümü</option>';$('#allStaff').innerHTML='<option value="">Tümü</option>';$('#schedStaff').innerHTML='';$('#a_staff').innerHTML='<option disabled selected>— Usta yok —</option>';return;}
  const opts=staff.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');$('#staff').innerHTML=opts;$('#calStaff').innerHTML=`<option value="">Tümü</option>`+opts;$('#allStaff').innerHTML=`<option value="">Tümü</option>`+opts;$('#schedStaff').innerHTML=opts;$('#a_staff').innerHTML=opts;
}

/* ==== Sekmeler ==== */
$$('.tab').forEach(b=>b.addEventListener('click',()=>{$$('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); $$('main section').forEach(s=>s.style.display='none'); $(b.dataset.target).style.display='block'; if(b.dataset.target==="#randevu") renderSlots();}));
$('#notifyBell').addEventListener('click',()=>{document.querySelector('.tab[data-target="#admin"]').click(); setTimeout(()=>{$('#queueTbody')?.scrollIntoView({behavior:'smooth'})},150);});
$('#shareBtn').addEventListener('click',async()=>{try{await navigator.share({title:document.title,url:location.href})}catch(e){navigator.clipboard.writeText(location.href);showToast('Bağlantı kopyalandı');}});

/* ==== Giriş/Kayıt/Admin ==== */
function setCurrentUser(u,remember=true){currentUser=u;$('.login').style.display='none';$('#profileBadge').style.display='inline-flex';$('#profName').textContent=`${u.name} (${maskPhone(u.phone)})`;$('#loginInfo').textContent=`Giriş yapıldı: ${u.name} (${maskPhone(u.phone)})`; remember?store.set('currentUserId',u.id):store.del('currentUserId'); loadMyAppts(); try{(store.get('appts',[])||[]).filter(a=>a.userId===currentUser.id).forEach(a=>_prevApptStatusById[a.id]=a.status);}catch(e){}}
function clearCurrentUser(){currentUser=null;$('#profileBadge').style.display='none';$('.login').style.display='block';$('#loginInfo').textContent='';store.del('currentUserId');document.querySelector('.auth-tab[data-auth="login"]').click();}
$('#switchBtn').addEventListener('click',()=>{clearCurrentUser();showToast('Hesap değiştirildi')});
function tryAutoLogin(){const id=store.get('currentUserId',null);if(!id) return;const u=(store.get('users',[])||[]).find(x=>x.id===id);if(u) setCurrentUser(u,true);}
['login','register','admin'].forEach(key=>document.querySelector(`.auth-tab[data-auth="${key}"]`).addEventListener('click',()=>{$$('.auth-tab').forEach(x=>x.classList.remove('active'));event.target.classList.add('active');$('#auth-login').style.display=key==='login'?'block':'none';$('#auth-register').style.display=key==='register'?'block':'none';$('#auth-admin').style.display=key==='admin'?'block':'none';}));
$('#registerBtn').addEventListener('click', async()=>{const name=trNormalize($('#r_name').value);const cc=$('#r_cc').value;const phone=cc==='other'?toE164($('#r_phone').value,'other'):toE164($('#r_phone').value,'+90');const pin=($('#r_pin').value||'').trim(); if(!name||!phone||!/^\d{4}$/.test(pin)){alert('Bilgileri kontrol edin');return;} if((store.get('users',[])||[]).some(x=>x.phone===phone)){alert('Bu telefonla kayıt var');return;} const u={id:uuid(),name,phone,verified:true,pin,createdAt:Date.now()}; await cloud.users_upsert(u); try{store.set('users',await cloud.users_list())}catch{} setCurrentUser(u,true); showToast('✅ Kayıt tamamlandı');});
$('#loginBtn').addEventListener('click',async()=>{const e164=($('#l_cc').value==='other')?toE164($('#l_phone').value,'other'):toE164($('#l_phone').value,'+90');const pin=($('#l_pin').value||'').trim(); if(!e164||pin.length!==4){alert('Telefon ve 4 haneli PIN');return;} let u=(store.get('users',[])||[]).find(x=>x.phone===e164)||null; if(!u){const digits=String($('#l_phone').value).replace(/\D/g,'');u=(store.get('users',[])||[]).find(x=>x.phone?.endsWith(digits));} if(!u||(String(u.pin||'').trim()!==pin)){alert('Telefon veya PIN hatalı');return;} await cloud.users_update(u.id,{lastLogin:Date.now()}); try{store.set('users',await cloud.users_list())}catch{} setCurrentUser(u,$('#l_remember').checked); showToast('Giriş başarılı');});
$('#adminLoginBtn').addEventListener('click',()=>{ if(!currentUser){$('#adminStatus').textContent='Önce müşteri girişi yap'; return;} if(currentUser.phone===ADMIN_PHONE_E164 && ($('#adminPass').value||'').trim()===ADMIN_PASSWORD){adminAuthed=true;$('#adminStatus').textContent='Admin girişi başarılı';showToast('✅ Admin girişi');}else{$('#adminStatus').textContent='Yetki yok / şifre hatalı'}});
$('#adminLogoutBtn').addEventListener('click',()=>{adminAuthed=false;$('#adminStatus').textContent='Çıkış yapıldı';showToast('Admin çıkış')});
$('#forgotPinBtn').addEventListener('click',()=>{const phoneRaw=prompt('Telefon:'); if(!phoneRaw) return; const e164=phoneRaw.startsWith('+')?toE164(phoneRaw,'other'):toE164(phoneRaw,'+90'); const u=e164?(store.get('users',[])||[]).find(x=>x.phone===e164):null; if(!u){alert('Bu telefonla kayıt yok');return;} const newPin=prompt('Yeni PIN (4 hane):'); if(!/^\d{4}$/.test(newPin||'')){alert('4 haneli PIN girin');return;} const reqs=store.get('resetReqs',[]); reqs.push({id:uuid(),phone:u.phone,newPin,createdAt:Date.now()}); store.set('resetReqs',reqs); updateBell(); alert('PIN sıfırlama talebi oluşturuldu.');});

/* ==== Hizmet/usta/ayar ==== */
function delSvc(id){ if(!adminAuthed){alert('Yalnızca admin');return;} store.set('services',(store.get('services',[])||[]).filter(s=>s.id!==id)); renderSvcUI(); renderSlots(); renderAdminNewSlots();}
$('#addSvc').addEventListener('click',()=>{ if(!adminAuthed){alert('Yalnızca admin');return;} const name=trNormalize($('#newSvcName').value); const dur=parseInt($('#newSvcDur').value||'30',10); const price=parseInt($('#newSvcPrice').value||'0',10); if(!name){alert('Hizmet adı gerekli');return;} const list=store.get('services',[]); list.push({id:uuid(),name,dur,price}); store.set('services',list); $('#newSvcName').value='';$('#newSvcDur').value='';$('#newSvcPrice').value=''; renderSvcUI(); renderSlots(); renderAdminNewSlots();});
function saveService(id){ if(!adminAuthed){alert('Yalnızca admin');return;} const name=trNormalize(document.querySelector(`[data-sv-name="${id}"]`).value); const dur=parseInt(document.querySelector(`[data-sv-dur="${id}"]`).value||'30',10); const price=parseInt(document.querySelector(`[data-sv-price="${id}"]`).value||'0',10); store.set('services',(store.get('services',[])||[]).map(s=>s.id===id?({...s,name,dur,price}):s)); renderSvcUI(); renderSlots(); renderAdminNewSlots(); showToast('Hizmet güncellendi');}
$('#saveSettings').addEventListener('click',()=>{ if(!adminAuthed){alert('Yalnızca admin');return;} const open=$('#openTime').value||'09:00', close=$('#closeTime').value||'21:00', slot=parseInt($('#slotSize').value||'15',10); store.set('settings',{open,close,slot}); $('#settingsStatus').textContent='Kaydedildi.'; refreshSettingsUI(); renderSlots();});

/* ==== Slot hesapları ==== */
function renderSlots(){ const s=store.get('settings'); $('#hoursLabel').textContent=`${s.open} - ${s.close}`; $('#slotSizeLabel').textContent=s.slot; const staffId=$('#staff')?.value; const svc=(store.get('services',[])||[]).find(x=>x.id===$('#svc')?.value); const date=$('#date')?.value; const box=$('#slots'); if(!box) return; const info=$('#staffInfo'); if(info) info.innerHTML=''; if(!staffId||!svc||!date){ box.innerHTML=''; if(info) info.innerHTML='<span class="small">Usta ve hizmet seçin.</span>'; return;}
  const staff=(staffAll().find(x=>x.id===staffId)||{}); const {open,close}=getHoursFor(staff,date); const works=staffWorksThatDay(staff,date); const closed=isOffDate(staff,date);
  info.innerHTML=`<span class="badge-soft">Usta: <b>${staff.name||''}</b></span> <span class="badge-soft">Saat: ${open}–${close}</span> <span class="badge-soft">Gün: ${DAY_LABELS[new Date(date+'T00:00:00').getDay()]}</span> ${closed?'<span class="badge-soft red">Kapalı gün</span>':''} ${!works?'<span class="badge-soft red">Usta çalışmıyor</span>':''}`;
  const openM=toMin(open), closeM=toMin(close), step=s.slot, dur=svc.dur; const taken=conflicts(date,staffId); box.innerHTML=''; for(let t=openM; t+dur<=closeM; t+=step){ const dis=!works||closed||taken.some(x=>overlaps(t,t+dur,x.start,x.end)); const b=document.createElement('button'); b.type='button'; b.className='slot'+(dis?' dis':''); b.textContent=toHHMM(t); b.dataset.time=toHHMM(t); const pick=()=>{if(dis)return; $$('.slot').forEach(x=>{x.classList.remove('sel');x.setAttribute('aria-pressed','false')}); b.classList.add('sel'); b.setAttribute('aria-pressed','true'); b.scrollIntoView({inline:'center',block:'nearest',behavior:'smooth'});}; b.addEventListener('click',pick,{passive:true}); b.addEventListener('touchstart',pick,{passive:true}); box.appendChild(b);} const first=box.querySelector('.slot:not(.dis)'); if(first&&!box.querySelector('.slot.sel')){first.classList.add('sel'); first.setAttribute('aria-pressed','true');}}
['#svc','#staff','#date'].forEach(sel=>$(sel).addEventListener('change',renderSlots));
document.addEventListener('click',(e)=>{const c=$('#slots'); if(!c) return; if(e.target?.id==='slotPrev') c.scrollBy({left:-220,behavior:'smooth'}); if(e.target?.id==='slotNext') c.scrollBy({left:220,behavior:'smooth'});});

/* ==== Randevu oluşturma (müşteri) ==== */
$('#makeAppt').addEventListener('click',async()=>{ if(!currentUser){$('#makeStatus').textContent='Önce giriş yapın.';showToast('Önce giriş');return;} const selDate=$('#date').value; if(!canCreateAppt(selDate,currentUser.phone)){ $('#makeStatus').textContent=`Aynı gün için en fazla ${MAX_APPTS_PER_DAY}`; showToast('Limit'); return;}
  const svc=store.get('services',[]).find(x=>x.id===$('#svc').value); const staff=staffAll().find(x=>x.id===$('#staff').value); const timeBtn=document.querySelector('.slot.sel'); if(!timeBtn){$('#makeStatus').textContent='Saat seçiniz.';return;}
  const time=timeBtn.dataset.time,duration=svc.dur; const taken=conflicts(selDate,staff.id), start=toMin(time), end=start+duration; if(!staffWorksThatDay(staff,selDate)||isOffDate(staff,selDate)||taken.some(x=>overlaps(start,end,x.start,x.end))){$('#makeStatus').textContent='Bu saat uygun değil.'; renderSlots(); return;}
  const newAppt={id:uuid(),userId:currentUser.id,name:currentUser.name,phone:currentUser.phone,serviceId:svc.id,serviceName:svc.name,staffId:staff.id,staffName:staff.name,date:selDate,time,duration:svc.dur,status:'pending',createdAt:Date.now()};
  await cloud.appts_add(newAppt); $('#makeStatus').textContent='Randevu oluşturuldu (Onay Bekliyor)'; showToast('Randevu oluşturuldu');
});

/* ==== Randevularım ==== */
function loadMyAppts(){const tb=$('#myApptTbody'); if(!tb||!currentUser) return; tb.innerHTML=''; const rows=(store.get('appts',[])||[]).filter(a=>a.userId===currentUser.id).sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time)); rows.forEach(a=>{const tr=document.createElement('tr'); const actionHtml = CUSTOMER_MODIFY?`<button class="btn" onclick="resched('${a.id}')">Saat Değiştir</button><button class="btn" onclick="cancelAppt('${a.id}')">İptal</button><button class="btn" onclick="deleteApptUser('${a.id}')">Sil</button>`:`<span class="small">Bu randevu <b>admin</b> tarafından yönetilir.</span>`; tr.innerHTML=`<td>${a.date}</td><td>${a.time}</td><td>${a.serviceName}</td><td>${a.staffName||''}</td><td>${a.status}</td><td>${actionHtml}</td>`; tb.appendChild(tr);});}
window.cancelAppt=async(id)=>{if(!CUSTOMER_MODIFY&&!adminAuthed){showToast('Yalnızca admin');return;} const a=(store.get('appts',[])||[]).find(x=>x.id===id); if(!a) return; await cloud.appts_update(a.id,{status:'cancelled'})};
window.deleteApptUser=async(id)=>{if(!CUSTOMER_MODIFY&&!adminAuthed){showToast('Yalnızca admin');return;} const a=(store.get('appts',[])||[]).find(x=>x.id===id); if(!a||!currentUser||a.userId!==currentUser.id){showToast('Yetki yok');return;} if(!confirm('Kalıcı silinsin mi?')) return; await cloud.appts_delete(id); showToast('Silindi');};
window.resched=async(id)=>{if(!CUSTOMER_MODIFY&&!adminAuthed){showToast('Yalnızca admin');return;} /* basit sürüm: mevcut koddaki gibi saat listesi vs. eklenebilir */};

/* ==== Admin tabloları ==== */
function statusTR(s){return s==='pending'?'Onay Bekliyor':s==='approved'?'Onaylandı':s==='cancelled'?'İptal':'Reddedildi'}
function renderQueue(){const tb=$('#queueTbody'); if(!tb) return; tb.innerHTML=''; const rows=(store.get('appts',[])||[]).filter(a=>a.status==='pending').sort((a,b)=>a.date.localeCompare(b.date)||a.time.localeCompare(b.time)); rows.forEach(a=>{const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="checkbox" class="chk-appt" data-id="${a.id}"></td><td>${a.name}</td><td>${maskPhone(a.phone)}</td><td>${a.date}</td><td>${a.time}</td><td>${a.serviceName}</td><td>${a.staffName||''}</td><td>${a.duration} dk</td><td><button class="btn" onclick="approve('${a.id}')">Onayla</button> <button class="btn" onclick="reject('${a.id}')">Reddet</button> <button class="btn" onclick="adminDelete('${a.id}')">Sil</button></td>`; tb.appendChild(tr);});}
window.approve=async(id)=>{if(!adminAuthed){alert('Yalnızca admin');return;} const a=(store.get('appts',[])||[]).find(x=>x.id===id); if(!a) return; const conf=(store.get('appts',[])||[]).some(x=>x.id!==a.id&&x.date===a.date&&x.staffId===a.staffId&&x.status!=='cancelled'&&x.status!=='rejected'&&(toMin(a.time)<toMin(x.time)+x.duration&&toMin(a.time)+a.duration>toMin(x.time))); if(conf){alert('Saat çakışıyor');return;} await cloud.appts_update(a.id,{status:'approved'})};
window.reject=async(id)=>{if(!adminAuthed){alert('Yalnızca admin');return;} await cloud.appts_update(id,{status:'rejected'})};
window.adminDelete=async(id)=>{if(!adminAuthed){alert('Yalnızca admin');return;} if(!confirm('Silinsin mi?')) return; await cloud.appts_delete(id)};

$('#viewCal').addEventListener('click',renderCal);
function renderCal(){const tb=$('#calTbody'); if(!tb) return; tb.innerHTML=''; const date=$('#calDate').value||todayISO(); const staffId=$('#calStaff').value; const rows=(store.get('appts',[])||[]).filter(a=>a.date===date&&(!staffId||a.staffId===staffId)&&a.status!=='rejected').sort((a,b)=>a.time.localeCompare(b.time)); rows.forEach(a=>{const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="checkbox" class="chk-appt" data-id="${a.id}"></td><td>${a.time} (${a.duration}')</td><td>${a.name}</td><td>${a.serviceName} / ${a.staffName||''}</td><td>${statusTR(a.status)}</td><td>${a.status!=='cancelled'?`<button class="btn" onclick="cancelAdmin('${a.id}')">İptal</button>`:''} <button class="btn" onclick="adminDelete('${a.id}')">Sil</button></td>`; tb.appendChild(tr);});}
window.cancelAdmin=async(id)=>{if(!adminAuthed){alert('Yalnızca admin');return;} await cloud.appts_update(id,{status:'cancelled'})};

$('#loadAll').addEventListener('click',renderAllAppts);
$('#bulkDelete').addEventListener('click',async()=>{if(!adminAuthed){alert('Yalnızca admin');return;} const ids=[...document.querySelectorAll('#allApptTbody .chk-appt:checked')].map(x=>x.dataset.id); if(ids.length===0){showToast('Seçim yok');return;} if(!confirm(`${ids.length} randevu silinsin mi?`)) return; for(const id of ids){ await cloud.appts_delete(id);} showToast('Silindi');});
$('#chkAll')?.addEventListener('change',e=>{$$('#allApptTbody .chk-appt').forEach(c=>c.checked=e.target.checked);});
function renderAllAppts(){const tb=$('#allApptTbody'); if(!tb) return; tb.innerHTML=''; const d=$('#allDate').value||todayISO(); const staffId=$('#allStaff').value; const rows=(store.get('appts',[])||[]).filter(a=>(!d||a.date===d)&&(!staffId||a.staffId===staffId)).sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time)); rows.forEach(a=>{const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="checkbox" class="chk-appt" data-id="${a.id}"></td><td>${a.date}</td><td>${a.time}</td><td>${a.name}</td><td>${maskPhone(a.phone)}</td><td>${a.serviceName}</td><td>${a.staffName||''}</td><td>${statusTR(a.status)}</td><td><button class="btn" onclick="adminDelete('${a.id}')">Sil</button></td>`; tb.appendChild(tr);});}

/* ==== Müşteriler ==== */
function renderUsers(){const tb=$('#usersTbody'); if(!tb) return; const list=(store.get('users',[])||[]).slice().sort((a,b)=>trCmp(a.name,b.name)); tb.innerHTML=list.map(u=>`<tr><td><input class="inlineFld" value="${u.name||''}" data-us-name="${u.id}"></td><td>${maskPhone(u.phone)||''}</td><td>${u.createdAt?new Date(u.createdAt).toLocaleString():'-'}</td><td>${u.lastLogin?new Date(u.lastLogin).toLocaleString():'-'}</td><td>${u.verified?'✅':'—'}</td><td><button class="btn btn-primary" onclick="saveUserName('${u.id}')">Kaydet</button><button class="btn" onclick="deleteUser('${u.id}')">Sil</button></td></tr>`).join('');}
window.saveUserName=async(id)=>{if(!adminAuthed){alert('Yalnızca admin');return;} const name=trNormalize(document.querySelector(`[data-us-name="${id}"]`).value); await cloud.users_update(id,{name}); showToast('Müşteri adı güncellendi');}
window.deleteUser=async(id)=>{if(!adminAuthed){alert('Yalnızca admin');return;} if(!confirm('Müşteri silinsin mi? (randevular korunur)')) return; await cloud.users_delete(id);}

/* ==== Usta Takvimi (gün/saat/off) ==== */
function renderScheduleEditor(){const staffArr=staffAll(); const meta=$('#schedMeta'), dayWrap=$('#dayChecks'); const offWrap=$('#offList'); if(staffArr.length===0){ if(meta){meta.innerHTML=`Henüz usta yok.`;} dayWrap.innerHTML=''; offWrap.innerHTML=''; return;}
  const sel=$('#schedStaff').value || staffArr.sort((a,b)=>trCmp(a.name,b.name))[0].id; $('#schedStaff').value=sel; const st=staffArr.find(s=>s.id===sel);
  if(!st.days) st.days=[1,2,3,4,5,6]; if(!st.hours) st.hours={open:store.get('settings').open,close:store.get('settings').close}; if(!Array.isArray(st.offDates)) st.offDates=[];
  $('#schedOpen').value=st.hours.open; $('#schedClose').value=st.hours.close; meta.textContent=`Seçili usta: ${st.name}`;
  dayWrap.innerHTML=DAY_LABELS.map((lab,i)=>`<label class="badge-soft"><input type="checkbox" data-dow="${i}" ${st.days.includes(i)?'checked':''} style="width:auto;margin-right:6px">${lab}</label>`).join(' ');
  renderOffList(st);
  $('#schedStaff').onchange=()=>renderScheduleEditor();
  $('#saveSched').onclick=async()=>{if(!adminAuthed){alert('Yalnızca admin');return;} const open=$('#schedOpen').value||'09:00', close=$('#schedClose').value||'21:00'; const days=[...document.querySelectorAll('#dayChecks input[type="checkbox"]')].filter(x=>x.checked).map(x=>parseInt(x.getAttribute('data-dow'),10)); await cloud.staff_update(st.id,{hours:{open,close},days}); showToast('Kaydedildi');};
  $('#addOff').onclick=async()=>{if(!adminAuthed){alert('Yalnızca admin');return;} const d=$('#offDate').value; if(!d) return; const list=new Set(st.offDates||[]); list.add(d); await cloud.staff_update(st.id,{offDates:[...list]}); showToast('Kapalı gün eklendi');};
}
function renderOffList(staff){const wrap=$('#offList'); wrap.innerHTML=''; (staff.offDates||[]).sort().forEach(d=>{const chip=document.createElement('span'); chip.className='badge-soft'; chip.textContent=d+' '; const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Sil'; btn.onclick=async()=>{ if(!adminAuthed){alert('Yalnızca admin');return;} const list=(staff.offDates||[]).filter(x=>x!==d); await cloud.staff_update(staff.id,{offDates:list}); showToast('Silindi');}; chip.appendChild(btn); wrap.appendChild(chip);});}

/* ==== Admin Yeni Randevu — Süre & slot ==== */
function _svcDurById(id){const svcs=store.get('services',[])||[];return (svcs.find(s=>s.id===id)?.dur)||30;}
(function initAdminDurationFields(){const durInp=$('#a_dur'), lockCb=$('#a_lockSvcDur'); if(!durInp||!lockCb) return; const setDur=()=>{const svcId=$('#a_svc')?.value; durInp.value=_svcDurById(svcId)}; const apply=()=>{durInp.disabled=lockCb.checked; if(lockCb.checked) setDur(); renderAdminNewSlots();};
  $('#a_svc')?.addEventListener('change',()=>{if(lockCb.checked) setDur(); renderAdminNewSlots();}); lockCb.addEventListener('change',apply); durInp.addEventListener('input',()=>renderAdminNewSlots()); setTimeout(apply,0);})();
function adminAvailableTimes(date,staffId,duration){const staff=(staffAll().find(x=>x.id===staffId)||{}); const works=(staff.days||[1,2,3,4,5,6]).includes(new Date(date+'T00:00:00').getDay()); const closed=(staff.offDates||[]).includes(date); const {open,close}=getHoursFor(staff,date); const openM=toMin(open), closeM=toMin(close), step=store.get('settings').slot; if(!works||closed) return []; const taken=conflicts(date,staffId); const list=[]; for(let t=openM; t+duration<=closeM; t+=step){const conflict=taken.some(x=>overlaps(t,t+duration,x.start,x.end)); if(!conflict) list.push(toHHMM(t));} return list;}
function renderAdminNewSlots(){const svc=store.get('services',[]).find(x=>x.id===$('#a_svc')?.value); const staffId=$('#a_staff')?.value; const date=$('#a_date')?.value; const box=$('#a_slots'); if(!box) return; const lock=$('#a_lockSvcDur'); const durInp=$('#a_dur'); let duration=0; if(lock && lock.checked){duration=svc?(svc.dur||30):30; if(durInp){durInp.value=duration; durInp.disabled=true;}}else{duration=parseInt(durInp?.value||'0',10)||(svc?.dur||30);} if(!svc||!staffId||!date){box.innerHTML='';return;} const times=adminAvailableTimes(date,staffId,duration); box.innerHTML=''; times.forEach(t=>{const b=document.createElement('button'); b.type='button'; b.className='slot'; b.textContent=t; b.dataset.time=t; b.onclick=()=>{$$('#a_slots .slot').forEach(x=>x.classList.remove('sel')); b.classList.add('sel');}; box.appendChild(b);}); const first=box.querySelector('.slot'); if(first){first.classList.add('sel');}}
['#a_svc','#a_staff','#a_date'].forEach(sel=>document.querySelector(sel)?.addEventListener('change', renderAdminNewSlots));
document.addEventListener('click',(e)=>{ if(e.target?.id==='a_prev') $('#a_slots').scrollBy({left:-220,behavior:'smooth'}); if(e.target?.id==='a_next') $('#a_slots').scrollBy({left:220,behavior:'smooth'}); });
$('#a_create')?.addEventListener('click', async()=>{ if(!adminAuthed){alert('Yalnızca admin');return;} const name=trNormalize($('#a_name').value); const cc=$('#a_cc').value; const phoneE164=(cc==='other')?toE164($('#a_phone').value,'other'):toE164($('#a_phone').value,'+90'); const svc=store.get('services',[]).find(x=>x.id===$('#a_svc').value); const staff=staffAll().find(x=>x.id===$('#a_staff').value); const date=$('#a_date').value; const timeBtn=$('#a_slots .slot.sel'); const time=timeBtn?.dataset.time; const override=$('#a_override').checked; const statusEl=$('#a_status'); const lock=$('#a_lockSvcDur')?.checked; let duration=lock?(svc?.dur||30):parseInt($('#a_dur')?.value||'0',10); if(!name||!phoneE164||!svc||!staff||!date||!time){statusEl.textContent='Eksik bilgi';return;} if(cc!=='other'&&!isTR(phoneE164)){statusEl.textContent='TR telefon biçimi hatalı';return;}
  if(!override && !canCreateAppt(date,phoneE164)){statusEl.textContent=`Aynı gün için en fazla ${MAX_APPTS_PER_DAY}`;return;}
  const taken=conflicts(date,staff.id), start=toMin(time), end=start+duration; if(taken.some(x=>overlaps(start,end,x.start,x.end))){statusEl.textContent='Saat dolu'; renderAdminNewSlots(); return;}
  let u=(store.get('users',[])||[]).find(x=>x.phone===phoneE164); if(!u){u={id:uuid(),name,phone:phoneE164,verified:true,pin:'0000',createdAt:Date.now()}; await cloud.users_upsert(u); try{store.set('users',await cloud.users_list())}catch{} }
  await cloud.appts_add({id:uuid(),userId:u.id,name,phone:phoneE164,serviceId:svc.id,serviceName:svc.name,staffId:staff.id,staffName:staff.name,date,time,duration,status:'pending',createdAt:Date.now()});
  statusEl.textContent='Randevu eklendi'; showToast('Admin: randevu eklendi');
});

/* ==== Bildirim çanı ==== */
function getPendingCount(){try{return (store.get('appts',[])||[]).filter(a=>a.status==='pending').length+(store.get('resetReqs',[])||[]).length}catch(e){return 0}}
function updateBell(){const n=$('#notifyCount'); if(!n) return; const c=getPendingCount(); n.textContent=String(c); n.style.background=c>0?'#ef4444':'#9ca3af';}
document.addEventListener('DOMContentLoaded',updateBell);

/* ==== PIN reset ==== */
function renderResetReqs(){const tb=$('#resetTbody'); if(!tb) return; const reqs=store.get('resetReqs',[])||[]; if(reqs.length===0){tb.innerHTML='<tr><td colspan="4" class="small">Aktif talep yok.</td></tr>';return;} tb.innerHTML=reqs.sort((a,b)=>b.createdAt-a.createdAt).map(r=>`<tr><td>${maskPhone(r.phone)}</td><td><code>${r.newPin}</code></td><td>${new Date(r.createdAt).toLocaleString()}</td><td><button class="btn btn-primary" onclick="approveReset('${r.id}')">Onayla</button><button class="btn" onclick="rejectReset('${r.id}')">Sil</button></td></tr>`).join('');}
window.approveReset=async(id)=>{if(!adminAuthed){alert('Yalnızca admin');return;} const reqs=store.get('resetReqs',[])||[]; const r=reqs.find(x=>x.id===id); if(!r){return;} const u=(store.get('users',[])||[]).find(x=>x.phone===r.phone); if(!u){showToast('Kullanıcı yok');return;} await cloud.users_update(u.id,{pin:String(r.newPin)}); store.set('resetReqs',reqs.filter(x=>x.id!==id)); updateBell(); renderResetReqs(); showToast('PIN güncellendi');}
window.rejectReset=(id)=>{const reqs=store.get('resetReqs',[])||[]; store.set('resetReqs',reqs.filter(x=>x.id!==id)); updateBell(); renderResetReqs(); showToast('Talep silindi');}

/* ==== Raporlar ==== */
function sumRevenue(list){const svcs=Object.fromEntries((store.get('services',[])||[]).map(s=>[s.id,s])); return list.reduce((acc,a)=>acc+((a.status==='approved')?(Number(svcs[a.serviceId]?.price||0)):0),0)}
const pct=(n,d)=>d>0?Math.round((n/d)*100):0;
function computeReport(days){const appts=(store.get('appts',[])||[]).slice(); const now=new Date(); const start=new Date(now); start.setHours(0,0,0,0); if(days>1) start.setDate(start.getDate()-(days-1)); const inRange=appts.filter(a=>{const dt=new Date(a.date+'T00:00:00'); return dt>=start&&dt<=now;}); const total=inRange.length,approved=inRange.filter(a=>a.status==='approved').length,cancelled=inRange.filter(a=>a.status==='cancelled').length,pending=inRange.filter(a=>a.status==='pending').length,revenue=sumRevenue(inRange); return {total,approved,cancelled,pending,approveRate:pct(approved,total),revenue};}
function renderReports(){const T=computeReport(1),W=computeReport(7),fmt=n=>new Intl.NumberFormat('tr-TR').format(n); const tEl=$('#reportToday'),wEl=$('#reportWeek'); if(tEl){tEl.innerHTML=`<div class="reportCard"><div class="k">Bugün Toplam</div><div class="v">${fmt(T.total)}</div></div><div class="reportCard"><div class="k">Onaylı</div><div class="v">${fmt(T.approved)}</div><div class="sub">Oran: %${fmt(T.approveRate)}</div></div><div class="reportCard"><div class="k">Bekleyen</div><div class="v">${fmt(T.pending)}</div></div><div class="reportCard"><div class="k">İptal</div><div class="v">${fmt(T.cancelled)}</div></div><div class="reportCard"><div class="k">Gelir (TL)</div><div class="v">${fmt(T.revenue)}</div><div class="sub">*Sadece onaylı</div></div>`;}
  if(wEl){wEl.innerHTML=`<div class="reportCard"><div class="k">Son 7 Gün Toplam</div><div class="v">${fmt(W.total)}</div></div><div class="reportCard"><div class="k">Onaylı</div><div class="v">${fmt(W.approved)}</div><div class="sub">Oran: %${fmt(W.approveRate)}</div></div><div class="reportCard"><div class="k">Bekleyen</div><div class="v">${fmt(W.pending)}</div></div><div class="reportCard"><div class="k">İptal</div><div class="v">${fmt(W.cancelled)}</div></div><div class="reportCard"><div class="k">Gelir (TL)</div><div class="v">${fmt(W.revenue)}</div><div class="sub">*Sadece onaylı</div></div>`;}}
document.getElementById('refreshAdmin')?.addEventListener('click',renderReports);

/* ==== Başlat ==== */
document.addEventListener('DOMContentLoaded',()=>{ $('#date').value=todayISO(); $('#calDate').value=todayISO(); $('#allDate').value=todayISO(); $('#a_date').value=todayISO(); refreshSettingsUI(); renderSvcUI(); tryAutoLogin(); startRealtime(); renderReports();
  $$('.auth-tab').forEach(b=>b.addEventListener('click',()=>{ $$('.auth-tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');}));
});
</script>
</body></html>
