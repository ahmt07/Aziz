<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ahmet Tekeli Erkek Kuaf√∂r√º ‚Ä¢ Online Randevu</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d1015; --ink:#e9ecf2; --muted:#9aa3b2; --line:#2a2f39;
  --panel:rgba(255,255,255,.08); --panel-line:rgba(255,255,255,.15);
  --brand:#d4af37; --danger:#ef4444; --ok:#22c55e; --blue:#60a5fa;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1080px;margin:0 auto;padding:0 16px}

/* Header */
header{position:sticky;top:0;z-index:20;backdrop-filter:blur(10px);background:rgba(13,16,21,.7);border-bottom:1px solid var(--line)}
.hrow{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;padding:12px 0}
.left,.right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.left{justify-content:flex-start}.right{justify-content:flex-end}

/* Brand */
.brand{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
.brand .t1{font-family:"Playfair Display",serif;font-weight:800;letter-spacing:.4px;font-size:28px}
.brand .t2{font-weight:700;letter-spacing:.25px;color:#a5b4fc}
@media(max-width:760px){.brand .t1{font-size:22px}.brand .t2{font-size:13px}}

/* Buttons / chips */
.badge{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#1b212b;color:#e5e7eb;border-radius:999px;padding:8px 12px;cursor:pointer}
.badge .dot{min-width:18px;height:18px;border-radius:999px;background:#ef4444;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:800}
.chip{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#202631;color:#e5e7eb;border-radius:999px;padding:6px 10px}

/* Bell blink */
#bellBtn.blink{animation:pulse 1s ease-in-out infinite}
@keyframes pulse{0%{filter:none}50%{filter:drop-shadow(0 0 10px #f66) saturate(1.15)}100%{filter:none}}

/* Main */
main{padding:18px 0}
.hero{display:flex;flex-direction:column;align-items:center;gap:12px;margin:18px 0 14px}
.hero .logo{width:82px;height:82px;border-radius:999px;border:4px solid rgba(255,255,255,.18);box-shadow:0 6px 26px rgba(0,0,0,.35);background:#fff url('') center/cover no-repeat}
.hero .rating{display:flex;gap:8px;align-items:center;color:#f8d57e;font-weight:700}
.hero .rating .star{filter:drop-shadow(0 0 6px rgba(212,175,55,.4))}

/* Card (frosted) */
.card{background:var(--panel);border:1px solid var(--panel-line);border-radius:18px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.35);backdrop-filter:blur(12px)}
.grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media(max-width:760px){.grid-2{grid-template-columns:minmax(0,1fr)}}

h2{margin:0 0 12px;font-size:26px}
h3,h4{margin:0 0 10px}
label{display:block;font-weight:700;margin:0 0 6px}
input,select,textarea{width:100%;padding:12px 12px;border:1px solid var(--line);border-radius:12px;background:#1b212b;color:var(--ink);font-size:16px}
input[readonly]{opacity:.85}
.small{font-size:12px;color:var(--muted)}
.btn{border:1px solid var(--line);background:#232a36;color:#e5e7eb;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn-primary{background:linear-gradient(90deg,#b99309,#f7e38e,#b99309);color:#121212;border:none;font-weight:800}
.btn-danger{background:#ef4444;border-color:#ef4444;color:#fff}

/* Slot grid */
.slotgrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
@media(max-width:540px){.slotgrid{grid-template-columns:repeat(3,minmax(0,1fr))}}
.slot{border:1px solid #2b313c;background:#232a36;color:#e8edf7;border-radius:22px;padding:14px 0;font-weight:700;text-align:center}
.slot.busy{background:#2a2f39;color:#6b7280;pointer-events:none}
.slot.sel{background:#0ea5e9;color:#00131a;border-color:#0ea5e9}

/* Table */
.table-scroll{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #2b313c;text-align:left}
thead th{background:#1f2530;font-weight:800}

/* Sheet (modal) */
.sheet{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;z-index:40}
.sheet.show{display:flex}
.sheet .panel{width:100%;max-height:92vh;background:#141820;border:1px solid var(--line);border-radius:16px 16px 0 0;box-shadow:0 -14px 40px rgba(0,0,0,.45);padding:20px;overflow:auto}
.sheet .panel.admin{max-width:980px;border-top:5px solid var(--brand)}
.sheet .panel.customer{max-width:920px;border-top:5px solid #3b82f6}
.sheet .panel h3{font-size:22px}

/* Toast */
#toast{position:fixed;left:50%;top:-80px;transform:translateX(-50%);background:#0b1220;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:80;transition:top .45s;border:1px solid #325}
#toast.show{top:12px}

/* Status badge */
.badge-status{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid transparent}
.st-pending{background:#3a3322;color:#f6e7c2;border-color:#b48b1d}
.st-approved{background:#1f3a2a;color:#c9f7d7;border-color:#2ea44f}
.st-cancelled{background:#33373e;color:#e2e8f0;border-color:#6b7280}
.st-rejected{background:#3b1f24;color:#ffd7d7;border-color:#ef4444}
.st-deleted{background:#3b1f1f;color:#ffdddd;border-color:#b91c1c}

/* Hide some chips on very small */
@media(max-width:520px){ .chip{display:none} }
</style>
</head>
<body>
<div id="toast"></div>

<header>
  <div class="wrap hrow">
    <!-- SOL: Admin + √áan -->
    <div class="left">
      <button id="adminOpen" class="badge">üë®‚Äçüíº Admin</button>
      <button id="bellBtn" class="badge" title="Bildirimler" style="display:none">üîî <span id="bellCount" class="dot">0</span></button>
    </div>

    <!-- ORTA: Marka -->
    <div class="brand">
      <div class="t1">AHMET TEKELƒ∞</div>
      <div class="t2">ERKEK KUAF√ñR√ú</div>
    </div>

    <!-- SAƒû: M√º≈üteri -->
    <div class="right">
      <span id="custBadge" class="chip" style="display:none">üë§ <b id="custNameShort">M√º≈üteri</b></span>
      <button id="custOpen" class="badge">üë§ M√º≈üteri</button>
      <button id="myApptsOpen" class="badge" style="display:none">üìÖ Randevularƒ±m</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <div class="logo" aria-hidden="true"></div>
    <div class="rating"><span class="star">‚≠ê</span>4.9 (161)</div>
  </section>

  <section class="card">
    <h2>Randevu Olu≈ütur</h2>
    <div class="grid-2">
      <div><label>Ad Soyad</label><input id="f_name" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z"></div>
      <div><label>Telefon</label><input id="f_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
      <div><label>Berber</label><select id="f_staff"><option disabled selected>‚Äî Se√ßiniz ‚Äî</option></select></div>
      <div><label>Hizmet</label><select id="f_service"><option disabled selected>‚Äî Se√ßiniz ‚Äî</option></select></div>
      <div><label>Tarih</label><input type="date" id="f_date"></div>
      <div>
        <label>Saat Se√ßimi</label>
        <div id="slotgrid" class="slotgrid"></div>
      </div>
    </div>
    <div class="small" id="f_priceInfo" style="margin-top:6px">√úcret: ‚Äî</div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
      <button class="btn btn-primary" id="f_book">RANDEVU AL</button>
      <span id="f_status" class="small"></span>
    </div>
  </section>

  <!-- Admin Analytics opsiyonel gizli -->
  <section class="card" id="adminAnalytics" style="margin-top:12px;display:none">
    <h4>Onay Bekleyenler</h4>
    <div id="kpi" class="small"></div>
  </section>
</main>

<!-- Bildirim/Onay kuyruƒüu -->
<div id="sheetBell" class="sheet"><div class="panel admin">
  <h3>Onay Kuyruƒüu</h3>
  <div id="queueList" class="small">Kuyruk bo≈ü.</div>
</div></div>

<!-- Admin giri≈üi -->
<div id="sheetAdmin" class="sheet"><div class="panel admin">
  <h3>Y√∂netici Giri≈üi</h3>
  <div class="grid-2">
    <div><label>Admin Telefon</label><input id="adminPhone" value="+905356749243"></div>
    <div><label>≈ûifre</label><input id="adminPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
  </div>
  <div class="small" style="margin-top:6px">Giri≈ü yaptƒ±ƒüƒ±nƒ±zda admin oturumu bu cihazda kalƒ±cƒ± olur.</div>
  <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
    <button class="btn btn-primary" id="adminLoginBtn">Giri≈ü Yap</button>
    <button class="btn" id="adminLogoutBtn">√áƒ±kƒ±≈ü</button>
    <span id="adminStatus" class="small"></span>
  </div>
</div></div>

<!-- M√º≈üteri giri≈üi -->
<div id="sheetCust" class="sheet"><div class="panel customer">
  <h3>M√º≈üteri Giri≈üi / Kayƒ±t</h3>
  <div class="grid-2">
    <div><label>Ad Soyad</label><input id="c_name" placeholder="Ad Soyad"></div>
    <div><label>Telefon</label><input id="c_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
  </div>
  <div class="grid-2">
    <div><label>≈ûifre</label><input id="c_pin" type="password" maxlength="32" placeholder="≈ûifreniz (min 4)"></div>
    <div style="display:flex;gap:8px;align-items:flex-end">
      <button class="btn btn-primary" id="c_login">Giri≈ü / Kayƒ±t</button>
      <button class="btn" id="c_forgot">≈ûifremi Unuttum</button>
    </div>
  </div>
  <p class="small" id="c_status"></p>
</div></div>

<!-- M√º≈üteri randevularƒ±m -->
<div id="sheetMyAppts" class="sheet"><div class="panel customer">
  <h3>Randevularƒ±m</h3>
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
    <select id="my_filter" style="max-width:220px">
      <option value="upcoming">Yakla≈üan</option>
      <option value="all">T√ºm√º</option>
      <option value="past">Ge√ßmi≈ü</option>
    </select>
    <button class="btn" id="my_refresh">Yenile</button>
    <button class="btn" id="c_logout" style="margin-left:auto">√áƒ±kƒ±≈ü</button>
  </div>
  <div class="table-scroll">
    <table>
      <thead><tr><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead>
      <tbody id="my_tbody"></tbody>
    </table>
  </div>
  <p class="small">‚ÄúDeƒüi≈ütir‚Äù sonrasƒ± randevu tekrar onaya d√º≈üer.</p>
</div></div>

<!-- Randevu Deƒüi≈ütir -->
<div id="sheetResched" class="sheet"><div class="panel customer">
  <h3>Randevuyu Deƒüi≈ütir</h3>
  <div class="grid-2">
    <div><label>Tarih</label><input type="date" id="rs_date"></div>
    <div><label>Saat Se√ßimi</label><div id="rs_grid" class="slotgrid"></div></div>
  </div>
  <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
    <button class="btn btn-primary" id="rs_save">Kaydet</button>
    <button class="btn" id="rs_cancel">Vazge√ß</button>
    <span id="rs_status" class="small"></span>
  </div>
</div></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const store={get(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}},del(k){try{localStorage.removeItem(k)}catch(e){}};
function toast(m,ms=2200){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);}
const toMin=t=>{const[h,m]=t.split(':').map(Number);return h*60+m}, toHHMM=m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
function overlaps(aS,aE,bS,bE){return aS<bE && aE>bS}
function maskPhone(p){ if(!p) return ''; if(p.startsWith('+90')){const n=p.slice(3); return `0${n.slice(0,3)} ${n.slice(3,6)} ${n.slice(6,8)} ${n.slice(8,10)}`} return p }
function normalizePhone(phone){const s=(phone||'').replace(/\s|-/g,''); if(s.startsWith('+')) return s; if(s.startsWith('05')) return '+90'+s.slice(1); if(s.startsWith('0')) return '+90'+s.slice(1); return s}

/* ===== Firebase ===== */
firebase.initializeApp({
  apiKey:"AIzaSyBtSQ9_5R42BU5ga0cOt1QETkC5nOf2tW4",
  authDomain:"randevu-81305.firebaseapp.com",
  projectId:"randevu-81305",
  storageBucket:"randevu-81305.firebasestorage.app",
  messagingSenderId:"686048709577",
  appId:"1:686048709577:web:b2db4eeae83203ca2e3618",
  measurementId:"G-3ZX91ND545"
});
const db=firebase.firestore();

/* ===== State ===== */
const ADMIN_PHONE_E164='+905356749243';
const ADMIN_PASSWORD='ahmet07';
let adminOn=false, currentUser=store.get('custSession',null);
let lastStaff=[], lastSvcs=[], lastAppts=[], unsubAppts=null, unsubStaff=null, unsubSvcs=null;
let _rs=null;

/* ===== UI state ===== */
function setAdmin(on){
  adminOn=!!on;
  $('#bellBtn').style.display = on ? 'inline-flex' : 'none';
  $('#adminAnalytics').style.display = on ? 'block' : 'none';
  if(on){ store.set('adminSession','on'); } else { store.del('adminSession'); }
}
function setCust(on){
  $('#myApptsOpen').style.display = on ? 'inline-flex' : 'none';
  if(on && currentUser){
    store.set('custSession', currentUser);
    $('#custNameShort').textContent = (currentUser.name||'M√º≈üteri').split(' ')[0];
    $('#custBadge').style.display = 'inline-flex';
  }else{
    $('#custBadge').style.display = 'none';
    store.del('custSession');
  }
}

/* restore sessions */
(function restore(){
  if(store.get('adminSession')==='on'){ setAdmin(true); }
  const savedUser = store.get('custSession');
  if(savedUser?.phone){ currentUser = savedUser; setCust(true); $('#f_name').value=savedUser.name||''; $('#f_phone').value=savedUser.phone.replace('+90','0'); }
})();

/* ===== Date helpers for availability ===== */
function isoToday(){ return new Date().toISOString().slice(0,10); }
function addDaysISO(iso, n){ const d=new Date(iso+'T00:00:00'); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
function staffWorks(staff,dateISO){
  const dow=new Date(dateISO+'T00:00:00').getDay();
  const dayOk = !staff?.days || staff.days.includes(dow);
  const off   = (staff?.offDates||[]).includes(dateISO);
  return dayOk && !off;
}
function getIntervalsFor(staff,dateISO){
  const dow=new Date(dateISO+'T00:00:00').getDay();
  const by=staff?.hoursByDay?.[dow];
  if(by && by.open1 && by.close1){
    const arr=[{open:by.open1, close:by.close1}];
    if(by.open2 && by.close2) arr.push({open:by.open2, close:by.close2});
    return arr;
  }
  const base=staff?.hours || {open:'09:00',close:'21:00'};
  return [{open:base.open, close:base.close}];
}

/* ===== Select fillers ===== */
function fillStaff(){
  const sel=$('#f_staff'); const cur=sel.value;
  sel.innerHTML='<option disabled selected>‚Äî Se√ßiniz ‚Äî</option>'+lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  if(lastStaff.some(s=>s.id===cur)) sel.value=cur;
}
function fillServices(){
  const sel=$('#f_service'); const cur=sel.value;
  sel.innerHTML='<option disabled selected>‚Äî Se√ßiniz ‚Äî</option>'+lastSvcs.map(s=>`<option value="${s.id}">${s.name} ‚Äî ${s.dur} dk (${s.price||0} TL)</option>`).join('');
  if(lastSvcs.some(s=>s.id===cur)) sel.value=cur;
}

/* ===== Slots ===== */
const STEP=30;
function conflicts(appts,date,staffId){
  return (appts||[]).filter(a=>a.date===date&&a.staffId===staffId&&a.status!=='cancelled'&&a.status!=='rejected'&&a.status!=='deleted')
    .map(a=>({start:toMin(a.time), end:toMin(a.time)+(a.duration||30)}));
}
function renderGrid(containerId, staff, svcDur, date){
  const box=document.getElementById(containerId); box.innerHTML='';
  if(!staff||!svcDur||!date) return;
  const works = staffWorks(staff,date);
  const taken=conflicts(lastAppts,date,staff.id);
  const intervals=getIntervalsFor(staff,date);
  intervals.forEach(iv=>{
    const openM=toMin(iv.open), closeM=toMin(iv.close);
    for(let t=openM; t+svcDur<=closeM; t+=STEP){
      const time=toHHMM(t);
      const busy = !works || taken.some(x=>overlaps(t,t+svcDur,x.start,x.end));
      const b=document.createElement('button');
      b.type='button'; b.className='slot'+(busy?' busy':''); b.textContent=time; b.dataset.time=time;
      b.onclick=()=>{ if(busy) return; [...box.querySelectorAll('.slot')].forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); };
      box.appendChild(b);
    }
  });
}
function getSelected(containerId){ return document.querySelector(`#${containerId} .slot.sel`)?.dataset.time||null; }

/* ===== Price (basit) ===== */
function updatePriceInfo(){
  const id=$('#f_service')?.value;
  const svc=lastSvcs.find(s=>s.id===id);
  const base=svc?.price||0;
  $('#f_priceInfo').textContent = id ? `√úcret: ${new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY'}).format(base)}` : '√úcret: ‚Äî';
}

/* ===== Compute slots on change ===== */
$('#f_date').value = isoToday();
$('#f_staff').onchange=computeSlots; $('#f_service').onchange=()=>{computeSlots(); updatePriceInfo();}; $('#f_date').onchange=computeSlots;
function computeSlots(){
  const sId=$('#f_staff').value, vId=$('#f_service').value, d=$('#f_date').value;
  if(!sId||!vId||!d){$('#slotgrid').innerHTML='';return;}
  const s=lastStaff.find(x=>x.id===sId), v=lastSvcs.find(x=>x.id===vId); if(!s||!v) return;
  renderGrid('slotgrid',s,v.dur||30,d);
}

/* ===== Admin & Customer Sheets ===== */
const sheet={show:id=>{ $(id).classList.add('show'); document.body.style.overflow='hidden'; }, hide:id=>{ $(id).classList.remove('show'); document.body.style.overflow=''; }};
['#sheetBell','#sheetAdmin','#sheetCust','#sheetMyAppts','#sheetResched'].forEach(id=>$(id).addEventListener('click',e=>{ if(e.target===e.currentTarget) sheet.hide(id); }));
$('#adminOpen').onclick=()=>sheet.show('#sheetAdmin');
$('#custOpen').onclick =()=>sheet.show('#sheetCust');
$('#myApptsOpen').onclick=()=>sheet.show('#sheetMyAppts');
$('#bellBtn').onclick  =()=>{ lastSeen=Date.now(); store.set('adminLastSeen',lastSeen); updateBell(0); sheet.show('#sheetBell'); };

/* ===== Realtime ===== */
function startRealtime(){
  if(unsubStaff)unsubStaff(); if(unsubSvcs)unsubSvcs(); if(unsubAppts)unsubAppts();
  unsubStaff=db.collection('staff').onSnapshot(ss=>{ lastStaff=ss.docs.map(d=>({id:d.id,...d.data()})); fillStaff(); if(_rs) computeResched(); computeSlots(); });
  unsubSvcs =db.collection('services').onSnapshot(ss=>{ lastSvcs =ss.docs.map(d=>({id:d.id,...d.data()})); fillServices(); updatePriceInfo(); computeSlots(); });
  unsubAppts=db.collection('appts').onSnapshot(ss=>{
    lastAppts=ss.docs.map(d=>({id:d.id,...d.data()}));
    renderQueue(lastAppts); renderMy(lastAppts);
    // admin KPI mini
    const pend = lastAppts.filter(a=>a.status==='pending').length;
    $('#kpi').textContent = `Beklemede: ${pend}`;
    // yeni pending sayƒ±sƒ± (√ßan)
    const news = lastAppts.filter(a => (a.createdAt||0) > lastSeen && a.status==='pending').length;
    updateBell(news);
  });
}
startRealtime();

/* ===== Admin login/logout (kalƒ±cƒ±) ===== */
$('#adminLoginBtn').onclick=()=>{
  try{
    const phone=normalizePhone($('#adminPhone').value||'');
    const pass =($('#adminPass').value||'').trim();
    if(phone===ADMIN_PHONE_E164 && pass===ADMIN_PASSWORD){
      setAdmin(true); $('#adminStatus').textContent='Giri≈ü ba≈üarƒ±lƒ±'; sheet.hide('#sheetAdmin'); toast('Admin a√ßƒ±ldƒ±');
    }else $('#adminStatus').textContent='≈ûifre hatalƒ±';
  }catch(err){ $('#adminStatus').textContent='Hata'; }
};
$('#adminLogoutBtn').onclick=()=>{ setAdmin(false); $('#adminStatus').textContent='√áƒ±kƒ±≈ü yapƒ±ldƒ±'; toast('Admin kapandƒ±'); };

/* ===== M√º≈üteri login/kayƒ±t + forgot ===== */
$('#c_login').onclick=async ()=>{
  const name=($('#c_name').value||'').trim(), phone=normalizePhone($('#c_phone').value||''), pin=($('#c_pin').value||'').trim();
  if(!name||!phone||pin.length<4){ $('#c_status').textContent='Ad/Telefon ve ≈üifre (min 4) gerekli.'; return; }
  try{
    const q=await db.collection('users').where('phone','==',phone).limit(1).get();
    let uid;
    if(q.empty){ const uref=await db.collection('users').add({name,phone,verified:true,pin,createdAt:Date.now(),lastLogin:Date.now()}); uid=uref.id; }
    else{
      const doc=q.docs[0], u=doc.data(); uid=doc.id;
      if(u.pin && u.pin!==pin){ $('#c_status').textContent='≈ûifre hatalƒ±.'; return; }
      await db.collection('users').doc(uid).set({name,lastLogin:Date.now()},{merge:true});
      if(u.forcePwChange){ // admin ge√ßici ≈üifre vermi≈üse
        toast('L√ºtfen yeni ≈üifre belirleyin (admin ge√ßici ≈üifre verdi)');
      }
    }
    currentUser={id:uid,name,phone}; setCust(true);
    $('#c_status').textContent='Giri≈ü ba≈üarƒ±lƒ±.'; sheet.hide('#sheetCust');
    $('#f_name').value=name; $('#f_phone').value=phone.replace('+90','0');
  }catch(e){ console.error(e); $('#c_status').textContent='Sunucu hatasƒ±'; }
};
$('#c_forgot').onclick=async ()=>{
  const name=($('#c_name').value||'').trim(); const phone=normalizePhone($('#c_phone').value||'');
  if(!name||!phone){ $('#c_status').textContent='Ad ve Telefon gerekli.'; return; }
  try{
    const q=await db.collection('users').where('phone','==',phone).limit(1).get();
    let uid;
    if(q.empty){ const uref=await db.collection('users').add({name,phone,verified:true,createdAt:Date.now(),lastLogin:Date.now()}); uid=uref.id; }
    else{ uid=q.docs[0].id; await db.collection('users').doc(uid).set({name},{merge:true}); }
    await db.collection('pw_resets').add({ userId:uid, name, phone, status:'pending', createdAt:Date.now() });
    $('#c_status').textContent='ƒ∞steƒüiniz alƒ±ndƒ±. Y√∂netici onayƒ± sonrasƒ± ge√ßici ≈üifre olu≈üturulacaktƒ±r.'; toast('≈ûifre sƒ±fƒ±rlama isteƒüi g√∂nderildi');
  }catch(e){ $('#c_status').textContent='Sunucu hatasƒ±'; }
};
$('#c_logout').onclick=()=>{ store.del('custSession'); currentUser=null; setCust(false); toast('M√º≈üteri oturumu kapandƒ±'); };

/* ===== Admin: Bildirim Kuyruƒüu + i≈ülemler + √ßan ===== */
let lastSeen = store.get('adminLastSeen', Date.now());
function updateBell(n){
  const b=$('#bellBtn'), d=$('#bellCount'); if(!b||!d) return;
  d.textContent=String(n);
  if(adminOn && n>0) b.classList.add('blink'); else b.classList.remove('blink');
  b.style.display = adminOn ? 'inline-flex' : 'none';
}
function renderQueue(list){
  if(!adminOn) return;
  const box=$('#queueList'); if(!box) return;
  const appts=(list||[]).filter(a=>a.status==='pending').sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  // ≈üifre istekleri
  const pwSnap = db.collection('pw_resets').orderBy('createdAt','desc').limit(50).get().then(s=>{
    const reqs = s.docs.map(d=>({id:d.id,...d.data()})).filter(r=>r.status==='pending');
    const pwHTML = reqs.map(r=>`
      <div style="display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0;background:#1b1f27">
        <div style="flex:1 1 auto;min-width:0">
          <b>≈ûifre Sƒ±fƒ±rlama</b> ‚Ä¢ ${r.name} (${maskPhone(r.phone)})
          <span class="badge-status st-pending" style="margin-left:8px">Onay bekliyor</span>
        </div>
        <button class="btn" onclick="adminMakeTempPass('${r.id}','${r.phone}')">Ge√ßici ≈ûifre</button>
        <button class="btn" onclick="adminDismissPw('${r.id}')">Yoksay</button>
      </div>
    `).join('');
    const apHTML = appts.map(a=>`
      <div style="display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0">
        <div style="flex:1 1 auto;min-width:0">
          <b>${a.date} ${a.time}</b> ‚Ä¢ ${a.name} ‚Ä¢ ${a.serviceName} / ${a.staffName}
          <span class="badge-status st-pending" style="margin-left:8px">Onay bekliyor</span>
        </div>
        <button class="btn" onclick="approve('${a.id}')">Onayla</button>
        <button class="btn" onclick="reject('${a.id}')">Reddet</button>
        <button class="btn" onclick="delAppt('${a.id}')">Sil</button>
      </div>`).join('');
    box.innerHTML=(pwHTML+apHTML)||'Kuyruk bo≈ü.';
  });
}
window.approve=async(id)=>{try{await db.collection('appts').doc(id).set({status:'approved',updatedAt:Date.now()},{merge:true});toast('Onaylandƒ±');}catch(e){toast('Hata');}}
window.reject =async(id)=>{try{await db.collection('appts').doc(id).set({status:'rejected',updatedAt:Date.now()},{merge:true});toast('Reddedildi');}catch(e){toast('Hata');}}
window.delAppt=async(id)=>{try{await db.collection('appts').doc(id).set({status:'deleted',updatedAt:Date.now()},{merge:true});toast('Silindi');}catch(e){toast('Hata');}}

/* Admin: ≈üifre reset i≈ülemleri */
window.adminMakeTempPass = async (rid, phone)=>{
  try{
    const rq = await db.collection('pw_resets').doc(rid).get(); if(!rq.exists) return toast('ƒ∞stek bulunamadƒ±');
    const r = rq.data();
    const tmp = String(Math.floor(100000 + Math.random()*900000));
    const uq = await db.collection('users').where('phone','==',r.phone).limit(1).get();
    if(uq.empty) return toast('Kullanƒ±cƒ± yok');
    const uid = uq.docs[0].id;
    await db.collection('users').doc(uid).set({ pin: tmp, forcePwChange: true }, { merge:true });
    await db.collection('pw_resets').doc(rid).set({ status:'completed', completedAt: Date.now(), tempPass: tmp }, { merge:true });
    toast('Ge√ßici ≈üifre: '+tmp);
  }catch(e){ console.error(e); toast('Hata'); }
};
window.adminDismissPw = async (rid)=>{ try{ await db.collection('pw_resets').doc(rid).set({ status:'rejected', completedAt: Date.now() }, { merge:true }); toast('ƒ∞stek yoksayƒ±ldƒ±'); }catch(e){ toast('Hata'); } };

/* ===== Customer: My appointments table ===== */
function tStatus(s){ switch(String(s||'').toLowerCase()){case'pending':return{t:'Onay bekliyor',c:'st-pending'};case'approved':return{t:'Onaylandƒ±',c:'st-approved'};case'cancelled':return{t:'ƒ∞ptal',c:'st-cancelled'};case'rejected':return{t:'Reddedildi',c:'st-rejected'};case'deleted':return{t:'Silindi',c:'st-deleted'}} return{t:'',c:''} }
function renderMy(list){
  const tb=$('#my_tbody'); if(!tb) return;
  if(!currentUser){ tb.innerHTML='<tr><td colspan="6" class="small">L√ºtfen m√º≈üteri giri≈üi yapƒ±n.</td></tr>'; return; }
  const today=isoToday();
  let rows=(list||[]).filter(a=>a.phone===currentUser.phone);
  const f=$('#my_filter').value||'upcoming';
  if(f==='upcoming') rows=rows.filter(a=>a.date>=today);
  else if(f==='past') rows=rows.filter(a=>a.date<today);
  rows.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  tb.innerHTML=rows.map(a=>{
    const canCancel=(a.status==='pending'||a.status==='approved');
    return `<tr>
      <td>${a.date}</td><td>${a.time}</td><td>${a.serviceName||''}</td><td>${a.staffName||''}</td>
      <td><span class="badge-status ${tStatus(a.status).c}">${tStatus(a.status).t}</span></td>
      <td class="row" style="display:flex;gap:6px">
        <button class="btn" onclick="openResched('${a.id}')">Deƒüi≈ütir</button>
        ${canCancel?`<button class="btn" onclick="cancelMine('${a.id}')">ƒ∞ptal</button>`:''}
      </td>
    </tr>`; }).join('') || '<tr><td colspan="6" class="small">Randevu yok</td></tr>';
}
$('#my_filter').onchange=()=>renderMy(lastAppts);
$('#my_refresh').onclick=()=>renderMy(lastAppts);
window.cancelMine=async(id)=>{if(!confirm('ƒ∞ptal edilsin mi?'))return;try{await db.collection('appts').doc(id).set({status:'cancelled',updatedAt:Date.now()},{merge:true});toast('ƒ∞ptal edildi');}catch(e){toast('Hata');}}

/* ===== Reschedule ===== */
async function openResched(id){
  if(!currentUser) return;
  const doc=await db.collection('appts').doc(id).get(); if(!doc.exists) return toast('Bulunamadƒ±');
  const a=doc.data(); if(a.phone!==currentUser.phone) return toast('Yetkisiz');
  _rs={id,staffId:a.staffId,duration:a.duration,date:a.date};
  $('#rs_date').value=a.date; computeResched(); sheet.show('#sheetResched');
}
function computeResched(){
  if(!_rs) return;
  const staff=lastStaff.find(s=>s.id===_rs.staffId); if(!staff) return;
  renderGrid('rs_grid',staff,_rs.duration,_rs.date);
}
$('#rs_date').onchange=()=>{ if(_rs){ _rs.date=$('#rs_date').value; computeResched(); } };
$('#rs_cancel').onclick=()=>{_rs=null; sheet.hide('#sheetResched');}
$('#rs_save').onclick=async ()=>{
  if(!_rs) return;
  const time=document.querySelector('#rs_grid .slot.sel')?.dataset.time; if(!time){ $('#rs_status').textContent='Saat se√ßin'; return; }
  try{ await db.collection('appts').doc(_rs.id).set({date:_rs.date,time,status:'pending',updatedAt:Date.now()},{merge:true}); toast('G√ºncellendi (beklemede)'); _rs=null; sheet.hide('#sheetResched'); }catch(e){toast('Hata');}
};

/* ===== Booking (m√º≈üteri) ===== */
$('#f_book').onclick=async ()=>{
  const name=$('#f_name').value.trim(), phoneRaw=$('#f_phone').value.trim();
  const staffId=$('#f_staff').value, svcId=$('#f_service').value, date=$('#f_date').value;
  const time=getSelected('slotgrid');
  if(!name||!phoneRaw||!staffId||!svcId||!date||!time){ $('#f_status').textContent='L√ºtfen t√ºm alanlarƒ± doldurun.'; toast('Eksik bilgi'); return; }
  const phone=normalizePhone(phoneRaw);

  // aynƒ± g√ºn max 2 aktif
  const same=await db.collection('appts').where('phone','==',phone).where('date','==',date).get();
  const activeCnt=same.docs.map(d=>d.data()).filter(a=>a.status==='pending'||a.status==='approved').length;
  if(activeCnt>=2){ toast('Aynƒ± g√ºn en fazla 2 aktif randevu'); return; }

  try{
    // user bul/olu≈ütur + kalƒ±cƒ± giri≈ü
    let uid=null; const uq=await db.collection('users').where('phone','==',phone).limit(1).get();
    if(uq.empty){ const uref=await db.collection('users').add({name,phone,verified:true,pin:'0000',createdAt:Date.now(),lastLogin:Date.now()}); uid=uref.id; }
    else{ uid=uq.docs[0].id; await db.collection('users').doc(uid).set({name,lastLogin:Date.now()},{merge:true}); }
    currentUser={id:uid,name,phone}; store.set('custSession',currentUser); setCust(true);

    const svc=(await db.collection('services').doc(svcId).get()).data();
    const st =(await db.collection('staff').doc(staffId).get()).data();

    await db.collection('appts').add({
      userId:uid,name,phone,serviceId:svcId,serviceName:svc?.name||'Hizmet',
      duration:svc?.dur||30, price:Number(svc?.price||0),
      staffId,staffName:st?.name||'Usta',date,time,status:'pending',createdAt:Date.now()
    });

    $('#f_status').textContent='Randevu alƒ±ndƒ± (beklemede).'; toast('Randevu olu≈üturuldu');
  }catch(e){ console.error(e); toast('Hata: Firestore izinleri?'); }
};

/* ===== Boot ===== */
(function boot(){
  $('#f_date').value=isoToday();
})();
</script>
</body>
</html>
