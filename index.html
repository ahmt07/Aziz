<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ahmet Tekeli â€¢ Randevu</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#eef0f3;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--card:#fff;--gold:#d4af37;--dark:#0b1324;--ok:#16a34a;--bad:#ef4444}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:min(1080px,100%);margin:0 auto;padding:0 14px}
header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:10}
.hero{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.brand b{font-weight:800} .brand small{color:var(--muted)}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}
.btn{padding:9px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
.btn-primary{background:var(--gold);border-color:var(--gold);font-weight:700}
#bellBtn{position:relative;display:none} #bellBtn .dot{position:absolute;top:-6px;right:-6px;background:#ef4444;color:#fff;border-radius:999px;min-width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800}
#bellBtn.flash{animation:bl 1s infinite}@keyframes bl{50%{transform:translateY(-1px)}}
.layout{display:grid;grid-template-columns:260px 1fr;gap:14px;margin:16px 0}
#sidebar{display:none;background:linear-gradient(180deg,var(--dark),#17213c);color:#e5eaf7;border-radius:16px;padding:10px}
#sidebar a{display:block;padding:10px;border-radius:10px;color:#e5eaf7;text-decoration:none}
#sidebar a.active,#sidebar a:hover{background:rgba(255,255,255,.08)}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
label{display:block;font-weight:700;margin:.5rem 0 .25rem}
input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
.slots{display:flex;gap:10px;overflow-x:auto;padding:6px 2px}
.slot{padding:10px 16px;border:1px solid var(--line);border-radius:999px;background:#fff;flex:0 0 auto}
.slot.dis{opacity:.5;pointer-events:none;text-decoration:line-through}
.slot.sel{background:#111827;color:#fff;border-color:#111827}
.table-scroll{overflow-x:auto} table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left} thead th{background:#f7f8fb}
.small{color:#6b7280;font-size:12px}
.sheet-mask{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;z-index:100}
.sheet{position:fixed;left:50%;top:-40%;transform:translate(-50%,-50%);width:min(520px,92vw);background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 18px 40px rgba(0,0,0,.25);opacity:0;transition:all .35s;z-index:101}
.sheet.show{top:50%;opacity:1}
.appt-card{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px;border-bottom:1px dashed #e6ebf5}
.ok{background:var(--ok);border-color:var(--ok);color:#fff} .no{background:var(--bad);border-color:var(--bad);color:#fff}
@media(max-width:900px){.layout{grid-template-columns:1fr}#sidebar{display:none}}
#banner{display:none;align-items:center;gap:8px;padding:8px 12px;border:1px dashed #a8b3d9;border-radius:12px;margin:8px 0;background:#f2f5ff}
</style>
</head>
<body>
<header>
  <div class="wrap hero">
    <div class="brand"><b>AHMET TEKELÄ°</b><small> Erkek KuafÃ¶rÃ¼</small></div>
    <div class="actions">
      <button id="menuToggle" class="btn">â˜°</button>
      <span id="banner" class="small">âš™ï¸ <b id="modeLabel"></b> modunda</span>
      <button id="bellBtn" class="badge" title="Bildirimler"><span>ğŸ””</span><span id="bellCount" class="dot">0</span></button>
      <button class="badge" id="adminOpen">ğŸ‘¨ğŸ»â€ğŸ’¼ Admin</button>
      <button class="badge" id="custOpen">ğŸ‘¤ MÃ¼ÅŸteri</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="layout">
    <aside id="sidebar">
      <a href="#" data-pane="#home" class="active">â¬…ï¸ Ana Ekran</a>
      <a href="#" data-pane="#pane_queue">ğŸ  Onay KuyruÄŸu</a>
      <a href="#" data-pane="#pane_calendar">ğŸ—“ï¸ GÃ¼nlÃ¼k Takvim</a>
      <a href="#" data-pane="#pane_staff">ğŸ’ˆ Ustalar</a>
      <a href="#" data-pane="#pane_services">ğŸ§° Hizmetler</a>
      <a href="#" data-pane="#pane_customers">ğŸ‘¥ MÃ¼ÅŸteriler</a>
      <a href="#" data-pane="#pane_pin">ğŸ”‘ PIN Talepleri</a>
      <a href="#" data-pane="#pane_reports">ğŸ“Š Raporlar</a>
    </aside>

    <!-- ANA EKRAN -->
    <section id="randevu" class="card">
      <h2>Randevu OluÅŸtur</h2>
      <div class="grid">
        <div>
          <label>Ad Soyad</label><input id="f_name" placeholder="Ad Soyad">
          <label>Telefon</label><input id="f_phone" placeholder="05xxxxxxxxx" inputmode="tel">
          <label>Berber</label><select id="f_staff"></select>
        </div>
        <div>
          <label>Hizmet</label><select id="f_service"></select>
          <label>Tarih</label><input id="f_date" type="date">
          <label>Uygun Saatler</label>
          <div class="slots" id="slots"></div>
          <p class="small">Saat aralÄ±ÄŸÄ±: <span id="hoursLabel"></span></p>
          <p id="staffInfo" class="small"></p>
        </div>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="createAppt" class="btn btn-primary">RANDEVU AL</button>
        <span id="formStatus" class="small"></span>
      </div>
    </section>

    <!-- ADMIN PANELLERÄ° -->
    <section id="pane_queue" class="card" style="display:none">
      <h3>Onay KuyruÄŸu</h3>
      <div class="table-scroll"><table>
        <thead><tr><th>Ad</th><th>Tel</th><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>SÃ¼re</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="queueTbody"></tbody>
      </table></div>
    </section>

    <section id="pane_calendar" class="card" style="display:none">
      <h3>GÃ¼nlÃ¼k Takvim</h3>
      <div class="actions">
        <input type="date" id="calDate">
        <select id="calStaff"></select>
        <button class="btn" id="viewCal">GÃ¶rÃ¼ntÃ¼le</button>
      </div>
      <div class="table-scroll"><table>
        <thead><tr><th>Saat</th><th>MÃ¼ÅŸteri</th><th>Hizmet</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="calTbody"></tbody>
      </table></div>
    </section>

    <section id="pane_staff" class="card" style="display:none">
      <h3>Ustalar</h3>
      <div class="actions" style="margin:8px 0">
        <input id="newStaffName" placeholder="Usta adÄ±" style="max-width:220px">
        <input id="newStaffOpen" type="time" value="09:00" style="max-width:120px"><span>â€“</span>
        <input id="newStaffClose" type="time" value="21:00" style="max-width:120px">
        <button class="btn" id="addStaff">Ekle</button>
      </div>
      <div class="table-scroll"><table>
        <thead><tr><th>Ad</th><th>GÃ¼nler</th><th>Saat</th><th>KapalÄ± GÃ¼nler</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="staffTbody"></tbody>
      </table></div>
    </section>

    <section id="pane_services" class="card" style="display:none">
      <h3>Hizmetler</h3>
      <div class="actions" style="margin:8px 0">
        <input id="newSvcName" placeholder="Hizmet adÄ±">
        <input id="newSvcDur" type="number" placeholder="SÃ¼re (dk)" style="max-width:120px">
        <input id="newSvcPrice" type="number" placeholder="Fiyat (TL)" style="max-width:120px">
        <button class="btn" id="addSvc">Ekle</button>
      </div>
      <div id="svcList"></div>
    </section>

    <section id="pane_customers" class="card" style="display:none">
      <h3>MÃ¼ÅŸteriler</h3>
      <div class="table-scroll"><table>
        <thead><tr><th>Ad</th><th>Telefon</th><th>KayÄ±t</th><th>Son GiriÅŸ</th><th>DoÄŸrulandÄ±</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="usersTbody"></tbody>
      </table></div>
    </section>

    <section id="pane_pin" class="card" style="display:none">
      <h3>PIN Talepleri</h3>
      <div class="table-scroll"><table>
        <thead><tr><th>Telefon</th><th>Yeni PIN</th><th>Tarih</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="pinTbody"></tbody>
      </table></div>
    </section>

    <section id="pane_reports" class="card" style="display:none">
      <h3>Raporlar</h3>
      <div class="grid">
        <div class="card"><div class="small">BugÃ¼n</div><div id="kpiToday" style="font-size:22px;font-weight:800">0</div></div>
        <div class="card"><div class="small">Hafta</div><div id="kpiWeek" style="font-size:22px;font-weight:800">0</div></div>
        <div class="card"><div class="small">Durumlar</div><div id="kpiStatus" style="font-size:22px;font-weight:800">0/0/0</div></div>
        <div class="card"><div class="small">Tutar</div><div id="kpiAmount" style="font-size:22px;font-weight:800">0 â‚º</div></div>
      </div>
    </section>
  </div>
</main>

<!-- MODALLER -->
<div id="mask" class="sheet-mask"></div>

<div id="adminSheet" class="sheet">
  <h3>YÃ¶netici GiriÅŸi</h3>
  <div class="grid">
    <input id="adminPhone" value="+905356749243" placeholder="+90â€¦">
    <input id="adminPass" type="password" placeholder="Admin ÅŸifre">
    <label class="badge"><input type="checkbox" id="autoApprove" style="width:auto"> Admin eklerse otomatik onay</label>
  </div>
  <div class="actions" style="margin-top:10px">
    <button class="btn btn-primary" id="adminLogin">GiriÅŸ</button>
    <button class="btn" id="adminLogout">Ã‡Ä±kÄ±ÅŸ</button>
    <button class="btn" id="adminClose">Kapat</button>
    <span id="adminStatus" class="small"></span>
  </div>
</div>

<div id="custSheet" class="sheet">
  <h3>MÃ¼ÅŸteri GiriÅŸi / KayÄ±t</h3>
  <div class="grid">
    <input id="c_name" placeholder="Ad Soyad">
    <input id="c_phone" placeholder="05xxxxxxxxx" inputmode="tel">
    <input id="c_pin" placeholder="PIN (4 hane)" inputmode="numeric" maxlength="4">
  </div>
  <div class="actions" style="margin-top:10px">
    <button class="btn btn-primary" id="custLogin">GiriÅŸ</button>
    <button class="btn" id="custRegister">KayÄ±t Ol</button>
    <button class="btn" id="custClose">Kapat</button>
    <span id="custStatus" class="small"></span>
  </div>
</div>

<div id="notifSheet" class="sheet">
  <h3>Yeni Randevu Talepleri</h3>
  <div id="notifList" style="max-height:55vh;overflow:auto;border:1px solid var(--line);border-radius:12px"></div>
  <div class="actions" style="margin-top:8px"><button class="btn" id="notifClose">Kapat</button></div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* ====== Sabitler ====== */
const ADMIN_PHONE_E164 = '+905356749243';
const settings = { open:'09:00', close:'21:00', slot:30 };

/* ====== YardÄ±mcÄ±lar ====== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const store={get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch(_){return d}},set(k,v){localStorage.setItem(k,JSON.stringify(v))},del(k){localStorage.removeItem(k)}};
const uuid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const todayISO=()=>new Date().toISOString().slice(0,10);
const toMin=t=>{const[h,m]=t.split(':').map(Number);return h*60+m}, toHHMM=m=>`${String(m/60|0).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
const maskPhone=p=>p?`0${p.slice(3,6)} ${p.slice(6,9)} ${p.slice(9,11)} ${p.slice(11,13)}`:'';
function toE164(raw){if(!raw) return null; let s=String(raw).trim().replace(/[()\-\s]/g,''); if(s.startsWith('+')) return '+'+s.replace(/\D/g,''); const only=s.replace(/\D/g,''); if(only.length===11&&only.startsWith('05')) return '+90'+only.slice(1); if(only.length===10&&only.startsWith('5')) return '+90'+only; return null;}
function showToast(msg){let t=document.getElementById('toast'); if(!t){t=document.createElement('div');t.id='toast';document.body.appendChild(t);Object.assign(t.style,{position:'fixed',left:'50%',top:'-80px',transform:'translateX(-50%)',background:'#111827',color:'#fff',padding:'10px 14px',borderRadius:'999px',boxShadow:'0 12px 24px rgba(0,0,0,.22)',zIndex:9999,transition:'top .4s ease'})} t.textContent=msg; t.style.top='12px'; setTimeout(()=>t.style.top='-80px',2200);}

/* ====== Veri KatmanÄ±: Firebase varsa FIREBASE, yoksa LOCAL ====== */
let MODE='LOCAL', db=null;
const FB_CONF={apiKey:"AIzaSyBtSQ9_5R42BU5ga0cOt1QETkC5nOf2tW4",authDomain:"randevu-81305.firebaseapp.com",projectId:"randevu-81305",storageBucket:"randevu-81305.firebasestorage.app",messagingSenderId:"686048709577",appId:"1:686048709577:web:b2db4eeae83203ca2e3618",measurementId:"G-3ZX91ND545"};

const localDB={
  services: ()=>store.get('services',[]),
  staff: ()=>store.get('staff',[]),
  users: ()=>store.get('users',[]),
  appts: ()=>store.get('appts',[]),
  pins: ()=>store.get('resetReqs',[]),
  set(col,arr){store.set(col,arr)},
  upsert(col,obj){const arr=store.get(col,[]); const i=arr.findIndex(x=>x.id===obj.id); if(i>=0) arr[i]=obj; else arr.push(obj); store.set(col,arr);},
  delete(col,id){store.set(col,(store.get(col,[])).filter(x=>x.id!==id))}
};

async function tryInitFirebase(){
  try{
    firebase.initializeApp(FB_CONF);
    db=firebase.firestore();
    await db.collection('services').limit(1).get();
    MODE='FIREBASE';
  }catch(e){ MODE='LOCAL'; }
  $('#modeLabel').textContent = MODE;
  $('#banner').style.display='inline-flex';
}
function colRef(name){
  if(MODE==='FIREBASE') return {
    onSnapshot: (cb)=>db.collection(name).onSnapshot(s=>cb(s.docs.map(d=>d.data()))),
    get: async()=> (await db.collection(name).get()).docs.map(d=>d.data()),
    add: async(obj)=>db.collection(name).doc(obj.id||uuid()).set({...obj,id:obj.id||uuid()}),
    set: async(id,patch)=>db.collection(name).doc(id).set(patch,{merge:true}),
    del: async(id)=>db.collection(name).doc(id).delete()
  };
  return {
    onSnapshot: (cb)=>{cb(localDB[name]()); const t=setInterval(()=>cb(localDB[name]()),800); return ()=>clearInterval(t);},
    get: async()=>localDB[name](),
    add: async(obj)=>localDB.upsert(name,{...obj,id:obj.id||uuid()}),
    set: async(id,patch)=>{ const arr=localDB[name](); const i=arr.findIndex(x=>x.id===id); if(i>=0) arr[i]={...arr[i],...patch}; else arr.push({id,...patch}); localDB.set(name,arr); },
    del: async(id)=>localDB.delete(name,id)
  };
}

/* ====== Global Durum ====== */
let adminOn=false, currentUser=null;
let Svc=[], Staff=[], Users=[], Appts=[], Pins=[];

/* ====== UI ====== */
function setAdminUI(on){
  adminOn=on;
  $('#sidebar').style.display = on ? 'block' : 'none';
  $('#bellBtn').style.display = on ? 'inline-flex' : 'none';
  // menÃ¼ linkleri
  $$('#sidebar a').forEach(a=>{
    a.onclick=(e)=>{e.preventDefault(); const id=a.dataset.pane; openPane(id);};
  });
  goHome(); // her giriÅŸ/Ã§Ä±kÄ±ÅŸta ana ekrana dÃ¶n
}
function goHome(){
  // panel gizle, ana ekrana dÃ¶n
  $$('#pane_queue,#pane_calendar,#pane_staff,#pane_services,#pane_customers,#pane_pin,#pane_reports').forEach(x=>x.style.display='none');
  $$('#sidebar a').forEach(x=>x.classList.remove('active'));
  $$('#sidebar a')[0]?.classList.add('active');
  document.querySelector('#randevu')?.scrollIntoView({behavior:'smooth'});
}
function openPane(id){
  $$('#pane_queue,#pane_calendar,#pane_staff,#pane_services,#pane_customers,#pane_pin,#pane_reports').forEach(x=>x.style.display='none');
  if(id!=='#home') $(id).style.display='block'; else goHome();
  $$('#sidebar a').forEach(a=>a.classList.toggle('active', a.dataset.pane===id));
}
function fillSelects(){
  $('#f_service').innerHTML = Svc.length ? Svc.map(s=>`<option value="${s.id}">${s.name} â€” ${s.dur} dk / ${s.price||0} â‚º</option>`).join('') : `<option disabled>â€” Hizmet eklenmeli â€”</option>`;
  $('#f_staff').innerHTML = Staff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#calStaff').innerHTML = `<option value="">TÃ¼mÃ¼</option>`+Staff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#hoursLabel').textContent=`${settings.open} - ${settings.close}`;
}

function renderSlots(){
  const svc = Svc.find(x=>x.id===$('#f_service').value);
  const st  = Staff.find(x=>x.id===$('#f_staff').value);
  const date=$('#f_date').value; 
  const box=$('#slots');
  const info=$('#staffInfo');
  box.innerHTML=''; if(info) info.textContent='';

  if(!svc||!st||!date){
    if(info) info.textContent = 'Usta ve hizmet seÃ§in.';
    return;
  }

  // UstanÄ±n gÃ¼n/saat bilgileri
  const days = (st.days?.length?st.days:[1,2,3,4,5,6]); // 0=PAZ
  const dow = new Date(date+'T00:00:00').getDay();
  const worksToday = days.includes(dow);
  const hours = st.hours || {open:settings.open, close:settings.close};
  const labels = ['Paz','Pzt','Sal','Ã‡ar','Per','Cum','Cmt'];
  const dayList = days.map(i=>labels[i]).join(', ') || 'â€”';

  // Ãœstte genel saat ibaresini seÃ§ili ustanÄ±n saatine Ã§evir
  $('#hoursLabel').textContent = `${hours.open} - ${hours.close}`;

  if(info){
    info.innerHTML = `
      <span style="display:inline-block;margin-right:8px"><b>Usta:</b> ${st.name}</span>
      <span style="display:inline-block;margin-right:8px"><b>Saat:</b> ${hours.open}â€“${hours.close}</span>
      <span style="display:inline-block;margin-right:8px"><b>GÃ¼nler:</b> ${dayList}</span>
      <span style="display:inline-block">${worksToday ? 'âœ… BugÃ¼n Ã§alÄ±ÅŸÄ±yor' : 'â›” BugÃ¼n Ã§alÄ±ÅŸmÄ±yor'}</span>
    `;
  }

  if(!worksToday){ 
    box.innerHTML='<span class="small">Bu usta seÃ§ilen gÃ¼nde Ã§alÄ±ÅŸmÄ±yor.</span>'; 
    return; 
  }

  const openM=toMin(hours.open), closeM=toMin(hours.close), step=settings.slot, dur=svc.dur;
  const taken=Appts
    .filter(a=>a.date===date && a.staffId===st.id && a.status!=='cancelled'&&a.status!=='rejected')
    .map(a=>({s:toMin(a.time),e:toMin(a.time)+(a.duration||30)}));

  for(let t=openM;t+dur<=closeM;t+=step){
    const conflict = taken.some(x=> t<x.e && (t+dur)>x.s );
    const b=document.createElement('button'); 
    b.className='slot'+(conflict?' dis':''); 
    b.textContent=toHHMM(t);
    b.onclick=()=>{ if(conflict) return; $$('#slots .slot').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); };
    box.appendChild(b);
  }
  box.querySelector('.slot:not(.dis)')?.classList.add('sel');
}

function updateBell(){
  const pend = Appts.filter(a=>a.status==='pending').length + Pins.length;
  $('#bellCount').textContent = pend;
  const btn=$('#bellBtn'); 
  if(adminOn && pend>0){ btn.style.display='inline-flex'; btn.classList.add('flash'); }
  else { btn.classList.remove('flash'); btn.style.display = adminOn ? 'inline-flex' : 'none'; }
}

/* ====== Render tablolar ====== */
function renderQueue(){
  const tb=$('#queueTbody'); tb.innerHTML='';
  Appts.filter(a=>a.status==='pending').sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time,'tr'))
       .forEach(a=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${a.name}</td><td>${maskPhone(a.phone)}</td><td>${a.date}</td><td>${a.time}</td><td>${a.serviceName}</td><td>${a.staffName}</td><td>${a.duration} dk</td>
        <td><button class="btn ok" onclick="approve('${a.id}')">Onayla</button> <button class="btn no" onclick="reject('${a.id}')">Reddet</button> <button class="btn" onclick="removeAppt('${a.id}')">Sil</button></td>`;
        tb.appendChild(tr);
       });
}
function renderCal(){
  const tb=$('#calTbody'); tb.innerHTML='';
  const d=$('#calDate').value||todayISO(), sid=$('#calStaff').value;
  Appts.filter(a=>a.date===d && (!sid||a.staffId===sid) && a.status!=='rejected')
       .sort((a,b)=>a.time.localeCompare(b.time)).forEach(a=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${a.time} (${a.duration}')</td><td>${a.name}</td><td>${a.serviceName} / ${a.staffName}</td><td>${a.status}</td>
        <td>${a.status!=='cancelled'?`<button class="btn" onclick="cancelAdmin('${a.id}')">Ä°ptal</button>`:''} <button class="btn" onclick="removeAppt('${a.id}')">Sil</button></td>`;
        tb.appendChild(tr);
       });
}
function renderServices(){
  const box=$('#svcList'); box.innerHTML = Svc.length? Svc.map(s=>`
    <div class="actions" style="justify-content:space-between;border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0">
      <span><b>${s.name}</b> â€” ${s.dur} dk / ${s.price||0} â‚º</span>
      <span>
        <button class="btn" onclick="editService('${s.id}')">DÃ¼zenle</button>
        <button class="btn" onclick="delService('${s.id}')">Sil</button>
      </span>
    </div>`).join('') : '<div class="small">HenÃ¼z hizmet yok</div>';
}
function renderStaff(){
  const tb=$('#staffTbody'); tb.innerHTML='';
  Staff.sort((a,b)=>String(a.name).localeCompare(String(b.name),'tr')).forEach(s=>{
    const days=(s.days?.length?s.days:[1,2,3,4,5,6]).map(i=>['Paz','Pzt','Sal','Ã‡ar','Per','Cum','Cmt'][i]).join(', ');
    const hours=s.hours?`${s.hours.open}â€“${s.hours.close}`:'-';
    const off=(s.offDates||[]).join(', ');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.name}</td><td>${days}</td><td>${hours}</td><td class="small">${off}</td>
    <td><button class="btn" onclick="editStaff('${s.id}')">DÃ¼zenle</button> <button class="btn" onclick="delStaff('${s.id}')">Sil</button></td>`;
    tb.appendChild(tr);
  });
}
function renderUsers(){
  const tb=$('#usersTbody'); tb.innerHTML='';
  Users.sort((a,b)=>String(a.name).localeCompare(String(b.name),'tr')).forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${u.name||''}</td><td>${maskPhone(u.phone)||''}</td><td>${u.createdAt?new Date(u.createdAt).toLocaleString('tr-TR'):'-'}</td><td>${u.lastLogin?new Date(u.lastLogin).toLocaleString('tr-TR'):'-'}</td><td>${u.verified?'âœ…':'â€”'}</td>
    <td><button class="btn" onclick="deleteUser('${u.id}')">Sil</button></td>`;
    tb.appendChild(tr);
  });
}
function renderPins(){
  const tb=$('#pinTbody'); tb.innerHTML='';
  Pins.sort((a,b)=>(a.createdAt||0)-(b.createdAt||0)).forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${maskPhone(p.phone)}</td><td><b>${p.newPin}</b></td><td>${p.createdAt?new Date(p.createdAt).toLocaleString('tr-TR'):'-'}</td>
    <td><button class="btn ok" onclick="applyPin('${p.id}')">PIN Uygula</button> <button class="btn" onclick="delPin('${p.id}')">Sil</button></td>`;
    tb.appendChild(tr);
  });
}
function renderReports(){
  const today=todayISO();
  const todayC=Appts.filter(a=>a.date===today).length;
  const weekC=Appts.filter(a=> (Date.now()-new Date(a.date).getTime())<=7*86400000 ).length;
  const ok=Appts.filter(a=>a.status==='approved').length, pend=Appts.filter(a=>a.status==='pending').length, can=Appts.filter(a=>a.status==='cancelled').length;
  let total=0; Appts.forEach(a=>{const s=Svc.find(x=>x.id===a.serviceId); total+=(s?.price||0);});
  $('#kpiToday').textContent=todayC; $('#kpiWeek').textContent=weekC; $('#kpiStatus').textContent=`${ok}/${pend}/${can}`; $('#kpiAmount').textContent=`${total} â‚º`;
}

/* ====== CRUD ====== */
async function addService(name,dur,price){ await colRef('services').add({id:uuid(),name,dur,price}); }
async function setService(id,patch){ await colRef('services').set(id,patch); }
async function delService(id){ await colRef('services').del(id); }
window.editService = async(id)=>{
  const s = Svc.find(x=>x.id===id); if(!s) return;
  const name=prompt('Hizmet adÄ±',s.name)||s.name; const dur=parseInt(prompt('SÃ¼re (dk)',s.dur)||s.dur,10); const price=parseInt(prompt('Fiyat (TL)',s.price||0),10)||0;
  await setService(id,{id,name,dur,price}); showToast('Hizmet gÃ¼ncellendi');
};

async function addStaffRec(name,open,close){ await colRef('staff').add({id:uuid(),name,days:[1,2,3,4,5,6],hours:{open,close},offDates:[]}); }
async function setStaff(id,patch){ await colRef('staff').set(id,patch); }
async function delStaff(id){ await colRef('staff').del(id); }
window.editStaff = async(id)=>{
  const s=Staff.find(x=>x.id===id); if(!s) return;
  const name=prompt('Usta adÄ±',s.name)||s.name;
  const open=prompt('AÃ§Ä±lÄ±ÅŸ (HH:MM)',s.hours?.open||'09:00')||'09:00';
  const close=prompt('KapanÄ±ÅŸ (HH:MM)',s.hours?.close||'21:00')||'21:00';
  await setStaff(id,{name,hours:{open,close}}); showToast('Usta gÃ¼ncellendi');
};

async function approve(id){ await colRef('appts').set(id,{status:'approved'}); }
async function reject(id){ await colRef('appts').set(id,{status:'rejected'}); }
async function removeAppt(id){ await colRef('appts').del(id); }
async function cancelAdmin(id){ await colRef('appts').set(id,{status:'cancelled'}); }
async function deleteUser(id){ await colRef('users').del(id); }
async function applyPin(id){
  const req = Pins.find(x=>x.id===id); if(!req) return;
  const u = Users.find(x=>x.phone===req.phone); if(!u){ showToast('KullanÄ±cÄ± bulunamadÄ±'); return; }
  await colRef('users').set(u.id,{pin:req.newPin});
  await colRef('resetReqs').del(id);
  showToast('PIN gÃ¼ncellendi');
}
async function delPin(id){ await colRef('resetReqs').del(id); }

/* ====== Randevu oluÅŸtur ====== */
async function createAppointment(){
  const name=$('#f_name').value.trim(), phone=toE164($('#f_phone').value), svc=Svc.find(x=>x.id===$('#f_service').value);
  const st=Staff.find(x=>x.id===$('#f_staff').value); const date=$('#f_date').value; const time=($('#slots .slot.sel')||{}).textContent;
  if(!name||!phone||!svc||!st||!date||!time){ $('#formStatus').textContent='Eksik bilgi'; return; }
  const auto=adminOn && $('#autoApprove').checked;
  if(!auto){
    const same = Appts.filter(a=>a.phone===phone && a.date===date && (a.status==='pending'||a.status==='approved')).length;
    if(same>=2){ $('#formStatus').textContent='AynÄ± gÃ¼n en fazla 2 aktif randevu.'; return; }
  }
  let u = Users.find(x=>x.phone===phone);
  if(!u){ u={id:uuid(),name,phone,verified:true,pin:'0000',createdAt:Date.now()}; await colRef('users').add(u); }
  const a={id:uuid(),userId:u.id,name,phone,serviceId:svc.id,serviceName:svc.name,staffId:st.id,staffName:st.name,date,time,duration:svc.dur,status:auto?'approved':'pending',createdAt:Date.now()};
  await colRef('appts').add(a);
  $('#formStatus').textContent = auto ? 'Randevu onaylandÄ±.' : 'Randevu oluÅŸturuldu (Onay bekliyor).';
}

/* ====== GiriÅŸ/Ã‡Ä±kÄ±ÅŸ & Olaylar ====== */
function openSheet(id){ $('#mask').style.display='block'; $(id).classList.add('show'); }
function closeSheets(){ $('#mask').style.display='none'; $$('.sheet').forEach(s=>s.classList.remove('show')); }

async function adminLogin(){
  const p=$('#adminPhone').value.trim(), pass=$('#adminPass').value.trim();
  if(p===ADMIN_PHONE_E164 && pass!==''){ setAdminUI(true); store.set('adminSession','on'); $('#adminStatus').textContent='GiriÅŸ baÅŸarÄ±lÄ±'; closeSheets(); }
  else $('#adminStatus').textContent='Bilgiler hatalÄ±';
}
function adminLogout(){ setAdminUI(false); store.del('adminSession'); $('#adminStatus').textContent='Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±'; }

async function custRegister(){
  const name=$('#c_name').value.trim(), phone=toE164($('#c_phone').value), pin=$('#c_pin').value.trim();
  if(!name||!phone||!/^\d{4}$/.test(pin)) return $('#custStatus').textContent='Ad/telefon/PIN gerekli';
  if(Users.find(x=>x.phone===phone)) return $('#custStatus').textContent='Bu telefon kayÄ±tlÄ±, giriÅŸ yapÄ±n.';
  const u={id:uuid(),name,phone,verified:true,pin,createdAt:Date.now()}; await colRef('users').add(u);
  currentUser=u; store.set('currentUserId',u.id); $('#custStatus').textContent='KayÄ±t tamamlandÄ±'; closeSheets();
}
async function custLogin(){
  const phone=toE164($('#c_phone').value), pin=$('#c_pin').value.trim();
  const u=Users.find(x=>x.phone===phone);
  if(!u){ $('#custStatus').textContent='KayÄ±t yok'; return; }
  if(String(u.pin)===pin){ currentUser=u; store.set('currentUserId',u.id); $('#custStatus').textContent='GiriÅŸ baÅŸarÄ±lÄ±'; closeSheets(); }
  else $('#custStatus').textContent='PIN hatalÄ±';
}

/* ====== BaÅŸlat ====== */
let unsubSvc,unsubStaff,unsubUsers,unsubAppts,unsubPins;
(async function init(){
  $('#f_date').value=todayISO(); $('#calDate').value=todayISO();
  await tryInitFirebase();

  unsubSvc = colRef('services').onSnapshot(list=>{Svc=list; if(!Svc.length){ addService('SaÃ§ Kesim',30,150); addService('SaÃ§ + Sakal',45,250);} fillSelects(); renderServices(); renderSlots(); renderReports();});
  unsubStaff = colRef('staff').onSnapshot(list=>{Staff=list; if(!Staff.length){ addStaffRec('Ahmet Usta','09:00','21:00'); } fillSelects(); renderStaff(); renderSlots(); renderCal();});
  unsubUsers = colRef('users').onSnapshot(list=>{Users=list; renderUsers();});
  unsubAppts = colRef('appts').onSnapshot(list=>{Appts=list; renderQueue(); renderCal(); renderSlots(); updateBell(); renderReports(); fillNotifSheet();});
  unsubPins = colRef('resetReqs').onSnapshot(list=>{Pins=list; renderPins(); updateBell();});

  // Oturum geri yÃ¼kle
  if(store.get('adminSession')==='on') setAdminUI(true); else setAdminUI(false);
  goHome();

  // Eventler
  $('#adminOpen').onclick=()=>openSheet('#adminSheet');
  $('#adminClose').onclick=closeSheets;
  $('#adminLogin').onclick=adminLogin;
  $('#adminLogout').onclick=adminLogout;

  $('#custOpen').onclick=()=>openSheet('#custSheet');
  $('#custClose').onclick=closeSheets;
  $('#custRegister').onclick=custRegister;
  $('#custLogin').onclick=custLogin;

  $('#notifClose').onclick=closeSheets;
  $('#bellBtn').onclick=()=>{ if(!adminOn) return; openSheet('#notifSheet'); };
  $('#menuToggle').onclick=()=>{ const s=$('#sidebar'); s.style.display=(s.style.display==='block')?'none':'block'; };

  $('#createAppt').onclick=createAppointment;
  $('#f_service').onchange=renderSlots; $('#f_staff').onchange=renderSlots; $('#f_date').onchange=renderSlots;
  $('#viewCal').onclick=renderCal;
  $('#addSvc').onclick=async()=>{ const n=$('#newSvcName').value.trim(), d=parseInt($('#newSvcDur').value||'30',10), p=parseInt($('#newSvcPrice').value||'0',10); if(!n) return; await addService(n,d,p); $('#newSvcName').value=''; $('#newSvcDur').value=''; $('#newSvcPrice').value=''; };
  $('#addStaff').onclick=async()=>{ const n=$('#newStaffName').value.trim(); if(!n) return; await addStaffRec(n,$('#newStaffOpen').value||'09:00',$('#newStaffClose').value||'21:00'); };

})();

/* ====== Bildirim Sheet doldur ====== */
function fillNotifSheet(){
  const box=$('#notifList'); if(!box) return;
  const rows = Appts.filter(a=>a.status==='pending').sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time,'tr'));
  box.innerHTML = rows.length ? rows.map(a=>`
    <div class="appt-card">
      <div><b>${a.date} ${a.time}</b> â€” ${a.serviceName} / ${a.staffName||'-'}<br><span class="small">${a.name} â€¢ ${maskPhone(a.phone)}</span></div>
      <div>
        <button class="btn ok" onclick="approve('${a.id}')">Onayla</button>
        <button class="btn no" onclick="reject('${a.id}')">Reddet</button>
        <button class="btn" onclick="removeAppt('${a.id}')">Sil</button>
      </div>
    </div>`).join('') : '<div class="small" style="padding:10px">Bekleyen talep yok.</div>';
}
</script>
</body>
</html>
