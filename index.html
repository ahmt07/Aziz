<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ahmet Tekeli Erkek Kuaf√∂r√º ‚Ä¢ Online Randevu</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Playfair+Display:wght@800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0e13; --ink:#f5f7fb; --muted:#b7c0cf; --line:#2a2f39;
  --panel:rgba(20,26,33,.55); --panel-border:rgba(255,255,255,.16);
  --whitebtn:#ffffff; --whiteink:#0f172a;
  --brand:#d4af37; --danger:#ef4444; --blue:#3b82f6;
}
*{box-sizing:border-box} html,body{margin:0;height:100%}
body{font:15px/1.55 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg);}
.bg{position:fixed; inset:0; background:url('https://images.unsplash.com/photo-1601233749202-95dfc58f38e9?q=80&w=1600&auto=format&fit=crop') center/cover no-repeat fixed; filter:blur(2px) brightness(.45); transform:scale(1.02); z-index:-2;}
.bg::after{content:""; position:absolute; inset:0; background:linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,.6));}
.wrap{max-width:1100px;margin:0 auto;padding:0 16px}
header{position:sticky;top:0;z-index:30;background:transparent}
.hrow{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;padding:12px 0}
.left,.right{display:flex;gap:10px;align-items:center}
.left{justify-content:flex-start}.right{justify-content:flex-end}
.topbtn{appearance:none;border:none;background:var(--whitebtn);color:var(--whiteink);padding:10px 14px;border-radius:14px;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.25);cursor:pointer}
.topbtn:active{transform:translateY(1px);}
.bell{display:none;gap:6px;align-items:center;background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);padding:9px 12px;border-radius:14px;backdrop-filter:blur(6px);cursor:pointer}
.bell .dot{min-width:18px;height:18px;border-radius:999px;background:#ef4444;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:800}
.blink{animation:pulse 1s ease-in-out infinite}
@keyframes pulse{0%{filter:none}50%{filter:drop-shadow(0 0 10px #f66) saturate(1.2)}100%{filter:none}}
.hero{display:flex;flex-direction:column;align-items:center;text-align:center;gap:8px;margin:14px 0 8px}
.hero .t1{font-family:"Playfair Display",serif;font-size:42px;letter-spacing:.5px}
.hero .t2{font-weight:700;letter-spacing:.3px;color:#dbe1ff}
.hero .rating{display:flex;gap:8px;align-items:center;color:#ffd166;font-weight:800}
.card{background:var(--panel);border:1px solid var(--panel-border);border-radius:18px;padding:18px;backdrop-filter:blur(12px);box-shadow:0 20px 70px rgba(0,0,0,.45)}
.grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media(max-width:760px){.grid-2{grid-template-columns:minmax(0,1fr)}}
label{display:block;font-weight:800;margin:0 0 6px}
input,select,textarea{width:100%;padding:12px 14px;border:1px solid rgba(255,255,255,.18);border-radius:14px;background:rgba(6,8,11,.55);color:#fff;font-size:16px}
input::placeholder{color:#c8d0df}
.small{font-size:12px;color:var(--muted)}
.btn{border:1px solid rgba(255,255,255,.18);background:#121823;color:#e8edf7;padding:12px 16px;border-radius:12px;cursor:pointer}
.btn-primary{border:none;background:linear-gradient(90deg,#b99309,#f7e38e,#b99309);color:#161616;font-weight:900;letter-spacing:.4px}
.btn-danger{background:#ef4444;border-color:#ef4444;color:#fff}
.slotgrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
@media(max-width:540px){.slotgrid{grid-template-columns:repeat(3,minmax(0,1fr))}}
.slot{border:1px solid rgba(255,255,255,.22);background:rgba(12,16,22,.75);color:#e8edf7;border-radius:22px;padding:14px 0;font-weight:800;text-align:center}
.slot.busy{background:rgba(255,255,255,.08);color:#7b8190;pointer-events:none}
.slot.sel{background:#0ea5e9;color:#00131a;border-color:#0ea5e9}
.table-scroll{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.15);text-align:left}
thead th{font-weight:900;background:rgba(255,255,255,.06)}
.sheet{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;z-index:60}
.sheet.show{display:flex}
.sheet .panel{width:100%;max-height:92vh;background:#0f141c;border:1px solid rgba(255,255,255,.12);border-radius:16px 16px 0 0;padding:20px;overflow:auto}
.sheet .panel.admin{max-width:1020px;border-top:5px solid var(--brand)}
.sheet .panel.customer{max-width:980px;border-top:5px solid var(--blue)}
.sheet .panel h3{margin:0 0 10px}
#toast{position:fixed;left:50%;top:-80px;transform:translateX(-50%);background:#0b1220;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 10px 24px rgba(0,0,0,.35);z-index:120;transition:top .45s;border:1px solid #325}
#toast.show{top:12px}
.badge-status{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid transparent}
.st-pending{background:#3a3322;color:#f6e7c2;border-color:#b48b1d}
.st-approved{background:#1f3a2a;color:#c9f7d7;border-color:#2ea44f}
.st-cancelled{background:#33373e;color:#e2e8f0;border-color:#6b7280}
.st-rejected{background:#3b1f24;color:#ffd7d7;border-color:#ef4444}
.st-deleted{background:#3b1f1f;color:#ffdddd;border-color:#b91c1c}
@media(max-width:520px){ .left { gap:8px; } .left .topbtn{ display:inline-flex; padding:10px 12px; font-size:14px; } }
</style>
</head>
<body>
<div class="bg"></div>
<div id="toast"></div>

<header class="wrap">
  <div class="hrow">
    <div class="left">
      <button class="topbtn" id="custOpen">M√º≈üteri Giri≈üi</button>
      <button class="topbtn" id="adminOpen">Admin Giri≈üi</button>
      <button class="topbtn" id="manageOpen" style="display:none">Y√∂netim</button>
    </div>
    <div></div>
    <div class="right">
      <button id="bellBtn" class="bell">üîî <span class="dot" id="bellCount">0</span></button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <div class="t1">AHMET TEKELƒ∞</div>
    <div class="t2">ERKEK KUAF√ñR√ú</div>
    <div class="rating">‚≠ê 4,9 (161)</div>
  </section>

  <section class="card" style="margin-top:10px">
    <div class="grid-2">
      <div><label>Ad Soyad</label><input id="f_name" placeholder="Adƒ±nƒ±z ve Soyadƒ±nƒ±z"></div>
      <div><label>Telefon</label><input id="f_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
      <div><label>Berber Se√ßimi</label><select id="f_staff"><option disabled selected>Bir berber se√ßin</option></select></div>
      <div><label>ƒ∞≈ülem Se√ßimi</label><select id="f_service"><option disabled selected>Hizmet se√ßin</option></select></div>
      <div><label>Tarih</label><input type="date" id="f_date"></div>
      <div>
        <label>Saat Se√ßimi</label>
        <div id="slotgrid" class="slotgrid"></div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;margin-top:14px">
      <button class="btn btn-primary" id="f_book">RANDEVU AL</button>
      <button class="btn" id="myApptsOpen" style="margin-left:auto;display:none">Randevularƒ±m</button>
      <span class="small" id="f_status"></span>
    </div>
  </section>

  <section class="card" id="adminAnalytics" style="display:none;margin-top:12px">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button class="btn" id="btnPdfToday">üßæ Bug√ºn PDF</button>
      <button class="btn" id="btnRefreshChart">üìà Haftalƒ±k Grafiƒüi Yenile</button>
    </div>
    <h3>Onay Bekleyenler</h3>
    <div class="small" id="kpi">‚Äî</div>
    <div style="height:240px;margin-top:8px"><canvas id="weekChart"></canvas></div>
  </section>
</main>

<!-- Bildirim Kuyruƒüu -->
<div id="sheetBell" class="sheet"><div class="panel admin">
  <h3>Onay Kuyruƒüu</h3>
  <div id="queueList" class="small">Kuyruk bo≈ü.</div>
</div></div>

<!-- Admin Giri≈üi -->
<div id="sheetAdmin" class="sheet"><div class="panel admin">
  <h3>Y√∂netici Giri≈üi</h3>
  <div class="grid-2">
    <div><label>Admin Telefon</label><input id="adminPhone" value="+905356749243"></div>
    <div><label>≈ûifre</label><input id="adminPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
  </div>
  <div class="small" style="margin-top:6px">Bu cihazda oturum kalƒ±cƒ± olur.</div>
  <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
    <button class="btn btn-primary" id="adminLoginBtn">Giri≈ü Yap</button>
    <button class="btn" id="adminLogoutBtn">√áƒ±kƒ±≈ü</button>
    <span class="small" id="adminStatus"></span>
  </div>
</div></div>

<!-- M√º≈üteri Giri≈ü / Kayƒ±t -->
<div id="sheetCust" class="sheet"><div class="panel customer">
  <h3>M√º≈üteri Giri≈üi / Kayƒ±t</h3>
  <div class="grid-2">
    <div><label>Ad Soyad</label><input id="c_name" placeholder="Ad Soyad"></div>
    <div><label>Telefon</label><input id="c_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
  </div>
  <div class="grid-2">
    <div><label>≈ûifre</label><input id="c_pin" type="password" maxlength="32" placeholder="≈ûifreniz (min 4)"></div>
    <div style="display:flex;gap:8px;align-items:flex-end">
      <button class="btn btn-primary" id="c_login">Giri≈ü / Kayƒ±t</button>
      <button class="btn" id="c_forgot">≈ûifremi Unuttum</button>
    </div>
  </div>
  <p class="small" id="c_status"></p>
</div></div>

<!-- Randevularƒ±m -->
<div id="sheetMyAppts" class="sheet"><div class="panel customer">
  <h3 style="display:flex;align-items:center;gap:8px">
    Randevularƒ±m
    <button class="btn" id="c_logout" style="margin-left:auto">√áƒ±kƒ±≈ü</button>
  </h3>
  <div class="table-scroll">
    <table>
      <thead><tr><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead>
      <tbody id="my_tbody"></tbody>
    </table>
  </div>
  <p class="small">‚ÄúDeƒüi≈ütir‚Äù sonrasƒ± randevu tekrar onaya d√º≈üer.</p>
</div></div>

<!-- Randevu Deƒüi≈ütir -->
<div id="sheetResched" class="sheet"><div class="panel customer">
  <h3>Randevuyu Deƒüi≈ütir</h3>
  <div class="grid-2">
    <div><label>Tarih</label><input type="date" id="rs_date"></div>
    <div><label>Saat Se√ßimi</label><div id="rs_grid" class="slotgrid"></div></div>
  </div>
  <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
    <button class="btn btn-primary" id="rs_save">Kaydet</button>
    <button class="btn" id="rs_cancel">Vazge√ß</button>
    <span class="small" id="rs_status"></span>
  </div>
</div></div>

<!-- Y√∂netim Paneli -->
<div id="sheetManage" class="sheet"><div class="panel admin">
  <h3>Y√∂netim</h3>
  <div class="grid-2">
    <section class="card" style="padding:12px"><h4>Ustalar</h4>
      <div style="display:flex;gap:8px;margin-bottom:6px">
        <input id="newStaffName" placeholder="Yeni usta adƒ±" style="max-width:260px">
        <button class="btn" id="addStaff">Ekle</button>
      </div>
      <ul id="staffList" class="small"></ul>
    </section>
    <section class="card" style="padding:12px"><h4>Hizmetler</h4>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px">
        <input id="newSvcName" placeholder="Hizmet adƒ±">
        <input id="newSvcDur" type="number" placeholder="S√ºre (dk)" style="max-width:140px">
        <input id="newSvcPrice" type="number" placeholder="Fiyat (TL)" style="max-width:140px">
        <button class="btn" id="addSvc">Ekle</button>
      </div>
      <ul id="svcList" class="small"></ul>
    </section>
  </div>

  <section class="card" style="padding:12px;margin-top:10px">
    <h4>Usta √áalƒ±≈üma Saatleri</h4>
    <div class="grid-2">
      <div><label>Usta</label><select id="wh_staff"></select></div>
      <div><label>Slot (dk)</label><input id="wh_slot" type="number" value="30" disabled></div>
    </div>
    <div class="grid-2" style="margin-top:8px">
      <div>
        <b>G√ºnl√ºk Saatler (√áift Aralƒ±k)</b>
        <div id="wh_days" style="margin:6px 0"></div>
        <div id="wh_intervals" style="margin-top:6px"></div>
      </div>
      <div>
        <b>ƒ∞zin / Tatil G√ºnleri</b>
        <div style="display:flex;gap:6px;margin-top:6px">
          <input type="date" id="offDate" style="max-width:180px"><button class="btn" id="addOff">Ekle</button>
        </div>
        <div id="offList" style="margin-top:6px"></div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <button class="btn btn-primary" id="saveWorkHours">Kaydet</button>
      <span id="wh_status" class="small"></span>
    </div>
  </section>

  <section class="card" style="padding:12px;margin-top:10px">
    <h4>Randevular</h4>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px">
      <input type="date" id="ap_fdate" style="max-width:180px">
      <select id="ap_fstaff" style="max-width:220px"><option value="">T√ºm Ustalar</option></select>
      <select id="ap_fstatus" style="max-width:180px">
        <option value="">T√ºm Durumlar</option>
        <option value="pending">Beklemede</option>
        <option value="approved">Onaylandƒ±</option>
        <option value="cancelled">ƒ∞ptal</option>
        <option value="deleted">Silindi</option>
      </select>
      <button class="btn" id="ap_refresh">Yenile</button>
      <span class="small" style="margin-left:auto">Toplu: </span>
      <button class="btn" id="bulk_cancel">ƒ∞ptal</button>
      <button class="btn" id="bulk_delete">Sil</button>
    </div>
    <div class="table-scroll">
      <table><thead><tr><th><input type="checkbox" id="ap_chkall"></th><th>Tarih</th><th>Saat</th><th>M√º≈üteri</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead><tbody id="ap_tbody"></tbody></table>
    </div>

    <hr style="margin:12px 0;border:none;border-top:1px solid var(--line)">
    <h4>Admin‚Äôden Randevu Olu≈ütur</h4>
    <div class="grid-2">
      <div><label>Ad Soyad</label><input id="a_name" placeholder="M√º≈üteri adƒ±"></div>
      <div><label>Telefon</label><input id="a_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
      <div><label>Usta</label><select id="a_staff"></select></div>
      <div><label>Hizmet</label><select id="a_svc"></select></div>
      <div><label>Tarih</label><input type="date" id="a_date"></div>
      <div><label>Saat</label><div id="a_slots" class="slotgrid"></div></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <label style="display:inline-flex;gap:8px;align-items:center"><input id="a_auto" type="checkbox" style="width:auto"> Oto Onay</label>
      <button class="btn btn-primary" id="a_create">Olu≈ütur</button>
      <span id="a_status" class="small"></span>
    </div>
  </section>
</div></div>

<!-- Firebase & libs -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const SESSION_TTL_MS = 30 * 24 * 60 * 60 * 1000;
const store={get(k,d){try{const raw=localStorage.getItem(k);if(!raw)return d;const o=JSON.parse(raw);if(o&&o._t&&(Date.now()-o._t>SESSION_TTL_MS)){localStorage.removeItem(k);return d}return o&&o.v!==undefined?o.v:d}catch(e){return d}},set(k,v){try{localStorage.setItem(k,JSON.stringify({v,_t:Date.now()}))}catch(e){}},del(k){try{localStorage.removeItem(k)}catch(e){}}};
function toast(m,ms=2200){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);}
const toMin=t=>{const[h,m]=t.split(':').map(Number);return h*60+m}, toHHMM=m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
function overlaps(aS,aE,bS,bE){return aS<bE && aE>bS}
function normalizePhone(p){const s=(p||'').replace(/\s|-/g,''); if(!s) return ''; if(s.startsWith('+')) return s; if(s.startsWith('05')) return '+90'+s.slice(1); if(s.startsWith('5')) return '+90'+s; if(s.startsWith('0')) return '+90'+s.slice(1); return '+90'+s}
function maskPhone(p){ if(!p) return ''; if(p.startsWith('+90')){const n=p.slice(3); return `0${n.slice(0,3)} ${n.slice(3,6)} ${n.slice(6,8)} ${n.slice(8,10)}`} return p }
function playAlert(){ try{ if(navigator.vibrate) navigator.vibrate([60,40,60]); const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.5); o.start(); o.stop(ctx.currentTime+0.5);}catch(e){} }

/* ===== Firebase ===== */
firebase.initializeApp({
  apiKey:"AIzaSyBtSQ9_5R42BU5ga0cOt1QETkC5nOf2tW4",
  authDomain:"randevu-81305.firebaseapp.com",
  projectId:"randevu-81305",
  storageBucket:"randevu-81305.firebasestorage.app",
  messagingSenderId:"686048709577",
  appId:"1:686048709577:web:b2db4eeae83203ca2e3618",
  measurementId:"G-3ZX91ND545"
});
const db=firebase.firestore();

/* ===== Globals ===== */
const ADMIN_PHONE_E164='+905356749243';
const ADMIN_PASSWORD='ahmet07';
const AUTO_APPROVE_MS = 60 * 1000; // 1 dakika sonra onay
let adminOn=false, currentUser=store.get('custSession',null);
let lastStaff=[], lastSvcs=[], lastAppts=[], lastUsers=[];
let unsubStaff=null,unsubSvcs=null,unsubAppts=null,unsubUsers=null;
let _rs=null; let lastSeen = store.get('adminLastSeen', Date.now());
let myPrevStatus = {};

/* ===== UI & Sheets ===== */
function setAdmin(on){
  adminOn=!!on;
  $('#adminAnalytics').style.display=on?'block':'none';
  $('#manageOpen').style.display=on?'inline-flex':'none';
  const bell=$('#bellBtn'); bell.style.display=on?'inline-flex':'none';
  if(on){ store.set('adminSession',{on:true,phone:ADMIN_PHONE_E164}); } else { store.del('adminSession'); }
}
function setCust(on){
  $('#myApptsOpen').style.display = on ? 'inline-flex' : 'none';
  if(on && currentUser){ store.set('custSession', currentUser); }
  else{ store.del('custSession'); }
}
(function restore(){
  const a=store.get('adminSession',null); if(a?.on) setAdmin(true);
  const u=store.get('custSession',null); if(u?.phone){ currentUser=u; setCust(true); $('#f_name').value=u.name||''; $('#f_phone').value=(u.phone||'').replace('+90','0'); }
})();
const sheet={show:id=>{$(id).classList.add('show');document.body.style.overflow='hidden'},hide:id=>{$(id).classList.remove('show');document.body.style.overflow=''}};
['#sheetAdmin','#sheetCust','#sheetBell','#sheetMyAppts','#sheetResched','#sheetManage'].forEach(id=>$(id).addEventListener('click',e=>{ if(e.target===e.currentTarget) sheet.hide(id); }));
$('#adminOpen')?.addEventListener('click',()=>sheet.show('#sheetAdmin'));
$('#custOpen')?.addEventListener('click',()=>sheet.show('#sheetCust'));
$('#manageOpen')?.addEventListener('click',()=>sheet.show('#sheetManage'));
$('#myApptsOpen')?.addEventListener('click',()=>sheet.show('#sheetMyAppts'));
$('#bellBtn')?.addEventListener('click',()=>{ lastSeen=Date.now(); store.set('adminLastSeen',lastSeen); updateBell(0); sheet.show('#sheetBell'); });

/* ===== Select doldur ===== */
function fillStaff(){ const s=$('#f_staff'), cur=s.value; s.innerHTML='<option disabled selected>Bir berber se√ßin</option>'+lastStaff.map(x=>`<option value="${x.id}">${x.name}</option>`).join(''); if(lastStaff.some(x=>x.id===cur)) s.value=cur; $('#ap_fstaff').innerHTML='<option value="">T√ºm Ustalar</option>'+lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); $('#a_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); $('#wh_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); }
function fillServices(){ const s=$('#f_service'), cur=s.value; s.innerHTML='<option disabled selected>Hizmet se√ßin</option>'+lastSvcs.map(x=>`<option value="${x.id}">${x.name} ‚Äî ${x.dur} dk (${x.price||0} TL)</option>`).join(''); if(lastSvcs.some(x=>x.id===cur)) s.value=cur; $('#a_svc').innerHTML=lastSvcs.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); }

/* ===== Slots ===== */
const STEP=30;
function conflicts(appts,date,staffId){return (appts||[]).filter(a=>a.date===date&&a.staffId===staffId&&a.status!=='cancelled'&&a.status!=='rejected'&&a.status!=='deleted').map(a=>({start:toMin(a.time), end:toMin(a.time)+(a.duration||30)}));}
function staffWorks(staff,dateISO){const dow=new Date(dateISO+'T00:00:00').getDay(); const dayOk=!staff?.days||staff.days.includes(dow); const off=(staff?.offDates||[]).includes(dateISO); return dayOk && !off;}
function getIntervalsFor(staff,dateISO){const dow=new Date(dateISO+'T00:00:00').getDay(); const by=staff?.hoursByDay?.[dow]; if(by && by.open1 && by.close1){const arr=[{open:by.open1,close:by.close1}]; if(by.open2&&by.close2) arr.push({open:by.open2,close:by.close2}); return arr;} const base=staff?.hours||{open:'09:00',close:'21:00'}; return [{open:base.open, close:base.close}];}
function renderGrid(id, staff, dur, date){const box=document.getElementById(id); box.innerHTML=''; if(!staff||!dur||!date) return; const taken=conflicts(lastAppts,date,staff.id); const works=staffWorks(staff,date); const intervals=getIntervalsFor(staff,date); intervals.forEach(iv=>{const s=toMin(iv.open), e=toMin(iv.close); for(let t=s;t+dur<=e;t+=STEP){const time=toHHMM(t); const busy=!works || taken.some(x=>overlaps(t,t+dur,x.start,x.end)); const b=document.createElement('button'); b.type='button'; b.className='slot'+(busy?' busy':''); b.textContent=time; b.dataset.time=time; b.onclick=()=>{ if(busy) return; [...box.querySelectorAll('.slot')].forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); }; box.appendChild(b);}});}
function getSelected(containerId){ return document.querySelector(`#${containerId} .slot.sel`)?.dataset.time||null; }

/* ===== Date defaults & slot recompute ===== */
$('#f_date').value=new Date().toISOString().slice(0,10);
$('#a_date').value=new Date().toISOString().slice(0,10);
$('#f_staff')?.addEventListener('change',computeSlots);
$('#f_service')?.addEventListener('change',computeSlots);
$('#f_date')?.addEventListener('change',computeSlots);
function computeSlots(){ const sId=$('#f_staff').value, vId=$('#f_service').value, d=$('#f_date').value; if(!sId||!vId||!d){$('#slotgrid').innerHTML='';return;} const s=lastStaff.find(x=>x.id===sId), v=lastSvcs.find(x=>x.id===vId); if(!s||!v) return; renderGrid('slotgrid',s,v.dur||30,d); }
function renderAdminSlots(){ const sId=$('#a_staff').value, vId=$('#a_svc').value, d=$('#a_date').value; const box=$('#a_slots'); box.innerHTML=''; if(!sId||!vId||!d) return; const s=lastStaff.find(x=>x.id===sId), v=lastSvcs.find(x=>x.id===vId); if(!s||!v) return; renderGrid('a_slots',s,v.dur||30,d); }
$('#a_staff')?.addEventListener('change',renderAdminSlots);
$('#a_svc')?.addEventListener('change',renderAdminSlots);
$('#a_date')?.addEventListener('change',renderAdminSlots);

/* ===== Realtime ===== */
function startRealtime(){
  if(unsubStaff)unsubStaff(); if(unsubSvcs)unsubSvcs(); if(unsubAppts)unsubAppts(); if(unsubUsers)unsubUsers();
  unsubStaff=db.collection('staff').onSnapshot(ss=>{
    lastStaff=ss.docs.map(d=>({id:d.id,...d.data()}));
    if(!lastStaff.length){ bootstrapDefaults(); } // ilk kurulum
    fillStaff(); renderWorkEditor(); computeSlots(); renderAdminSlots();
  });
  unsubSvcs=db.collection('services').onSnapshot(ss=>{
    lastSvcs=ss.docs.map(d=>({id:d.id,...d.data()}));
    if(!lastSvcs.length){ bootstrapDefaults(); }
    fillServices(); computeSlots(); renderAdminSlots();
    renderServiceList();
  });
  unsubUsers=db.collection('users').onSnapshot(ss=>{
    lastUsers=ss.docs.map(d=>({id:d.id,...d.data()}));
    renderCustomers();
  });
  unsubAppts=db.collection('appts').onSnapshot(ss=>{
    lastAppts=ss.docs.map(d=>({id:d.id,...d.data()}));
    renderQueue(lastAppts); renderMy(lastAppts); renderAdminAppts(lastAppts); renderWeeklyChart(); updateKpi(lastAppts);

    // Admin i√ßin yeni randevu alarmƒ±
    const news=lastAppts.filter(a=>(a.createdAt||0)>lastSeen&&a.status==='pending');
    if(adminOn && news.length){ updateBell(news.length); toast('Yeni randevu bekliyor'); playAlert(); const bell=$('#bellBtn'); bell.style.display='inline-flex'; bell.classList.add('blink'); }

    // M√º≈üteri i√ßin durum deƒüi≈üikliƒüi bildirimi
    if(currentUser){
      const mine = lastAppts.filter(a=>a.phone===currentUser.phone);
      mine.forEach(a=>{
        const prev = myPrevStatus[a.id];
        const nowS = (a.status||'').toLowerCase();
        if(prev==='pending' && (nowS==='approved'||nowS==='rejected'||nowS==='cancelled'||nowS==='deleted')){
          toast(
            nowS==='approved' ? '‚úÖ Randevunuz onaylandƒ±' :
            nowS==='rejected' ? '‚õî Randevunuz reddedildi' :
            nowS==='cancelled' ? '‚ÑπÔ∏è Randevunuz iptal edildi' : 'üóë Randevunuz silindi'
          );
          try{ if(navigator.vibrate) navigator.vibrate([60,40,60]); }catch(e){}
        }
        myPrevStatus[a.id] = nowS;
      });
    }
  });
}
startRealtime();

/* ===== Bootstrap defaults (ilk kurulum) ===== */
async function bootstrapDefaults(){
  try{
    if(!lastStaff.length){
      await db.collection('staff').add({name:'Ahmet Tekeli',days:[0,1,2,3,4,5,6],hours:{open:'09:00',close:'21:00'},hoursByDay:{},offDates:[]});
    }
    if(!lastSvcs.length){
      await db.collection('services').add({name:'Sa√ß Kesim', dur:30, price:250});
      await db.collection('services').add({name:'Sakal Tra≈ü', dur:30, price:200});
      await db.collection('services').add({name:'Yƒ±kama + F√∂n', dur:20, price:150});
    }
  }catch(e){}
}

/* ===== Bell ===== */
function updateBell(n){ const b=$('#bellBtn'), d=$('#bellCount'); if(!b||!d) return; d.textContent=String(n); if(adminOn && n>0) b.classList.add('blink'); else b.classList.remove('blink'); b.style.display = adminOn ? 'inline-flex' : 'none'; }

/* ===== Admin Login/Logout ===== */
$('#adminLoginBtn')?.addEventListener('click',()=>{
  const phone=normalizePhone($('#adminPhone').value||''); const pass=($('#adminPass').value||'').trim();
  const ok=(phone===ADMIN_PHONE_E164||phone==='+905356749243') && pass===ADMIN_PASSWORD;
  if(ok){ setAdmin(true); $('#adminStatus').textContent='Giri≈ü ba≈üarƒ±lƒ±'; sheet.hide('#sheetAdmin'); toast('Admin a√ßƒ±ldƒ±'); }
  else { $('#adminStatus').textContent='≈ûifre/telefon hatalƒ±'; }
});
$('#adminLogoutBtn')?.addEventListener('click',()=>{ setAdmin(false); $('#adminStatus').textContent='√áƒ±kƒ±≈ü yapƒ±ldƒ±'; toast('Admin kapandƒ±'); });

/* ===== Customer Login/Sign-up + Forgot + Logout ===== */
$('#c_login')?.addEventListener('click', async ()=>{
  const name=($('#c_name').value||'').trim(); const phone=normalizePhone($('#c_phone').value||''); const pin=($('#c_pin').value||'').trim();
  if(!name||!phone||pin.length<4){ $('#c_status').textContent='Ad/Telefon ve ≈üifre (min 4) gerekli.'; return; }
  try{
    const q=await db.collection('users').where('phone','==',phone).limit(1).get(); let uid;
    if(q.empty){ const uref=await db.collection('users').add({ name, phone, verified:true, pin, createdAt:Date.now(), lastLogin:Date.now() }); uid=uref.id; }
    else{ const doc=q.docs[0], u=doc.data(); uid=doc.id; if(u.pin && u.pin!==pin){ $('#c_status').textContent='≈ûifre hatalƒ±.'; return; } await db.collection('users').doc(uid).set({ name, lastLogin:Date.now() }, { merge:true }); }
    currentUser={id:uid,name,phone}; setCust(true); sheet.hide('#sheetCust'); $('#f_name').value=name; $('#f_phone').value=phone.replace('+90','0'); toast('Giri≈ü tamamlandƒ±');
  }catch(e){ $('#c_status').textContent=(e?.code==='permission-denied'?'Firestore izin hatasƒ±':'Sunucu hatasƒ±'); }
});
$('#c_forgot')?.addEventListener('click', async ()=>{
  const name=($('#c_name').value||'').trim(); const phone=normalizePhone($('#c_phone').value||'');
  if(!name||!phone){ $('#c_status').textContent='Ad ve Telefon gerekli.'; return; }
  try{
    const q=await db.collection('users').where('phone','==',phone).limit(1).get(); let uid;
    if(q.empty){ const uref=await db.collection('users').add({ name, phone, verified:true, createdAt:Date.now(), lastLogin:Date.now() }); uid=uref.id; }
    else{ uid=q.docs[0].id; await db.collection('users').doc(uid).set({ name }, { merge:true }); }
    await db.collection('pw_resets').add({ userId:uid, name, phone, status:'pending', createdAt:Date.now() });
    $('#c_status').textContent='ƒ∞steƒüiniz alƒ±ndƒ±. Y√∂netici ge√ßici ≈üifre olu≈üturacak.'; toast('≈ûifre sƒ±fƒ±rlama talebi kaydedildi');
  }catch(e){ $('#c_status').textContent='Sunucu hatasƒ±'; }
});
document.getElementById('c_logout')?.addEventListener('click', ()=>{
  currentUser=null; setCust(false); toast('M√º≈üteri oturumu kapandƒ±');
});

/* ===== Admin Kuyruk + ƒ∞≈ülemler ===== */
function renderQueue(list){
  if(!adminOn) return;
  const box=$('#queueList'); if(!box) return;
  const appts=(list||[]).filter(a=>a.status==='pending').sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  box.innerHTML=appts.length?appts.map(a=>`
    <div style="display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px;margin:6px 0;background:rgba(255,255,255,.04)">
      <div style="flex:1 1 auto;min-width:0"><b>${a.date} ${a.time}</b> ‚Ä¢ ${a.name} ‚Ä¢ ${a.serviceName} / ${a.staffName}
        <span class="badge-status st-pending" style="margin-left:8px">Onay bekliyor</span></div>
      <button class="btn" onclick="approve('${a.id}')">Onayla</button>
      <button class="btn" onclick="reject('${a.id}')">Reddet</button>
      <button class="btn btn-danger" onclick="delAppt('${a.id}')">Sil</button>
    </div>`).join('') : 'Kuyruk bo≈ü.';
}
window.approve=async(id)=>{try{await db.collection('appts').doc(id).set({status:'approved',updatedAt:Date.now()},{merge:true}); lastSeen=Date.now(); store.set('adminLastSeen',lastSeen); $('#bellBtn')?.classList.remove('blink'); toast('Onaylandƒ±');}catch(e){toast('Hata');}}
window.reject =async(id)=>{try{await db.collection('appts').doc(id).set({status:'rejected',updatedAt:Date.now()},{merge:true}); lastSeen=Date.now(); store.set('adminLastSeen',lastSeen); $('#bellBtn')?.classList.remove('blink'); toast('Reddedildi');}catch(e){toast('Hata');}}
window.delAppt=async(id)=>{try{await db.collection('appts').doc(id).set({status:'deleted',updatedAt:Date.now()},{merge:true}); toast('Silindi');}catch(e){toast('Hata');}}

/* ===== Admin ‚Äî Customers ===== */
function renderCustomers(){
  const term=($('#custSearch')?.value||'').toLowerCase(); const tb=$('#custTbody'); if(!tb) return;
  const rows=(lastUsers||[]).filter(u=>!term || (u.name||'').toLowerCase().includes(term) || (u.phone||'').toLowerCase().includes(term)).sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr'));
  tb.innerHTML=rows.map(u=>`
    <tr><td>${u.name||''}</td><td>${maskPhone(u.phone)||''}</td>
    <td>${u.createdAt?new Date(u.createdAt).toLocaleString('tr-TR'):'-'}</td>
    <td>${u.lastLogin?new Date(u.lastLogin).toLocaleString('tr-TR'):'-'}</td>
    <td><button class="btn btn-danger" onclick="delUser('${u.id}')">Sil</button></td></tr>`).join('') || `<tr><td colspan="5" class="small">M√º≈üteri yok</td></tr>`;
}
$('#custSearch')?.addEventListener('input',renderCustomers);
$('#custRefresh')?.addEventListener('click',renderCustomers);
window.delUser=async(id)=>{ if(!confirm('Bu m√º≈üteriyi silmek istiyor musunuz?')) return; try{ await db.collection('users').doc(id).delete(); toast('M√º≈üteri silindi'); }catch(e){ toast('Hata: M√º≈üteri silinemedi'); } };

/* ===== Admin ‚Äî Appointments table + bulk ===== */
function tStatus(s){switch(String(s||'').toLowerCase()){case'pending':return{t:'Onay bekliyor',c:'st-pending'};case'approved':return{t:'Onaylandƒ±',c:'st-approved'};case'cancelled':return{t:'ƒ∞ptal',c:'st-cancelled'};case'rejected':return{t:'Reddedildi',c:'st-rejected'};case'deleted':return{t:'Silindi',c:'st-deleted'}} return{t:'',c:''}}
function renderAdminAppts(list){
  const tb=$('#ap_tbody'); if(!tb) return;
  const fdate=$('#ap_fdate').value||'', fstaff=$('#ap_fstaff').value||'', fstat=$('#ap_fstatus').value||'';
  let rows=[...(list||[])]; if(fdate) rows=rows.filter(a=>a.date===fdate); if(fstaff) rows=rows.filter(a=>a.staffId===fstaff); if(fstat) rows=rows.filter(a=>a.status===fstat);
  rows.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  tb.innerHTML=rows.map(a=>{
    const act=a.status==='pending' ? `<button class="btn" onclick="approve('${a.id}')">Onayla</button> <button class="btn" onclick="reject('${a.id}')">Reddet</button>` : a.status==='approved' ? `<button class="btn" onclick="setCancelled('${a.id}')">ƒ∞ptal</button>` : '';
    return `<tr>
      <td><input type="checkbox" class="ap_chk" data-id="${a.id}"></td>
      <td>${a.date}</td><td>${a.time}</td>
      <td>${a.name} (${maskPhone(a.phone)})</td>
      <td>${a.serviceName||''}</td>
      <td>${a.staffName||''}</td>
      <td><span class="badge-status ${tStatus(a.status).c}">${tStatus(a.status).t}</span></td>
      <td style="display:flex;gap:6px">${act} <button class="btn btn-danger" onclick="delAppt('${a.id}')">Sil</button></td>
    </tr>`;
  }).join('') || `<tr><td colspan="8" class="small">Randevu yok</td></tr>`;
}
$('#ap_refresh')?.addEventListener('click',()=>renderAdminAppts(lastAppts));
$('#ap_fdate')?.addEventListener('change',()=>renderAdminAppts(lastAppts));
$('#ap_fstaff')?.addEventListener('change',()=>renderAdminAppts(lastAppts));
$('#ap_fstatus')?.addEventListener('change',()=>renderAdminAppts(lastAppts));
$('#ap_chkall')?.addEventListener('change',e=>$$('.ap_chk').forEach(c=>c.checked=e.target.checked));
$('#bulk_cancel')?.addEventListener('click',async()=>{const ids=$$('.ap_chk:checked').map(x=>x.dataset.id); for(const id of ids){ await setCancelled(id,true);} toast('Se√ßili randevular iptal edildi');});
$('#bulk_delete')?.addEventListener('click',async()=>{const ids=$$('.ap_chk:checked').map(x=>x.dataset.id); for(const id of ids){ await db.collection('appts').doc(id).set({status:'deleted',updatedAt:Date.now()},{merge:true}); } toast('Se√ßili randevular silindi');});
window.setCancelled=async(id,silent=false)=>{ try{ await db.collection('appts').doc(id).set({status:'cancelled',updatedAt:Date.now()},{merge:true}); if(!silent) toast('ƒ∞ptal edildi'); }catch(e){ toast('Hata'); } };

/* ===== Admin ‚Äî Staff & Services ===== */
function renderStaffList(){
  $('#staffList').innerHTML=(lastStaff||[]).sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr')).map(s=>`
    <li style="display:flex;gap:8px;align-items:center;margin:6px 0">
      <span style="flex:1">${s.name}</span>
      <button class="btn btn-danger" onclick="delStaff('${s.id}')">Sil</button>
    </li>`).join('') || '‚Äî';
  $('#wh_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#a_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  renderWorkEditor();
}
window.delStaff=async(id)=>{ try{await db.collection('staff').doc(id).delete(); toast('Usta silindi');}catch(e){toast('Hata: Usta silinemedi');} };
$('#addStaff')?.addEventListener('click', async ()=>{
  const name=$('#newStaffName').value.trim(); if(!name){toast('Usta adƒ± gerekli');return;}
  try{ await db.collection('staff').add({name,days:[1,2,3,4,5,6,0],hours:{open:'09:00',close:'21:00'},hoursByDay:{},offDates:[]}); $('#newStaffName').value=''; toast('Usta eklendi'); }catch(e){ toast('Hata: Usta eklenemedi'); }
});

function renderServiceList(){ $('#svcList').innerHTML=(lastSvcs||[]).sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr')).map(s=>`
  <li style="display:flex;gap:8px;align-items:center;margin:6px 0">
    <span style="flex:1">${s.name} ‚Äî ${s.dur} dk / ${s.price||0} TL</span>
    <button class="btn btn-danger" onclick="delSvc('${s.id}')">Sil</button>
  </li>`).join('') || '‚Äî'; $('#a_svc').innerHTML=lastSvcs.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); }
window.delSvc=async(id)=>{ try{await db.collection('services').doc(id).delete(); toast('Hizmet silindi');}catch(e){toast('Hata: Hizmet silinemedi');} };
$('#addSvc')?.addEventListener('click', async ()=>{
  const name=$('#newSvcName').value.trim(), dur=parseInt($('#newSvcDur').value||'30',10), price=parseInt($('#newSvcPrice').value||'0',10);
  if(!name){toast('Hizmet adƒ± gerekli');return;}
  try{ await db.collection('services').add({name,dur,price}); $('#newSvcName').value=''; $('#newSvcDur').value=''; $('#newSvcPrice').value=''; toast('Hizmet eklendi'); }catch(e){ toast('Hata: Hizmet eklenemedi'); }
});

/* ===== Admin ‚Äî Work Hours ===== */
const DAYS=['Paz','Pzt','Sal','√áar','Per','Cum','Cmt'];
function renderWorkEditor(){
  const sid=$('#wh_staff').value || lastStaff[0]?.id; if(!sid){ $('#wh_staff').innerHTML=''; return; }
  $('#wh_staff').value=sid;
  const staff=lastStaff.find(s=>s.id===sid); if(!staff) return;
  const dayWrap=$('#wh_days'); dayWrap.innerHTML='';
  for(let i=0;i<7;i++){
    const label=document.createElement('label'); label.style.cssText='display:inline-flex;gap:8px;align-items:center;margin:2px 6px 2px 0';
    const chk=document.createElement('input'); chk.type='checkbox'; chk.style.width='auto'; chk.dataset.dow=String(i);
    chk.checked=(staff.days||[1,2,3,4,5,6]).includes(i);
    label.append(chk, document.createTextNode(' '+DAYS[i])); dayWrap.appendChild(label);
  }
  const iv=$('#wh_intervals'); iv.innerHTML='';
  const by=staff.hoursByDay||{};
  for(let i=0;i<7;i++){
    const row=document.createElement('div'); row.style.cssText='display:flex;gap:6px;align-items:center;margin:4px 0';
    const d=by[i]||{};
    row.innerHTML=`<div style="min-width:54px"><b>${DAYS[i]}</b></div>
      <input type="time" data-k="open1"  data-dow="${i}" value="${d.open1||staff.hours?.open||'09:00'}">
      <span>‚Äì</span>
      <input type="time" data-k="close1" data-dow="${i}" value="${d.close1||staff.hours?.close||'21:00'}">
      <span style="width:8px"></span>
      <input type="time" data-k="open2"  data-dow="${i}" value="${d.open2||''}">
      <span>‚Äì</span>
      <input type="time" data-k="close2" data-dow="${i}" value="${d.close2||''}">`;
    iv.appendChild(row);
  }
  renderOffList(staff);
}
$('#wh_staff')?.addEventListener('change',renderWorkEditor);
function renderOffList(staff){
  const wrap=$('#offList'); wrap.innerHTML='';
  (staff.offDates||[]).sort().forEach(d=>{
    const chip=document.createElement('span'); chip.style.cssText='display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:6px 10px;margin:3px 6px 0 0;background:#1a2130';
    chip.textContent=d+' ';
    const b=document.createElement('button'); b.className='btn btn-danger'; b.textContent='Sil';
    b.onclick=async()=>{ const list=(staff.offDates||[]).filter(x=>x!==d); await db.collection('staff').doc(staff.id).set({offDates:list},{merge:true}); toast('ƒ∞zin silindi'); };
    chip.appendChild(b); wrap.appendChild(chip);
  });
}
$('#addOff')?.addEventListener('click', async ()=>{
  const sid=$('#wh_staff').value; const staff=lastStaff.find(s=>s.id===sid); const d=$('#offDate').value; if(!d||!staff) return;
  const set=new Set(staff.offDates||[]); set.add(d); await db.collection('staff').doc(sid).set({offDates:[...set]},{merge:true}); toast('ƒ∞zin eklendi');
});
$('#saveWorkHours')?.addEventListener('click', async ()=>{
  const sid=$('#wh_staff').value; if(!sid){toast('Usta se√ßiniz');return;}
  const staff=lastStaff.find(s=>s.id===sid); if(!staff) return;
  const days=[...document.querySelectorAll('#wh_days input[type="checkbox"]')].filter(x=>x.checked).map(x=>parseInt(x.dataset.dow,10));
  const hoursByDay={}; $$('#wh_intervals input[type="time"]').forEach(inp=>{ const i=parseInt(inp.dataset.dow,10); const k=inp.dataset.k; hoursByDay[i]=hoursByDay[i]||{}; hoursByDay[i][k]=inp.value||''; });
  try{
    await db.collection('staff').doc(sid).set({ days,hoursByDay, hours:{open:hoursByDay[1]?.open1||'09:00',close:hoursByDay[1]?.close1||'21:00'} },{merge:true});
    $('#wh_status').textContent='Kaydedildi.'; toast('√áalƒ±≈üma saatleri kaydedildi'); computeSlots(); renderAdminSlots(); if(_rs) computeResched();
  }catch(e){ toast('Hata: √áalƒ±≈üma saatleri kaydedilemedi'); }
});

/* ===== Admin ‚Äî Create appointment ===== */
$('#a_create')?.addEventListener('click', async ()=>{
  const name=$('#a_name').value.trim(), phoneRaw=$('#a_phone').value.trim();
  const staffId=$('#a_staff').value, svcId=$('#a_svc').value, date=$('#a_date').value, time=getSelected('a_slots');
  const auto=$('#a_auto').checked;
  if(!name||!phoneRaw||!staffId||!svcId||!date||!time){ $('#a_status').textContent='Eksik bilgi'; toast('Eksik bilgi'); return; }
  const phone=normalizePhone(phoneRaw);
  try{
    let uid=null; const uq=await db.collection('users').where('phone','==',phone).limit(1).get();
    if(uq.empty){ const uref=await db.collection('users').add({name,phone,verified:true,pin:'0000',createdAt:Date.now(),lastLogin:Date.now()}); uid=uref.id; }
    else{ uid=uq.docs[0].id; await db.collection('users').doc(uid).set({name,lastLogin:Date.now()},{merge:true}); }
    const svc=(await db.collection('services').doc(svcId).get()).data();
    const st =(await db.collection('staff').doc(staffId).get()).data();
    await db.collection('appts').add({ userId:uid,name,phone,serviceId:svcId,serviceName:svc?.name||'Hizmet', duration:svc?.dur||30, price:Number(svc?.price||0), staffId,staffName:st?.name||'Usta',date,time,status:auto?'approved':'pending',createdAt:Date.now() });
    $('#a_status').textContent=auto?'Olu≈üturuldu (onaylƒ±)':'Olu≈üturuldu (beklemede)'; toast('Admin randevu eklendi');
  }catch(e){ $('#a_status').textContent='Hata'; toast('Hata'); }
});

/* ===== Customer ‚Äî My appointments ===== */
function renderMy(list){
  const tb=$('#my_tbody'); if(!tb) return;
  if(!currentUser){ tb.innerHTML='<tr><td colspan="6" class="small">L√ºtfen m√º≈üteri giri≈üi yapƒ±n.</td></tr>'; return; }
  let rows=(list||[]).filter(a=>a.phone===currentUser.phone);
  rows.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  tb.innerHTML=rows.map(a=>{
    const canCancel=(a.status==='pending'||a.status==='approved');
    return `<tr>
      <td>${a.date}</td><td>${a.time}</td><td>${a.serviceName||''}</td><td>${a.staffName||''}</td>
      <td><span class="badge-status ${tStatus(a.status).c}">${tStatus(a.status).t}</span></td>
      <td style="display:flex;gap:6px">
        <button class="btn" onclick="openResched('${a.id}')">Deƒüi≈ütir</button>
        ${canCancel?`<button class="btn btn-danger" onclick="cancelMine('${a.id}')">Sil</button>`:''}
      </td>
    </tr>`;
  }).join('') || '<tr><td colspan="6" class="small">Randevu yok</td></tr>';
}
window.cancelMine=async(id)=>{if(!confirm('ƒ∞ptal edilsin mi?'))return;try{await db.collection('appts').doc(id).set({status:'cancelled',updatedAt:Date.now()},{merge:true});toast('ƒ∞ptal edildi');}catch(e){toast('Hata');}}

/* ===== Reschedule ===== */
async function openResched(id){ if(!currentUser) return; const doc=await db.collection('appts').doc(id).get(); if(!doc.exists) return toast('Bulunamadƒ±'); const a=doc.data(); if(a.phone!==currentUser.phone) return toast('Yetkisiz'); _rs={id,staffId:a.staffId,duration:a.duration,date:a.date}; $('#rs_date').value=a.date; computeResched(); sheet.show('#sheetResched'); }
function computeResched(){ if(!_rs) return; const staff=lastStaff.find(s=>s.id===_rs.staffId); if(!staff) return; renderGrid('rs_grid',staff,_rs.duration,_rs.date); }
$('#rs_date')?.addEventListener('change',()=>{ if(_rs){ _rs.date=$('#rs_date').value; computeResched(); } });
$('#rs_cancel')?.addEventListener('click',()=>{_rs=null; sheet.hide('#sheetResched');});
$('#rs_save')?.addEventListener('click', async ()=>{
  if(!_rs) return;
  const sel = document.querySelector('#rs_grid .slot.sel');
  const time = sel ? sel.dataset.time : null;
  if(!time){ $('#rs_status').textContent='Saat se√ßin'; toast('L√ºtfen saat se√ßin'); return; }
  try{
    await db.collection('appts').doc(_rs.id).set(
      { date:_rs.date, time, status:'pending', updatedAt: Date.now() },
      { merge:true }
    );
    toast('G√ºncellendi (beklemede)');
    _rs=null; sheet.hide('#sheetResched');
  }catch(e){ toast('Hata'); }
});

/* ===== Admin Analytics (PDF + Chart) ===== */
function getTodayAppointments(list){ const t=new Date().toISOString().slice(0,10); return (list||[]).filter(a=>a.date===t).sort((a,b)=>(a.time).localeCompare(b.time)); }
async function downloadTodayPdf(){
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt', format:'a4'});
    const todayStr = new Date().toLocaleDateString('tr-TR');
    const rows = getTodayAppointments(lastAppts);
    const total = rows.length;
    const count = s => rows.filter(x=>x.status===s).length;
    doc.setFont('helvetica','bold'); doc.setFontSize(16);
    doc.text('Ahmet Tekeli Erkek Kuaf√∂r√º ‚Äî G√ºnl√ºk Rapor', 40, 50);
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text(`Tarih: ${todayStr}`, 40, 70);
    doc.text(`Toplam: ${total} | Onaylandƒ±: ${count('approved')} | Beklemede: ${count('pending')} | ƒ∞ptal: ${count('cancelled')} | Reddedildi: ${count('rejected')} | Silindi: ${count('deleted')}`, 40, 88);
    let y=115; doc.setFont('helvetica','bold'); doc.text('Saat',40,y); doc.text('M√º≈üteri',100,y); doc.text('Hizmet',260,y); doc.text('Berber',430,y); doc.text('Durum',520,y);
    doc.setLineWidth(0.5); doc.line(40, y+6, 555, y+6); doc.setFont('helvetica','normal'); y+=22;
    const T=s=>({pending:'Onay bekliyor',approved:'Onaylandƒ±',cancelled:'ƒ∞ptal',rejected:'Reddedildi',deleted:'Silindi'}[s]||'');
    rows.forEach(a=>{ if(y>760){ doc.addPage(); y=60; } doc.text(a.time,40,y); doc.text(a.name||'',100,y); doc.text((a.serviceName||''),260,y,{maxWidth:150}); doc.text((a.staffName||''),430,y,{maxWidth:80}); doc.text(T(a.status),520,y); y+=18;});
    doc.save(`gunluk_rapor_${new Date().toISOString().slice(0,10)}.pdf`);
  }catch(e){ toast('PDF olu≈üturulamadƒ±'); }
}
document.getElementById('btnPdfToday')?.addEventListener('click', downloadTodayPdf);

function weekRange(today=new Date()){ const d=new Date(today); const day=d.getDay(); const diffToMonday=(day===0?-6:1-day); const ws=new Date(d); ws.setDate(d.getDate()+diffToMonday); const we=new Date(ws); we.setDate(ws.getDate()+6); const iso=x=>x.toISOString().slice(0,10); return {ws, we, wsISO:iso(ws), weISO:iso(we)}; }
function computeWeekData(list){ const {wsISO,weISO}=weekRange(new Date()); const inWeek=(list||[]).filter(a=>a.date>=wsISO&&a.date<=weISO); const dayIndex=d=>new Date(d+'T00:00:00').getDay(); const map=Array.from({length:7},()=>({all:0, approved:0, pending:0, cancelled:0, rejected:0, deleted:0})); inWeek.forEach(a=>{ const idx=dayIndex(a.date); const b=map[idx]; b.all++; const st=(a.status||'').toLowerCase(); if(b[st]!=null) b[st]++; }); return {labels:['Paz','Pzt','Sal','√áar','Per','Cum','Cmt'], map}; }
let _chartInstance=null;
function renderWeeklyChart(){ if(!adminOn) return; const ctx=document.getElementById('weekChart'); if(!ctx) return; const {labels,map}=computeWeekData(lastAppts); const ds=t=>map.map(x=>x[t]||0); const data={ labels, datasets:[ {label:'Onaylandƒ±',data:ds('approved')},{label:'Beklemede',data:ds('pending')},{label:'ƒ∞ptal',data:ds('cancelled')},{label:'Reddedildi',data:ds('rejected')},{label:'Silindi',data:ds('deleted')} ]}; const opt={responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}; if(_chartInstance){_chartInstance.destroy();} _chartInstance=new Chart(ctx,{type:'bar',data,options:opt}); }
document.getElementById('btnRefreshChart')?.addEventListener('click', renderWeeklyChart);
function updateKpi(list){ if(!adminOn) return; const today=new Date().toISOString().slice(0,10); const d=list.filter(a=>a.date===today); const ap=d.filter(a=>a.status==='approved').length; const pe=d.filter(a=>a.status==='pending').length; const ca=d.filter(a=>a.status==='cancelled').length; const rj=d.filter(a=>a.status==='rejected').length; const dl=d.filter(a=>a.status==='deleted').length; $('#kpi').innerHTML=`<span class="badge-status st-approved">${ap} Onaylandƒ±</span> <span class="badge-status st-pending">${pe} Beklemede</span> <span class="badge-status st-cancelled">${ca} ƒ∞ptal</span> ${rj?`<span class="badge-status st-rejected">${rj} Reddedildi</span>`:''} ${dl?`<span class="badge-status st-deleted">${dl} Silindi</span>`:''}`; }

/* ===== Booking (m√º≈üteri) ===== */
$('#f_book')?.addEventListener('click', async ()=>{
  const name=$('#f_name').value.trim(), phoneRaw=$('#f_phone').value.trim();
  const staffId=$('#f_staff').value, svcId=$('#f_service').value, date=$('#f_date').value, time=getSelected('slotgrid');
  if(!name||!phoneRaw||!staffId||!svcId||!date||!time){ $('#f_status').textContent='L√ºtfen t√ºm alanlarƒ± doldurun.'; toast('Eksik bilgi'); return; }
  const phone=normalizePhone(phoneRaw);
  try{
    const same=await db.collection('appts').where('phone','==',phone).where('date','==',date).get();
    const activeCnt=same.docs.map(d=>d.data()).filter(a=>a.status==='pending'||a.status==='approved').length;
    if(activeCnt>=2){ toast('Aynƒ± g√ºn en fazla 2 aktif randevu'); return; }
    let uid=null; const uq=await db.collection('users').where('phone','==',phone).limit(1).get();
    if(uq.empty){ const uref=await db.collection('users').add({name,phone,verified:true,pin:'0000',createdAt:Date.now(),lastLogin:Date.now()}); uid=uref.id; }
    else{ uid=uq.docs[0].id; await db.collection('users').doc(uid).set({name,lastLogin:Date.now()},{merge:true}); }
    currentUser={id:uid,name,phone}; setCust(true);
    const svc=(await db.collection('services').doc(svcId).get()).data(); const st=(await db.collection('staff').doc(staffId).get()).data();
    await db.collection('appts').add({ userId:uid,name,phone,serviceId:svcId,serviceName:svc?.name||'Hizmet', duration:svc?.dur||30, price:Number(svc?.price||0), staffId,staffName:st?.name||'Usta',date,time,status:'pending',createdAt:Date.now() });
    $('#f_status').textContent='Randevu alƒ±ndƒ± (beklemede).'; toast('Randevu olu≈üturuldu');
  }catch(e){ toast(e?.code==='permission-denied'?'Firestore izin hatasƒ±':'Hata'); }
});

/* ===== Auto-approve (1 dk) ===== */
async function autoApproveOverdue(){
  try{
    const cutoff = Date.now() - AUTO_APPROVE_MS;
    const q = await db.collection('appts')
      .where('status','==','pending')
      .where('createdAt','<',cutoff)
      .limit(25)
      .get();
    if(!q.empty){
      const batch = db.batch();
      q.docs.forEach((doc)=> batch.set(doc.ref, { status: 'approved', autoApprovedAt: Date.now() }, { merge:true }) );
      await batch.commit();
    }
  }catch(e){ /* sessiz d√º≈ü */ }
}
function startAutoApproveDaemon(){
  autoApproveOverdue();
  setInterval(autoApproveOverdue, 15000); // 15 sn‚Äôde bir kontrol
}

/* ===== Boot ===== */
(function boot(){ $('#ap_fdate').value=new Date().toISOString().slice(0,10); })();
startAutoApproveDaemon();
</script>
</body>
</html>
