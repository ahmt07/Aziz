<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ahmet Tekeli Erkek Kuaf√∂r√º</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#eef0f3; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --card:#ffffff;
    --brand:#111827; --gold:#d4af37;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overflow-x:hidden}
  img{max-width:100%;height:auto}
  .wrap{max-width:min(940px,100%);margin:0 auto;padding:0 12px}

  /* Arka plan (g√∂m√ºl√º desen) */
  .bg-tiles{position:fixed; inset:0; z-index:-1; pointer-events:none;
    background:radial-gradient(900px 400px at 15% -10%, rgba(212,175,55,.08), transparent 55%),
               radial-gradient(700px 360px at 85% 0%, rgba(0,0,0,.05), transparent 60%),
               linear-gradient(180deg,#f3f5f8 0%, var(--bg) 45%, #e7ebf1 100%);
  }
  .bg-tiles::after{content:""; position:absolute; inset:0; opacity:.10;
    background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'>\
<g fill='none' stroke='%23b59a3a' stroke-width='2' opacity='0.8'>\
<path d='M20 70c12-28 36-28 48 0s36 28 48 0'/>\
<path d='M24 32l22 22M116 32l-22 22'/>\
<circle cx='70' cy='70' r='7'/>\
</g></svg>");
    background-size:140px; background-repeat:repeat; background-position:center;
  }

  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .hero{display:flex;flex-direction:column;align-items:center;gap:8px;padding:14px 0}
  .hero img{max-width:160px;filter:drop-shadow(0 4px 12px rgba(0,0,0,.12))}
  .brand{font-family:"Playfair Display",serif;font-style:italic;font-weight:700;color:#111827;font-size:28px;text-align:center}
  .login{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;width:100%;max-width:860px}
  .login .row{display:flex;gap:8px;flex-wrap:wrap}
  .login input{flex:1 1 220px;padding:12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .auth-tabs{display:flex;gap:8px;margin-bottom:8px}
  .auth-tab{border:1px solid var(--line);background:#f8fafc;padding:8px 10px;border-radius:10px;cursor:pointer}
  .auth-tab.active{background:#111827;color:#fff;border-color:#111827}
  .muted{color:var(--muted);font-size:12px}

  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn-primary{background:var(--gold);border-color:var(--gold);color:#111}
  .tabs{display:flex;gap:18px;padding:10px 4px;border-radius:12px;background:#f7f8fb;border:1px solid var(--line);max-width:860px;width:100%}
  .tab{background:transparent;border:none;padding:8px 6px;border-bottom:2px solid transparent;cursor:pointer;color:#1f2937}
  .tab.active{border-bottom-color:#111827;font-weight:700}
  main{padding:16px 0}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;max-width:100%;overflow:hidden}
  label{display:block;font-weight:700;margin:.4rem 0 .2rem}
  input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff}

  /* Saatler */
  .slots-wrap{display:flex;align-items:center;gap:8px}
  .slots{display:flex;gap:12px;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;padding:6px 2px;max-width:100%}
  .slots::-webkit-scrollbar{height:6px}.slots::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
  .slot{padding:10px 16px;border:1px solid var(--line);border-radius:999px;background:#fff;flex:0 0 auto}
  .slot.dis{opacity:.45;pointer-events:none;text-decoration:line-through}
  .slot.sel{background:#111827;color:#fff;border-color:#111827;box-shadow:0 4px 14px rgba(0,0,0,.18)}

  .actions{display:flex;gap:12px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}
  thead th{background:#f3f4f6;font-weight:700}
  .small{font-size:12px;color:var(--muted)}
  .table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .table-scroll table{min-width:560px}
  footer{padding:24px 0;color:var(--muted);text-align:center}
  @media (max-width:420px){.brand{font-size:24px}.login{padding:10px}.login input{min-width:0}.btn{padding:10px 12px}.tabs{gap:10px}th,td{padding:8px}}

  /* √áan ve Payla≈ü */
  #topRight{position:fixed;top:10px;right:12px;z-index:100;display:flex;gap:8px}
  #notifyBell{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.9);box-shadow:0 6px 16px rgba(0,0,0,.08);backdrop-filter:blur(6px)}
  #notifyBell .bell{font-size:18px;line-height:1}
  #notifyBell .badge{min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:#ef4444;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}
  #shareBtn{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.9)}

  /* Profil Rozeti */
  #profileBadge{
    display:none; align-items:center; gap:8px;
    margin-top:6px; padding:6px 10px; border:1px solid var(--line);
    border-radius:999px; background:rgba(255,255,255,.9); backdrop-filter:blur(6px);
  }
</style>
</head>
<body>
<div class="bg-tiles"></div>

<!-- √áan + Payla≈ü -->
<div id="topRight">
  <button id="shareBtn" title="Baƒülantƒ±yƒ± payla≈ü">üîó Payla≈ü</button>
  <button id="notifyBell" title="Bildirimler" type="button">
    <span class="bell">üîî</span><span id="notifyCount" class="badge">0</span>
  </button>
</div>

<!-- Bildirim sesi (g√∂m√ºl√º beep) -->
<audio id="ding" preload="auto" src="data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBHQAAABwAAABkYXRhUAAAAAAAgICAf39/f4CAgICAf39/f4CAgICAf39/f4CAgICAf39/f4CAgICAf39/f4CAgA==" ></audio>

<header>
  <div class="wrap">
    <div class="hero">
      <img src="logo.png" alt="Ahmet Tekeli Erkek Kuaf√∂r√º Logosu" onerror="this.style.display='none'">
      <div class="brand">Ahmet Tekeli<br>Erkek Kuaf√∂r√º</div>

      <!-- PROFƒ∞L ROZETƒ∞ (giri≈üte g√∂r√ºn√ºr) -->
      <div id="profileBadge">
        üë§ <b id="profName"></b>
        <button id="switchBtn" class="btn">Hesabƒ± deƒüi≈ütir</button>
      </div>

      <!-- KAYIT / Gƒ∞Rƒ∞≈û -->
      <div class="login">
        <div class="auth-tabs">
          <button class="auth-tab active" data-auth="login">Giri≈ü Yap</button>
          <button class="auth-tab" data-auth="register">Kayƒ±t Ol</button>
          <button class="btn" id="collapseLogin" style="margin-left:auto" title="Paneli daralt">‚Äî</button>
        </div>
        <div id="auth-login">
          <div class="row">
            <input id="l_phone" placeholder="Telefon (5xx...)" inputmode="tel">
            <input id="l_pin" placeholder="PIN (4 hane)" inputmode="numeric" maxlength="4">
            <label style="display:flex;align-items:center;gap:8px;margin:.2rem 0 0">
              <input type="checkbox" id="l_remember" checked style="width:auto"> <span class="muted">Beni hatƒ±rla</span>
            </label>
            <button class="btn btn-primary" id="loginBtn" type="button">Giri≈ü</button>
            <button class="btn" id="forgotPinBtn" type="button" title="PIN sƒ±fƒ±rlama talebi">≈ûifremi Unuttum?</button>
          </div>
          <p class="muted" id="loginInfo" style="margin-top:6px"></p>
        </div>

        <div id="auth-register" style="display:none">
          <div class="row">
            <input id="r_name" placeholder="Ad Soyad">
            <input id="r_phone" placeholder="Telefon (5xx...)" inputmode="tel">
            <input id="r_pin" placeholder="PIN (4 hane)" inputmode="numeric" maxlength="4">
            <button class="btn btn-primary" id="registerBtn" type="button">Kayƒ±t Ol</button>
          </div>
          <p class="muted">Bir kez kayƒ±t ol; sonrasƒ±nda <b>Giri≈ü Yap</b> ile PIN girerek devam et. ‚ÄúBeni hatƒ±rla‚Äù a√ßƒ±kken otomatik giri≈ü yapƒ±lƒ±r.</p>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-target="#randevu">Randevu Al</button>
        <button class="tab" data-target="#randevularim">Randevularƒ±m</button>
        <button class="tab" data-target="#admin">Admin Paneli</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="randevu" class="card">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px">
      <div>
        <label>Hizmet</label>
        <select id="svc"></select>
        <label>Berber</label>
        <select id="staff"></select>
        <label>Tarih</label>
        <input type="date" id="date">
        <p class="small">Kayƒ±t olmadan <b>uygun saatleri g√∂rebilirsin</b>. Randevu olu≈üturmak i√ßin giri≈ü gerekir.</p>
      </div>
      <div>
        <label>Uygun Saatler</label>
        <div class="slots-wrap">
          <button class="btn" type="button" id="slotPrev">‚Äπ</button>
          <div id="slots" class="slots" aria-label="Uygun saatler"></div>
          <button class="btn" type="button" id="slotNext">‚Ä∫</button>
        </div>
        <div class="actions" style="margin-top:10px">
          <button class="btn btn-primary" id="makeAppt" type="button">Randevu Olu≈ütur</button>
          <button class="btn" id="waPreview" type="button">WhatsApp Mesajƒ±</button>
        </div>
        <div id="makeStatus" class="small"></div>
        <p class="small">√áalƒ±≈üma: <span id="hoursLabel"></span> ‚Ä¢ Slot: <span id="slotSizeLabel"></span> dk</p>
      </div>
    </div>
  </section>

  <section id="randevularim" class="card" style="display:none">
    <h3>Randevularƒ±m</h3>
    <div class="table-scroll">
      <table>
        <thead><tr><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead>
        <tbody id="myApptTbody"></tbody>
      </table>
    </div>
  </section>

  <section id="admin" class="card" style="display:none">
    <h3>Admin Paneli</h3>
    <div class="actions" style="margin:8px 0">
      <input id="adminPass" placeholder="Admin ≈üifresi (varsayƒ±lan: ahmet-admin-2025)" style="max-width:320px">
      <button class="btn" id="adminLogin" type="button">Giri≈ü</button>
      <button class="btn" id="enableNotif" type="button" title="Masa√ºst√º bildirim">Bildirimleri A√ß</button>
      <span id="adminStatus" class="small"></span>
    </div>

    <div id="adminArea" style="display:none">
      <h4>Onay Kuyruƒüu</h4>
      <div class="table-scroll">
        <table>
          <thead><tr><th>M√º≈üteri</th><th>Tel</th><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>S√ºre</th><th>ƒ∞≈ülem</th></tr></thead>
          <tbody id="queueTbody"></tbody>
        </table>
      </div>

      <h4 style="margin-top:16px">PIN Sƒ±fƒ±rlama Talepleri</h4>
      <div class="table-scroll">
        <table>
          <thead><tr><th>Telefon</th><th>Yeni PIN</th><th>ƒ∞≈ülem</th></tr></thead>
          <tbody id="resetTbody"></tbody>
        </table>
      </div>

      <h4 style="margin-top:16px">G√ºnl√ºk Takvim</h4>
      <div class="actions" style="margin:8px 0">
        <input type="date" id="calDate">
        <select id="calStaff"></select>
        <button class="btn" id="viewCal" type="button">G√∂r√ºnt√ºle</button>
        <button class="btn" id="refreshAdmin" type="button">Yenile</button>
      </div>
      <div class="table-scroll">
        <table>
          <thead><tr><th>Saat</th><th>M√º≈üteri</th><th>Hizmet</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead>
          <tbody id="calTbody"></tbody>
        </table>
      </div>

      <!-- Admin ayarlarƒ± -->
      <details class="card" style="margin-top:16px">
        <summary><b>‚öôÔ∏è Ayarlar (Y√∂netici)</b></summary>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:12px">
          <div>
            <label>A√ßƒ±lƒ±≈ü</label><input id="openTime" value="09:00" type="time">
            <label>Kapanƒ±≈ü</label><input id="closeTime" value="21:00" type="time">
            <label>Slot S√ºresi (dk)</label><input id="slotSize" value="15" type="number" min="5" step="5">
            <label>Admin ≈ûifresi</label><input id="adminPwdInput" placeholder="Yeni ≈üifre">
            <button class="btn" id="saveSettings" type="button">Kaydet</button>
            <p class="small">Mevcut: <b id="defaultPwd"></b></p>
            <p id="settingsStatus" class="small"></p>
          </div>
          <div>
            <label>Berberler</label>
            <div id="staffList"></div>
            <div class="actions">
              <input id="newStaffName" placeholder="Berber adƒ±">
              <button class="btn" id="addStaff" type="button">Ekle</button>
            </div>
            <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">
            <label>Hizmetler</label>
            <div id="svcList"></div>
            <div class="actions">
              <input id="newSvcName" placeholder="Hizmet adƒ±">
              <input id="newSvcDur" type="number" placeholder="S√ºre (dk)" style="max-width:140px">
              <input id="newSvcPrice" type="number" placeholder="Fiyat (TL)" style="max-width:140px">
              <button class="btn" id="addSvc" type="button">Ekle</button>
            </div>
          </div>
        </div>
      </details>
    </div>
  </section>
</main>

<footer>
  <div class="wrap">¬© Ahmet Tekeli Erkek Kuaf√∂r√º ‚Ä¢ Randevu Sistemi</div>
</footer>

<script>
/* G√ºvenli Depo (localStorage yoksa RAM) */
(function(){
  const mem = {};
  window.store = {
    get(k, d){ try{ const v=localStorage.getItem(k); if(v!==null) return JSON.parse(v); return mem.hasOwnProperty(k)?mem[k]:d; }catch(e){ return mem.hasOwnProperty(k)?mem[k]:d; } },
    set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){ mem[k]=v; } },
    del(k){ try{ localStorage.removeItem(k); }catch(e){ delete mem[k]; } }
  };
})();

/* Yardƒ±mcƒ±lar */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const toMin=t=>{const [h,m]=t.split(':').map(Number);return h*60+m}, toHHMM=m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
const todayISO=()=>new Date().toISOString().slice(0,10); const uuid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);

/* Global */
let adminAuthed=false, currentUser=null;

/* Seed */
(function seed(){
  if(!store.get('settings')) store.set('settings',{open:"09:00",close:"21:00",slot:15,adminPwd:"ahmet-admin-2025"});
  if(!store.get('staff')) store.set('staff',[{id:uuid(),name:"Ahmet Usta"},{id:uuid(),name:"Kadir Usta"}]);
  if(!store.get('services')) store.set('services',[
    {id:uuid(),name:"Sa√ß Kesim",dur:30,price:400},
    {id:uuid(),name:"Sa√ß + Sakal",dur:45,price:600},
    {id:uuid(),name:"Sakal",dur:20,price:300}
  ]);
  if(!store.get('users')) store.set('users',[]);
  if(!store.get('appts')) store.set('appts',[]);
  if(!store.get('blocks')) store.set('blocks',[]);
  if(!store.get('resetReqs')) store.set('resetReqs',[]);
})();

/* Sekmeler */
$$('.tab').forEach(b=>b.addEventListener('click',()=>{
  $$('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  $$('main section').forEach(s=>s.style.display='none'); $(b.dataset.target).style.display='block';
  if(b.dataset.target==="#randevu") renderSlots();
}));

/* Auth sekmeleri */
$$('.auth-tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    $$('.auth-tab').forEach(x=>x.classList.remove('active')); btn.classList.add('active');
    const mode=btn.dataset.auth;
    $('#auth-login').style.display=(mode==='login'?'block':'none');
    $('#auth-register').style.display=(mode==='register'?'block':'none');
  });
});

/* Login panelini daralt */
document.getElementById('collapseLogin').addEventListener('click',()=>{
  const login=$('.login'); login.style.display=(login.style.display==='none'?'block':'none');
});

/* Admin korumasƒ± */
function requireAdmin(){ if(!adminAuthed){ alert('Bu i≈ülem yalnƒ±zca y√∂netici i√ßindir.'); return false; } return true; }

/* Ayarlar UI */
function refreshSettingsUI(){
  const s=store.get('settings');
  $('#hoursLabel')&&( $('#hoursLabel').textContent=`${s.open} - ${s.close}` );
  $('#slotSizeLabel')&&( $('#slotSizeLabel').textContent=s.slot );
  $('#openTime')&&( $('#openTime').value=s.open ); $('#closeTime')&&( $('#closeTime').value=s.close ); $('#slotSize')&&( $('#slotSize').value=s.slot );
  $('#defaultPwd')&&( $('#defaultPwd').textContent=s.adminPwd );
}
function renderStaffUI(){
  const staff=store.get('staff',[]), opts=staff.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
  $('#staff') && ($('#staff').innerHTML=opts);
  $('#calStaff') && ($('#calStaff').innerHTML=`<option value="">T√ºm√º</option>`+opts);
  $('#staffList') && ($('#staffList').innerHTML=staff.map(s=>`<div class="actions" style="align-items:center"><span>${s.name}</span><button class="btn" onclick="delStaff('${s.id}')">Sil</button></div>`).join(''));
}
function renderSvcUI(){
  const svcs=store.get('services',[]);
  $('#svc') && ($('#svc').innerHTML=svcs.map(s=>`<option value="${s.id}">${s.name} ‚Äî ${s.dur} dk / ${s.price} TL</option>`).join(''));
  $('#svcList') && ($('#svcList').innerHTML=svcs.map(s=>`<div class="actions" style="align-items:center"><span>${s.name} ‚Äî ${s.dur} dk / ${s.price} TL</span><button class="btn" onclick="delSvc('${s.id}')">Sil</button></div>`).join(''));
}
refreshSettingsUI(); renderStaffUI(); renderSvcUI();
$('#date')&&($('#date').value=todayISO()); $('#calDate')&&($('#calDate').value=todayISO());
setTimeout(()=>{ const s=$('#staff'); if(s&&s.options.length) s.selectedIndex=0; const v=$('#svc'); if(v&&v.options.length) v.selectedIndex=0; renderSlots(); },0);

/* Kayƒ±t / Giri≈ü / √áƒ±kƒ±≈ü + Otomatik giri≈ü */
function normPhone(p){ return (p||'').replace(/\D/g,''); }
function users(){ return store.get('users',[]); }
function saveUsers(u){ store.set('users',u); }
function findByPhone(p){ const ph=normPhone(p); return users().find(x=>x.phone===ph); }

function setCurrentUser(u, remember=true){
  currentUser=u;
  // login panelini gizle, profil rozetini g√∂ster
  const loginBox = document.querySelector('.login');
  if(loginBox) loginBox.style.display = 'none';
  const badge = document.getElementById('profileBadge');
  const profName = document.getElementById('profName');
  if(badge && profName){ profName.textContent = `${u.name} (${u.phone})`; badge.style.display = 'inline-flex'; }
  // alt bilgi
  const info = document.getElementById('loginInfo');
  if(info) info.textContent = `Giri≈ü yapƒ±ldƒ±: ${u.name} (${u.phone})`;
  // beni hatƒ±rla
  remember ? store.set('currentUserId',u.id) : store.del('currentUserId');
  loadMyAppts();
}
function clearCurrentUser(){
  currentUser=null;
  // profil rozetini gizle
  const badge = document.getElementById('profileBadge'); if(badge) badge.style.display = 'none';
  // login panelini tekrar g√∂ster ve login sekmesine d√∂n
  const loginBox = document.querySelector('.login'); if(loginBox) loginBox.style.display = 'block';
  const info = document.getElementById('loginInfo'); if(info) info.textContent = '';
  store.del('currentUserId');
  const authLoginTab = document.querySelector('.auth-tab[data-auth="login"]'); if(authLoginTab){ authLoginTab.click(); }
}

document.getElementById('registerBtn').addEventListener('click',()=>{
  const name=($('#r_name').value||'').trim(), phone=normPhone($('#r_phone').value), pin=($('#r_pin').value||'').trim();
  if(!name||!phone||pin.length!==4){ alert('Ad, telefon ve 4 haneli PIN gerekli.'); return; }
  if(findByPhone(phone)){ alert('Bu telefon ile kayƒ±t var. Giri≈ü yapmayƒ± deneyin.'); return; }
  const u={id:uuid(),name,phone,pin}; const list=users(); list.push(u); saveUsers(list);
  setCurrentUser(u,true);
  alert('Kayƒ±t tamam. Giri≈ü yapƒ±ldƒ±.');
});

document.getElementById('loginBtn').addEventListener('click',()=>{
  const phone=normPhone($('#l_phone').value), pin=($('#l_pin').value||'').trim();
  if(!phone||pin.length!==4){ alert('Telefon ve 4 haneli PIN gerekli.'); return; }
  const u=findByPhone(phone);
  if(!u||u.pin!==pin){ alert('Telefon veya PIN hatalƒ±.'); return; }
  setCurrentUser(u,$('#l_remember').checked);
  alert('Giri≈ü ba≈üarƒ±lƒ±.');
});

document.getElementById('switchBtn').addEventListener('click',()=>{
  clearCurrentUser();
  alert('Hesap deƒüi≈ütirildi. Yeni m√º≈üteri giri≈ü/kayƒ±t yapabilir.');
});

// Otomatik login
(function(){ const id=store.get('currentUserId',null); if(!id) return; const u=users().find(x=>x.id===id); if(u) setCurrentUser(u,true); })();

/* ≈ûifremi Unuttum? ‚Üí PIN sƒ±fƒ±rlama talebi */
document.getElementById('forgotPinBtn').addEventListener('click',()=>{
  const phone=prompt('Telefon numaran (5xx...):'); if(!phone) return;
  const u=findByPhone(phone); if(!u){ alert('Bu telefonla kayƒ±t bulunamadƒ±.'); return; }
  const newPin=prompt('Yeni PIN (4 hane):'); if(!newPin || newPin.length!==4){ alert('4 haneli PIN giriniz.'); return; }
  const reqs=store.get('resetReqs',[]); reqs.push({id:uuid(), phone:normPhone(phone), newPin, createdAt:Date.now()});
  store.set('resetReqs',reqs);
  updateBell(); // √ßanda g√∂r√ºns√ºn
  alert('PIN sƒ±fƒ±rlama talebin alƒ±ndƒ±. Y√∂netici onaylayƒ±nca aktif olur.');
});

/* Ayar i≈ülemleri (admin) */
document.getElementById('saveSettings')?.addEventListener('click',()=>{
  if(!requireAdmin()) return;
  const s=store.get('settings'); s.open=$('#openTime').value; s.close=$('#closeTime').value; s.slot=parseInt($('#slotSize').value||15,10);
  const pwd=$('#adminPwdInput').value.trim(); if(pwd) s.adminPwd=pwd; store.set('settings',s);
  $('#adminPwdInput').value=''; $('#settingsStatus').textContent='Kaydedildi.'; refreshSettingsUI(); renderSlots();
});
document.getElementById('addStaff')?.addEventListener('click',()=>{
  if(!requireAdmin()) return; const n=$('#newStaffName').value.trim(); if(!n) return;
  const list=store.get('staff',[]); list.push({id:uuid(),name:n}); store.set('staff',list);
  $('#newStaffName').value=''; renderStaffUI(); renderSlots();
});
document.getElementById('addSvc')?.addEventListener('click',()=>{
  if(!requireAdmin()) return;
  const n=$('#newSvcName').value.trim(), d=parseInt($('#newSvcDur').value||0,10), p=parseInt($('#newSvcPrice').value||0,10);
  if(!n||!d||!p){ alert('Hizmet adƒ±, s√ºre ve fiyat gerekli.'); return; }
  const list=store.get('services',[]); list.push({id:uuid(),name:n,dur:d,price:p}); store.set('services',list);
  $('#newSvcName').value=''; $('#newSvcDur').value=''; $('#newSvcPrice').value=''; renderSvcUI(); renderSlots();
});
window.delStaff=(id)=>{ if(!requireAdmin()) return; const list=store.get('staff',[]).filter(s=>s.id!==id); store.set('staff',list); renderStaffUI(); renderSlots(); }
window.delSvc=(id)=>{ if(!requireAdmin()) return; const list=store.get('services',[]).filter(s=>s.id!==id); store.set('services',list); renderSvcUI(); renderSlots(); }

/* Admin giri≈ü + masa√ºst√º bildirim izni */
document.getElementById('adminLogin').addEventListener('click',()=>{
  const pass=$('#adminPass').value.trim();
  if(pass===store.get('settings').adminPwd){
    adminAuthed=true; $('#adminArea').style.display='block'; $('#adminStatus').textContent='Giri≈ü ba≈üarƒ±lƒ±.';
    renderQueue(); renderResets(); renderCal(); renderAdminSelects(); refreshSettingsUI(); renderStaffUI(); renderSvcUI();
  } else $('#adminStatus').textContent='≈ûifre hatalƒ±.';
});
document.getElementById('enableNotif').addEventListener('click',()=>{
  if(!("Notification" in window)){ alert('Tarayƒ±cƒ± bildirimini desteklemiyor.'); return; }
  Notification.requestPermission().then(p=>{ alert(p==='granted'?'Bildirimler a√ßƒ±k.':'ƒ∞zin verilmedi.'); });
});
function renderAdminSelects(){ const staff=store.get('staff',[]); $('#calStaff')&&($('#calStaff').innerHTML=`<option value="">T√ºm√º</option>`+staff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')); }

/* Slotlar */
function overlaps(aS,aE,bS,bE){return aS<bE && aE>bS}
function conflicts(date,staffId){
  return store.get('appts',[]).filter(a=>a.date===date && a.staffId===staffId && a.status!=='cancelled' && a.status!=='rejected')
  .map(a=>({start:toMin(a.time),end:toMin(a.time)+a.duration}));
}
function blocks(date,staffId){
  return store.get('blocks',[]).filter(b=>b.date===date && b.staffId===staffId).map(b=>({start:toMin(b.start),end:toMin(b.end)}));
}
function renderSlots(){
  const s=store.get('settings'); $('#hoursLabel')&&($('#hoursLabel').textContent=`${s.open} - ${s.close}`); $('#slotSizeLabel')&&($('#slotSizeLabel').textContent=s.slot);
  const open=toMin(s.open), close=toMin(s.close), step=s.slot;
  const staffId=$('#staff')?.value; const svcId=$('#svc')?.value; const svc=store.get('services',[]).find(x=>x.id===svcId); const dur=svc?svc.dur:step;
  const date=$('#date')?.value; const taken=conflicts(date,staffId); const bl=blocks(date,staffId);
  const box=$('#slots'); if(!box) return; box.innerHTML='';
  for(let t=open; t+dur<=close; t+=step){
    const disabled = taken.some(x=>overlaps(t,t+dur,x.start,x.end)) || bl.some(x=>overlaps(t,t+dur,x.start,x.end));
    const b=document.createElement('button'); b.type='button'; b.className='slot'+(disabled?' dis':''); b.textContent=toHHMM(t); b.dataset.time=toHHMM(t);
    const pick=()=>{ if(disabled) return; $$('.slot').forEach(x=>{x.classList.remove('sel'); x.setAttribute('aria-pressed','false');}); b.classList.add('sel'); b.setAttribute('aria-pressed','true'); b.scrollIntoView({inline:'center',block:'nearest',behavior:'smooth'}); };
    b.addEventListener('click', pick, {passive:true}); b.addEventListener('touchstart', pick, {passive:true});
    box.appendChild(b);
  }
  const first = Array.from(box.querySelectorAll('.slot:not(.dis)'))[0];
  if(first && !box.querySelector('.slot.sel')){ first.classList.add('sel'); first.setAttribute('aria-pressed','true'); }
}
['#svc','#staff','#date'].forEach(sel=>{ $(sel)?.addEventListener('change',renderSlots); });
document.addEventListener('click',(e)=>{ const c=$('#slots'); if(!c) return; if(e.target?.id==='slotPrev') c.scrollBy({left:-200,behavior:'smooth'}); if(e.target?.id==='slotNext') c.scrollBy({left:200,behavior:'smooth'}); });

/* Randevu */
document.getElementById('makeAppt').addEventListener('click',()=>{
  if(!currentUser){ $('#makeStatus').textContent='Randevu olu≈üturmak i√ßin √∂nce giri≈ü yapƒ±n.'; return; }
  const svc=store.get('services',[]).find(x=>x.id===$('#svc').value);
  const staff=store.get('staff',[]).find(x=>x.id===$('#staff').value);
  const timeBtn=$('.slot.sel'); if(!timeBtn){ $('#makeStatus').textContent='Saat se√ßiniz.'; return; }
  const date=$('#date').value, time=timeBtn.dataset.time, duration=svc.dur;
  const taken=conflicts(date, staff.id); const bl=blocks(date, staff.id);
  if(taken.some(x=>overlaps(toMin(time),toMin(time)+duration,x.start,x.end))||bl.some(x=>overlaps(toMin(time),toMin(time)+duration,x.start,x.end))){
    $('#makeStatus').textContent='Bu saat doldu.'; renderSlots(); return;
  }
  const appts=store.get('appts',[]);
  appts.push({id:uuid(), userId:currentUser.id, name:currentUser.name, phone:currentUser.phone,
              serviceId:svc.id, serviceName:svc.name, staffId:staff.id, staffName:staff.name,
              date, time, duration, status:'pending', createdAt:Date.now()});
  store.set('appts',appts);
  $('#makeStatus').textContent='Randevu olu≈üturuldu (onay bekliyor).';
  loadMyAppts(); renderSlots(); updateBell(); adminNotify(`Yeni randevu: ${date} ${time} ‚Ä¢ ${svc.name} ‚Ä¢ ${currentUser.name}`);
});

/* WhatsApp (opsiyonel √∂nizleme) */
document.getElementById('waPreview').addEventListener('click',()=>{
  const staffName=store.get('staff',[]).find(s=>s.id===$('#staff').value)?.name||'';
  const svc=store.get('services',[]).find(x=>x.id===$('#svc').value);
  const msg=`Ahmet Tekeli Erkek Kuaf√∂r√º randevu talebi: ${$('#date').value} ${$('.slot.sel')?$('.slot.sel').dataset.time:''} - ${svc?svc.name:''} - ${staffName}`;
  const phone=currentUser?.phone || '905XXXXXXXXX';
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,'_blank');
});

/* Randevularƒ±m */
function loadMyAppts(){
  const tb=$('#myApptTbody'); if(!tb||!currentUser) return; tb.innerHTML='';
  const rows=store.get('appts',[]).filter(a=>a.userId===currentUser.id).sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  rows.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.date}</td><td>${a.time}</td><td>${a.serviceName}</td><td>${a.staffName||''}</td><td>${a.status}</td>
    <td><button class="btn" onclick="resched('${a.id}')">Saat Deƒüi≈ütir</button> <button class="btn" onclick="cancelAppt('${a.id}')">ƒ∞ptal</button></td>`;
    tb.appendChild(tr);
  });
}
window.cancelAppt=(id)=>{ const appts=store.get('appts',[]); const a=appts.find(x=>x.id===id); if(!a) return; a.status='cancelled'; store.set('appts',appts); loadMyAppts(); renderSlots(); };
window.resched=(id)=>{
  const appts=store.get('appts',[]); const a=appts.find(x=>x.id===id); if(!a) return;
  const s=store.get('settings'); const open=toMin(s.open), close=toMin(s.close), step=s.slot;
  const taken=conflicts(a.date,a.staffId).filter(x=>!(x.start===toMin(a.time) && x.end===toMin(a.time)+a.duration));
  let opts=[]; for(let t=open; t+a.duration<=close; t+=step){ if(!taken.some(x=>overlaps(t,t+a.duration,x.start,x.end))) opts.push(toHHMM(t)); }
  const pick=prompt(`Yeni saat (${opts.slice(0,20).join(', ')})`, opts[0]||a.time); if(!pick) return; a.time=pick; a.status='pending'; store.set('appts',appts); loadMyAppts(); renderSlots();
};

/* Admin ‚Äì Randevu ve Reset Kuyruƒüu */
document.getElementById('refreshAdmin').addEventListener('click',()=>{renderQueue(); renderResets(); renderCal(); updateBell();});
function renderQueue(){
  const tb=$('#queueTbody'); if(!tb) return; tb.innerHTML='';
  const rows=store.get('appts',[]).filter(a=>a.status==='pending').sort((a,b)=>a.date.localeCompare(b.date)||a.time.localeCompare(b.time));
  rows.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.name}</td><td>${a.phone}</td><td>${a.date}</td><td>${a.time}</td><td>${a.serviceName}</td><td>${a.staffName||''}</td><td>${a.duration} dk</td>
    <td><button class="btn" onclick="approve('${a.id}')">Onayla</button> <button class="btn" onclick="reject('${a.id}')">Reddet</button></td>`;
    tb.appendChild(tr);
  });
}
function renderResets(){
  const tb=$('#resetTbody'); if(!tb) return; tb.innerHTML='';
  const rows=store.get('resetReqs',[]).sort((a,b)=>a.createdAt-b.createdAt);
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.phone}</td><td>${r.newPin}</td>
    <td><button class="btn" onclick="approveReset('${r.id}')">Onayla</button> <button class="btn" onclick="rejectReset('${r.id}')">Sil</button></td>`;
    tb.appendChild(tr);
  });
}

window.approve=(id)=>{
  if(!requireAdmin()) return;
  const appts=store.get('appts',[]); const a=appts.find(x=>x.id===id); if(!a) return;
  const conf=appts.some(x=>x.id!==a.id && x.date===a.date && x.staffId===a.staffId && x.status!=='cancelled' && x.status!=='rejected' && (toMin(a.time)<toMin(x.time)+x.duration && toMin(a.time)+a.duration>toMin(x.time)));
  if(conf){ alert('Bu saat √ßakƒ±≈üƒ±yor.'); return; }
  a.status='approved'; store.set('appts',appts); renderQueue(); renderCal(); updateBell();
};
window.reject=(id)=>{ if(!requireAdmin()) return; const appts=store.get('appts',[]); const a=appts.find(x=>x.id===id); if(!a) return; a.status='rejected'; store.set('appts',appts); renderQueue(); renderCal(); updateBell(); };

window.approveReset=(id)=>{
  if(!requireAdmin()) return;
  const reqs=store.get('resetReqs',[]); const r=reqs.find(x=>x.id===id); if(!r) return;
  const us=users(); const u=us.find(x=>x.phone===r.phone); if(!u){ alert('Kullanƒ±cƒ± bulunamadƒ±.'); return; }
  u.pin=r.newPin; saveUsers(us);
  store.set('resetReqs', reqs.filter(x=>x.id!==id));
  renderResets(); alert(`PIN g√ºncellendi: ${r.phone}`);
};
window.rejectReset=(id)=>{ if(!requireAdmin()) return; const reqs=store.get('resetReqs',[]).filter(x=>x.id!==id); store.set('resetReqs',reqs); renderResets(); };

/* Admin ‚Äì G√ºnl√ºk Takvim */
document.getElementById('viewCal').addEventListener('click', renderCal);
function renderCal(){
  const tb=$('#calTbody'); if(!tb) return; tb.innerHTML='';
  const date=$('#calDate')?.value||todayISO(); const staffId=$('#calStaff')?.value;
  const rows=store.get('appts',[]).filter(a=>a.date===date && (!staffId || a.staffId===staffId) && a.status!=='rejected').sort((a,b)=>a.time.localeCompare(b.time));
  rows.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.time} (${a.duration}')</td><td>${a.name}</td><td>${a.serviceName} / ${a.staffName||''}</td><td>${a.status}</td>
    <td>${a.status!=='cancelled'?`<button class="btn" onclick="cancelAdmin('${a.id}')">ƒ∞ptal</button>`:''}</td>`;
    tb.appendChild(tr);
  });
}
window.cancelAdmin=(id)=>{ if(!requireAdmin()) return; const appts=store.get('appts',[]); const a=appts.find(x=>x.id===id); if(!a) return; a.status='cancelled'; store.set('appts',appts); renderCal(); updateBell(); };

/* √áan ‚Äì sayƒ±yƒ± g√ºncelle + admin masa√ºst√º bildirimi + ses */
function getPendingCount(){ try{ return (store.get('appts',[])||[]).filter(a=>a.status==='pending').length + (store.get('resetReqs',[])||[]).length; }catch(e){ return 0; } }
function updateBell(){ const n=getPendingCount(); const badge=$('#notifyCount'); if(!badge) return; badge.textContent=String(n); }
function adminNotify(text){
  updateBell();
  try{ document.getElementById('ding').currentTime=0; document.getElementById('ding').play().catch(()=>{});}catch(e){}
  if("Notification" in window && Notification.permission==='granted'){
    new Notification('Yeni Bildirim', { body: text });
  }
}
document.getElementById('notifyBell').addEventListener('click',()=>{
  const adminTab = Array.from(document.querySelectorAll('.tab')).find(t=>t.dataset.target==="#admin");
  if(adminTab) adminTab.click();
  setTimeout(()=>{ document.getElementById('queueTbody')?.scrollIntoView({behavior:'smooth',block:'start'}); }, 100);
});
document.addEventListener('DOMContentLoaded', ()=>{ refreshSettingsUI(); renderSlots(); updateBell(); });

/* Payla≈ü butonu */
document.getElementById('shareBtn').addEventListener('click', async ()=>{
  const url = location.href;
  if(navigator.share){
    try{ await navigator.share({title:'Ahmet Tekeli Erkek Kuaf√∂r√º', text:'Randevu olu≈üturmak i√ßin tƒ±klayƒ±n', url}); }catch(e){}
  }else{
    try{
      await navigator.clipboard.writeText(url);
      alert('Baƒülantƒ± kopyalandƒ±: ' + url);
    }catch(e){
      prompt('Baƒülantƒ±yƒ± kopyalayƒ±n:', url);
    }
  }
});
</script>
</body>
</html>
