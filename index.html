<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AŞKIM ERKEK KUAFÖRÜ — Randevu</title>
<meta name="theme-color" content="#121416">
<style>
:root{--bg:#121416;--glass:#1b1f24cc;--line:#3a4048;--txt:#f2f4f7;--mut:#b3b9c5;--gold1:#c38b3a;--gold2:#dfb572;--input:#0f1317}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:#0e1115;color:var(--txt);font:500 15px/1.6 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.bg{position:fixed;inset:0;z-index:-2;background:url('data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%201400%20900%27%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3CradialGradient%20id%3D%27g1%27%20cx%3D%2730%25%27%20cy%3D%2725%25%27%20r%3D%2760%25%27%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%270%27%20stop-color%3D%27%23f1d6a1%27%20stop-opacity%3D%27.35%27/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%271%27%20stop-color%3D%27%230e1115%27%20stop-opacity%3D%271%27/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%20%20%3CradialGradient%20id%3D%27g2%27%20cx%3D%2780%25%27%20cy%3D%2760%25%27%20r%3D%2770%25%27%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%270%27%20stop-color%3D%27%23dfb572%27%20stop-opacity%3D%27.28%27/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%271%27%20stop-color%3D%27%230e1115%27%20stop-opacity%3D%271%27/%3E%0A%20%20%20%20%3C/radialGradient%3E%0A%20%20%20%20%3ClinearGradient%20id%3D%27stripes%27%20x1%3D%270%27%20y1%3D%270%27%20x2%3D%271%27%20y2%3D%271%27%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%270%27%20stop-color%3D%27%23ffffff%27%20stop-opacity%3D%27.035%27/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%27.5%27%20stop-color%3D%27%23ffffff%27%20stop-opacity%3D%27.02%27/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%271%27%20stop-color%3D%27%23ffffff%27%20stop-opacity%3D%27.01%27/%3E%0A%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3Cfilter%20id%3D%27blur%27%20x%3D%27-20%25%27%20y%3D%27-20%25%27%20width%3D%27140%25%27%20height%3D%27140%25%27%3E%0A%20%20%20%20%20%20%3CfeGaussianBlur%20stdDeviation%3D%2720%27/%3E%0A%20%20%20%20%3C/filter%3E%0A%20%20%3C/defs%3E%0A%20%20%3Crect%20width%3D%27100%25%27%20height%3D%27100%25%27%20fill%3D%27%230e1115%27/%3E%0A%20%20%3Crect%20width%3D%27100%25%27%20height%3D%27100%25%27%20fill%3D%27url%28%23g1%29%27/%3E%0A%20%20%3Crect%20width%3D%27100%25%27%20height%3D%27100%25%27%20fill%3D%27url%28%23g2%29%27/%3E%0A%20%20%3Cg%20filter%3D%27url%28%23blur%29%27%3E%0A%20%20%20%20%3Ccircle%20cx%3D%27260%27%20cy%3D%27180%27%20r%3D%27180%27%20fill%3D%27%23c38b3a%27%20opacity%3D%27.18%27/%3E%0A%20%20%20%20%3Ccircle%20cx%3D%271180%27%20cy%3D%27620%27%20r%3D%27240%27%20fill%3D%27%23dfb572%27%20opacity%3D%27.16%27/%3E%0A%20%20%20%20%3Ccircle%20cx%3D%27760%27%20cy%3D%27220%27%20r%3D%27130%27%20fill%3D%27%23cfa76a%27%20opacity%3D%27.12%27/%3E%0A%20%20%3C/g%3E%0A%20%20%3Cg%20opacity%3D%27.25%27%3E%0A%20%20%20%20%3Crect%20x%3D%27-200%27%20y%3D%27-200%27%20width%3D%272200%27%20height%3D%271400%27%20fill%3D%27url%28%23stripes%29%27%20transform%3D%27rotate%28-18%20700%20450%29%27/%3E%0A%20%20%3C/g%3E%0A%20%20%3Crect%20width%3D%27100%25%27%20height%3D%27100%25%27%20fill%3D%27%230e1115%27%20opacity%3D%27.18%27/%3E%0A%3C/svg%3E') center/cover no-repeat;filter:blur(4px)}
.overlay{position:fixed;inset:0;z-index:-1;background:linear-gradient(180deg,rgba(18,20,22,.70),rgba(18,20,22,.85))}
.admin{position:fixed;right:18px;top:18px;background:#fff;color:#111;padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;font-weight:700;cursor:pointer}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50;padding:18px}
.box{max-width:860px;width:100%;background:#0e1115;border:1px solid #2b3139;border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
.box h3{margin:0 0 10px}
.table{border:1px solid #2b3139;border-radius:12px;overflow:hidden}
.th,.tr{display:grid;grid-template-columns:150px 90px 110px 120px 1fr 72px;gap:8px;align-items:center}
.th div{font-size:12px;color:#cdd3dc;background:#12161b;padding:8px 10px;border-bottom:1px solid #2b3139;font-weight:800}
.tr div{padding:8px 10px;border-bottom:1px dashed #2b3139}
.tr:last-child div{border-bottom:none}
.actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.a-btn{padding:10px 12px;border-radius:10px;border:1px solid #2b3139;background:#0f1317;color:#fff;cursor:pointer;font-weight:800}
.a-btn.gold{background:linear-gradient(90deg,var(--gold1),var(--gold2));border:none;color:#111}
.card{max-width:760px;margin:70px auto 24px;padding:22px;border-radius:22px;border:1px solid #ffffff33;background:var(--glass);backdrop-filter:blur(16px);box-shadow:0 24px 70px rgba(0,0,0,.38);border-top:1px solid #ffffff30;border-left:1px solid #ffffff25}
.header{display:flex;flex-direction:column;align-items:center;margin-top:-56px}
.logo{width:92px;height:92px;border-radius:999px;background:#fff url('data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%2064%2064%27%3E%0A%20%20%3Cdefs%3E%3ClinearGradient%20id%3D%27g%27%20x1%3D%270%27%20y1%3D%270%27%20x2%3D%271%27%20y2%3D%271%27%3E%0A%20%20%20%20%3Cstop%20offset%3D%270%27%20stop-color%3D%27%23c38b3a%27/%3E%3Cstop%20offset%3D%271%27%20stop-color%3D%27%23dfb572%27/%3E%0A%20%20%3C/linearGradient%3E%3C/defs%3E%0A%20%20%3Ccircle%20cx%3D%2720%27%20cy%3D%2722%27%20r%3D%278%27%20fill%3D%27none%27%20stroke%3D%27url%28%23g%29%27%20stroke-width%3D%275%27/%3E%0A%20%20%3Ccircle%20cx%3D%2744%27%20cy%3D%2722%27%20r%3D%278%27%20fill%3D%27none%27%20stroke%3D%27url%28%23g%29%27%20stroke-width%3D%275%27/%3E%0A%20%20%3Cpath%20d%3D%27M12%2050%20L52%2030%27%20stroke%3D%27url%28%23g%29%27%20stroke-width%3D%276%27%20stroke-linecap%3D%27round%27/%3E%0A%20%20%3Cpath%20d%3D%27M12%2030%20L52%2050%27%20stroke%3D%27url%28%23g%29%27%20stroke-width%3D%276%27%20stroke-linecap%3D%27round%27/%3E%0A%3C/svg%3E') center/70% no-repeat;box-shadow:0 10px 30px rgba(0,0,0,.4)}
h1{margin:12px 0 2px;font-size:28px;letter-spacing:.6px;font-weight:900}
.sub{color:#d0d5dd;font-weight:800;letter-spacing:.2px}
hr.sep{height:0;border:none;border-top:1px solid #ffffff26;margin:18px 0}
label{display:block;font-size:13px;color:#c8ced8;margin:8px 0 6px;font-weight:800}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #2c323a;background:var(--input);color:var(--txt)}
input::placeholder{color:#93a0b2}
select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#8fa0b7 50%),linear-gradient(135deg,#8fa0b7 50%,transparent 50%);background-position:calc(100% - 18px) calc(50% + 2px), calc(100% - 12px) calc(50% + 2px);background-size:6px 6px; background-repeat:no-repeat}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:540px){.grid{grid-template-columns:1fr}}
.slotbox{margin-top:8px;border:1px solid var(--line);border-radius:14px;background:#0e1216aa;padding:12px}
.slotmsg{color:#cbd4df}
.cta{margin-top:18px}
.btn{width:100%;padding:14px 18px;border:none;border-radius:16px;color:#fff;font-weight:900;letter-spacing:.4px;cursor:pointer;background:linear-gradient(90deg,var(--gold1),var(--gold2));box-shadow:0 10px 24px rgba(196,145,69,.35)}
.btn:active{transform:translateY(1px)}
.time{padding:10px 0;border:1px solid #2c323a;border-radius:10px;background:#0f1317;color:#fff;font-weight:800;cursor:pointer;text-align:center;font-size:14px}
.time.active{outline:3px solid var(--gold2)}
.time.disabled{opacity:.45;filter:grayscale(1) blur(.2px);pointer-events:none;position:relative}
.time.disabled::after{content:'DOLU';position:absolute;inset:auto 6px 6px auto;font-size:10px;color:#bcc3cf;}
.credits{opacity:.8;text-align:center;margin-top:14px;color:#cad3df;font-size:12px}
.group{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.legend{display:flex;gap:8px;align-items:center;margin:6px 0 0 0;font-size:12px;color:#cbd4df}
.legend span{display:inline-block;width:14px;height:14px;border-radius:4px;border:1px solid #2c323a;background:#0f1317}
.legend .sel{outline:2px solid var(--gold2)}

.settings{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0 6px 0}
.settings .full{grid-column:1 / -1}
.settings input,.settings textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3139;background:#0f1317;color:#fff}
.settings small{color:#9aa6b2}

.switches{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:6px}
.chk{display:flex;gap:6px;align-items:center;background:#0f1317;border:1px solid #2b3139;border-radius:10px;padding:8px 10px}
.chk input{accent-color:#dfb572}
.badge{display:inline-block;padding:6px 8px;border:1px solid #2b3139;border-radius:10px;background:#0f1317;color:#cbd4df;margin-left:6px}
.kapali{color:#f3b7b7}

.userbox{max-width:520px;width:100%;background:#0e1115;border:1px solid #2b3139;border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
.tabs{display:flex;gap:8px;margin-bottom:10px}
.tab{padding:8px 12px;border-radius:10px;border:1px solid #2b3139;background:#0f1317;color:#cbd4df;cursor:pointer}
.tab.active{background:linear-gradient(90deg,var(--gold1),var(--gold2));color:#111;border:none;font-weight:800}
.uf{display:grid;gap:10px}
.uf input{width:100%;padding:12px;border-radius:12px;border:1px solid #2c323a;background:#0f1317;color:#f2f4f7}
.user-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.list{border:1px solid #2b3139;border-radius:12px;margin-top:10px}
.item{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 100px;gap:8px;align-items:center;padding:8px;border-bottom:1px dashed #2b3139}
.item:last-child{border-bottom:none}
.badge-ok{display:inline-block;padding:2px 8px;border-radius:999px;background:#19331a;color:#b9f7b6;border:1px solid #295b2c;font-size:12px}

.bokeh{position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:.35;
  background:
    radial-gradient(220px 220px at 15% 20%, rgba(255,255,255,.28), rgba(255,255,255,0) 60%),
    radial-gradient(260px 260px at 85% 30%, rgba(255,210,140,.22), rgba(255,255,255,0) 60%),
    radial-gradient(240px 240px at 70% 80%, rgba(255,240,200,.18), rgba(255,255,255,0) 60%),
    radial-gradient(180px 180px at 35% 75%, rgba(255,255,255,.2), rgba(255,255,255,0) 60%);
  filter: blur(10px);
  animation: drift 28s ease-in-out infinite alternate;
}
@keyframes drift{
  0%{transform:translate3d(0,0,0) scale(1); opacity:.30;}
  50%{transform:translate3d(-10px,8px,0) scale(1.03); opacity:.36;}
  100%{transform:translate3d(8px,-12px,0) scale(1.06); opacity:.40;}
}


.controls{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px}
@media(max-width:900px){.controls{grid-template-columns:1fr 1fr}}
@media(max-width:520px){.controls{grid-template-columns:1fr}}
.controls label{font-size:12px;color:#c8ced8;margin:0 0 4px 2px;font-weight:800}
.strip{display:flex;gap:8px;overflow-x:auto;padding:8px;border:1px solid #2c323a;border-radius:12px;background:#0f1317}
.chip{padding:8px 10px;border-radius:10px;border:1px solid #2c323a;background:#151a20;color:#e7ecf3;font-weight:800;cursor:pointer;white-space:nowrap;font-size:14px}
.chip.active{outline:3px solid var(--gold2)}
.chip.disabled{opacity:.45;filter:grayscale(1);pointer-events:none;position:relative}
.chip.disabled::after{content:'DOLU';position:absolute;right:6px;bottom:4px;font-size:10px;color:#cbd4df}
.chip .avail{font-size:11px;opacity:.85;margin-left:6px}
.section{margin-top:10px}

</style>
</head>
<body>
<div class="bg"></div><div class="overlay"></div><div class="bokeh"></div>
<button class="admin" id="adminBtn" style="right:130px">Admin Girişi</button>
<button class="admin" id="userBtn">Müşteri Girişi</button>
<main class="card">
  <div class="header">
    <div class="logo"></div>
    <h1>AŞKIM ERKEK KUAFÖRÜ</h1>
    <div class="sub">ERKEK KUAFÖRÜ</div>
  </div>
  <hr class="sep">
  <div class="controls">
    <div>
      <label>Berber</label>
      <select id="staff">
        <option value="">Farketmez</option>
        <option>Ahmet</option>
        <option>Aziz</option>
        <option>Usta</option>
      </select>
    </div>
    <div>
      <label>Hizmet</label>
      <select id="service">
        <option value="">Hizmet seçin</option>
        <option value="Saç" data-min="30">Saç</option>
        <option value="Sakal" data-min="20">Sakal</option>
        <option value="Saç + Sakal" data-min="45">Saç + Sakal</option>
      </select>
    </div>
    <div>
      <label>Tarih</label>
      <input id="date" type="date">
    </div>
    <div>
      <label>Saat</label>
      <div id="timestrip" class="strip"></div>
    </div>
  </div>
  <div class="section">
    <label>Ad Soyad</label>
    <input id="name" placeholder="Adınız ve Soyadınız">
  </div>
  <div class="section">
    <label>Telefon</label>
    <input id="phone" placeholder="05xxxxxxxxx">
  </div>
  <div class="cta"><button class="btn" id="bookBtn" type="button">RANDEVU AL</button></div>
  <div class="credits">Designed by Aşkım Erkek Kuaförü</div>
</main>

<section class="modal" id="userModal" aria-hidden="true">
  <div class="userbox">
    <h3>👤 Müşteri Hesabı</h3>
    <div class="tabs">
      <button class="tab active" id="tabLogin">Giriş</button>
      <button class="tab" id="tabRegister">Kayıt Ol</button>
      <div style="margin-left:auto" id="loggedInfo"></div>
    </div>
    <div id="loginPane">
      <div class="uf">
        <input id="uLogin" placeholder="Kullanıcı adı">
        <input id="pLogin" type="password" placeholder="Şifre">
        <button class="a-btn gold" id="doLogin">Giriş Yap</button>
      </div>
    </div>
    <div id="registerPane" style="display:none">
      <div class="uf">
        <input id="uReg" placeholder="Kullanıcı adı">
        <input id="pReg" type="password" placeholder="Şifre">
        <input id="phReg" placeholder="Telefon (05xxxxxxxxx)">
        <button class="a-btn gold" id="doRegister">Kayıt Ol</button>
      </div>
    </div>
    <div id="accountPane" style="display:none">
      <div class="user-actions">
        <span>Durum: <span class="badge-ok">Giriş yapıldı</span></span>
        <button class="a-btn" id="logoutBtn">Çıkış</button>
      </div>
      <h4 style="margin:10px 0 6px 0">Randevularım</h4>
      <div class="list" id="myBookings"></div>
    </div>
    <div class="actions" style="margin-top:12px">
      <button class="a-btn" id="closeUser">Kapat</button>
    </div>
  </div>
</section>

<section class="modal" id="adminModal" aria-hidden="true">
  <div class="box">
    <h3>⚙️ Admin Paneli <span id="pinInfo" style="font-size:12px;color:#9aa6b2">PIN: 2525</span></h3>
    <div class="settings">
      <div>
        <label>Açılış (HH:MM)</label>
        <input id="setStart" placeholder="09:00" value="09:00">
      </div>
      <div>
        <label>Kapanış (HH:MM)</label>
        <input id="setEnd" placeholder="21:00" value="21:00">
      </div>
      <div>
        <label>Adım (dakika)</label>
        <input id="setStep" type="number" min="5" step="5" placeholder="30" value="30">
      </div>
      <div>
        <label>Berberler</label>
        <input id="setBarbers" placeholder="Ahmet, Aziz, Usta" value="Ahmet, Aziz, Usta">
      </div>
      <div class="full">
        <label>Haftalık Kapalı Günler</label>
        <div class="switches">
          <label class="chk"><input type="checkbox" id="cw1"> Pzt</label>
          <label class="chk"><input type="checkbox" id="cw2"> Sal</label>
          <label class="chk"><input type="checkbox" id="cw3"> Çar</label>
          <label class="chk"><input type="checkbox" id="cw4"> Per</label>
          <label class="chk"><input type="checkbox" id="cw5"> Cum</label>
          <label class="chk"><input type="checkbox" id="cw6"> Cmt</label>
          <label class="chk"><input type="checkbox" id="cw0"> Paz</label>
        </div>
      </div>
      <div class="full">
        <label>Kapalı Tarihler (virgülle ayır, YYYY-MM-DD)</label>
        <input id="setClosedDates" placeholder="2025-01-01, 2025-04-23">
        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="a-btn" id="closeToday">Bugünü Kapalı Yap</button>
          <button class="a-btn" id="openToday">Bugünü Aç</button>
          <span class="badge">Bugün: <span id="todayBadge"></span></span>
        </div>
      </div>
      <div class="full">
        <button class="a-btn gold" id="saveSettings">Ayarları Kaydet</button>
        <button class="a-btn" id="resetSettings">Varsayılan Yap</button>
        <small>Bu ayarlar cihazınızda saklanır ve hemen uygulanır.</small>
      </div>
    </div>
    <div class="table" id="tableWrap">
      <div class="th"><div>Tarih</div><div>Saat</div><div>Berber</div><div>Hizmet</div><div>Müşteri</div><div>İşlem</div></div>
      <div id="rows"></div>
    </div>
    <div class="actions">
      <button class="a-btn gold" id="exportBtn">Dışa Aktar (.json)</button>
      <label class="a-btn" for="importFile">İçe Aktar</label><input id="importFile" type="file" accept="application/json" style="display:none">
      <button class="a-btn" id="clearBtn">Tümünü Sil</button>
      <button class="a-btn" id="closeAdmin">Kapat</button>
    </div>
  </div>
</section>
<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const KEY='askim_bookings_v4', PIN='2525', SKEY='askim_settings_v1';
document.getElementById('date').value = new Date().toISOString().slice(0,10);
function load(){ try { return JSON.parse(localStorage.getItem(KEY))||[]; } catch(e) { return []; } }
function save(list){ localStorage.setItem(KEY, JSON.stringify(list)); }
function getSettings(){
  const d={start:'09:00', end:'21:00', step:30, barbers:['Ahmet','Aziz','Usta'], closedWeek:[], closedDates:[]};
  try{ const s=JSON.parse(localStorage.getItem(SKEY)); return Object.assign(d, s||{}); }catch(e){ return d; }
}
function setSettings(s){ localStorage.setItem(SKEY, JSON.stringify(s)); }
function applyBarbers(){
  const s=getSettings();
  const sel=document.getElementById('staff');
  const cur=sel.value;
  sel.innerHTML='';
  // First "Farketmez"
  const opt=document.createElement('option'); opt.value=''; opt.textContent='Farketmez'; sel.appendChild(opt);
  s.barbers.forEach(name=>{ const o=document.createElement('option'); o.textContent=name.trim(); o.value=name.trim(); sel.appendChild(o); });
  // keep previous if still exists
  if([...sel.options].some(o=>o.value===cur)) sel.value=cur;
}

function buildSlots(){
  const date=document.getElementById('date').value || new Date().toISOString().slice(0,10);
  const root=document.getElementById('timestrip'); root.innerHTML='';
  const SS=getSettings?getSettings():{start:'09:00',end:'21:00',step:30};
  const START=SS.start, END=SS.end, STEP=parseInt(SS.step||30,10);
  const staffSel=(document.getElementById('staff').value||'').trim();
  const bookings = (typeof load==='function'?load():[]).filter(b=>b.date===date && (staffSel ? (b.staff||'')===staffSel : true));
  const occupied = new Set(bookings.map(b=>b.time));
  const toHM=d=>String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
  const addMins=(d,m)=>{const x=new Date(d); x.setMinutes(x.getMinutes()+m); return x;};
  let cur=new Date(date+'T'+START+':00'), end=new Date(date+'T'+END+':00');
  while(cur<=end){
    const hm=toHM(cur);
    const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=hm; b.dataset.time=hm;
    if(occupied.has(hm)){ b.classList.add('disabled'); }
    b.addEventListener('click', ()=>{ if(b.classList.contains('disabled')) return; document.querySelectorAll('.chip.active').forEach(x=>x.classList.remove('active')); b.classList.add('active'); });
    root.appendChild(b);
    cur=addMins(cur,STEP);
  }
}
applyBarbers?.();
buildSlots();
document.getElementById('date').addEventListener('change', buildSlots);
document.getElementById('service').addEventListener('change', buildSlots);

document.getElementById('bookBtn').onclick=()=>{
  const list = load();
  const name=document.getElementById('name').value.trim(), phone=document.getElementById('phone').value.trim();
  const staff=document.getElementById('staff').value, service=document.getElementById('service').value, date=document.getElementById('date').value || new Date().toISOString().slice(0,10);
  const sel=document.querySelector('.chip.active');
  if(!name||!phone||!service||!date||!sel){ alert('Lütfen ad, telefon, hizmet, tarih ve saat seçiniz.'); return; }
  const booking={date:date,time:sel.dataset.time,staff:staff,service:service,name:name,phone:phone,createdAt:new Date().toISOString()};
  list.push(booking); save(list);
  alert('Randevunuz alındı: '+booking.date+' '+booking.time+' — Teşekkürler!');
};

document.getElementById('adminBtn').onclick=()=>{
  const pin = prompt('PIN giriniz (varsayılan 2525):');
  if(pin===PIN){ openAdmin(); } else if(pin!==null){ alert('Hatalı PIN'); }
};
function openAdmin(){
  // preload settings to inputs
  const s=getSettings();
  document.getElementById('setStart').value=s.start;
  document.getElementById('setEnd').value=s.end;
  document.getElementById('setStep').value=s.step;
  document.getElementById('setBarbers').value=s.barbers.join(', ');
  document.getElementById('setClosedDates').value=(s.closedDates||[]).join(', ');
  (s.closedWeek||[]).forEach(d=>{ const el=document.getElementById('cw'+d); if(el) el.checked=true; });
  renderRows();
  document.getElementById('adminModal').style.display='flex';
}
document.getElementById('closeAdmin').onclick=()=>document.getElementById('adminModal').style.display='none';

function renderRows(){
  const rows=document.getElementById('rows'); rows.innerHTML='';
  const list=load().sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  if(!list.length){ const empty=document.createElement('div'); empty.className='tr'; empty.innerHTML="<div style='grid-column:1/-1;padding:12px;color:#cbd4df'>Henüz randevu yok.</div>"; rows.appendChild(empty); return; }
  list.forEach((b,i)=>{
    const tr=document.createElement('div'); tr.className='tr';
    tr.innerHTML="<div>"+b.date+"</div><div>"+b.time+"</div><div>"+(b.staff||'—')+"</div><div>"+b.service+"</div><div>"+b.name+" ("+b.phone+")</div>";
    const act=document.createElement('div');
    const del=document.createElement('button'); del.textContent='Sil'; del.className='a-btn'; del.onclick=()=>{ const arr=load(); arr.splice(i,1); save(arr); renderRows(); };
    act.appendChild(del);
    tr.appendChild(act);
    rows.appendChild(tr);
  });
}
document.getElementById('exportBtn')?.addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(load(),null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='askim-randevular.json'; a.click();
});
document.getElementById('importFile')?.addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader(); rd.onload=()=>{ try{ const data=JSON.parse(rd.result); if(Array.isArray(data)){ save(data); renderRows(); alert('İçe aktarıldı'); } else alert('Geçersiz dosya'); }catch(_){ alert('Dosya okunamadı'); } }; rd.readAsText(f);
});
document.getElementById('clearBtn')?.addEventListener('click',()=>{ if(confirm('Tüm randevular silinsin mi?')){ save([]); renderRows(); } });
// Settings actions
document.getElementById('saveSettings')?.addEventListener('click',()=>{
  const s={
    start:document.getElementById('setStart').value||'09:00',
    end:document.getElementById('setEnd').value||'21:00',
    step:parseInt(document.getElementById('setStep').value||30,10),
    barbers:(document.getElementById('setBarbers').value||'').split(',').map(x=>x.trim()).filter(Boolean)
  };
  // collect weekly closures
  s.closedWeek=[]; [0,1,2,3,4,5,6].forEach(i=>{ const el=document.getElementById('cw'+i); if(el&&el.checked) s.closedWeek.push(i); });
  // collect date closures
  const raw=(document.getElementById('setClosedDates').value||''); s.closedDates=raw.split(',').map(x=>x.trim()).filter(Boolean);
  setSettings(s); applyBarbers(); buildSlots(); alert('Ayarlar kaydedildi.');
});
document.getElementById('resetSettings')?.addEventListener('click',()=>{
  const d={start:'09:00', end:'21:00', step:30, barbers:['Ahmet','Aziz','Usta'], closedWeek:[], closedDates:[]} ;
  setSettings(d); applyBarbers(); buildSlots(); 
  document.getElementById('setStart').value=d.start;
  document.getElementById('setEnd').value=d.end;
  document.getElementById('setStep').value=d.step;
  document.getElementById('setBarbers').value=d.barbers.join(', ');
  document.getElementById('setClosedDates').value='';
  [0,1,2,3,4,5,6].forEach(i=>{ const el=document.getElementById('cw'+i); if(el) el.checked=false; });
});

// Quick close/open today
document.getElementById('closeToday')?.addEventListener('click',()=>{
  const s=getSettings(); const today=new Date().toISOString().slice(0,10);
  if(!(s.closedDates||[]).includes(today)){ s.closedDates=(s.closedDates||[]); s.closedDates.push(today); setSettings(s); document.getElementById('setClosedDates').value=s.closedDates.join(', '); buildSlots(); }
});
document.getElementById('openToday')?.addEventListener('click',()=>{
  const s=getSettings(); const today=new Date().toISOString().slice(0,10);
  s.closedDates=(s.closedDates||[]).filter(x=>x!==today); setSettings(s); document.getElementById('setClosedDates').value=s.closedDates.join(', '); buildSlots();
});


// ====== CUSTOMER ACCOUNTS ======
const USERS='askim_users_v1', SESSION='askim_session_v1';
function getUsers(){ try{return JSON.parse(localStorage.getItem(USERS))||[];}catch(e){return [];} }
function setUsers(u){ localStorage.setItem(USERS, JSON.stringify(u)); }
function getSession(){ try{return JSON.parse(localStorage.getItem(SESSION))||null;}catch(e){return null;} }
function setSession(s){ if(s) localStorage.setItem(SESSION, JSON.stringify(s)); else localStorage.removeItem(SESSION); }

function hash(s){ // simple demo hash (not secure!)
  let h=0; for(let i=0;i<s.length;i++){h=(h<<5)-h + s.charCodeAt(i); h|=0;} return String(h);
}
function ensureLoggedUI(){
  const sess=getSession();
  const info=document.getElementById('loggedInfo');
  if(sess){ info.textContent = 'Giriş: ' + sess.username; }
  else { info.textContent = ''; }
  document.getElementById('loginPane').style.display = sess? 'none':'block';
  document.getElementById('registerPane').style.display = sess? 'none':'none';
  document.getElementById('accountPane').style.display = sess? 'block':'none';
}
function openUser(){
  ensureLoggedUI();
  const sess=getSession();
  if(sess){ renderMyBookings(); }
  document.getElementById('userModal').style.display='flex';
}
document.getElementById('userBtn').onclick=openUser;
document.getElementById('closeUser').onclick=()=>document.getElementById('userModal').style.display='none';

// Tabs
document.getElementById('tabLogin').onclick=()=>{
  document.getElementById('tabLogin').classList.add('active');
  document.getElementById('tabRegister').classList.remove('active');
  document.getElementById('loginPane').style.display='block';
  document.getElementById('registerPane').style.display='none';
};
document.getElementById('tabRegister').onclick=()=>{
  document.getElementById('tabRegister').classList.add('active');
  document.getElementById('tabLogin').classList.remove('active');
  document.getElementById('loginPane').style.display='none';
  document.getElementById('registerPane').style.display='block';
};

document.getElementById('doRegister').onclick=()=>{
  const u=(document.getElementById('uReg').value||'').trim();
  const p=(document.getElementById('pReg').value||'').trim();
  const ph=(document.getElementById('phReg').value||'').trim();
  if(!u||!p||!ph){ alert('Kullanıcı adı, şifre ve telefon gerekli.'); return; }
  const users=getUsers();
  if(users.some(x=>x.username.toLowerCase()===u.toLowerCase())){ alert('Bu kullanıcı adı zaten var.'); return; }
  users.push({username:u, pass:hash(p), phone:ph, createdAt:new Date().toISOString()});
  setUsers(users);
  setSession({username:u});
  alert('Kayıt tamamlandı. Giriş yapıldı.');
  ensureLoggedUI(); renderMyBookings();
};

document.getElementById('doLogin').onclick=()=>{
  const u=(document.getElementById('uLogin').value||'').trim();
  const p=(document.getElementById('pLogin').value||'').trim();
  const users=getUsers();
  const ok=users.find(x=>x.username.toLowerCase()===u.toLowerCase() && x.pass===hash(p));
  if(!ok){ alert('Hatalı kullanıcı adı/şifre.'); return; }
  setSession({username:ok.username});
  ensureLoggedUI(); renderMyBookings();
};
document.getElementById('logoutBtn').onclick=()=>{ setSession(null); ensureLoggedUI(); };

function renderMyBookings(){
  const box=document.getElementById('myBookings'); box.innerHTML='';
  const sess=getSession(); if(!sess){ box.innerHTML='<div style="padding:10px;color:#cbd4df">Giriş yapınız.</div>'; return; }
  const all=load();
  // Filter: bookings by uid, or by phone match to this user's phone (legacy)
  const urec=getUsers().find(x=>x.username===sess.username);
  const mine=all.filter(b=>b.uid===sess.username || (urec && urec.phone && b.phone===urec.phone));
  if(!mine.length){ box.innerHTML='<div style="padding:10px;color:#cbd4df">Henüz randevunuz yok.</div>'; return; }
  mine.forEach((b,idx)=>{
    const row=document.createElement('div'); row.className='item';
    row.innerHTML = '<div>'+b.date+'</div><div>'+b.time+'</div><div>'+(b.staff||'—')+'</div><div>'+b.service+'</div>';
    const act=document.createElement('div');
    const edit=document.createElement('button'); edit.textContent='Değiştir'; edit.className='a-btn'; 
    edit.onclick=()=>editBooking(b);
    const cancel=document.createElement('button'); cancel.textContent='İptal'; cancel.className='a-btn';
    cancel.onclick=()=>{ if(confirm('Randevuyu iptal edilsin mi?')){ const all=load(); const i=all.findIndex(x=>x.createdAt===b.createdAt); if(i>-1){ all.splice(i,1); save(all); renderMyBookings(); } } };
    act.appendChild(edit); act.appendChild(cancel);
    row.appendChild(act);
    box.appendChild(row);
  });
}

function editBooking(b){
  // Simple prompt-based change: new date + pick a time from grid
  const nd=prompt('Yeni tarih (YYYY-MM-DD):', b.date);
  if(!nd) return;
  // Temporarily rebuild grid for chosen date and ask user to tap a time, then confirm
  document.getElementById('date').value = nd;
  buildSlots();
  alert('Yeni saat seçin ve ardından tekrar "Değiştir"e basın.');
  // On second press, if a time is selected, commit
  const sel=document.querySelector('.chip.active');
  if(sel){
    const all=load();
    const i=all.findIndex(x=>x.createdAt===b.createdAt);
    if(i>-1){ all[i].date=nd; all[i].time=sel.dataset.time; save(all); alert('Randevu güncellendi.'); renderMyBookings(); }
  }
}

// When booking, attach uid if logged in
const _origBook = document.getElementById('bookBtn').onclick;
document.getElementById('bookBtn').onclick = ()=>{
  const sess=getSession();
  const list = load();
  const name=document.getElementById('name').value.trim(), phone=document.getElementById('phone').value.trim();
  const staff=document.getElementById('staff').value, service=document.getElementById('service').value, date=document.getElementById('date').value || new Date().toISOString().slice(0,10);
  const sel=document.querySelector('.chip.active');
  if(!name||!phone||!service||!date||!sel){ alert('Lütfen ad, telefon, hizmet, tarih ve saat seçiniz.'); return; }
  // double-booking check
  if(list.some(b=>b.date===date && b.time===sel.dataset.time && (staff ? (b.staff||'')===staff : true))){
    alert('Bu saat dolu. Lütfen farklı bir saat seçin.');
    buildSlots();
    return;
  }
  const booking={date:date,time:sel.dataset.time,staff:staff,service:service,name:name,phone:phone,createdAt:new Date().toISOString()};
  if(sess){ booking.uid=sess.username; }
  list.push(booking); save(list);
  alert('Randevunuz alındı: '+booking.date+' '+booking.time+' — Teşekkürler!');
  if(sess){ renderMyBookings(); }
  buildSlots();
};

</script>
</body>
</html>
