<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ahmet Tekeli • Randevu</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f6f7fb;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--card:#fff;--brand:#101827;--gold:#d4af37}
:root[data-theme="ak"]   { --brand:#101827; --gold:#d4af37; }
:root[data-theme="enjoy"]{ --brand:#6d28d9; --gold:#f59e0b; }
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1000px;margin:0 auto;padding:0 14px}
header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:20}
.header-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.brand .title{font-family:Georgia,serif;font-weight:700;color:var(--brand);font-size:24px;line-height:1}
.brand .sub{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:8px;align-items:center}
.badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
.badge .dot{min-width:18px;height:18px;border-radius:999px;background:#ef4444;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:700}
#bellBtn{display:none}
#bellBtn.blink{animation:pulse 1s ease-in-out infinite}
@keyframes pulse{0%{filter:none}50%{filter:drop-shadow(0 0 8px #f43) saturate(1.2)}100%{filter:none}}
main{padding:16px 0}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
.grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media(max-width:760px){.grid-2{grid-template-columns:minmax(0,1fr)}}
h2{margin:0 0 12px} h3{margin:6px 0 10px} h4{margin:0 0 8px}
label{display:block;font-weight:600;margin:0 0 6px}
input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;font-size:16px}
.btn{border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
.btn-primary{background:var(--gold);border-color:var(--gold);color:#111}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.slotgrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
@media(max-width:540px){.slotgrid{grid-template-columns:repeat(3,minmax(0,1fr))}}
.slot{border:1px solid #e5e7eb;background:#f3f4f6;color:#0f172a;border-radius:22px;padding:14px 0;font-weight:700;text-align:center}
.slot.busy{background:#cfd4dc;color:#6b7280;pointer-events:none}
.slot.sel{background:#111827;color:#fff;border-color:#111827}
.table-scroll{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}
thead th{background:#f3f4f6;font-weight:700}
.kpi{display:none;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:16px}
.kpi .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
.sheet{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:flex-end;z-index:30}
.sheet.show{display:flex}
.sheet .panel{width:100%;max-height:92vh;background:#fff;border-radius:16px 16px 0 0;box-shadow:0 -12px 30px rgba(0,0,0,.25);padding:14px 14px 18px;overflow:auto}
#toast{position:fixed;left:50%;top:-80px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;box-shadow:0 10px 24px rgba(0,0,0,.18);z-index:50;transition:top .45s}
#toast.show{top:12px}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);background:#f8fafc;border-radius:999px;padding:6px 10px}
.hero{margin:12px 0;background:linear-gradient(135deg,#fff,#f6f7fb)}
.hero .row{align-items:center}
</style>
</head>
<body>
<div id="toast"></div>

<header>
  <div class="wrap header-row">
    <div class="brand">
      <div>
        <div class="title">AHMET TEKELİ</div>
        <div class="sub">Erkek Kuaförü</div>
      </div>
    </div>
    <div class="actions">
      <select id="themeSel" class="badge" title="Tema">
        <option value="ak">Ahmet Tekeli</option>
        <option value="enjoy">Enjoy Beauty</option>
      </select>
      <button id="bellBtn" class="badge" title="Bildirimler">🔔 <span id="bellCount" class="dot">0</span></button>
      <button id="adminOpen" class="badge">👨‍💼 Admin</button>
      <button id="custOpen"  class="badge">👤 Müşteri</button>
      <button id="manageOpen" class="badge" style="display:none">⚙️ Yönetim</button>
      <button id="myApptsOpen" class="badge" style="display:none">📅 Randevularım <span id="myBadge" class="dot" style="display:none">0</span></button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- HERO -->
  <section class="card hero">
    <div class="row">
      <div style="display:flex;gap:12px;align-items:center">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96'><rect width='100%' height='100%' rx='16' ry='16' fill='%23d4af37'/><text x='50%' y='54%' font-size='28' text-anchor='middle' fill='white' font-family='Georgia'>AT</text></svg>" alt="Logo" style="width:72px;height:72px;border-radius:16px">
        <div>
          <h2 style="margin:0">Ahmet Tekeli Erkek Kuaförü</h2>
          <div class="small">Antalya’da kişisel bakımın yeni adresi</div>
        </div>
      </div>
      <button class="btn btn-primary" style="margin-left:auto" onclick="document.getElementById('randevu').scrollIntoView({behavior:'smooth'})">Randevu Al</button>
    </div>
  </section>

  <!-- RANDEVU -->
  <section class="card" id="randevu">
    <h2>Randevu Oluştur</h2>
    <div class="grid-2">
      <div><label>Ad Soyad</label><input id="f_name" placeholder="Adınız Soyadınız"></div>
      <div><label>Telefon</label><input id="f_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
      <div><label>Berber</label><select id="f_staff"><option disabled selected>— Seçiniz —</option></select></div>
      <div><label>Hizmet</label><select id="f_service"><option disabled selected>— Seçiniz —</option></select></div>
      <div><label>Tarih</label><input type="date" id="f_date"></div>
      <div><label>Saat Seçimi</label><div id="slotgrid" class="slotgrid"></div></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn btn-primary" id="f_book">RANDEVU AL</button>
      <span id="f_status" class="small"></span>
    </div>
    <div id="kpi" class="kpi">
      <div class="box"><div class="small">Bugün</div><b id="kpiToday">0</b></div>
      <div class="box"><div class="small">Onay/Bekl/İptal</div><b id="kpiOBI">0/0/0</b></div>
      <div class="box"><div class="small">Haftalık</div><b id="kpiWeek">0</b></div>
    </div>
  </section>
</main>

<!-- Bildirim/Onay kuyruğu -->
<div id="sheetBell" class="sheet"><div class="panel">
  <h3>Onay Kuyruğu</h3>
  <div id="queueList" class="small">Kuyruk boş.</div>
</div></div>

<!-- Admin girişi -->
<div id="sheetAdmin" class="sheet"><div class="panel">
  <h3>Yönetici Girişi</h3>
  <div class="grid-2">
    <div><label>Admin Telefon</label><input id="adminPhone" value="+905356749243"></div>
    <div><label>Şifre</label><input id="adminPass" type="password" placeholder="••••••"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <button class="btn btn-primary" id="adminLoginBtn">Giriş Yap</button>
    <button class="btn" id="adminLogoutBtn">Çıkış</button>
    <span id="adminStatus" class="small"></span>
  </div>

  <hr style="margin:12px 0;border:none;border-top:1px solid var(--line)">
  <h4>Yönetici Şifre Değiştir</h4>
  <div class="grid-2">
    <div><label>Mevcut Şifre</label><input id="adm_old" type="password"></div>
    <div><label>Yeni Şifre (min 6)</label><input id="adm_new" type="password"></div>
  </div>
  <div class="row" style="margin-top:8px">
    <button class="btn" id="adm_change">Şifreyi Güncelle</button>
    <span id="adm_status" class="small"></span>
  </div>
</div></div>

<!-- Müşteri girişi -->
<div id="sheetCust" class="sheet"><div class="panel">
  <h3>Müşteri Girişi / Kayıt</h3>
  <div class="grid-2">
    <div><label>Ad Soyad</label><input id="c_name" placeholder="Ad Soyad"></div>
    <div><label>Telefon</label><input id="c_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
  </div>
  <div class="grid-2">
    <div><label>Şifre</label><input id="c_pass" type="password" placeholder="Şifre (yeni kayıt için oluştur)"></div>
    <div><label style="visibility:hidden">-</label>
      <div class="row">
        <button class="btn btn-primary" id="c_login">Giriş / Kayıt</button>
        <button class="btn" id="c_forgot">Şifremi Unuttum</button>
      </div>
    </div>
  </div>
  <p class="small" id="c_status"></p>
</div></div>

<!-- Müşteri randevularım -->
<div id="sheetMyAppts" class="sheet"><div class="panel">
  <h3>Randevularım</h3>
  <div class="row" style="gap:8px;margin-bottom:6px">
    <select id="my_filter" style="max-width:220px">
      <option value="upcoming">Yaklaşan</option>
      <option value="all">Tümü</option>
      <option value="past">Geçmiş</option>
    </select>
    <button class="btn" id="my_refresh">Yenile</button>
  </div>
  <div class="table-scroll">
    <table>
      <thead><tr><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>İşlem</th></tr></thead>
      <tbody id="my_tbody"></tbody>
    </table>
  </div>
  <p class="small">“Değiştir” sonrası randevu tekrar onaya düşer.</p>
</div></div>

<!-- Değiştir sheet -->
<div id="sheetResched" class="sheet"><div class="panel">
  <h3>Randevuyu Değiştir</h3>
  <div class="grid-2">
    <div><label>Tarih</label><input type="date" id="rs_date"></div>
    <div><label>Saat Seçimi</label><div id="rs_grid" class="slotgrid"></"></div></div>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btn btn-primary" id="rs_save">Kaydet</button>
    <button class="btn" id="rs_cancel">Vazgeç</button>
    <span id="rs_status" class="small"></span>
  </div>
</div></div>

<!-- Yönetim (yalnız admin) -->
<div id="sheetManage" class="sheet"><div class="panel">
  <h3>Yönetim</h3>

  <div class="grid-2">
    <!-- Ustalar -->
    <section class="card" style="padding:12px">
      <h4>Ustalar</h4>
      <div class="row">
        <input id="newStaffName" placeholder="Yeni usta adı" style="max-width:260px">
        <button class="btn" id="addStaff">Ekle</button>
      </div>
      <ul id="staffList" class="small"></ul>
    </section>

    <!-- Hizmetler -->
    <section class="card" style="padding:12px">
      <h4>Hizmetler</h4>
      <div class="row" style="flex-wrap:wrap">
        <input id="newSvcName" placeholder="Hizmet adı">
        <input id="newSvcDur" type="number" placeholder="Süre (dk)" style="max-width:120px">
        <input id="newSvcPrice" type="number" placeholder="Fiyat (TL)" style="max-width:120px">
        <button class="btn" id="addSvc">Ekle</button>
      </div>
      <ul id="svcList" class="small"></ul>
    </section>
  </div>

  <!-- Çalışma saatleri + çift aralık + offDates -->
  <section class="card" style="padding:12px;margin-top:10px">
    <h4>Usta Çalışma Saatleri</h4>
    <div class="grid-2">
      <div><label>Usta</label><select id="wh_staff"></select></div>
      <div><label>Slot (dk) — (sistem 30 dk kullanır)</label><input id="wh_slot" type="number" value="30" disabled></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div style="flex:1">
        <b>Günlük Saatler (Çift Aralık)</b>
        <div id="wh_days" class="chips" style="margin-top:6px"></div>
        <div id="wh_intervals" class="grid-2" style="margin-top:8px"></div>
      </div>
      <div style="flex:1">
        <b>İzin / Tatil Günleri</b>
        <div class="row" style="margin-top:6px">
          <input type="date" id="offDate" style="max-width:180px">
          <button class="btn" id="addOff">Ekle</button>
        </div>
        <div id="offList" class="chips" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn btn-primary" id="saveWorkHours">Kaydet</button>
      <span id="wh_status" class="small"></span>
    </div>
  </section>

  <!-- Randevular + toplu işlemler + admin’den ekle -->
  <section class="card" style="padding:12px;margin-top:10px">
    <h4>Randevular</h4>
    <div class="row" style="gap:8px;margin-bottom:6px;flex-wrap:wrap">
      <input type="date" id="ap_fdate" style="max-width:180px">
      <select id="ap_fstaff" style="max-width:220px"><option value="">Tüm Ustalar</option></select>
      <select id="ap_fstatus" style="max-width:180px">
        <option value="">Tüm Durumlar</option>
        <option value="pending">Beklemede</option>
        <option value="approved">Onaylandı</option>
        <option value="cancelled">İptal</option>
        <option value="rejected">Reddedildi</option>
      </select>
      <span class="small" style="margin-left:auto">Toplu: </span>
      <button class="btn" id="ap_refresh">Yenile</button>
      <button class="btn" id="bulk_cancel">İptal</button>
      <button class="btn" id="bulk_delete">Sil</button>
    </div>
    <div class="chips" style="margin:6px 0">
      <label class="chip"><input type="radio" name="scope" id="sc_today" checked style="width:auto"> Bugün</label>
      <label class="chip"><input type="radio" name="scope" id="sc_tom" style="width:auto"> Yarın</label>
      <label class="chip"><input type="radio" name="scope" id="sc_week" style="width:auto"> Haftalık</label>
    </div>
    <div class="table-scroll">
      <table>
        <thead><tr><th><input type="checkbox" id="ap_chkall"></th><th>Tarih</th><th>Saat</th><th>Müşteri</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>İşlem</th></tr></thead>
        <tbody id="ap_tbody"></tbody>
      </table>
    </div>

    <hr style="margin:12px 0;border:none;border-top:1px solid var(--line)">

    <h4>Admin’den Randevu Oluştur</h4>
    <div class="grid-2">
      <div><label>Ad Soyad</label><input id="a_name" placeholder="Müşteri adı"></div>
      <div><label>Telefon</label><input id="a_phone" placeholder="05xxxxxxxxx" inputmode="tel"></div>
      <div><label>Usta</label><select id="a_staff"></select></div>
      <div><label>Hizmet</label><select id="a_svc"></select></div>
      <div><label>Tarih</label><input type="date" id="a_date"></div>
      <div><label>Saat Seçimi</label><div id="a_slots" class="slotgrid"></div></div>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="chip"><input type="checkbox" id="a_auto" style="width:auto"> Oto Onay (approved)</label>
      <button class="btn btn-primary" id="a_create">Randevu Oluştur</button>
      <span id="a_status" class="small"></span>
    </div>
  </section>

  <!-- Haftalık Takvim -->
  <section class="card" style="padding:12px;margin-top:10px">
    <h4>Haftalık Takvim</h4>
    <div class="row" style="gap:8px;margin-bottom:6px;flex-wrap:wrap">
      <input type="date" id="wk_ref" style="max-width:180px" title="Hafta referans tarihi">
      <select id="wk_staff" style="max-width:220px"><option value="">Tüm Berberler</option></select>
      <select id="wk_service" style="max-width:220px"><option value="">Tüm Hizmetler</option></select>
      <button class="btn" id="wk_refresh">Yenile</button>
    </div>
    <div class="table-scroll">
      <table>
        <thead id="wk_head"></thead>
        <tbody id="wk_body"></tbody>
      </table>
    </div>
    <p class="small">Hücreler 30 dk slot; onaylı/beklemede olanlar içerikte görünür.</p>
  </section>

  <!-- Analitikler -->
  <section class="card" style="padding:12px;margin-top:10px">
    <h4>Analitikler (Son 30 Gün)</h4>
    <div class="row" style="gap:12px;flex-wrap:wrap">
      <div style="min-width:220px"><div class="small">Toplam Randevu</div><b id="an_total">0</b></div>
      <div style="min-width:220px"><div class="small">Onay/Beklemede/İptal</div><b id="an_obi">0/0/0</b></div>
      <div style="min-width:220px"><div class="small">En Popüler Hizmet</div><b id="an_top_svc">-</b></div>
      <div style="min-width:220px"><div class="small">En Popüler Berber</div><b id="an_top_staff">-</b></div>
    </div>
    <div style="margin-top:12px">
      <canvas id="an_hours" width="960" height="180" style="max-width:100%"></canvas>
    </div>
    <p class="small">Grafik: Saat bazında randevu yoğunluğu (0–23).</p>
  </section>

</div></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-functions-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-messaging-compat.js"></script>

<script>
/* ====== Yardımcılar ====== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const store={get(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}},del(k){try{localStorage.removeItem(k)}catch(e){}}};
function toast(m,ms=2200){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms);}
const toMin=t=>{const[h,m]=t.split(':').map(Number);return h*60+m}, toHHMM=m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
function overlaps(aS,aE,bS,bE){return aS<bE && aE>bS}
function maskPhone(p){ if(!p) return ''; if(p.startsWith('+90')&&p.length===13){const n=p.slice(3); return `0${n.slice(0,3)} ${n.slice(3,6)} ${n.slice(6,8)} ${n.slice(8,10)}`} return p }
function playAlertTone(){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime+0.01); o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.25); setTimeout(()=>{ o.stop(); ctx.close(); },260); },240);}catch(e){} }
function vibrate(ms=200){ if(navigator.vibrate) try{ navigator.vibrate(ms);}catch(e){} }

/* ====== Firebase Init ====== */
firebase.initializeApp({
  apiKey:"AIzaSyBtSQ9_5R42BU5ga0cOt1QETkC5nOf2tW4",
  authDomain:"randevu-81305.firebaseapp.com",
  projectId:"randevu-81305",
  storageBucket:"randevu-81305.firebasestorage.app",
  messagingSenderId:"686048709577",
  appId:"1:686048709577:web:b2db4eeae83203ca2e3618",
  measurementId:"G-3ZX91ND545"
});
const db=firebase.firestore();
const fx=firebase.functions();
let messaging=null, swReg=null;

/* ====== Globals ====== */
let adminOn=false, currentUser=store.get('custSession',null);
let lastStaff=[], lastSvcs=[], lastAppts=[], lastUsers=[];
let unsubStaff=null, unsubSvcs=null, unsubAppts=null, unsubUsers=null;
let _rs=null, myPrevStatus={}, myUnread=0;

/* ====== PWA Manifest & FCM SW (tek dosya hack) ====== */
(async function bootstrapSWAndManifest(){
  // manifest.json
  const manifest = {
    name:"Ahmet Tekeli • Randevu",
    short_name:"Randevu",
    start_url:"./",
    display:"standalone",
    background_color:"#ffffff",
    theme_color:"#101827",
    icons:[{src:"data:image/png;base64,iVBORw0KGgo=",sizes:"192x192",type:"image/png"}]
  };
  const mUrl = URL.createObjectURL(new Blob([JSON.stringify(manifest)],{type:'application/json'}));
  const link = document.createElement('link'); link.rel='manifest'; link.href=mUrl; document.head.appendChild(link);

  // firebase-messaging-sw.js içeriğini blob olarak yaz
  const swCode = `
    importScripts('https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js');
    importScripts('https://www.gstatic.com/firebasejs/10.12.4/firebase-messaging-compat.js');
    firebase.initializeApp({
      apiKey:"AIzaSyBtSQ9_5R42BU5ga0cOt1QETkC5nOf2tW4",
      authDomain:"randevu-81305.firebaseapp.com",
      projectId:"randevu-81305",
      messagingSenderId:"686048709577",
      appId:"1:686048709577:web:b2db4eeae83203ca2e3618"
    });
    const messaging = firebase.messaging();
    self.addEventListener('notificationclick', event => {
      const action = event.action;
      const data = event.notification?.data || {};
      event.notification.close();
      if(action === 'open-admin'){ event.waitUntil(clients.openWindow('/#admin')); }
      else if(action === 'add-calendar' && data?.gcal){ event.waitUntil(clients.openWindow(data.gcal)); }
      else { event.waitUntil(clients.openWindow('/')); }
    });
  `;
  const swUrl = URL.createObjectURL(new Blob([swCode],{type:'text/javascript'}));
  swReg = await navigator.serviceWorker.register(swUrl, { scope: './' });
  messaging = firebase.messaging();
})();

/* ====== FCM: izin + token kaydı ====== */
async function callFn(name, payload){
  try{ const fn=fx.httpsCallable(name); const res=await fn(payload||{}); return res.data; }
  catch(e){ console.error('Fn error',name,e); toast(e?.message||'Sunucu hatası'); throw e; }
}
function getAdminToken(){ return store.get('adminToken', null); }
function setAdminToken(t){ if(t){ store.set('adminToken', t);} else { store.del('adminToken'); } }

async function ensureFcm(){
  try{
    if(!('Notification' in window) || !messaging || !swReg) return null;
    const perm = await Notification.requestPermission();
    if(perm!=='granted') return null;
    const tok = await messaging.getToken({
      vapidKey: 'REPLACE_WITH_YOUR_VAPID_PUBLIC_KEY', // <- DOLDUR
      serviceWorkerRegistration: swReg
    });
    if(tok){
      try{ await callFn('saveFcmToken', { token: tok, who: adminOn ? 'admin' : 'user', phone: currentUser?.phone||null }); }
      catch(e){ console.warn('saveFcmToken yok veya rules izin vermedi, atlanıyor.'); }
    }
    return tok;
  }catch(e){ console.error(e); return null; }
}

/* ====== Tema ====== */
(function themeBoot(){
  const t=store.get('theme','ak');
  document.documentElement.setAttribute('data-theme',t);
  const sel=$('#themeSel'); if(sel){ sel.value=t; sel.onchange=()=>{ const v=sel.value; document.documentElement.setAttribute('data-theme',v); store.set('theme',v); }; }
})();

/* ====== Sheet aç/kapa ====== */
const sheet={show:id=>{ $(id).classList.add('show'); document.body.style.overflow='hidden'; }, hide:id=>{ $(id).classList.remove('show'); document.body.style.overflow=''; }};
['#sheetBell','#sheetAdmin','#sheetCust','#sheetMyAppts','#sheetResched','#sheetManage'].forEach(id=>$(id).addEventListener('click',e=>{ if(e.target===e.currentTarget) sheet.hide(id); }));
$('#adminOpen').onclick=()=>{location.hash='#admin'; sheet.show('#sheetAdmin')};
$('#custOpen').onclick =()=>sheet.show('#sheetCust');
$('#bellBtn').onclick  =()=>sheet.show('#sheetBell');
$('#manageOpen').onclick=()=>sheet.show('#sheetManage');
$('#myApptsOpen').onclick=()=>{ sheet.show('#sheetMyAppts'); myUnread=0; $('#myBadge').style.display='none'; };

/* ====== Görünürlük ====== */
function setAdmin(on){
  adminOn=!!on;
  $('#bellBtn').style.display=on?'inline-flex':'none';
  $('#kpi').style.display=on?'grid':'none';
  $('#manageOpen').style.display=on?'inline-flex':'none';
  ensureFcm(); // rol değişince token'ı role ile kaydet
}
function setCust(on){ $('#myApptsOpen').style.display=on?'inline-flex':'none';}

/* ====== Realtime ====== */
function startRealtime(){
  if(unsubStaff)unsubStaff(); if(unsubSvcs)unsubSvcs(); if(unsubAppts)unsubAppts(); if(unsubUsers)unsubUsers();

  unsubStaff=db.collection('staff').onSnapshot(ss=>{
    lastStaff=ss.docs.map(d=>({id:d.id,...d.data()}));
    fillStaff(); fillAdminStaff(); renderStaffList(); renderWorkEditor(); computeSlots(); renderAdminSlots(); if(_rs) computeResched();
    fillWeekSelectors();
  });
  unsubSvcs=db.collection('services').onSnapshot(ss=>{
    lastSvcs=ss.docs.map(d=>({id:d.id,...d.data()}));
    fillServices(); fillAdminSvcs(); renderServiceList(); computeSlots(); renderAdminSlots();
    fillWeekSelectors();
  });
  unsubUsers=db.collection('users').onSnapshot(ss=>{
    lastUsers=ss.docs.map(d=>({id:d.id,...d.data()})); renderCustomers();
  });
  unsubAppts=db.collection('appts').onSnapshot(ss=>{
    lastAppts=ss.docs.map(d=>({id:d.id,...d.data()}));
    computeSlots(lastAppts); renderAdminSlots(); renderQueue(lastAppts); updateKpi(lastAppts); renderMy(lastAppts); renderAdminAppts(lastAppts);
    refreshMgmtExtras();

    // müşteri bildirimleri + ses + titreşim
    if(currentUser){
      const mine=lastAppts.filter(a=>a.phone===currentUser.phone);
      mine.forEach(a=>{
        const prev=myPrevStatus[a.id];
        if(prev==='pending' && (a.status==='approved'||a.status==='rejected'||a.status==='cancelled')){
          myUnread++; const b=$('#myBadge'); b.style.display='inline-flex'; b.textContent=String(myUnread);
          toast(a.status==='approved'?'✅ Randevunuz onaylandı':a.status==='rejected'?'⛔ Randevunuz reddedildi':'ℹ️ Randevunuz iptal edildi');
          playAlertTone(); vibrate(200);
          try{ new Notification('Randevu Güncellemesi',{body:`${a.date} ${a.time} • ${a.serviceName}`,icon:''}); }catch(e){}
        }
        myPrevStatus[a.id]=a.status;
      });
    }
  });
}
startRealtime();

/* ====== Select doldurucular ====== */
function fillStaff(){
  const sel=$('#f_staff'); const cur=sel.value;
  sel.innerHTML='<option disabled selected>— Seçiniz —</option>'+lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  if(lastStaff.some(s=>s.id===cur)) sel.value=cur;
  $('#wh_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
function fillAdminStaff(){ $('#ap_fstaff').innerHTML='<option value="">Tüm Ustalar</option>'+lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); $('#a_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); }
function fillServices(){
  const sel=$('#f_service'); const cur=sel.value;
  sel.innerHTML='<option disabled selected>— Seçiniz —</option>'+lastSvcs.map(s=>`<option value="${s.id}">${s.name} — ${s.dur} dk</option>`).join('');
  if(lastSvcs.some(s=>s.id===cur)) sel.value=cur;
}
function fillAdminSvcs(){ $('#a_svc').innerHTML=lastSvcs.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); }

/* ====== Çakışma/slot ====== */
function conflicts(appts,date,staffId){
  return (appts||[]).filter(a=>a.date===date&&a.staffId===staffId&&a.status!=='cancelled'&&a.status!=='rejected')
    .map(a=>({start:toMin(a.time), end:toMin(a.time)+(a.duration||30)}));
}
function getIntervalsFor(staff,dateISO){
  const dow=new Date(dateISO+'T00:00:00').getDay();
  const by=staff?.hoursByDay?.[dow];
  if(by && by.open1 && by.close1){
    const arr=[{open:by.open1, close:by.close1}];
    if(by.open2 && by.close2) arr.push({open:by.open2, close:by.close2});
    return arr;
  }
  const base=staff?.hours || {open:'09:00',close:'21:00'};
  return [{open:base.open, close:base.close}];
}
function staffWorks(staff,dateISO){
  const dow=new Date(dateISO+'T00:00:00').getDay();
  const dayOk = !staff?.days || staff.days.includes(dow);
  const off   = (staff?.offDates||[]).includes(dateISO);
  return dayOk && !off;
}
const STEP=30;
function renderGrid(containerId, staff, svcDur, date){
  const box=document.getElementById(containerId); box.innerHTML='';
  if(!staff||!svcDur||!date) return;
  const works = staffWorks(staff,date);
  const taken=conflicts(lastAppts,date,staff.id);
  const intervals=getIntervalsFor(staff,date);
  intervals.forEach(iv=>{
    const openM=toMin(iv.open), closeM=toMin(iv.close);
    for(let t=openM; t+svcDur<=closeM; t+=STEP){
      const time=toHHMM(t);
      const busy = !works || taken.some(x=>overlaps(t,t+svcDur,x.start,x.end));
      const b=document.createElement('button');
      b.type='button'; b.className='slot'+(busy?' busy':''); b.textContent=time; b.dataset.time=time;
      b.onclick=()=>{ if(busy) return; [...box.querySelectorAll('.slot')].forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); };
      box.appendChild(b);
    }
  });
}
function getSelected(containerId){ return document.querySelector(`#${containerId} .slot.sel`)?.dataset.time||null; }

/* ====== Müşteri • Randevu al ====== */
$('#f_date').value=new Date().toISOString().slice(0,10);
$('#f_staff').onchange=computeSlots; $('#f_service').onchange=computeSlots; $('#f_date').onchange=computeSlots;
async function computeSlots(){ const sId=$('#f_staff').value, vId=$('#f_service').value, d=$('#f_date').value; if(!sId||!vId||!d){$('#slotgrid').innerHTML='';return;} const s=lastStaff.find(x=>x.id===sId), v=lastSvcs.find(x=>x.id===vId); if(!s||!v)return; renderGrid('slotgrid',s,v.dur||30,d); }

$('#f_book').onclick=async ()=>{
  const name=$('#f_name').value.trim(), phoneRaw=$('#f_phone').value.trim();
  const staffId=$('#f_staff').value, svcId=$('#f_service').value, date=$('#f_date').value;
  const time=getSelected('slotgrid');
  if(!name||!phoneRaw||!staffId||!svcId||!date||!time){ $('#f_status').textContent='Lütfen tüm alanları doldurun.'; toast('Eksik bilgi'); return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);
  try{
    await callFn('createAppointment', { name, phone, staffId, serviceId:svcId, date, time });
    currentUser={name, phone}; store.set('custSession',currentUser); setCust(true);
    $('#f_status').textContent='Randevu alındı (beklemede).'; toast('Randevu oluşturuldu');
    playAlertTone(); vibrate(100);
  }catch(e){ /* hata toastlandı */ }
};

/* ====== Admin: bildirim kuyruğu ====== */
function updateBell(list){
  const cnt=(list||[]).filter(a=>a.status==='pending').length;
  $('#bellCount').textContent=String(cnt);
  if(adminOn && cnt>0){ $('#bellBtn').classList.add('blink'); playAlertTone(); vibrate(200); try{ new Notification('Yeni randevu isteği',{body:`${cnt} bekleyen`,icon:''}); }catch(e){} }
  else $('#bellBtn').classList.remove('blink');
}
function renderQueue(list){
  const box=$('#queueList'); const rows=(list||[]).filter(a=>a.status==='pending').sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  if(rows.length===0){ box.textContent='Kuyruk boş.'; return; }
  box.innerHTML=rows.map(a=>`
    <div style="display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:8px;margin:6px 0">
      <div style="flex:1 1 auto;min-width:0"><b>${a.date} ${a.time}</b> • ${a.name} • ${a.serviceName} / ${a.staffName}</div>
      <button class="btn" onclick="approve('${a.id}')">Onayla</button>
      <button class="btn" onclick="reject('${a.id}')">Reddet</button>
      <button class="btn" onclick="delAppt('${a.id}')">Sil</button>
    </div>`).join('');
}

/* ====== KPI ====== */
function updateKpi(list){
  if(!adminOn) return;
  const today=new Date().toISOString().slice(0,10);
  const d=list.filter(a=>a.date===today);
  $('#kpiToday').textContent=String(d.length);
  $('#kpiOBI').textContent=[d.filter(a=>a.status==='approved').length,d.filter(a=>a.status==='pending').length,d.filter(a=>a.status==='cancelled').length].join('/');
  const now=new Date(); const ws=new Date(now); ws.setDate(now.getDate()-now.getDay()); const we=new Date(ws); we.setDate(ws.getDate()+6);
  const inWeek=list.filter(a=>a.status!=='rejected' && a.date>=ws.toISOString().slice(0,10) && a.date<=we.toISOString().slice(0,10));
  $('#kpiWeek').textContent=String(inWeek.length);
}

/* ====== Müşteriler ====== */
function renderCustomers(){
  const term=($('#custSearch')?.value||'').toLowerCase();
  const tb=$('#custTbody'); if(!tb) return;
  const rows=(lastUsers||[])
    .filter(u=>!term || (u.name||'').toLowerCase().includes(term) || (u.phone||'').toLowerCase().includes(term))
    .sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr'));
  tb.innerHTML=rows.map(u=>`
    <tr><td>${u.name||''}</td><td>${maskPhone(u.phone)||''}</td>
    <td>${u.createdAt?new Date(u.createdAt).toLocaleString():'-'}</td>
    <td>${u.lastLogin?new Date(u.lastLogin).toLocaleString():'-'}</td>
    <td><button class="btn" onclick="delUser('${u.id}')">Sil</button></td></tr>
  `).join('') || `<tr><td colspan="5" class="small">Müşteri yok</td></tr>`;
}
$('#custSearch')?.addEventListener('input',renderCustomers);
$('#custRefresh')?.addEventListener('click',renderCustomers);
window.delUser=async(id)=>{ if(!confirm('Bu müşteriyi silmek istiyor musunuz?')) return; try{ await callFn('deleteUser', { token:getAdminToken(), id }); toast('Müşteri silindi'); }catch(e){ toast('Hata: Silinemedi'); } };

/* ====== Admin • Randevular ====== */
function renderAdminAppts(list){
  const tb=$('#ap_tbody'); if(!tb) return;
  const fdate=$('#ap_fdate').value||'', fstaff=$('#ap_fstaff').value||'', fstat=$('#ap_fstatus').value||'';
  let rows=[...(list||[])];
  // Sekmeler
  const today = new Date().toISOString().slice(0,10);
  const tom = new Date(); tom.setDate(new Date().getDate()+1);
  const tomS = tom.toISOString().slice(0,10);
  const scToday = $('#sc_today')?.checked;
  const scTom   = $('#sc_tom')?.checked;
  const scWeek  = $('#sc_week')?.checked;
  if(scToday){ rows = rows.filter(a=>a.date===today); }
  else if(scTom){ rows = rows.filter(a=>a.date===tomS); }
  else if(scWeek){
    const ws=new Date(); ws.setDate(ws.getDate()-ws.getDay()+1);
    const we=new Date(ws); we.setDate(ws.getDate()+6);
    const wsS=ws.toISOString().slice(0,10), weS=we.toISOString().slice(0,10);
    rows = rows.filter(a=>a.date>=wsS && a.date<=weS);
  }
  if(fdate) rows=rows.filter(a=>a.date===fdate);
  if(fstaff) rows=rows.filter(a=>a.staffId===fstaff);
  if(fstat) rows=rows.filter(a=>a.status===fstat);
  rows.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  tb.innerHTML=rows.map(a=>{
    const act=a.status==='pending'
      ? `<button class="btn" onclick="approve('${a.id}')">Onayla</button> <button class="btn" onclick="reject('${a.id}')">Reddet</button>`
      : a.status==='approved' ? `<button class="btn" onclick="setCancelled('${a.id}')">İptal</button>` : '';
    return `<tr>
      <td><input type="checkbox" class="ap_chk" data-id="${a.id}"></td>
      <td>${a.date}</td><td>${a.time}</td>
      <td>${a.name} (${maskPhone(a.phone)})</td>
      <td>${a.serviceName||''}</td>
      <td>${a.staffName||''}</td>
      <td>${a.status}</td>
      <td class="row" style="gap:6px">${act} <button class="btn" onclick="delAppt('${a.id}')">Sil</button></td>
    </tr>`;
  }).join('') || `<tr><td colspan="8" class="small">Randevu yok</td></tr>`;
}
$('#ap_refresh').onclick=()=>renderAdminAppts(lastAppts);
$('#ap_fdate').onchange=()=>renderAdminAppts(lastAppts);
$('#ap_fstaff').onchange=()=>renderAdminAppts(lastAppts);
$('#ap_fstatus').onchange=()=>renderAdminAppts(lastAppts);
$('#ap_chkall').onchange=e=>$$('.ap_chk').forEach(c=>c.checked=e.target.checked);
$('#bulk_cancel').onclick=async()=>{const ids=$$('.ap_chk:checked').map(x=>x.dataset.id); for(const id of ids){ await setCancelled(id,true);} toast('Seçili randevular iptal edildi');}
$('#bulk_delete').onclick=async()=>{const ids=$$('.ap_chk:checked').map(x=>x.dataset.id); if(!confirm(`${ids.length} randevu silinsin mi?`)) return; for(const id of ids){ await delAppt(id); } toast('Seçili randevular silindi');}

/* ====== Admin CRUD Calls (Functions) ====== */
window.approve=async(id)=>{ await callFn('updateAppointmentStatus', { token:getAdminToken(), id, status:'approved' }); toast('Onaylandı'); };
window.reject =async(id)=>{ await callFn('updateAppointmentStatus', { token:getAdminToken(), id, status:'rejected'  }); toast('Reddedildi'); };
window.setCancelled=async(id,silent=false)=>{ await callFn('updateAppointmentStatus', { token:getAdminToken(), id, status:'cancelled' }); if(!silent) toast('İptal edildi'); };
window.delAppt=async(id)=>{ if(!confirm('Silinsin mi?')) return; await callFn('deleteAppointment', { token:getAdminToken(), id }); toast('Silindi'); };

/* ====== Admin • Ustalar/Hizmetler ====== */
function renderStaffList(){
  $('#staffList').innerHTML=(lastStaff||[]).sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr')).map(s=>`
    <li style="display:flex;gap:8px;align-items:center;margin:6px 0">
      <span style="flex:1">${s.name}</span>
      <button class="btn" onclick="delStaff('${s.id}')">Sil</button>
    </li>`).join('') || '—';
  $('#wh_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  $('#a_staff').innerHTML=lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  renderWorkEditor();
}
window.delStaff=async(id)=>{ try{await callFn('deleteStaff', { token:getAdminToken(), id }); toast('Usta silindi');}catch(e){toast('Hata: Usta silinemedi');} };
$('#addStaff').onclick=async ()=>{
  const name=$('#newStaffName').value.trim(); if(!name){toast('Usta adı gerekli');return;}
  try{
    await callFn('createStaff', { token:getAdminToken(), name });
    $('#newStaffName').value=''; toast('Usta eklendi');
  }catch(e){ toast('Hata'); }
};

function renderServiceList(){
  $('#svcList').innerHTML=(lastSvcs||[]).sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr')).map(s=>`
    <li style="display:flex;gap:8px;align-items:center;margin:6px 0">
      <span style="flex:1">${s.name} — ${s.dur} dk / ${s.price||0} TL</span>
      <button class="btn" onclick="delSvc('${s.id}')">Sil</button>
    </li>`).join('') || '—';
  $('#a_svc').innerHTML=lastSvcs.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
window.delSvc=async(id)=>{ try{await callFn('deleteService', { token:getAdminToken(), id }); toast('Hizmet silindi');}catch(e){toast('Hata: Hizmet silinemedi');} };
$('#addSvc').onclick=async ()=>{
  const name=$('#newSvcName').value.trim(), dur=parseInt($('#newSvcDur').value||'30',10), price=parseInt($('#newSvcPrice').value||'0',10);
  if(!name){toast('Hizmet adı gerekli');return;}
  try{
    await callFn('createService', { token:getAdminToken(), name, dur, price });
    $('#newSvcName').value=''; $('#newSvcDur').value=''; $('#newSvcPrice').value='';
    toast('Hizmet eklendi');
  }catch(e){ toast('Hata'); }
};

/* ====== Çalışma saatleri editörü ====== */
const DAYS=['Paz','Pzt','Sal','Çar','Per','Cum','Cmt'];
function renderWorkEditor(){
  const sid=$('#wh_staff').value || lastStaff[0]?.id; if(!sid){ $('#wh_staff').innerHTML=''; return; }
  $('#wh_staff').value=sid;
  const staff=lastStaff.find(s=>s.id===sid); if(!staff) return;
  const dayWrap=$('#wh_days'); dayWrap.innerHTML='';
  for(let i=0;i<7;i++){
    const chip=document.createElement('label'); chip.className='chip';
    const chk=document.createElement('input'); chk.type='checkbox'; chk.style.width='auto'; chk.dataset.dow=String(i);
    chk.checked=(staff.days||[1,2,3,4,5,6]).includes(i);
    chip.append(chk, document.createTextNode(' '+DAYS[i]));
    dayWrap.appendChild(chip);
  }
  const iv=$('#wh_intervals'); iv.innerHTML='';
  const by=staff.hoursByDay||{};
  for(let i=0;i<7;i++){
    const row=document.createElement('div'); row.className='row'; row.style.margin='4px 0';
    const d=by[i]||{};
    row.innerHTML=`
      <div style="min-width:60px"><b>${DAYS[i]}</b></div>
      <input type="time" data-k="open1"  data-dow="${i}" value="${d.open1||staff.hours?.open||'09:00'}" style="max-width:120px">
      <span>–</span>
      <input type="time" data-k="close1" data-dow="${i}" value="${d.close1||staff.hours?.close||'21:00'}" style="max-width:120px">
      <span style="width:12px"></span>
      <input type="time" data-k="open2"  data-dow="${i}" value="${d.open2||''}" style="max-width:120px">
      <span>–</span>
      <input type="time" data-k="close2" data-dow="${i}" value="${d.close2||''}" style="max-width:120px">`;
    iv.appendChild(row);
  }
  renderOffList(staff);
}
$('#wh_staff').addEventListener('change',renderWorkEditor);
function renderOffList(staff){
  const wrap=$('#offList'); wrap.innerHTML='';
  (staff.offDates||[]).sort().forEach(d=>{
    const chip=document.createElement('span'); chip.className='chip'; chip.textContent=d+' ';
    const b=document.createElement('button'); b.className='btn'; b.textContent='Sil';
    b.onclick=async()=>{ const list=(staff.offDates||[]).filter(x=>x!==d); await callFn('saveWorkingHours',{ token:getAdminToken(), staffId:staff.id, days:staff.days, hoursByDay:staff.hoursByDay, hours:staff.hours, offDates:list }); toast('İzin silindi'); };
    chip.appendChild(b); wrap.appendChild(chip);
  });
}
$('#addOff').onclick=async ()=>{
  const sid=$('#wh_staff').value; const staff=lastStaff.find(s=>s.id===sid); const d=$('#offDate').value; if(!d||!staff) return;
  const set=new Set(staff.offDates||[]); set.add(d);
  await callFn('saveWorkingHours',{ token:getAdminToken(), staffId:sid, days:staff.days, hoursByDay:staff.hoursByDay, hours:staff.hours, offDates:[...set] });
  toast('İzin eklendi');
};
$('#saveWorkHours').onclick=async ()=>{
  const sid=$('#wh_staff').value; if(!sid){toast('Usta seçiniz');return;}
  const staff=lastStaff.find(s=>s.id===sid); if(!staff) return;
  const days=[...document.querySelectorAll('#wh_days input[type="checkbox"]')].filter(x=>x.checked).map(x=>parseInt(x.dataset.dow,10));
  const hoursByDay={};
  $$('#wh_intervals input[type="time"]').forEach(inp=>{
    const i=parseInt(inp.dataset.dow,10); const k=inp.dataset.k; hoursByDay[i]=hoursByDay[i]||{}; hoursByDay[i][k]=inp.value||'';
  });
  const hours={open:hoursByDay[1]?.open1||'09:00',close:hoursByDay[1]?.close1||'21:00'};
  try{
    await callFn('saveWorkingHours', { token:getAdminToken(), staffId:sid, days, hoursByDay, hours });
    $('#wh_status').textContent='Kaydedildi.'; toast('Çalışma saatleri kaydedildi'); computeSlots(); renderAdminSlots(); if(_rs) computeResched();
  }catch(e){ toast('Hata: Çalışma saatleri kaydedilemedi'); }
};

/* ====== Admin’den randevu ====== */
function renderAdminSlots(){
  const sId=$('#a_staff').value, vId=$('#a_svc').value, d=$('#a_date').value;
  const box=$('#a_slots'); box.innerHTML='';
  if(!sId||!vId||!d) return;
  const s=lastStaff.find(x=>x.id===sId), v=lastSvcs.find(x=>x.id===vId); if(!s||!v) return;
  renderGrid('a_slots', s, v.dur||30, d);
}
$('#a_staff').addEventListener('change',renderAdminSlots);
$('#a_svc').addEventListener('change',renderAdminSlots);
$('#a_date').addEventListener('change',renderAdminSlots);
$('#a_date').value=new Date().toISOString().slice(0,10);

$('#a_create').onclick=async ()=>{
  const name=$('#a_name').value.trim(), phoneRaw=$('#a_phone').value.trim();
  const staffId=$('#a_staff').value, svcId=$('#a_svc').value, date=$('#a_date').value, time=getSelected('a_slots');
  const auto=$('#a_auto').checked;
  if(!name||!phoneRaw||!staffId||!svcId||!date||!time){ $('#a_status').textContent='Eksik bilgi'; toast('Eksik bilgi'); return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);
  try{
    await callFn('adminCreateAppointment', { token:getAdminToken(), name, phone, staffId, serviceId:svcId, date, time, autoApprove:auto });
    $('#a_status').textContent=auto?'Oluşturuldu (onaylı)':'Oluşturuldu (beklemede)'; toast('Admin randevu eklendi');
  }catch(e){ $('#a_status').textContent='Hata'; }
};

/* ====== Takvime ekleme ====== */
function buildEventPayload(a){
  const title=`${a.serviceName} - ${a.staffName||'Berber'}`;
  const desc=`Müşteri: ${a.name} (${maskPhone(a.phone)})
Hizmet: ${a.serviceName}
Berber: ${a.staffName||'-'}
Tarih: ${a.date} ${a.time}
Süre: ${a.duration||30} dk`;
  const location='Ahmet Tekeli Erkek Kuaförü';
  const tz='Europe/Istanbul';
  const [hh,mm]=a.time.split(':').map(Number);
  const start=new Date(a.date+'T00:00:00'); start.setHours(hh,mm,0,0);
  const end=new Date(start.getTime()+(a.duration||30)*60000);
  const ymd = d=>`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}${String(d.getSeconds()).padStart(2,'0')}`;
  return {title,desc,location,tz,gStart:ymd(start),gEnd:ymd(end),start,end};
}
function openGoogleCalendar(a){
  const p=buildEventPayload(a);
  const url='https://calendar.google.com/calendar/render?action=TEMPLATE'
    +'&text='+encodeURIComponent(p.title)
    +'&dates='+encodeURIComponent(`${p.gStart}/${p.gEnd}`)
    +'&details='+encodeURIComponent(p.desc)
    +'&location='+encodeURIComponent(p.location)
    +'&ctz='+encodeURIComponent(p.tz);
  window.open(url,'_blank');
}
function downloadICS(a){
  const p=buildEventPayload(a);
  const dt=d=>`${d.getUTCFullYear()}${String(d.getUTCMonth()+1).padStart(2,'0')}${String(d.getUTCDate()).padStart(2,'0')}${String(d.getUTCHours()).padStart(2,'0')}${String(d.getUTCMinutes()).padStart(2,'0')}${String(d.getUTCSeconds()).padStart(2,'0')}Z`;
  const uid=`${a.id||Math.random().toString(36).slice(2)}@ahmettekeli`;
  const ics=`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//AhmetTekeli//Randevu//TR
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dt(new Date())}
DTSTART:${dt(p.start)}
DTEND:${dt(p.end)}
SUMMARY:${p.title}
DESCRIPTION:${p.desc.replace(/\n/g,'\\n')}
LOCATION:${p.location}
END:VEVENT
END:VCALENDAR`;
  const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'}); const aEl=document.createElement('a');
  aEl.href=URL.createObjectURL(blob); aEl.download=`randevu_${a.date}_${a.time.replace(':','')}.ics`; document.body.appendChild(aEl); aEl.click(); setTimeout(()=>{URL.revokeObjectURL(aEl.href); aEl.remove();},0);
}

/* ====== Müşteri randevularım ====== */
function renderMy(list){
  const tb=$('#my_tbody'); if(!tb) return;
  if(!currentUser){ tb.innerHTML='<tr><td colspan="6" class="small">Lütfen müşteri girişi yapın.</td></tr>'; return; }
  const today=new Date().toISOString().slice(0,10);
  let rows=(list||[]).filter(a=>a.phone===currentUser.phone);
  const f=$('#my_filter').value||'upcoming';
  if(f==='upcoming') rows=rows.filter(a=>a.date>=today);
  else if(f==='past') rows=rows.filter(a=>a.date<today);
  rows.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  tb.innerHTML=rows.map(a=>{
    const canCancel=(a.status==='pending'||a.status==='approved');
    return `<tr>
      <td>${a.date}</td><td>${a.time}</td><td>${a.serviceName||''}</td><td>${a.staffName||''}</td>
      <td>${a.status}</td>
      <td class="row" style="gap:6px">
        <button class="btn" onclick="openResched('${a.id}')">Değiştir</button>
        ${canCancel?`<button class="btn" onclick="cancelMine('${a.id}')">İptal</button>`:''}
        <button class="btn" onclick='(function(){openGoogleCalendar(${JSON.stringify({id:'__',date:'__D',time:'__T',duration:0,serviceName:a.serviceName,staffName:a.staffName,name:a.name,phone:a.phone})}).toString})()'>Google</button>
        <button class="btn" onclick='(function(){downloadICS(${JSON.stringify({id:a.id,date:a.date,time:a.time,duration:a.duration,serviceName:a.serviceName,staffName:a.staffName,name:a.name,phone:a.phone})})})()'>ICS</button>
      </td>
    </tr>`.replace('"__D"',`"${a.date}"`).replace('"__T"',`"${a.time}"`);
  }).join('') || '<tr><td colspan="6" class="small">Randevu yok</td></tr>';
}
$('#my_filter').onchange=()=>renderMy(lastAppts);
$('#my_refresh').onclick=()=>renderMy(lastAppts);
window.cancelMine=async(id)=>{if(!confirm('İptal edilsin mi?'))return;try{await callFn('cancelMyAppointment',{id,phone:currentUser?.phone});toast('İptal edildi');}catch(e){toast('Hata');}}

/* ====== Değiştir ====== */
async function openResched(id){
  if(!currentUser) return;
  const doc=await db.collection('appts').doc(id).get(); if(!doc.exists) return toast('Bulunamadı');
  const a=doc.data(); if(a.phone!==currentUser.phone) return toast('Yetkisiz');
  _rs={id,staffId:a.staffId,duration:a.duration,date:a.date,name:a.name,phone:a.phone,serviceName:a.serviceName,staffName:a.staffName};
  $('#rs_date').value=a.date; computeResched(); sheet.show('#sheetResched');
}
function computeResched(){
  if(!_rs) return;
  const staff=lastStaff.find(s=>s.id===_rs.staffId); if(!staff) return;
  renderGrid('rs_grid',staff,_rs.duration,_rs.date);
}
$('#rs_date').onchange=()=>{ if(_rs){ _rs.date=$('#rs_date').value; computeResched(); } };
$('#rs_cancel').onclick=()=>{_rs=null; sheet.hide('#sheetResched');}
$('#rs_save').onclick=async ()=>{
  if(!_rs) return;
  const time=getSelected('rs_grid'); if(!time){ $('#rs_status').textContent='Saat seçin'; return; }
  try{ await callFn('rescheduleMyAppointment',{id:_rs.id,phone:currentUser?.phone,date:_rs.date,time}); toast('Güncellendi (Beklemede)'); _rs=null; sheet.hide('#sheetResched'); }catch(e){toast('Hata');}
};

/* ====== Admin Auth ====== */
$('#adminLoginBtn').onclick=async()=>{
  const phone=($('#adminPhone').value||'').trim(), pass=($('#adminPass').value||'').trim();
  if(!phone||!pass){ $('#adminStatus').textContent='Telefon ve şifre gerekli.'; return; }
  try{
    const r=await callFn('adminLogin',{phone,pass});
    setAdmin(true); setAdminToken(r?.token||null);
    $('#adminStatus').textContent='Giriş başarılı'; sheet.hide('#sheetAdmin'); toast('Yönetici girişi yapıldı');
    ensureFcm();
  }catch(e){ $('#adminStatus').textContent=e?.message||'Giriş başarısız'; }
};
$('#adminLogoutBtn').onclick=async()=>{
  try{ const tok=getAdminToken(); if(tok) await callFn('adminLogout',{token:tok}); }catch{}
  setAdmin(false); setAdminToken(null); $('#adminStatus').textContent='Çıkış yapıldı'; toast('Yönetici çıkış yaptı');
};
$('#adm_change').onclick=async()=>{
  if(!adminOn){ $('#adm_status').textContent='Önce yönetici girişi yapın.'; return; }
  const old=($('#adm_old').value||'').trim(), nw=($('#adm_new').value||'').trim();
  if(nw.length<6){ $('#adm_status').textContent='Yeni şifre en az 6 karakter.'; return; }
  try{
    await callFn('changeAdminPassword',{token:getAdminToken(),oldPass:old,newPass:nw});
    $('#adm_status').textContent='Şifre güncellendi.'; toast('Yönetici şifresi değiştirildi');
    $('#adm_old').value=''; $('#adm_new').value='';
  }catch(e){ $('#adm_status').textContent=e?.message||'Hata'; }
};

/* ====== Müşteri Giriş/Kayıt + Unuttum ====== */
async function sha256(s){ const enc=new TextEncoder().encode(s); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
$('#c_login').onclick=async ()=>{
  const name=$('#c_name').value.trim(), phoneRaw=$('#c_phone').value.trim(), pass=($('#c_pass').value||'').trim();
  if(!name||!phoneRaw||!pass){ $('#c_status').textContent='Ad/Telefon/Şifre gerekli.'; return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);
  try{
    // Basit upsert: Functions tarafında zaten kullanıcı güncelleniyor.
    currentUser={name,phone}; store.set('custSession',currentUser); setCust(true);
    myPrevStatus={}; lastAppts.filter(a=>a.phone===phone).forEach(a=>myPrevStatus[a.id]=a.status);
    $('#c_status').textContent='Giriş/Kayıt başarılı.'; toast('Müşteri girişi'); setTimeout(()=>sheet.hide('#sheetCust'),300);
    $('#f_name').value=name; $('#f_phone').value=phone.replace('+90','0');
    ensureFcm();
  }catch(e){ console.error(e); $('#c_status').textContent='Sunucu hatası'; }
};
$('#c_forgot').onclick=async()=>{
  const name=$('#c_name').value.trim(), phoneRaw=$('#c_phone').value.trim();
  if(!name||!phoneRaw){ $('#c_status').textContent='Ad ve Telefon gerekli.'; return; }
  const phone=phoneRaw.startsWith('+')?phoneRaw.replace(/\s/g,''):(phoneRaw.startsWith('05')?'+90'+phoneRaw.slice(1):phoneRaw);
  try{
    await callFn('requestPasswordReset',{name,phone});
    $('#c_status').textContent='Şifre sıfırlama isteğiniz iletildi. Onay sonrası bilgilendirileceksiniz.';
    toast('Şifre sıfırlama talebi alındı');
  }catch(e){ $('#c_status').textContent=e?.message||'Hata'; }
};

/* ====== Haftalık Takvim + Analitik ====== */
function mondayOf(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
function ymd(d){ return d.toISOString().slice(0,10); }
function fillWeekSelectors(){
  const staffSel=$('#wk_staff'), svcSel=$('#wk_service');
  if(staffSel){ staffSel.innerHTML='<option value="">Tüm Berberler</option>'+lastStaff.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); }
  if(svcSel){ svcSel.innerHTML='<option value="">Tüm Hizmetler</option>'+lastSvcs.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); }
  if($('#wk_ref') && !$('#wk_ref').value) $('#wk_ref').value = new Date().toISOString().slice(0,10);
}
function renderWeekly(){
  const refStr=$('#wk_ref').value||new Date().toISOString().slice(0,10);
  const staffId=$('#wk_staff').value||'';
  const svcId=$('#wk_service').value||'';
  const ref=new Date(refStr+'T00:00:00');
  const mon=mondayOf(ref);
  const days=[0,1,2,3,4,5,6].map(i=>{const d=new Date(mon); d.setDate(mon.getDate()+i); return d;});
  const head=$('#wk_head');
  head.innerHTML='<tr><th>Saat</th>'+days.map(d=>`<th>${d.toLocaleDateString('tr-TR',{weekday:'short', day:'2-digit', month:'2-digit'})}</th>`).join('')+'</tr>';
  const body=$('#wk_body'); const rows=[];
  for(let m=9*60; m<=21*60-30; m+=30){
    const hh=String(Math.floor(m/60)).padStart(2,'0'), mm=String(m%60).padStart(2,'0');
    const label=`${hh}:${mm}`;
    const tds=days.map(d=>{
      const date=ymd(d);
      let dayAppts=lastAppts.filter(a=>a.date===date);
      if(staffId) dayAppts=dayAppts.filter(a=>a.staffId===staffId);
      if(svcId)   dayAppts=dayAppts.filter(a=>a.serviceId===svcId);
      const busy = dayAppts.some(a=>{
        const start=toMin(a.time), end=start+(a.duration||30);
        return overlaps(m, m+30, start, end) && a.status!=='cancelled' && a.status!=='rejected';
      });
      const own  = dayAppts.find(a=>toMin(a.time)===m && (a.status==='approved'||a.status==='pending'));
      const cls  = busy ? (own?.status==='approved'?'slot sel':'slot busy') : 'slot';
      const txt  = own ? `${own.staffName||''} • ${own.serviceName||''}` : '';
      return `<td title="${txt}"><div class="${cls}" style="padding:8px 6px">${label}${own?'<br><span class="small">'+txt+'</span>':''}</div></td>`;
    }).join('');
    rows.push(`<tr><td>${label}</td>${tds}</tr>`);
  }
  body.innerHTML=rows.join('');
}
$('#wk_refresh')?.addEventListener('click', renderWeekly);
$('#wk_ref')?.addEventListener('change', renderWeekly);
$('#wk_staff')?.addEventListener('change', renderWeekly);
$('#wk_service')?.addEventListener('change', renderWeekly);

function renderAnalytics(){
  const now=new Date(); const start=new Date(now); start.setDate(now.getDate()-30);
  const range=lastAppts.filter(a=>a.date && a.date>=ymd(start) && a.date<=ymd(now));
  const total=range.length;
  const approved=range.filter(a=>a.status==='approved').length;
  const pending =range.filter(a=>a.status==='pending').length;
  const cancelled=range.filter(a=>a.status==='cancelled').length;
  $('#an_total').textContent=String(total);
  $('#an_obi').textContent=`${approved}/${pending}/${cancelled}`;
  const svcCount={}; range.forEach(a=>{ if(!a.serviceName) return; svcCount[a.serviceName]=(svcCount[a.serviceName]||0)+1; });
  const topSvc=Object.entries(svcCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
  $('#an_top_svc').textContent=topSvc;
  const stCount={}; range.forEach(a=>{ if(!a.staffName) return; stCount[a.staffName]=(stCount[a.staffName]||0)+1; });
  const topStaff=Object.entries(stCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';
  $('#an_top_staff').textContent=topStaff;
  drawBarChart('#an_hours', (function(){ const h=new Array(24).fill(0); range.forEach(a=>{ if(!a.time) return; const hh=parseInt(a.time.slice(0,2),10); if(!isNaN(hh)) h[hh]++; }); return h; })());
}
function drawBarChart(sel, data){
  const c=document.querySelector(sel); if(!c) return; const ctx=c.getContext('2d');
  const W=c.width, H=c.height; ctx.clearRect(0,0,W,H);
  const max=Math.max(1, ...data);
  const padL=30, padB=20, padT=10, padR=10;
  const plotW=W-padL-padR, plotH=H-padT-padB;
  const bw=plotW/data.length;
  ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(padL, padT); ctx.lineTo(padL, H-padB); ctx.lineTo(W-padR, H-padB); ctx.stroke();
  ctx.fillStyle='#111827';
  data.forEach((v,i)=>{ const x=padL+i*bw+2; const h=(v/max)*plotH; const y=H-padB-h; ctx.fillRect(x, y, bw-4, h); });
  ctx.fillStyle='#6b7280'; ctx.font='11px Inter,system-ui';
  [0,6,12,18,23].forEach(hh=>{ const x=padL+hh*bw; ctx.fillText(String(hh), x, H-6); });
}
function refreshMgmtExtras(){ fillWeekSelectors(); renderWeekly(); renderAnalytics(); }

/* ====== Boot ====== */
(function boot(){
  $('#f_date').value=new Date().toISOString().slice(0,10);
  if(currentUser){ $('#f_name').value=currentUser.name||''; $('#f_phone').value=(currentUser.phone||'').replace('+90','0'); setCust(true); }
  $('#ap_fdate').value=new Date().toISOString().slice(0,10);
  if($('#wk_ref')) $('#wk_ref').value = new Date().toISOString().slice(0,10);

  // Admin token varsa görünürlük
  if(getAdminToken()){ setAdmin(true); }

  // Bildirim paneli kısa yol
  if(location.hash==='#admin'){ sheet.show('#sheetAdmin'); }
  ensureFcm();
})();

/* ====== Appts snapshot sonrasında admin bildirim sayacı ====== */
function onApptsChanged(){ updateBell(lastAppts); }
</script>
</body>
</html>
