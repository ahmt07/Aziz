<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ahmet Tekeli â€” Randevu Sistemi</title>
<style>
:root{--bg:#eef0f3;--card:#fff;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--gold:#d4af37}
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg);-webkit-font-smoothing:antialiased}
a{color:inherit;text-decoration:none}
.container{max-width:1200px;margin:16px auto;padding:12px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{font-family:"Playfair Display",serif;font-weight:700;font-size:28px;text-align:center;line-height:1.1}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:#fff;border:1px solid var(--line);padding:8px 12px;border-radius:10px;cursor:pointer}
.btn-primary{background:var(--gold);border-color:var(--gold);color:#111;font-weight:700}
.badge{background:#ef4444;color:#fff;border-radius:999px;padding:2px 8px;font-weight:700;font-size:12px}
.layout{display:flex;gap:16px;margin-top:12px}
#sidebar{width:260px;background:#111827;color:#fff;border-radius:12px;padding:16px;flex:0 0 260px}
#sidebar nav a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;margin-bottom:6px}
#sidebar nav a.active{background:rgba(255,255,255,.06)}
.main{flex:1;min-width:0}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:12px}
.form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
label{display:block;font-weight:700;margin-bottom:6px}
input,select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#fff;font-size:15px}
.small{font-size:13px;color:var(--muted)}
.slots{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.slot{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
.slot.sel{background:#111827;color:#fff;border-color:#111827}
.table-scroll{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left}
.grid-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
.footer{color:var(--muted);text-align:center;padding:18px 0;font-size:13px}
.badge-soft{display:inline-flex;align-items:center;gap:6px;font-size:12px;background:#f3f4f6;border:1px solid var(--line);border-radius:999px;padding:4px 8px}

/* MOBILE */
@media (max-width:900px){
  .layout{flex-direction:column}
  #sidebar{display:none}
  .form-row{grid-template-columns:1fr}
  input,select{font-size:16px}
}

/* ADMIN gÃ¶rÃ¼nÃ¼mÃ¼: istatistikleri yalnÄ±z admin gÃ¶rÃ¼r */
#statsArea{display:none}
body.admin #statsArea{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}

/* ==== Animasyonlu Modallar / Sheet / Drawer ==== */
.app-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0);display:none;z-index:90}
.app-backdrop.show{display:block;animation:bd-in .3s ease forwards}
@keyframes bd-in{to{background:rgba(0,0,0,.45)}}
@keyframes bd-out{to{background:rgba(0,0,0,0)}}

/* Bottom sheet (MÃ¼ÅŸteri) */
.sheet{position:fixed;left:0;right:0;bottom:-100%;z-index:100;background:#fff;border-radius:16px 16px 0 0;box-shadow:0 -12px 28px rgba(0,0,0,.25);max-height:84vh;overflow:auto;padding:16px}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes slideDown{from{transform:translateY(0)}to{transform:translateY(100%)}}
.sheet.show{animation:slideUp .28s ease forwards}
.sheet.hide{animation:slideDown .25s ease forwards}

/* Admin login kartÄ± */
.modal-card{position:fixed;inset:0;display:none;z-index:100;align-items:center;justify-content:center}
.modal-card.show{display:flex}
.card-modal{width:min(92%,420px);background:#fff;border-radius:14px;padding:22px;box-shadow:0 10px 28px rgba(0,0,0,.22)}

/* Drawer (sol menÃ¼) */
.drawer{position:fixed;top:0;left:-290px;width:280px;height:100vh;background:#0b1220;color:#fff;box-shadow:12px 0 24px rgba(0,0,0,.25);z-index:110;display:flex;flex-direction:column}
.drawer.show{left:0;transition:left .28s ease}
.drawer a{display:flex;align-items:center;gap:10px;padding:12px 14px;color:#e5e7eb;text-decoration:none;border-bottom:1px solid rgba(255,255,255,.06)}
.drawer a:hover{background:rgba(255,255,255,.06)}
.drawer .top{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.1)}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">AHMET TEKELÄ°<br><span class="small">Erkek KuafÃ¶rÃ¼</span></div>
    <div class="controls">
      <button id="bellBtn" class="btn" title="Bildirimler">ğŸ”” <span id="bellCount" class="badge">0</span></button>
      <button id="adminBtn" class="btn">Admin GiriÅŸi</button>
      <button id="userBtn" class="btn">MÃ¼ÅŸteri GiriÅŸi</button>
    </div>
  </header>

  <div class="layout">
    <!-- Sidebar (admin only; drawer ayrÄ±ca var) -->
    <aside id="sidebar" class="card" style="display:none">
      <nav id="sideNav"></nav>
    </aside>

    <main class="main">
      <!-- Ãœst kart + istatistikler (yalnÄ±z admin) -->
      <section id="topCard" class="card" style="display:flex;align-items:center;gap:18px;flex-wrap:wrap">
        <div style="width:96px;height:96px;border-radius:999px;background:#fff;display:flex;align-items:center;justify-content:center;border:6px solid #fff;box-shadow:0 8px 30px rgba(0,0,0,.12)">
          <img id="logoImg" alt="logo" style="width:72px;height:72px;border-radius:999px;display:block" />
        </div>
        <div style="flex:1;min-width:220px">
          <h2 style="margin:0">AHMET TEKELÄ°</h2>
          <div class="small">Erkek KuafÃ¶rÃ¼ â€¢ <span id="rating">â­ 4.9 (161)</span></div>
        </div>
        <div id="statsArea"></div>
      </section>

      <!-- Ana form -->
      <section class="card">
        <form id="apptForm">
          <div class="form-row">
            <div>
              <label>Ad Soyad</label>
              <input id="f_name" placeholder="AdÄ±nÄ±z ve SoyadÄ±nÄ±z" autocomplete="name">
            </div>
            <div>
              <label>Telefon</label>
              <input id="f_phone" placeholder="05xxxxxxxxx" inputmode="tel" autocomplete="tel">
            </div>

            <div>
              <label>Berber SeÃ§imi</label>
              <select id="f_staff"></select>
            </div>
            <div>
              <label>Hizmet SeÃ§imi</label>
              <select id="f_service"></select>
            </div>

            <div>
              <label>Tarih</label>
              <input id="f_date" type="date">
            </div>
          </div>

          <div style="margin-top:12px">
            <div class="small">Uygun Saatler</div>
            <div id="slots" class="slots"></div>
          </div>

          <div style="display:flex;gap:12px;margin-top:14px;align-items:center;flex-wrap:wrap">
            <button id="bookBtn" class="btn btn-primary" type="button">RANDEVU AL</button>
            <button id="forgotPin" class="btn" type="button">Åifremi Unuttum</button>
            <div id="formMsg" class="small"></div>
          </div>
        </form>
      </section>

      <!-- RandevularÄ±m -->
      <section id="myAppts" class="card">
        <h3>RandevularÄ±m</h3>
        <div class="table-scroll">
          <table>
            <thead><tr><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
            <tbody id="myApptTbody"></tbody>
          </table>
        </div>
      </section>

      <div class="footer">Â© Ahmet Tekeli Erkek KuafÃ¶rÃ¼ â€¢ Randevu Sistemi</div>
    </main>
  </div>
</div>

<!-- ======= Backdrops ======= -->
<div id="userBackdrop"  class="app-backdrop"></div>
<div id="adminBackdrop" class="app-backdrop"></div>
<div id="drawerBackdrop" class="app-backdrop"></div>

<!-- ======= MÃ¼ÅŸteri Sheet (Animasyonlu) ======= -->
<div id="userSheet" class="sheet" aria-modal="true" role="dialog">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <b>ğŸ‘¤ MÃ¼ÅŸteri</b>
    <button class="btn" id="userCloseBtn">Kapat</button>
  </div>
  <div style="display:flex;gap:6px;margin:10px 0">
    <button class="btn" id="tabUserLogin" style="flex:1">GiriÅŸ Yap</button>
    <button class="btn" id="tabUserReg"   style="flex:1">KayÄ±t Ol</button>
  </div>

  <!-- GiriÅŸ -->
  <div id="userPaneLogin">
    <label>Telefon</label>
    <input id="lg_phone" placeholder="05xxxxxxxxx" inputmode="tel" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;margin:4px 0 8px">
    <label>PIN (4 hane)</label>
    <input id="lg_pin" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric" maxlength="4" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;margin:4px 0 12px">
    <div style="display:flex;gap:8px">
      <button id="doUserLogin" class="btn btn-primary" style="flex:1">GiriÅŸ</button>
      <button id="doUserForgot" class="btn" style="flex:1">Åifremi Unuttum</button>
    </div>
    <p id="lg_msg" class="small" style="margin-top:8px"></p>
  </div>

  <!-- KayÄ±t -->
  <div id="userPaneReg" style="display:none">
    <label>Ad Soyad</label>
    <input id="rg_name" placeholder="AdÄ±nÄ±z ve SoyadÄ±nÄ±z" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;margin:4px 0 8px">
    <label>Telefon</label>
    <input id="rg_phone" placeholder="05xxxxxxxxx" inputmode="tel" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;margin:4px 0 8px">
    <label>PIN (4 hane)</label>
    <input id="rg_pin" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric" maxlength="4" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;margin:4px 0 12px">
    <button id="doUserRegister" class="btn btn-primary" style="width:100%">KayÄ±t Ol</button>
    <p id="rg_msg" class="small" style="margin-top:8px"></p>
  </div>
</div>

<!-- ======= Admin Login (Animasyonlu Kart) ======= -->
<div id="adminModal" class="modal-card" aria-modal="true" role="dialog">
  <div class="card-modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <b>ğŸ”‘ YÃ¶netici GiriÅŸi</b>
      <button class="btn" id="adminCloseBtn">Kapat</button>
    </div>
    <label>Admin Telefon</label>
    <input id="ad_phone" value="+905356749243" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;margin:4px 0 8px">
    <label>Admin Åifre</label>
    <input id="ad_pass" type="password" placeholder="********" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;margin:4px 0 12px">
    <div style="display:flex;gap:8px">
      <button id="doAdminLogin"  class="btn btn-primary" style="flex:1">GiriÅŸ Yap</button>
      <button id="doAdminLogout" class="btn"            style="flex:1">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
    <label class="small" style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <input id="autoApprove" type="checkbox" style="width:auto"> Admin eklediÄŸinde otomatik onayla
    </label>
  </div>
</div>

<!-- ======= Admin Drawer (Sol MenÃ¼) ======= -->
<nav id="adminDrawer" class="drawer" aria-label="YÃ¶netim MenÃ¼sÃ¼">
  <div class="top">
    <b>âš™ï¸ YÃ¶netim</b>
    <button class="btn" id="drawerCloseBtn">Geri</button>
  </div>
  <a data-pane="queue">ğŸ  Onay KuyruÄŸu</a>
  <a data-pane="calendar">ğŸ“… GÃ¼nlÃ¼k Takvim</a>
  <a data-pane="new">ğŸ†• Yeni Randevu</a>
  <a data-pane="customers">ğŸ‘¥ MÃ¼ÅŸteriler</a>
  <a data-pane="staff">ğŸ’ˆ Ustalar</a>
  <a data-pane="services">ğŸ§° Hizmetler & Ayarlar</a>
  <a data-pane="pin">ğŸ”‘ PIN Talepleri</a>
  <a data-pane="reports">ğŸ“Š Raporlar</a>
  <a data-pane="hours">ğŸ•˜ Ã‡alÄ±ÅŸma Saatleri</a>
</nav>

<!-- ======= Admin Panel Ä°Ã§erikleri (Modal iÃ§inde) ======= -->
<div id="adminPanel" style="display:none;position:fixed;inset:0;z-index:120;align-items:center;justify-content:center">
  <div style="width:92%;max-width:1100px;background:#fff;border-radius:12px;padding:16px;position:relative;max-height:92vh;overflow:auto;box-shadow:0 10px 28px rgba(0,0,0,.2)">
    <button id="closeAdminPanel" style="position:absolute;right:12px;top:12px" class="btn">Kapat</button>
    <h3 id="adminPanelTitle" style="margin-top:0">Panel</h3>
    <div id="adminPanelBody"></div>
  </div>
</div>

<script>
/* ========= Basit store ========= */
(function(){
  const mem={};
  window.store={
    get(k,d){try{const v=localStorage.getItem(k);if(v!==null)return JSON.parse(v);return mem.hasOwnProperty(k)?mem[k]:d}catch(e){return mem.hasOwnProperty(k)?mem[k]:d}},
    set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){mem[k]=v}},
    del(k){try{localStorage.removeItem(k)}catch(e){delete mem[k]}}
  };
})();

/* ========= VarsayÄ±lan seed ========= */
if(!store.get('settings')) store.set('settings',{open:"09:00",close:"21:00",slot:30,adminAutoApprove:true});
if(!store.get('services')) store.set('services',[
  {id:'s1',name:'SaÃ§ Kesimi',dur:30,price:150},
  {id:'s2',name:'Sakal TÄ±raÅŸÄ±',dur:20,price:100},
  {id:'s3',name:'SaÃ§ + Sakal',dur:45,price:220}
]);
if(!store.get('staff')) store.set('staff',[
  {id:'st1',name:'Efe KARA',days:[1,2,3,4,5,6],hours:{open:'09:00',close:'21:00'},offDates:[]},
  {id:'st2',name:'Ozan YILMAZ',days:[1,2,3,4,5,6],hours:{open:'09:00',close:'21:00'},offDates:[]}
]);
if(!store.get('users')) store.set('users',[]);
if(!store.get('appts')) store.set('appts',[]);
if(!store.get('pinReqs')) store.set('pinReqs',[]);

/* ========= Sabitler ========= */
const ADMIN_PHONE_E164 = '+905356749243';
const ADMIN_PASSWORD   = 'ahmet07';
const LS_USER_SESSION  = 'userSession';
const LS_ADMIN_SESSION = 'adminSession';

/* ========= YardÄ±mcÄ±lar ========= */
const uuid = ()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const todayISO = ()=>new Date().toISOString().slice(0,10);
const pad2 = n=>String(n).padStart(2,'0');
const toMin = t=>{const [h,m]=t.split(':').map(Number);return h*60+m};
const toHHMM = m=>`${pad2(Math.floor(m/60))}:${pad2(m%60)}`;
function phoneNormalize(raw){
  if(!raw) return '';
  const only = String(raw).replace(/\D/g,'');
  if(only.length===10 && only.startsWith('5')) return '+90'+only;
  if(only.length===11 && only.startsWith('90')) return '+'+only;
  if(raw.startsWith('+')) return raw;
  return '+90'+only;
}
const DAY_LABELS=['Paz','Pzt','Sal','Ã‡ar','Per','Cum','Cmt'];

/* ========= Bildirim Ã§anÄ± ========= */
const bellCountEl = document.getElementById('bellCount');
function updateBell(){
  const pending=(store.get('appts',[])||[]).filter(a=>a.status==='pending').length;
  const pin=(store.get('pinReqs',[])||[]).length;
  bellCountEl.textContent=String(pending+pin);
}

/* ========= Select/Slot ========= */
function renderSelects(){
  const services=(store.get('services',[])||[]).slice().sort((a,b)=>a.name.localeCompare(b.name,'tr'));
  const staff=(store.get('staff',[])||[]).slice().sort((a,b)=>a.name.localeCompare(b.name,'tr'));
  document.getElementById('f_service').innerHTML='<option value="">â€” Hizmet seÃ§ â€”</option>'+services.map(s=>`<option value="${s.id}">${s.name} â€” ${s.price} TL</option>`).join('');
  document.getElementById('f_staff').innerHTML='<option value="">â€” Berber seÃ§ â€”</option>'+staff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
function staffWorksThatDay(staff,dateISO){const dow=new Date(dateISO+'T00:00:00').getDay();return (staff.days||[1,2,3,4,5,6]).includes(dow);}
function isOffDate(staff,dateISO){return (staff.offDates||[]).includes(dateISO)}
function conflicts(date,staffId){
  return (store.get('appts',[])||[]).filter(a=>a.date===date&&a.staffId===staffId&&a.status!=='cancelled'&&a.status!=='rejected')
    .map(a=>({start:toMin(a.time),end:toMin(a.time)+a.duration}));
}
function overlaps(aS,aE,bS,bE){return aS<bE && aE>bS}
function getHoursFor(staff,dateISO){
  const s=store.get('settings');
  if(staff?.hours?.open&&staff?.hours?.close) return {open:staff.hours.open,close:staff.hours.close};
  return {open:s.open,close:s.close};
}
function renderSlots(){
  const box=document.getElementById('slots'); box.innerHTML='';
  const svc=(store.get('services',[])||[]).find(x=>x.id===document.getElementById('f_service').value);
  const staff=(store.get('staff',[])||[]).find(x=>x.id===document.getElementById('f_staff').value);
  const date=document.getElementById('f_date').value;
  if(!svc||!staff||!date) return;
  const {open,close}=getHoursFor(staff,date);
  const works=staffWorksThatDay(staff,date); const closed=isOffDate(staff,date);
  const openM=toMin(open), closeM=toMin(close), step=store.get('settings').slot||30;
  const dur=svc.dur;
  const taken=conflicts(date,staff.id);
  for(let t=openM;t+dur<=closeM;t+=step){
    const disabled= !works || closed || taken.some(x=>overlaps(t,t+dur,x.start,x.end));
    const b=document.createElement('button');
    b.type='button'; b.className='slot'+(disabled?' dis':''); b.textContent=toHHMM(t); b.dataset.time=toHHMM(t);
    b.disabled=disabled;
    b.addEventListener('click',()=>{ if(disabled) return; document.querySelectorAll('.slot').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); });
    box.appendChild(b);
  }
}
['f_staff','f_service','f_date'].forEach(id=>document.getElementById(id).addEventListener('change',renderSlots));

/* ========= Randevu Alma (mÃ¼ÅŸteri 2/ gÃ¼n limiti) ========= */
function countActiveForPhoneOnDate(phone,date){
  const appts=store.get('appts')||[];
  return appts.filter(a=>a.phone===phone && a.date===date && (a.status==='pending'||a.status==='approved')).length;
}
document.getElementById('bookBtn').addEventListener('click',()=>{
  const name=(document.getElementById('f_name').value||'').trim();
  const phoneRaw=(document.getElementById('f_phone').value||'').trim();
  const svc=(store.get('services',[])||[]).find(x=>x.id===document.getElementById('f_service').value);
  const staff=(store.get('staff',[])||[]).find(x=>x.id===document.getElementById('f_staff').value);
  const date=document.getElementById('f_date').value;
  const timeBtn=document.querySelector('#slots .slot.sel');
  const msg=document.getElementById('formMsg');
  if(!name||!phoneRaw||!svc||!staff||!date||!timeBtn){msg.textContent='Eksik bilgi';return;}
  const phone=phoneNormalize(phoneRaw);
  if(countActiveForPhoneOnDate(phone,date)>=2){msg.textContent='AynÄ± gÃ¼n iÃ§in en fazla 2 aktif randevu alabilirsiniz.';return;}
  const time=timeBtn.dataset.time, duration=svc.dur;
  const taken=conflicts(date,staff.id); const start=toMin(time), end=start+duration;
  if(taken.some(x=>overlaps(start,end,x.start,x.end)) || !staffWorksThatDay(staff,date) || isOffDate(staff,date)){msg.textContent='SeÃ§ilen saat uygun deÄŸil'; renderSlots(); return;}
  const appts=store.get('appts',[])||[];
  appts.push({id:uuid(),userId:phone,name,phone,serviceId:svc.id,serviceName:svc.name,staffId:staff.id,staffName:staff.name,date,time,duration,status:'pending',createdAt:Date.now()});
  store.set('appts',appts);
  setCurrentUserSession({id:phone,name,phone});
  msg.textContent='Randevu oluÅŸturuldu (Onay Bekliyor)';
  renderQueue(); renderCalendar(); loadMyAppts(); updateBell();
});
document.getElementById('forgotPin').addEventListener('click',()=>{
  const phoneRaw=prompt('Telefon (05xxxxxxxxx):'); if(!phoneRaw) return;
  const e164 = phoneNormalize(phoneRaw);
  const newPin=prompt('Yeni PIN (4 hane):'); if(!newPin||!/^\d{4}$/.test(newPin)) return alert('4 haneli PIN giriniz');
  const reqs=store.get('pinReqs',[])||[]; reqs.push({id:uuid(),phone:e164,newPin,createdAt:Date.now()}); store.set('pinReqs',reqs);
  updateBell(); alert('PIN sÄ±fÄ±rlama talebi oluÅŸturuldu.');
});

/* ========= MÃ¼ÅŸteri oturumu ========= */
function setCurrentUserSession(u){
  const sess={id:u.id||uuid(),name:u.name,phone:u.phone,ts:Date.now()};
  store.set(LS_USER_SESSION,sess);
  document.getElementById('userBtn').textContent=`${u.name} (Hesap)`;
  document.getElementById('f_name').value=u.name||'';
  document.getElementById('f_phone').value=(u.phone||'').replace('+90','0');
  loadMyAppts();
}
function loadMyAppts(){
  const sess=store.get(LS_USER_SESSION); const tb=document.getElementById('myApptTbody'); if(!tb) return; tb.innerHTML='';
  const rows=(store.get('appts',[])||[]).filter(a=>sess && (a.userId===sess.id || a.phone===sess.phone))
    .sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
  rows.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.date}</td><td>${a.time}</td><td>${a.serviceName}</td><td>${a.staffName||''}</td><td>${a.status}</td>
      <td>
        <button class="btn" onclick="userCancel('${a.id}')">Ä°ptal</button>
        <button class="btn" onclick="userDelete('${a.id}')">Sil</button>
      </td>`;
    tb.appendChild(tr);
  });
}
window.userCancel=(id)=>{const list=store.get('appts',[])||[];const i=list.findIndex(x=>x.id===id); if(i<0) return; list[i].status='cancelled'; store.set('appts',list); loadMyAppts(); renderQueue(); renderCalendar(); updateBell(); }
window.userDelete=(id)=>{if(!confirm('Randevu silinsin mi?')) return; store.set('appts',(store.get('appts',[])||[]).filter(x=>x.id!==id)); loadMyAppts(); renderQueue(); renderCalendar(); updateBell(); }

/* ========= Admin giriÅŸ/oturum ========= */
let adminAuthed = store.get(LS_ADMIN_SESSION)===true;
function setAdminUI(on){
  adminAuthed=!!on;
  if(on){
    document.body.classList.add('admin');
    document.getElementById('sidebar').style.display='block';
    renderSideNav(); renderReports(); renderQueue(); renderCalendar(); renderStaffManager(); renderServiceManager(); renderPinReqs(); renderCustomers();
  }else{
    document.body.classList.remove('admin');
    document.getElementById('sidebar').style.display='none';
    document.getElementById('sideNav').innerHTML='';
  }
  updateBell();
}

/* ========= Sidebar ========= */
function renderSideNav(){
  const nav=document.getElementById('sideNav');
  nav.innerHTML = `
    <a data-target="#pane_queue" class="active">ğŸ  Onay KuyruÄŸu</a>
    <a data-target="#pane_calendar">ğŸ“… GÃ¼nlÃ¼k Takvim</a>
    <a data-target="#pane_staff">ğŸ’ˆ Ustalar</a>
    <a data-target="#pane_services">ğŸ§° Hizmetler</a>
    <a data-target="#pane_customers">ğŸ‘¥ MÃ¼ÅŸteriler</a>
    <a data-target="#pane_pin">ğŸ”‘ PIN Talepleri</a>
    <a data-target="#pane_reports">ğŸ“Š Raporlar</a>
  `;
  nav.querySelectorAll('a').forEach(a=>{
    a.addEventListener('click',(e)=>{
      e.preventDefault();
      openAdminPane(a.dataset.target);
    });
  });
}

/* ========= Admin Panel ÅablonlarÄ± ========= */
const PANE_TEMPLATES = {
  '#pane_queue': `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4>Onay KuyruÄŸu</h4>
      <button id="openAdminCreate" class="btn">+ Yeni Randevu (Admin)</button>
    </div>
    <div class="table-scroll" style="max-height:320px">
      <table><thead><tr><th></th><th>Ad</th><th>Tel</th><th>Tarih</th><th>Saat</th><th>Hizmet</th><th>Berber</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead>
      <tbody id="queueTbody"></tbody></table>
    </div>
    <details id="adminCreateBox" class="card" style="margin-top:10px">
      <summary><b>Yeni Randevu (Admin)</b> â€” limit yok</summary>
      <div class="form-row">
        <div><label>Ad Soyad</label><input id="a_name"></div>
        <div><label>Telefon</label><input id="a_phone" placeholder="05xxxxxxxxx"></div>
        <div><label>Hizmet</label><select id="a_service"></select></div>
        <div><label>Berber</label><select id="a_staff"></select></div>
        <div><label>Tarih</label><input id="a_date" type="date"></div>
        <div><label>Oto Onay</label><label class="small"><input id="a_auto" type="checkbox"> Direkt onayla</label></div>
      </div>
      <div style="margin-top:10px">
        <div class="small">Uygun Saatler</div>
        <div id="a_slots" class="slots"></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button id="a_create" class="btn btn-primary" type="button">OluÅŸtur</button>
        <span id="a_status" class="small"></span>
      </div>
    </details>
  `,
  '#pane_calendar': `
    <h4>GÃ¼nlÃ¼k Takvim</h4>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="date" id="calDate">
      <select id="calStaff"><option value="">TÃ¼mÃ¼</option></select>
      <button id="viewCal" class="btn">GÃ¶rÃ¼ntÃ¼le</button>
    </div>
    <div class="table-scroll" style="margin-top:8px;max-height:320px">
      <table><thead><tr><th></th><th>Saat</th><th>MÃ¼ÅŸteri</th><th>Hizmet</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="calTbody"></tbody></table>
    </div>
  `,
  '#pane_staff': `
    <h4>Ustalar</h4>
    <div class="card" style="margin-bottom:10px">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <input id="st_name" placeholder="Usta adÄ±" style="max-width:240px">
        <label class="small">Ã‡alÄ±ÅŸma:
          <input id="st_open" type="time" value="09:00" style="max-width:120px"> â€“
          <input id="st_close" type="time" value="21:00" style="max-width:120px">
        </label>
        <div id="st_days_add" class="small" style="display:flex;gap:8px;flex-wrap:wrap"></div>
        <button id="st_add" class="btn btn-primary" type="button">Ekle</button>
      </div>
      <p class="small" style="margin:6px 0 0">GÃ¼n seÃ§mezsen varsayÄ±lan: Pztâ€“Cmt Ã§alÄ±ÅŸÄ±r.</p>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr><th>Ad</th><th>Ã‡alÄ±ÅŸma Saatleri</th><th>GÃ¼nler</th><th>KapalÄ± GÃ¼n</th><th>Ä°ÅŸlem</th></tr>
        </thead>
        <tbody id="st_tbody"></tbody>
      </table>
    </div>
  `,
  '#pane_services': `
    <h4>Hizmetler</h4>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <input id="sv_name" placeholder="Hizmet adÄ±">
      <input id="sv_dur" type="number" placeholder="SÃ¼re (dk)">
      <input id="sv_price" type="number" placeholder="Fiyat (TL)">
      <button id="sv_add" class="btn btn-primary">Ekle</button>
    </div>
    <div class="table-scroll" style="max-height:320px">
      <table>
        <thead><tr><th>Ad</th><th>SÃ¼re</th><th>Fiyat</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="sv_tbody"></tbody>
      </table>
    </div>
  `,
  '#pane_customers': `
    <h4>MÃ¼ÅŸteriler</h4>
    <div class="table-scroll" style="max-height:360px">
      <table>
        <thead><tr><th>Ad</th><th>Telefon</th><th>KayÄ±t</th><th>Son GiriÅŸ</th><th>Ä°ÅŸlem</th></tr></thead>
        <tbody id="custTbody"></tbody>
      </table>
    </div>
  `,
  '#pane_pin': `
    <h4>PIN Talepleri</h4>
    <div class="table-scroll" style="max-height:320px">
      <table><thead><tr><th>Tel</th><th>Yeni PIN</th><th>Zaman</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="pinTbody"></tbody></table>
    </div>
  `,
  '#pane_reports': `
    <h4>Raporlar</h4>
    <div class="grid-cards" id="reportCards"></div>
  `
};

/* ========= Admin Panel AÃ§/Kapa ========= */
function openAdminPane(selector){
  if(!selector) return;
  const panel=document.getElementById('adminPanel');
  const body=document.getElementById('adminPanelBody');
  const title=document.getElementById('adminPanelTitle');
  body.innerHTML = PANE_TEMPLATES[selector] || '<div class="small">Panel bulunamadÄ±</div>';
  title.textContent = document.querySelector(`#sideNav a[data-target="${selector}"]`)?.textContent || 'Panel';
  panel.style.display='flex';

  // Panel iÃ§i olay baÄŸlama
  if(selector==='#pane_queue'){ renderQueue(); renderAdminCreateSeeds(); }
  if(selector==='#pane_calendar'){ document.getElementById('calDate').value=todayISO(); renderCalendar(); document.getElementById('viewCal').onclick=renderCalendar; }
  if(selector==='#pane_staff'){ renderStaffManager(); }
  if(selector==='#pane_services'){ renderServiceManager(); }
  if(selector==='#pane_customers'){ renderCustomers(); }
  if(selector==='#pane_pin'){ renderPinReqs(); }
  if(selector==='#pane_reports'){ renderReports(); }
}
document.getElementById('closeAdminPanel').addEventListener('click',()=>{ document.getElementById('adminPanel').style.display='none'; });

/* ========= Admin Drawer baÄŸlama ========= */
function openAdminDrawer(){ document.getElementById('adminDrawer').classList.add('show'); document.getElementById('drawerBackdrop').classList.add('show'); }
function closeAdminDrawer(){ document.getElementById('adminDrawer').classList.remove('show'); document.getElementById('drawerBackdrop').classList.remove('show'); }
document.getElementById('drawerCloseBtn').onclick=closeAdminDrawer;
document.getElementById('drawerBackdrop').onclick=closeAdminDrawer;
document.querySelectorAll('#adminDrawer a[data-pane]').forEach(a=>{
  a.addEventListener('click',()=>{
    const map={
      queue:'#pane_queue', calendar:'#pane_calendar', new:'#pane_queue',
      customers:'#pane_customers', staff:'#pane_staff', services:'#pane_services',
      pin:'#pane_pin', reports:'#pane_reports', hours:'#pane_staff'
    };
    openAdminPane(map[a.getAttribute('data-pane')]);
    closeAdminDrawer();
  });
});

/* ========= MÃ¼ÅŸteri Sheet aÃ§/kapat ========= */
function openUserSheet(){
  document.getElementById('userBackdrop').classList.add('show');
  const s=document.getElementById('userSheet'); s.classList.remove('hide'); s.classList.add('show'); s.style.display='block';
  document.getElementById('userPaneLogin').style.display='block'; document.getElementById('userPaneReg').style.display='none';
}
function closeUserSheet(){
  const s=document.getElementById('userSheet'); s.classList.remove('show'); s.classList.add('hide');
  setTimeout(()=>{s.style.display='none'; document.getElementById('userBackdrop').classList.remove('show');},230);
}
document.getElementById('userCloseBtn').onclick=closeUserSheet;
document.getElementById('tabUserLogin').onclick=()=>{document.getElementById('userPaneLogin').style.display='block';document.getElementById('userPaneReg').style.display='none';};
document.getElementById('tabUserReg').onclick  =()=>{document.getElementById('userPaneLogin').style.display='none';document.getElementById('userPaneReg').style.display='block';};
if(document.getElementById('userBtn')) document.getElementById('userBtn').onclick=openUserSheet;

/* ========= MÃ¼ÅŸteri GiriÅŸ/KayÄ±t & PIN ========= */
function toE164TR(raw){
  if(!raw) return null; const only=String(raw).replace(/\D/g,'');
  if(only.length===10 && only.startsWith('5')) return '+90'+only;
  if(only.length===12 && only.startsWith('90')) return '+'+only;
  if(String(raw).startsWith('+')) return raw; return null;
}
const users = () => (store.get('users',[])||[]);
const saveUsers = (arr) => store.set('users',arr);
const findUserByPhone = (p) => users().find(u=>u.phone===p);

document.getElementById('doUserLogin').onclick = function(){
  const phone=toE164TR(document.getElementById('lg_phone').value);
  const pin=(document.getElementById('lg_pin').value||'').trim();
  const msg=document.getElementById('lg_msg');
  if(!phone || !/^\d{4}$/.test(pin)){ msg.textContent='Telefon ve 4 haneli PIN gerekli.'; return; }
  const u=findUserByPhone(phone);
  if(!u || String(u.pin)!==pin){ msg.textContent='Telefon veya PIN hatalÄ±.'; return; }
  const list=users(); const i=list.findIndex(x=>x.id===u.id); if(i>=0){ list[i].lastLogin=Date.now(); saveUsers(list); }
  setCurrentUserSession({id:u.id,name:u.name,phone:u.phone});
  closeUserSheet();
};
document.getElementById('doUserRegister').onclick = function(){
  const name=(document.getElementById('rg_name').value||'').trim();
  const phone=toE164TR(document.getElementById('rg_phone').value);
  const pin=(document.getElementById('rg_pin').value||'').trim();
  const msg=document.getElementById('rg_msg');
  if(!name||!phone||!/^\d{4}$/.test(pin)){msg.textContent='Ad, telefon ve 4 haneli PIN zorunlu.';return;}
  if(findUserByPhone(phone)){msg.textContent='Bu telefonla kayÄ±t var. LÃ¼tfen giriÅŸ yapÄ±n.';return;}
  const u={id:uuid(),name,phone,pin,createdAt:Date.now(),lastLogin:Date.now()}; const list=users(); list.push(u); saveUsers(list);
  setCurrentUserSession({id:u.id,name:u.name,phone:u.phone}); closeUserSheet();
};
document.getElementById('doUserForgot').onclick=function(){
  const p=prompt('Telefon (05xxxxxxxxx)'); const phone=toE164TR(p||''); if(!phone) return alert('Telefon biÃ§imi hatalÄ±');
  const newPin=prompt('Yeni PIN (4 hane)'); if(!/^\d{4}$/.test(newPin||'')) return alert('4 haneli PIN giriniz');
  const reqs=store.get('pinReqs',[])||[]; reqs.push({id:uuid(),phone,newPin,createdAt:Date.now()}); store.set('pinReqs',reqs);
  updateBell(); alert('PIN talebi oluÅŸturuldu (Admin onaylayacak).');
};

/* ========= Admin Login (kart) ========= */
function openAdminModal(){ document.getElementById('adminBackdrop').classList.add('show'); document.getElementById('adminModal').classList.add('show'); }
function closeAdminModal(){ document.getElementById('adminBackdrop').classList.remove('show'); document.getElementById('adminModal').classList.remove('show'); }
document.getElementById('adminCloseBtn').onclick=closeAdminModal;
if(document.getElementById('adminBtn')) document.getElementById('adminBtn').onclick=openAdminModal;

document.getElementById('doAdminLogin').onclick=function(){
  const ph=(document.getElementById('ad_phone').value||'').trim();
  const pw=(document.getElementById('ad_pass').value||'').trim();
  if(ph!==ADMIN_PHONE_E164 || pw!==ADMIN_PASSWORD){ alert('Admin bilgileri hatalÄ±'); return; }
  store.set(LS_ADMIN_SESSION,true);
  const s=store.get('settings'); s.adminAutoApprove = !!document.getElementById('autoApprove').checked; store.set('settings',s);
  closeAdminModal(); setAdminUI(true); openAdminDrawer();
};
document.getElementById('doAdminLogout').onclick=function(){ store.del(LS_ADMIN_SESSION); setAdminUI(false); closeAdminModal(); closeAdminDrawer(); };

/* ========= Kuyruk / Admin New ========= */
function renderAdminCreateSeeds(){
  renderSelects();
  document.getElementById('a_date').value=todayISO();
  ['a_service','a_staff','a_date'].forEach(id=>document.getElementById(id).addEventListener('change',renderAdminSlots));
  renderAdminSlots();
  document.getElementById('a_create').addEventListener('click',()=>{
    if(!adminAuthed) return alert('YalnÄ±zca admin');
    const name=(document.getElementById('a_name').value||'').trim();
    const phone=phoneNormalize((document.getElementById('a_phone').value||'').trim());
    const svc=(store.get('services',[])||[]).find(x=>x.id===document.getElementById('a_service').value);
    const staff=(store.get('staff',[])||[]).find(x=>x.id===document.getElementById('a_staff').value);
    const date=document.getElementById('a_date').value;
    const timeBtn=document.querySelector('#a_slots .slot.sel');
    const auto=document.getElementById('a_auto').checked || store.get('settings').adminAutoApprove;
    const st=document.getElementById('a_status');
    if(!name||!phone||!svc||!staff||!date||!timeBtn){st.textContent='Eksik bilgi';return;}
    const time=timeBtn.dataset.time; const duration=svc.dur;
    const appts=store.get('appts',[])||[];
    appts.push({id:uuid(),userId:phone,name,phone,serviceId:svc.id,serviceName:svc.name,staffId:staff.id,staffName:staff.name,date,time,duration,status:auto?'approved':'pending',createdAt:Date.now()});
    store.set('appts',appts);
    st.textContent='Kaydedildi'; renderQueue(); renderCalendar(); updateBell();
  });
  document.getElementById('openAdminCreate').addEventListener('click',()=>{document.getElementById('adminCreateBox').open=true;});
}
function renderAdminSlots(){
  const svc=(store.get('services',[])||[]).find(x=>x.id===document.getElementById('a_service').value);
  const staff=(store.get('staff',[])||[]).find(x=>x.id===document.getElementById('a_staff').value);
  const date=document.getElementById('a_date').value;
  const box=document.getElementById('a_slots'); box.innerHTML='';
  if(!svc||!staff||!date) return;
  const {open,close}=getHoursFor(staff,date);
  const openM=toMin(open), closeM=toMin(close), step=store.get('settings').slot||30, dur=svc.dur;
  const taken=conflicts(date,staff.id);
  for(let t=openM;t+dur<=closeM;t+=step){
    const disabled=taken.some(x=>overlaps(t,t+dur,x.start,x.end)) || !staffWorksThatDay(staff,date) || isOffDate(staff,date);
    if(disabled) continue;
    const b=document.createElement('button'); b.type='button'; b.className='slot'; b.textContent=toHHMM(t); b.dataset.time=toHHMM(t);
    b.onclick=()=>{document.querySelectorAll('#a_slots .slot').forEach(x=>x.classList.remove('sel')); b.classList.add('sel');};
    box.appendChild(b);
  }
}

/* ========= Kuyruk ========= */
function statusTR(s){return s==='pending'?'Onay Bekliyor':s==='approved'?'OnaylandÄ±':s==='cancelled'?'Ä°ptal Edildi':s==='rejected'?'Reddedildi':s}
function renderQueue(){
  if(!adminAuthed) return;
  const tb=document.getElementById('queueTbody'); if(!tb) return;
  tb.innerHTML='';
  const rows=(store.get('appts',[])||[]).filter(a=>a.status==='pending').sort((a,b)=>a.date.localeCompare(b.date)||a.time.localeCompare(b.time));
  rows.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="checkbox" data-id="${a.id}"></td>
      <td>${a.name}</td><td>${a.phone}</td><td>${a.date}</td><td>${a.time}</td><td>${a.serviceName}</td><td>${a.staffName||''}</td><td>${statusTR(a.status)}</td>
      <td>
        <button class="btn" onclick="approve('${a.id}')">Onayla</button>
        <button class="btn" onclick="reject('${a.id}')">Reddet</button>
        <button class="btn" onclick="adminDelete('${a.id}')">Sil</button>
      </td>`;
    tb.appendChild(tr);
  });
}
window.approve=(id)=>{const list=store.get('appts',[])||[];const i=list.findIndex(x=>x.id===id); if(i<0) return;
  const a=list[i]; const conf=list.some(x=>x.id!==a.id && x.date===a.date && x.staffId===a.staffId && x.status!=='cancelled'&&x.status!=='rejected' && (toMin(a.time)<toMin(x.time)+x.duration && toMin(a.time)+a.duration>toMin(x.time)));
  if(conf){alert('Bu saat Ã§akÄ±ÅŸÄ±yor'); return;}
  list[i].status='approved'; store.set('appts',list); renderQueue(); renderCalendar(); updateBell();
}
window.reject=(id)=>{const list=store.get('appts',[])||[];const i=list.findIndex(x=>x.id===id); if(i<0) return; list[i].status='rejected'; store.set('appts',list); renderQueue(); updateBell();}
window.adminDelete=(id)=>{if(!confirm('Randevu silinsin mi?')) return; store.set('appts',(store.get('appts',[])||[]).filter(x=>x.id!==id)); renderQueue(); renderCalendar(); updateBell();}

/* ========= Takvim ========= */
function renderCalendar(){
  if(!adminAuthed) return;
  const date=document.getElementById('calDate')?.value||todayISO();
  const staffId=document.getElementById('calStaff')?.value||'';
  const tb=document.getElementById('calTbody'); if(!tb) return; tb.innerHTML='';
  const rows=(store.get('appts',[])||[]).filter(a=>a.date===date && (!staffId||a.staffId===staffId) && a.status!=='rejected')
    .sort((a,b)=>a.time.localeCompare(b.time));
  rows.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="checkbox" data-id="${a.id}"></td>
      <td>${a.time} (${a.duration}') </td><td>${a.name}</td><td>${a.serviceName} / ${a.staffName||''}</td><td>${statusTR(a.status)}</td>
      <td>${a.status!=='cancelled'?`<button class="btn" onclick="cancelAdmin('${a.id}')">Ä°ptal</button>`:''} <button class="btn" onclick="adminDelete('${a.id}')">Sil</button></td>`;
    tb.appendChild(tr);
  });
}
window.cancelAdmin=(id)=>{const list=store.get('appts',[])||[];const i=list.findIndex(x=>x.id===id); if(i<0) return; list[i].status='cancelled'; store.set('appts',list); renderCalendar(); renderQueue(); updateBell();}

/* ========= Usta YÃ¶netimi ========= */
function dayChipsHTML(prefix, checked=[]){
  return DAY_LABELS.map((lab,i)=>{
    const on = checked.includes(i) ? 'checked' : '';
    return `<label class="small" style="display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;margin:2px 0">
      <input type="checkbox" data-dow="${i}" data-prefix="${prefix}" ${on} style="width:auto">${lab}</label>`;
  }).join(' ');
}
function readDaysFrom(containerSel,prefix){
  return [...document.querySelectorAll(`${containerSel} input[type="checkbox"][data-prefix="${prefix}"]:checked`)]
          .map(x=>parseInt(x.getAttribute('data-dow'),10));
}
function renderStaffManager(){
  if(!adminAuthed) return;
  const addWrap=document.getElementById('st_days_add'); if(addWrap) addWrap.innerHTML = dayChipsHTML('add',[1,2,3,4,5,6]);
  const staff=(store.get('staff',[])||[]).slice().sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr'));
  const tb=document.getElementById('st_tbody'); if(!tb) return; tb.innerHTML='';
  staff.forEach(s=>{
    const open=s.hours?.open || store.get('settings').open || '09:00';
    const close=s.hours?.close || store.get('settings').close || '21:00';
    const days=Array.isArray(s.days)?s.days:[1,2,3,4,5,6];
    const off=(s.offDates||[]).slice(0,3).join(' â€¢ ')+((s.offDates||[]).length>3?' â€¦':'');
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input id="st_name_${s.id}" value="${s.name||''}" style="max-width:220px"></td>
      <td>
        <input id="st_open_${s.id}" type="time" value="${open}" style="max-width:110px"> â€“
        <input id="st_close_${s.id}" type="time" value="${close}" style="max-width:110px">
      </td>
      <td><div id="st_days_${s.id}" style="display:flex;gap:6px;flex-wrap:wrap">${dayChipsHTML(s.id,days)}</div></td>
      <td>
        <div class="small">${off||'â€”'}</div>
        <div style="display:flex;gap:6px;margin-top:6px">
          <input type="date" id="st_off_${s.id}" style="max-width:160px">
          <button class="btn" onclick="stAddOff('${s.id}')">Ekle</button>
        </div>
      </td>
      <td>
        <button class="btn" onclick="stSave('${s.id}')">Kaydet</button>
        <button class="btn" onclick="stDelete('${s.id}')">Sil</button>
      </td>`;
    tb.appendChild(tr);
  });

  document.getElementById('st_add')?.addEventListener('click',()=>{
    if(!adminAuthed) return alert('YalnÄ±zca admin');
    const name=(document.getElementById('st_name').value||'').trim();
    const open=document.getElementById('st_open').value||'09:00';
    const close=document.getElementById('st_close').value||'21:00';
    let days=readDaysFrom('#pane_staff','add'); if(days.length===0) days=[1,2,3,4,5,6];
    if(!name){alert('Usta adÄ± gerekli');return;}
    const list=store.get('staff',[])||[]; list.push({id:uuid(),name,days,hours:{open,close},offDates:[]}); store.set('staff',list);
    document.getElementById('st_name').value=''; renderStaffManager(); renderSelects(); renderSlots(); alert('Usta eklendi');
  });
}
window.stSave=(id)=>{
  if(!adminAuthed) return alert('YalnÄ±zca admin');
  const list=store.get('staff',[])||[]; const i=list.findIndex(x=>x.id===id); if(i<0) return;
  list[i].name=(document.getElementById(`st_name_${id}`).value||'').trim();
  list[i].hours={open:document.getElementById(`st_open_${id}`).value||'09:00', close:document.getElementById(`st_close_${id}`).value||'21:00'};
  list[i].days=readDaysFrom(`#st_days_${id}`,id);
  if(!Array.isArray(list[i].offDates)) list[i].offDates=[];
  store.set('staff',list); renderStaffManager(); renderSelects(); renderSlots(); alert('Usta gÃ¼ncellendi');
};
window.stDelete=(id)=>{
  if(!adminAuthed) return alert('YalnÄ±zca admin');
  if(!confirm('Usta silinsin mi? Bu ustanÄ±n randevularÄ± kalÄ±r.')) return;
  store.set('staff',(store.get('staff',[])||[]).filter(x=>x.id!==id));
  renderStaffManager(); renderSelects(); renderSlots(); alert('Usta silindi');
};
window.stAddOff=(id)=>{
  if(!adminAuthed) return alert('YalnÄ±zca admin');
  const d=document.getElementById(`st_off_${id}`).value; if(!d) return;
  const list=store.get('staff',[])||[]; const i=list.findIndex(x=>x.id===id); if(i<0) return;
  const set=new Set(list[i].offDates||[]); set.add(d); list[i].offDates=[...set]; store.set('staff',list);
  renderStaffManager(); alert('KapalÄ± gÃ¼n eklendi');
};

/* ========= Hizmetler ========= */
function renderServiceManager(){
  if(!adminAuthed) return;
  const tb=document.getElementById('sv_tbody'); if(!tb) return;
  const list=(store.get('services',[])||[]).slice().sort((a,b)=>a.name.localeCompare(b.name,'tr'));
  tb.innerHTML=list.map(s=>`
    <tr>
      <td><input id="sv_name_${s.id}" value="${s.name||''}" style="max-width:220px"></td>
      <td><input id="sv_dur_${s.id}" type="number" min="5" step="5" value="${s.dur||30}" style="max-width:120px"></td>
      <td><input id="sv_price_${s.id}" type="number" min="0" step="1" value="${s.price||0}" style="max-width:120px"></td>
      <td>
        <button class="btn" onclick="svSave('${s.id}')">Kaydet</button>
        <button class="btn" onclick="svDelete('${s.id}')">Sil</button>
      </td>
    </tr>
  `).join('');
}
document.addEventListener('click',(e)=>{
  if(e.target?.id==='sv_add'){
    if(!adminAuthed) return alert('YalnÄ±zca admin');
    const name=(document.getElementById('sv_name').value||'').trim();
    const dur=parseInt(document.getElementById('sv_dur').value,10)||30;
    const price=parseInt(document.getElementById('sv_price').value,10)||0;
    if(!name){alert('Hizmet adÄ± gerekli');return;}
    const list=store.get('services',[])||[]; list.push({id:uuid(),name,dur,price}); store.set('services',list);
    document.getElementById('sv_name').value=''; document.getElementById('sv_dur').value=''; document.getElementById('sv_price').value='';
    renderServiceManager(); renderSelects(); renderSlots(); alert('Hizmet eklendi');
  }
});
window.svSave=(id)=>{
  if(!adminAuthed) return alert('YalnÄ±zca admin');
  const list=store.get('services',[])||[]; const i=list.findIndex(x=>x.id===id); if(i<0) return;
  list[i].name=(document.getElementById(`sv_name_${id}`).value||'').trim();
  list[i].dur=parseInt(document.getElementById(`sv_dur_${id}`).value,10)||30;
  list[i].price=parseInt(document.getElementById(`sv_price_${id}`).value,10)||0;
  store.set('services',list); renderServiceManager(); renderSelects(); renderSlots(); alert('Hizmet gÃ¼ncellendi');
};
window.svDelete=(id)=>{
  if(!adminAuthed) return alert('YalnÄ±zca admin');
  if(!confirm('Hizmet silinsin mi?')) return;
  store.set('services',(store.get('services',[])||[]).filter(x=>x.id!==id));
  renderServiceManager(); renderSelects(); renderSlots(); alert('Hizmet silindi');
};

/* ========= MÃ¼ÅŸteriler ========= */
function renderCustomers(){
  if(!adminAuthed) return;
  const tb=document.getElementById('custTbody'); if(!tb) return;
  const list=(users()).slice().sort((a,b)=>(a.name||'').localeCompare(b.name||'','tr'));
  tb.innerHTML = list.map(u=>`
    <tr>
      <td><input id="c_name_${u.id}" value="${u.name||''}" style="max-width:220px"></td>
      <td>${u.phone}</td>
      <td>${u.createdAt?new Date(u.createdAt).toLocaleString('tr-TR'):'-'}</td>
      <td>${u.lastLogin?new Date(u.lastLogin).toLocaleString('tr-TR'):'-'}</td>
      <td>
        <button class="btn" onclick="custSave('${u.id}')">Kaydet</button>
        <button class="btn" onclick="custDelete('${u.id}')">Sil</button>
      </td>
    </tr>
  `).join('');
}
window.custSave = function(id){
  const list=users(); const i=list.findIndex(x=>x.id===id); if(i<0) return;
  list[i].name=(document.getElementById('c_name_'+id).value||'').trim();
  saveUsers(list);
  renderCustomers();
  alert('MÃ¼ÅŸteri gÃ¼ncellendi');
};
window.custDelete = function(id){
  if(!confirm('MÃ¼ÅŸteri silinsin mi? Randevular kalÄ±r.')) return;
  const list=users().filter(x=>x.id!==id); saveUsers(list);
  const sess=store.get('userSession'); if(sess && sess.id===id){ store.del('userSession'); document.getElementById('userBtn').textContent='MÃ¼ÅŸteri GiriÅŸi'; }
  renderCustomers();
};

/* ========= PIN Talepleri ========= */
function renderPinReqs(){
  if(!adminAuthed) return;
  const tb=document.getElementById('pinTbody'); if(!tb) return;
  const list=(store.get('pinReqs',[])||[]).slice().sort((a,b)=>b.createdAt-a.createdAt);
  tb.innerHTML=list.map(r=>`<tr><td>${r.phone}</td><td>${r.newPin}</td><td>${new Date(r.createdAt).toLocaleString('tr-TR')}</td>
    <td><button class="btn" onclick="pinDone('${r.id}')">TamamlandÄ±</button></td></tr>`).join('');
}
window.pinDone=(id)=>{store.set('pinReqs',(store.get('pinReqs',[])||[]).filter(x=>x.id!==id)); renderPinReqs(); updateBell();};

/* ========= Raporlar ========= */
function renderReports(){
  if(!adminAuthed) return;
  const cards=document.getElementById('reportCards'); if(!cards) return;
  const appts=store.get('appts',[])||[];
  const today=todayISO();
  const weekStart=(()=>{const d=new Date();const day=d.getDay();d.setDate(d.getDate()-((day+6)%7));return d.toISOString().slice(0,10)})();
  const isWeek=(d)=>d>=weekStart;
  const tday=appts.filter(a=>a.date===today);
  const wday=appts.filter(a=>isWeek(a.date));
  const sumPrice = list => list.reduce((s,a)=>{const svc=(store.get('services',[])||[]).find(x=>x.id===a.serviceId); return s + (svc?.price||0);},0);
  cards.innerHTML=`
    <div class="card"><div class="small">BugÃ¼n Toplam</div><div style="font-size:22px">${tday.length}</div></div>
    <div class="card"><div class="small">BugÃ¼n OnaylÄ±</div><div style="font-size:22px">${tday.filter(a=>a.status==='approved').length}</div></div>
    <div class="card"><div class="small">BugÃ¼n Tutar (TL)</div><div style="font-size:22px">${sumPrice(tday)}</div></div>
    <div class="card"><div class="small">Hafta Toplam</div><div style="font-size:22px">${wday.length}</div></div>
    <div class="card"><div class="small">Hafta OnaylÄ±</div><div style="font-size:22px">${wday.filter(a=>a.status==='approved').length}</div></div>
    <div class="card"><div class="small">Hafta Tutar (TL)</div><div style="font-size:22px">${sumPrice(wday)}</div></div>
  `;
}

/* ========= BaÅŸlangÄ±Ã§ ========= */
document.getElementById('logoImg').src=''; // logonu istersen buraya base64/path ver
document.getElementById('f_date').value=todayISO();
renderSelects(); renderSlots(); updateBell();

if(store.get(LS_ADMIN_SESSION)===true){ setAdminUI(true); }
const savedUser=store.get(LS_USER_SESSION);
if(savedUser){
  document.getElementById('userBtn').textContent=`${savedUser.name} (Hesap)`;
  document.getElementById('f_name').value=savedUser.name||'';
  document.getElementById('f_phone').value=(savedUser.phone||'').replace('+90','0');
}
loadMyAppts();
</script>
</body>
</html>
